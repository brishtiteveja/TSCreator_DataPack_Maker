/*
		PolyK library
		url: http://polyk.ivank.net
		Released under MIT licence.
		
		Copyright (c) 2012 Ivan Kuckir

		Permission is hereby granted, free of charge, to any person
		obtaining a copy of this software and associated documentation
		files (the "Software"), to deal in the Software without
		restriction, including without limitation the rights to use,
		copy, modify, merge, publish, distribute, sublicense, and/or sell
		copies of the Software, and to permit persons to whom the
		Software is furnished to do so, subject to the following
		conditions:

		The above copyright notice and this permission notice shall be
		included in all copies or substantial portions of the Software.

		THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
		EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
		OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
		NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
		HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
		WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
		FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
		OTHER DEALINGS IN THE SOFTWARE.
	*/

define("baseView",[],function(){var e=Backbone.View.extend({});return e.prototype.wrapString=function(e,t,n,r){n=n||"\n",t=t||75,r=r||!1;if(!e)return e;var i=".{1,"+t+"}(\\s|$)"+(r?"|.{"+t+"}|.+$":"|\\S+?(\\s|$)");return e.match(RegExp(i,"g")).join(n)},e}),define("baseModel",[],function(){var e=Backbone.Model.extend({localStorage:new Backbone.LocalStorage("timescale-creator")});return e}),define("cursor",["baseModel"],function(e){var t=e.extend({constructor:function(t,n){var r=[{lockH:!1,lockV:!1}];e.apply(this,r)}});return t}),define("cursorView",["baseView","cursor"],function(e,t){var n=e.extend({el:".main",classname:"CursorView",events:{keypress:"togglelock",'click a[href="#lock-cursor-h"]':"toggleHlock",'click a[href="#lock-cursor-v"]':"toggleVlock"}});return n.prototype.initialize=function(e){this.app=e,this.cursor=new t,this.app.Cursor=this.cursor,this.$hLock=this.$('a[href="#lock-cursor-h"]'),this.$vLock=this.$('a[href="#lock-cursor-v"]')},n.prototype.togglelock=function(e){e.keyCode==TimescaleApp.KEY_MINUS&&this.toggleHlock(),e.keyCode==TimescaleApp.KEY_EQUAL&&this.toggleVlock()},n.prototype.toggleHlock=function(){this.$vLock.parent().hasClass("active")&&this.toggleVlock(),this.$hLock.parent().toggleClass("active"),this.cursor.set({lockH:!this.cursor.get("lockH")})},n.prototype.toggleVlock=function(){this.$hLock.parent().hasClass("active")&&this.toggleHlock(),this.$vLock.parent().toggleClass("active"),this.cursor.set({lockV:!this.cursor.get("lockV")})},n}),define("transectView",["baseView"],function(e){var t=e.extend({tagName:"li",classname:"TransectView",events:{"click .toggle":"toggleTransectForm","click .transect-data":"toggleTransectForm","keypress :input":"updateTransect","keyup :input":"updateTransect",mouseover:"onMouseOver",mouseout:"onMouseOut"}});return t.prototype.template=new EJS({url:"../../../transect_maker/ejs/transect.ejs"}),t.prototype.initialize=function(e){this.transect=e,this.listenTo(this.transect,"change:edit",this.toggleEditStatus.bind(this)),this.listenTo(this.transect,"change:name",this.render.bind(this)),this.listenTo(this.transect,"change:description",this.render.bind(this)),this.listenTo(this.transect,"destroy",this.delete.bind(this)),this.render()},t.prototype.render=function(){this.$el.html(this.template.render(this.transect.toJSON())),this.$transectForm=this.$(".transect-form"),this.$transectData=this.$(".transect-data"),this.$destroy=this.$(".destroy"),this.$toggle=this.$(".toggle"),this.$update=this.$(".update"),this.$name=this.$("input[name*=transect-name]")[0],this.$description=this.$("textarea[name*=transect-description]")[0]},t.prototype.toggleTransectForm=function(){this.transect.set({edit:!this.transect.get("edit")})},t.prototype.toggleEditStatus=function(){this.transect.get("edit")?(this.$transectForm.removeClass("hide"),this.$transectData.addClass("hide"),this.$toggle.removeClass("hide-data"),this.$toggle.addClass("show-data")):(this.$transectForm.addClass("hide"),this.$transectData.removeClass("hide"),this.$toggle.removeClass("show-data"),this.$toggle.addClass("hide-data"))},t.prototype.onMouseOver=function(){this.$el.addClass("hover"),this.transect.get("wellLeft").set({hover:!0}),this.transect.get("wellRight").set({hover:!0})},t.prototype.onMouseOut=function(){this.$el.removeClass("hover"),this.transect.get("wellLeft").set({hover:!1}),this.transect.get("wellRight").set({hover:!1})},t.prototype.updateTransect=function(e){if(e.keyCode==TimescaleApp.ENTER||e.keyCode==TimescaleApp.ESC){var t=this.$name.value,n=this.$description.value;this.transect.set({name:t,description:n}),this.toggleTransectForm()}},t.prototype.delete=function(){this.element!==undefined&&this.element.remove(),this.$el.remove(),this.remove()},t.prototype.destroy=function(){this.transect.destroy()},t}),define("baseCollection",[],function(){var e=Backbone.Collection.extend({localStorage:new Backbone.LocalStorage("timescale-creator")});return e}),define("settings",["baseModel"],function(e){var t=e.extend({classname:"Settings",constructor:function(t,n){var r=[{fontFamily:t?t.fontFamily:"Arial, Helvetica, sans-serif",fontVariant:t?t.fontVariant:"normal",fontWeight:t?t.fontWeight:"normal",fontStretch:t?t.fontStretch:"normal",fontSize:t?t.fontSize:12,backgroundColor:t&&t.backgroundColor?TscToCssColor(t.backgroundColor):"#DDDDDD",fill:t&&t.fill?TscToCssColor(t.fill):"#000000",strokeWidth:t?t.strokeWidth:3,strokeColor:t?t.strokeColor:"#000000"}];e.apply(this,r)}});return t}),define("transect",["baseModel","settings"],function(e,t){var n=e.extend({classname:"Transect",constructor:function(n,r,i,s){this.app=s;var o=[{name:n.name||_.uniqueId("Transect-"),id:_.uniqueId("transect-"),description:n.description||null,wellLeft:r,wellRight:i,settings:new t,width:500,status:"on"}];e.apply(this,o)}});return n.prototype.isXInsideTransect=function(e){return this.get("wellLeft").get("x")<e&&e<this.get("wellRight").get("x")?!0:!1},n.prototype.getAbsoluteX=function(e){var t=this.get("wellLeft").get("x")+(this.get("wellRight").get("x")-this.get("wellLeft").get("x"))*e;return t},n.prototype.getRelativeX=function(e){if(this.get("wellLeft").get("x")<e&&e<this.get("wellRight").get("x")){var t=(e-this.get("wellLeft").get("x"))/(this.get("wellRight").get("x")-this.get("wellLeft").get("x"));return Math.round(t*1e3)/1e3}return null},n.prototype.getPolyKPointsArray=function(){return[this.get("wellLeft").get("x")-2,0,this.get("wellRight").get("x")+2,0,this.get("wellRight").get("x")+2,this.app.Canvas.height,this.get("wellLeft").get("x")-2,this.app.Canvas.height]},n});var transectApp=transectApp||{};define("transects",["baseCollection","transect"],function(e,t){var n=e.extend({classname:"Transects",model:t});return n.prototype.getTransectForX=function(e){var t=null;return this.each(function(n){n.isXInsideTransect(e)&&(t=n)}),t},n.prototype.getTransectInNeighborhoodForX=function(e,t){var n=this.indexOf(t),r=this.at(n-1),i=this.at(n+1);return r&&r.isXInsideTransect(e)?r:i&&i.isXInsideTransect(e)?i:t.isXInsideTransect(e)?t:null},n}),define("transectsView",["baseView","transectView","transects"],function(e,t,n){var r=e.extend({el:"#transects-list",classname:"TransectsView"});return r.prototype.template=new EJS({url:"/commons/ejs/data_tbl.ejs"}),r.prototype.initialize=function(e){this.app=e,this.transects=this.app.TransectsCollection,this.render(),this.listenTo(this.transects,"add",this.addTransect.bind(this)),this.listenTo(this.transects,"reset",this.resetTransect.bind(this))},r.prototype.render=function(){this.$el.html(this.template.render({name:"Transect"})),this.$transectsTable=this.$(".data-list"),this.transects.each(this.addTransect.bind(this))},r.prototype.addTransect=function(e){var n=new t(e);this.$transectsTable.append(n.el)},r.prototype.resetTransect=function(){this.$transectsTable.html(""),this.transects.each(this.addTransect,this),this.app.PointsCollection.updatePoints(),this.app.TransectTextsCollection.updateTransectTexts()},r}),define("transectImage",["baseModel"],function(e){var t=e.extend({classname:"TransectImage",constructor:function(t,n){var r=[{x:"x"in t?t.x:0,y:"y"in t?t.y:0,width:"width"in t?t.width:null,height:"height"in t?t.height:null,origWidth:"origWidth"in t?t.origWidth:null,origHeight:"origHeight"in t?t.origHeight:null,angle:"angle"in t?t.angle:0,preserveAspectRatio:"preserveAspectRatio"in t?t.preserveAspectRatio:!0,visible:"visible"in t?t.visible:!0,data:"data"in t?t.data:null}];e.apply(this,r)}});return t}),define("transectImageView",["baseView","transectImage"],function(e,t){var n=e.extend({el:"#bg-image-settings-list",classname:"TransectImageView",events:{'change input[name="width"]':"updateImageWidth",'change input[name="height"]':"updateImageHeight",'change input[name="preserve-aspect-ratio"]':"updateImage",'change input[name="image-visible"]':"updateImage",'change input[name="angle"]':"updateImage","dragover #image-box":"imageDragover","drop #image-box":"imageDrop"}});return n.prototype.template=new EJS({url:"/transect_maker/ejs/transect_image_settings.ejs"}),n.prototype.initialize=function(e){this.app=e,this.transectImage=this.app.TransectImage,this.listenTo(this.transectImage,"change:data",this.renderData.bind(this)),this.listenTo(this.transectImage,"change:width",this.renderImage.bind(this)),this.listenTo(this.transectImage,"change:height",this.renderImage.bind(this)),this.listenTo(this.transectImage,"change:angle",this.renderImage.bind(this)),this.listenTo(this.transectImage,"change:preserveAspectRatio",this.renderImage.bind(this)),this.render()},n.prototype.render=function(){this.$el.html(this.template.render(this.transectImage.toJSON())),this.$width=this.$('input[name="width"]')[0],this.$height=this.$('input[name="height"]')[0],this.$preserveAspectRatio=this.$('input[name="preserve-aspect-ratio"]')[0],this.$visible=this.$('input[name="image-visible"]')[0],this.$angle=this.$('input[name="angle"]')[0],this.renderData()},n.prototype.renderData=function(){if(this.transectImage.get("data")===null)return;this.element&&this.element.remove(),this.element=this.app.Canvas.image(this.transectImage.get("data")),this.renderImage()},n.prototype.renderImage=function(){this.element===undefined&&(this.element=this.app.Canvas.image(this.transectImage.get("data"))),this.element.toBack(),this.app.transectImageElement=this.element,this.element.attr({x:this.transectImage.get("x"),y:this.transectImage.get("y"),width:this.transectImage.get("width"),height:this.transectImage.get("height"),opacity:this.transectImage.get("visible")?1:0}),(this.transectImage.get("origHeight")==null||this.transectImage.get("origWidth")==null)&&this.transectImage.set({origWidth:this.transectImage.get("width"),origHeight:this.transectImage.get("height")}),this.rotate(this.transectImage.get("angle")),this.updateHtmlElements(),this.resizeCanvas()},n.prototype.updateHtmlElements=function(){if(this.transectImage.get("data")===null)return;this.$width.value=this.transectImage.get("width"),this.$height.value=this.transectImage.get("height"),this.$angle.value=this.transectImage.get("angle")},n.prototype.rotate=function(e){if(this.transectImage.get("data")===null)return;var t="t0,0r"+e;this.element.transform(t)},n.prototype.resizeCanvas=function(){if(this.transectImage.get("data")===null)return;var e=this.element.getBBox(),t="t"+ -e.x+","+ -e.y+"r"+this.transectImage.get("angle");this.element.transform(t);var n=e.height+50;this.app.refCol&&this.app.refCol.Canvas&&(n=Math.max(this.app.refCol.Canvas,n),this.app.refCol.Canvas.setSize(this.app.refCol.Canvas.width,n)),this.app.Canvas.setSize(e.width+50,n)},n.prototype.updateImageWidth=function(){if(this.transectImage.get("data")===null)return;if(this.transectImage.get("preserveAspectRatio")){var e=parseInt(this.$width.value)*this.transectImage.get("origHeight")/this.transectImage.get("origWidth");this.$height.value=e}this.updateImage()},n.prototype.updateImageHeight=function(){if(this.transectImage.get("data")===null)return;if(this.transectImage.get("preserveAspectRatio")){var e=parseInt(this.$height.value)*this.transectImage.get("origWidth")/this.transectImage.get("origHeight");this.$width.value=e}this.updateImage()},n.prototype.updateImage=function(){if(this.transectImage.get("data")===null)return;this.transectImage.set({width:parseInt(this.$width.value),height:parseInt(this.$height.value),angle:parseFloat(this.$angle.value),preserveAspectRatio:this.$preserveAspectRatio.checked,visible:this.$visible.checked})},n.prototype.imageDragover=function(e){var e=e.originalEvent;e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"},n.prototype.imageDrop=function(e){var e=e.originalEvent;e.stopPropagation(),e.preventDefault();var t=e.dataTransfer.files[0];if(t.type==="image/png"||t.type==="image/jpg"||t.type==="image/jpeg"||t.type==="image/gif"){var n=new FileReader;n.onload=this.readImage.bind(this),n.readAsDataURL(t)}},n.prototype.readImage=function(e){var t=this,n=new Image;$(n).load(function(){t.app.TransectImage.set({data:e.target.result,width:n.width,height:n.height})}),n.src=e.target.result},n}),define("transectMarkerView",["baseView"],function(e){var t=e.extend({tagName:"li",classname:"TransectMarkerView",events:{"click .toggle":"toggleMarkerForm","click .marker-data":"toggleMarkerForm","click .destroy":"destroy","keypress :input":"updateMarker","keyup :input":"updateMarker",mouseover:"onMouseOver",mouseout:"onMouseOut"}});return t.prototype.template=new EJS({url:"/transect_maker/ejs/transect_marker.ejs"}),t.prototype.initialize=function(e,t,n){this.app=e,this.transectMarkersView=n,this.transectMarker=t,this.render(),this.listenTo(this.transectMarker,"change:edit",this.editTransectMarker.bind(this)),this.listenTo(this.transectMarker,"change:y",this.renderMarker.bind(this)),this.listenTo(this.transectMarker,"change:age",this.renderMarker.bind(this)),this.listenTo(this.transectMarker,"change:name",this.renderMarker.bind(this)),this.listenTo(this.transectMarker,"change:hover",this.setHoverStatus.bind(this)),this.listenTo(this.transectMarker,"destroy",this.delete.bind(this))},t.prototype.render=function(){this.$el.html(this.template.render(this.transectMarker.toJSON())),this.$toggle=this.$(".toggle"),this.$markerForm=this.$(".marker-form"),this.$markerData=this.$(".marker-data"),this.$markerName=this.$('input[name="marker-name"]')[0],this.$markerAge=this.$('input[name="marker-age"]')[0],this.editTransectMarker(),this.renderMarker()},t.prototype.renderMarker=function(){this.element===undefined&&(this.element=this.app.Canvas.path(),this.element.attr({"stroke-width":2,stroke:"#900000"}),this.element.hover(this.onMouseOver.bind(this),this.onMouseOut.bind(this)),this.element.drag(this.dragMove.bind(this),this.dragStart.bind(this),this.dragEnd.bind(this)),this.element.toFront(),this.app.MarkersSet.push(this.element)),this.renderTooltip(),this.element.attr({path:this.getPath()}),this.app.TransectTextsCollection.updateTransectTexts(),this.resizeCanvas()},t.prototype.resizeCanvas=function(){var e=this.app.Canvas.width,t=Math.max(this.app.Canvas.height,this.transectMarker.get("y")+100);this.app.refCol&&this.app.refCol.Canvas&&(t=Math.max(this.app.refCol.Canvas.height,t),this.app.refCol.Canvas.setSize(this.app.refCol.Canvas.width,t)),this.app.Canvas.setSize(e,t)},t.prototype.renderTooltip=function(){var e=this.transectMarker.get("age")===null?"-":this.transectMarker.get("age");$(this.element.node).qtip({content:{text:this.transectMarker.get("name")+"【"+e+" myr】"},position:{my:"bottom left",target:"mouse"}})},t.prototype.getPath=function(){return"M0,"+this.transectMarker.get("y")+"H"+this.app.Canvas.width},t.prototype.dragStart=function(e,t,n){var r=this.app.TransectMarkersCollection,i=r.indexOf(this.transectMarker);this.prevMarker=r.at(i-1),this.nextMarker=r.at(i+1)},t.prototype.dragMove=function(e,t,n,r,i){if(this.prevMarker&&this.nextMarker&&(this.prevMarker.get("y")+2>i.offsetY||i.offsetY>this.nextMarker.get("y")-2))return;if(!this.prevMarker&&this.nextMarker&&i.offsetY>this.nextMarker.get("y")-2)return;if(this.prevMarker&&!this.nextMarker&&this.prevMarker.get("y")+2>i.offsetY)return;this.transectMarker.set({y:i.offsetY})},t.prototype.dragEnd=function(e){this.app.PointsCollection.updatePoints(),this.app.TransectTextsCollection.updateTransectTexts()},t.prototype.onMouseOver=function(){this.transectMarkersView.undelegateEvents(),this.$el.addClass("hover"),this.transectMarker.set({hover:!0})},t.prototype.onMouseOut=function(){this.transectMarkersView.delegateEvents(),this.$el.removeClass("hover"),this.transectMarker.set({hover:!1})},t.prototype.setHoverStatus=function(){this.transectMarker.get("hover")?(this.element.attr({"stroke-width":5}),this.$el.addClass("hover")):(this.element.attr({"stroke-width":2}),this.$el.removeClass("hover"))},t.prototype.toggleMarkerForm=function(){this.render(),this.transectMarker.set({edit:!this.transectMarker.get("edit")})},t.prototype.editTransectMarker=function(){this.transectMarker.get("edit")?(this.$markerForm.removeClass("hide"),this.$markerData.addClass("hide"),this.$toggle.removeClass("hide-data"),this.$toggle.addClass("show-data")):(this.$markerForm.addClass("hide"),this.$markerData.removeClass("hide"),this.$toggle.removeClass("show-data"),this.$toggle.addClass("hide-data"))},t.prototype.updateMarker=function(e){(e.keyCode==TimescaleApp.ENTER||e.keyCode==TimescaleApp.ESC)&&this.toggleMarkerForm();var t=this.$markerName.value,n=parseFloat(this.$markerAge.value)||0;this.transectMarker.set({name:t,age:n})},t.prototype.delete=function(){this.element!==undefined&&this.element.remove(),this.$el.remove(),this.remove()},t.prototype.destroy=function(){var e=this.app.ZonesCollection.findWhere({topMarker:this.transectMarker}),t=this.app.ZonesCollection.findWhere({baseMarker:this.transectMarker});this.transectMarker.destroy(),e&&e.destroy(),t&&t.destroy()},t}),define("transectMarker",["baseModel"],function(e){var t=e.extend({classname:"TransectMarker",constructor:function(t,n){var r=[{edit:!1,name:t.name||_.uniqueId("Time Line "),y:t.y,age:t.age!==undefined?t.age:null,hover:!1}];e.apply(this,r)}});return t}),define("zone",["baseModel"],function(e){var t=e.extend({classname:"Zone",constructor:function(t,n,r,i){this.app=i;var s=[{edit:!1,name:t.name||_.uniqueId("Zone "),description:t.description||null,topMarker:n,baseMarker:r}];e.apply(this,s)}});return t.prototype.getAbsoluteY=function(e){var t=this.get("topMarker").get("y")+(this.get("baseMarker").get("y")-this.get("topMarker").get("y"))*e;return t},t.prototype.isYInsideZone=function(e){return this.get("topMarker").get("y")<=e&&e<this.get("baseMarker").get("y")?!0:!1},t.prototype.getRelativeY=function(e){if(this.get("topMarker").get("y")<=e&&e<this.get("baseMarker").get("y")){var t=(e-this.get("topMarker").get("y"))/(this.get("baseMarker").get("y")-this.get("topMarker").get("y"));return Math.round(t*1e3)/1e3}return null},t.prototype.getAbsoluteAge=function(e){if(this.get("topMarker").get("y")<=e&&e<this.get("baseMarker").get("y")&&this.get("topMarker").get("age")!=null&&this.get("baseMarker").get("age")!=null){var t=(e-this.get("topMarker").get("y"))/(this.get("baseMarker").get("y")-this.get("topMarker").get("y"));return age=t*(this.get("baseMarker").get("age")-this.get("topMarker").get("age"))+this.get("topMarker").get("age"),Math.round(age*100)/100}return null},t.prototype.getPolyKPointsArray=function(){return[0,this.get("topMarker").get("y"),0,this.get("baseMarker").get("y"),this.app.Canvas.width,this.get("baseMarker").get("y"),this.app.Canvas.width,this.get("topMarker").get("y")]},t}),define("transectMarkersView",["baseView","transectMarkerView","transectMarker","zone"],function(e,t,n,r){var i=e.extend({el:"#markers-list",classname:"TransectMarkersView"});return i.prototype.template=new EJS({url:"../../../commons/ejs/data_tbl.ejs"}),i.prototype.initialize=function(e){this.app=e,this.transectZones=this.app.ZonesCollection,this.transectMarkers=this.app.TransectMarkersCollection,this.enMarkers=!1,this.listenTo(this.transectMarkers,"add",this.addMarker.bind(this)),this.listenTo(this.transectMarkers,"remove",this.render.bind(this)),this.listenToActionEvents(),this.render()},i.prototype.listenToActionEvents=function(){$("#canvas").bind("dblclick",this.createMarker.bind(this))},i.prototype.render=function(){this.$el.html(this.template.render({name:"Markers"})),this.$markersTable=this.$(".data-list"),this.renderMarkers()},i.prototype.renderMarkers=function(){this.transectMarkers.each(this.addMarker.bind(this))},i.prototype.addMarker=function(e){var n=new t(this.app,e,this);this.$markersTable.append(n.el),this.updateZones()},i.prototype.toggleMarkers=function(e){$("a[href='#add-marker']").parent().hasClass("active")?($("a[href='#add-marker']").parent().removeClass("active"),this.enMarkers=!1):($("a[href='#add-marker']").parent().addClass("active"),this.enMarkers=!0)},i.prototype.createMarker=function(e){this.enMarkers&&this.transectMarkers.add(new n({y:e.offsetY}))},i.prototype.updateZones=function(){var e=this,t=[];this.transectMarkers.sort(),this.transectMarkers.each(function(n,i,s){if(i>0){var o=e.transectZones.findWhere({topMarker:s[i-1],baseMarker:n})||new r({name:"New Zone "+i},s[i-1],n,e.app);e.transectZones.add(o),i<e.transectMarkers.length-1&&(o=e.transectZones.findWhere({topMarker:s[i-1],baseMarker:s[i+1]}),o&&t.push(o))}}),_.invoke(t,"destroy")},i}),define("transectWellView",["baseView"],function(e){var t=e.extend({tagName:"li",classname:"TransectWellView",events:{"click .toggle":"toggleWellForm","click .well-data":"toggleWellForm","click .destroy":"destroy","keypress :input":"updateWell","keyup :input":"updateWell",mouseover:"onMouseOver",mouseout:"onMouseOut"}});return t.prototype.template=new EJS({url:"../../../transect_maker/ejs/transect_well.ejs"}),t.prototype.initialize=function(e,t,n){this.app=e,this.transectWell=t,this.transectWellsView=n,this.render(),this.listenTo(this.transectWell,"change:edit",this.editTransectWell.bind(this)),this.listenTo(this.transectWell,"change:x",this.renderWell.bind(this)),this.listenTo(this.transectWell,"change:name",this.renderWell.bind(this)),this.listenTo(this.transectWell,"change:lat",this.renderWell.bind(this)),this.listenTo(this.transectWell,"change:lon",this.renderWell.bind(this)),this.listenTo(this.transectWell,"change:hover",this.setHoverStatus.bind(this)),this.listenTo(this.transectWell,"destroy",this.delete.bind(this))},t.prototype.render=function(){this.$el.html(this.template.render(this.transectWell.toJSON())),this.$toggle=this.$(".toggle"),this.$wellForm=this.$(".well-form"),this.$wellData=this.$(".well-data"),this.$wellName=this.$('input[name="well-name"]')[0],this.$wellLat=this.$('input[name="well-lat"]')[0],this.$wellLon=this.$('input[name="well-lon"]')[0],this.editTransectWell(),this.renderWell()},t.prototype.renderWell=function(){this.element===undefined&&(this.element=this.app.Canvas.path(),this.element.attr({"stroke-width":2,stroke:"#900000"}),this.app.WellsSet.push(this.element),this.element.hover(this.onMouseOver.bind(this),this.onMouseOut.bind(this)),this.element.drag(this.dragMove.bind(this),this.dragStart.bind(this),this.dragEnd.bind(this))),this.renderTooltip(),this.element.attr({path:this.getPath()}),this.resizeCanvas()},t.prototype.resizeCanvas=function(){var e=Math.max(this.app.Canvas.width,this.transectWell.get("x")+100),t=this.app.Canvas.height;this.app.Canvas.setSize(e,t)},t.prototype.renderTooltip=function(){$(this.element.node).qtip({content:{text:this.transectWell.get("name")},position:{my:"left bottom",at:"left middle",target:"mouse"}})},t.prototype.getPath=function(){return"M"+this.transectWell.get("x")+",0"+"V"+this.app.Canvas.height},t.prototype.dragStart=function(e,t,n){var r=this.app.TransectWellsCollection,i=r.indexOf(this.transectWell);this.prevWell=r.at(i-1),this.nextWell=r.at(i+1)},t.prototype.dragMove=function(e,t,n,r,i){if(this.prevWell&&this.nextWell&&(this.prevWell.get("x")+2>i.offsetX||i.offsetX>this.nextWell.get("x")-2))return;if(!this.prevWell&&this.nextWell&&i.offsetX>this.nextWell.get("x")-2)return;if(this.prevWell&&!this.nextWell&&this.prevWell.get("x")+2>i.offsetX)return;this.transectWell.set({x:i.offsetX})},t.prototype.dragEnd=function(e){this.app.PointsCollection.updatePoints(),this.app.TransectTextsCollection.updateTransectTexts()},t.prototype.onMouseOver=function(){this.transectWellsView.undelegateEvents(),this.transectWell.set({hover:!0})},t.prototype.onMouseOut=function(){this.transectWellsView.delegateEvents(),this.transectWell.set({hover:!1})},t.prototype.setHoverStatus=function(){this.transectWell.get("hover")?(this.element.attr({"stroke-width":5}),this.$el.addClass("hover")):(this.element.attr({"stroke-width":2}),this.$el.removeClass("hover"))},t.prototype.toggleWellForm=function(){this.render(),this.transectWell.set({edit:!this.transectWell.get("edit")})},t.prototype.editTransectWell=function(){this.transectWell.get("edit")?(this.$wellForm.removeClass("hide"),this.$wellData.addClass("hide"),this.$toggle.removeClass("hide-data"),this.$toggle.addClass("show-data")):(this.$wellForm.addClass("hide"),this.$wellData.removeClass("hide"),this.$toggle.removeClass("show-data"),this.$toggle.addClass("hide-data"))},t.prototype.updateWell=function(e){(e.keyCode==TimescaleApp.ENTER||e.keyCode==TimescaleApp.ESC)&&this.toggleWellForm();var t=this.$wellName.value,n=parseFloat(this.$wellLat.value),r=parseFloat(this.$wellLon.value);this.transectWell.set({name:t,lat:n,lon:r})},t.prototype.delete=function(){this.element!==undefined&&this.element.remove(),this.$el.remove(),this.remove()},t.prototype.destroy=function(){var e=this.app.TransectsCollection.findWhere({wellLeft:this.transectWell}),t=this.app.TransectsCollection.findWhere({wellRight:this.transectWell});this.transectWell.destroy(),e&&e.destroy(),t&&t.destroy()},t}),define("transectWell",["baseModel","settings"],function(e,t){var n=e.extend({classname:"TransectWell",constructor:function(n,r){var i=[{edit:!1,name:n.name||_.uniqueId("Well "),id:n.id||_.uniqueId("well-"),x:n.x,lat:n.lat||null,lon:n.lon||null,settings:new t,width:100,hover:!1}];e.apply(this,i)}});return n}),define("transectWellsView",["baseView","transectWellView","transectWell","transect"],function(e,t,n,r){var i=e.extend({el:"#wells-list",classname:"TransectWellsView"});return i.prototype.template=new EJS({url:"../../../commons/ejs/data_tbl.ejs"}),i.prototype.initialize=function(e){this.app=e,this.transects=this.app.TransectsCollection,this.transectWells=this.app.TransectWellsCollection,this.enWells=!1,this.render(),this.listenToActionEvents(),this.listenTo(this.transectWells,"add",this.addWell.bind(this))},i.prototype.render=function(){this.$el.html(this.template.render({name:"Reference Wells"})),this.$wellsTable=this.$(".data-list"),this.renderWells()},i.prototype.listenToActionEvents=function(){$("#canvas").bind("dblclick",this.createWell.bind(this))},i.prototype.renderWells=function(){this.transectWells.each(this.addWell.bind(this))},i.prototype.addWell=function(e){var n=new t(this.app,e,this);this.$wellsTable.append(n.el),this.updateTransects()},i.prototype.toggleWells=function(e){$("a[href='#add-well']").parent().hasClass("active")?($("a[href='#add-well']").parent().removeClass("active"),this.enWells=!1):($("a[href='#add-well']").parent().addClass("active"),this.enWells=!0)},i.prototype.createWell=function(e){this.enWells&&this.transectWells.add(new n({x:e.offsetX}))},i.prototype.wellAdded=function(){this.render()},i.prototype.updateTransects=function(){var e=this,t=[];this.transectWells.sort(),this.transectWells.each(function(n,i,s){if(i>0){var o=e.transects.findWhere({wellLeft:s[i-1],wellRight:n})||new r({name:"Transect "+i},s[i-1],n,e.app);e.transects.add(o),i<e.transectWells.length-1&&(o=e.transects.findWhere({wellLeft:s[i-1],wellRight:s[i+1]}),o&&t.push(o))}}),_.invoke(t,"destroy")},i}),define("point",["baseModel"],function(e){var t=e.extend({classname:"Point",constructor:function(t,n){var r=[{edit:!1,name:t.name||_.uniqueId("X"),x:t.x?parseInt(t.x):0,y:t.y?parseInt(t.y):0,age:0,relativeX:null,relativeY:null,transect:null,zone:null,app:n}];e.apply(this,r)}});return t.prototype.initialize=function(e,t){this.updateTransectAndZone()},t.prototype.updateTransectAndZone=function(){var e=this.get("zone")===null?this.get("app").ZonesCollection.getZoneForY(this.get("y")):this.get("app").ZonesCollection.getZoneInNeighborhoodForY(this.get("y"),this.get("zone")),t=this.get("zone")===null?this.get("app").TransectsCollection.getTransectForX(this.get("x")):this.get("app").TransectsCollection.getTransectInNeighborhoodForX(this.get("x"),this.get("transect"));e===null&&(e=this.get("app").ZonesCollection.getZoneForY(this.get("y")-1),e===null?(e=this.get("app").ZonesCollection.getZoneForY(this.get("y")+1),e!==null&&this.set({y:this.get("y")+1})):this.set({y:this.get("y")-1})),t===null&&(t=this.get("app").TransectsCollection.getTransectForX(this.get("x")+1),t===null?(t=this.get("app").TransectsCollection.getTransectForX(this.get("x")-1),t!==null&&this.set({x:this.get("x")-1})):this.set({x:this.get("x")+1})),e!==null&&t!==null&&(this.set({transect:t,zone:e}),this.updateRelativeCoordinates())},t.prototype.updateRelativeCoordinates=function(){this.set({relativeX:this.get("transect").getRelativeX(this.get("x")),relativeY:this.get("zone").getRelativeY(this.get("y")),age:this.get("zone").getAbsoluteAge(this.get("y"))})},t.prototype.toJSON=function(){var e=_.clone(this.attributes);return delete e.transect,delete e.zone,delete e.app,e},t.prototype.toStatusJSON=function(){var e=_.clone(this.attributes);return e},t}),define("polyK",[],function(){var e={};e.IsSimple=function(t){var n=t.length>>1;if(n<4)return!0;var r=new e._P,i=new e._P,s=new e._P,o=new e._P,u=new e._P;for(var a=0;a<n;a++){r.x=t[2*a],r.y=t[2*a+1],a==n-1?(i.x=t[0],i.y=t[1]):(i.x=t[2*a+2],i.y=t[2*a+3]);for(var f=0;f<n;f++){if(Math.abs(a-f)<2)continue;if(f==n-1&&a==0)continue;if(a==n-1&&f==0)continue;s.x=t[2*f],s.y=t[2*f+1],f==n-1?(o.x=t[0],o.y=t[1]):(o.x=t[2*f+2],o.y=t[2*f+3]);if(e._GetLineIntersection(r,i,s,o,u)!=null)return!1}}return!0},e.IsConvex=function(t){if(t.length<6)return!0;var n=t.length-4;for(var r=0;r<n;r+=2)if(!e._convex(t[r],t[r+1],t[r+2],t[r+3],t[r+4],t[r+5]))return!1;return e._convex(t[n],t[n+1],t[n+2],t[n+3],t[0],t[1])?e._convex(t[n+2],t[n+3],t[0],t[1],t[2],t[3])?!0:!1:!1},e.GetArea=function(e){if(e.length<6)return 0;var t=e.length-2,n=0;for(var r=0;r<t;r+=2)n+=(e[r+2]-e[r])*(e[r+1]+e[r+3]);return n+=(e[0]-e[t])*(e[t+1]+e[1]),-n*.5},e.GetAABB=function(e){var t=Infinity,n=Infinity,r=-t,i=-n;for(var s=0;s<e.length;s+=2)t=Math.min(t,e[s]),r=Math.max(r,e[s]),n=Math.min(n,e[s+1]),i=Math.max(i,e[s+1]);return{x:t,y:n,width:r-t,height:i-n}},e.Reverse=function(e){var t=[];for(var n=e.length-2;n>=0;n-=2)t.push(e[n],e[n+1]);return t},e.Triangulate=function(t){var n=t.length>>1;if(n<3)return[];var r=[],i=[];for(var s=0;s<n;s++)i.push(s);var s=0,o=n;while(o>3){var u=i[(s+0)%o],a=i[(s+1)%o],f=i[(s+2)%o],l=t[2*u],c=t[2*u+1],h=t[2*a],p=t[2*a+1],d=t[2*f],v=t[2*f+1],m=!1;if(e._convex(l,c,h,p,d,v)){m=!0;for(var g=0;g<o;g++){var y=i[g];if(y==u||y==a||y==f)continue;if(e._PointInTriangle(t[2*y],t[2*y+1],l,c,h,p,d,v)){m=!1;break}}}if(m)r.push(u,a,f),i.splice((s+1)%o,1),o--,s=0;else if(s++>3*o)break}return r.push(i[0],i[1],i[2]),r},e.ContainsPoint=function(e,t,n){var r=e.length>>1,i,s,o=e[2*r-2]-t,u=e[2*r-1]-n,a=0;for(var f=0;f<r;f++){i=o,s=u,o=e[2*f]-t,u=e[2*f+1]-n;if(s<0&&u<0)continue;if(s>0&&u>0)continue;if(i<0&&o<0)continue;var l=i+(o-i)*-s/(u-s);if(l==0)return!0;l>0&&a++}return(a&1)==1},e.Slice=function(t,n,r,i,s){if(e.ContainsPoint(t,n,r)||e.ContainsPoint(t,i,s))return[t.slice(0)];var o=new e._P(n,r),u=new e._P(i,s),a=[],f=[];for(var l=0;l<t.length;l+=2)f.push(new e._P(t[l],t[l+1]));for(var l=0;l<f.length;l++){var c=new e._P(0,0);c=e._GetLineIntersection(o,u,f[l],f[(l+1)%f.length],c),c&&(c.flag=!0,a.push(c),f.splice(l+1,0,c),l++)}if(a.length==0)return[t.slice(0)];var h=function(t,n){return e._P.dist(o,t)-e._P.dist(o,n)};a.sort(h);var p=[],d=0;while(a.length>0){var v=f.length,m=a[0],g=a[1],y=f.indexOf(m),b=f.indexOf(g),w=!1;e._firstWithFlag(f,y)==b?w=!0:(m=a[1],g=a[0],y=f.indexOf(m),b=f.indexOf(g),e._firstWithFlag(f,y)==b&&(w=!0));if(w){d--;var E=e._getPoints(f,y,b);p.push(E),f=e._getPoints(f,b,y),m.flag=g.flag=!1,a.splice(0,2),a.length==0&&p.push(f)}else d++,a.reverse();if(d>1)break}var S=[];for(var l=0;l<p.length;l++){var x=p[l],T=[];for(var N=0;N<x.length;N++)T.push(x[N].x,x[N].y);S.push(T)}return S},e.Raycast=function(t,n,r,i,s,o){var u=t.length-2,a=e._tp,f=a[0],l=a[1],c=a[2],h=a[3],p=a[4];f.x=n,f.y=r,l.x=n+i,l.y=r+s,o==null&&(o={dist:0,edge:0,norm:{x:0,y:0},refl:{x:0,y:0}}),o.dist=Infinity;for(var d=0;d<u;d+=2){c.x=t[d],c.y=t[d+1],h.x=t[d+2],h.y=t[d+3];var v=e._RayLineIntersection(f,l,c,h,p);v&&e._updateISC(i,s,f,c,h,p,d/2,o)}c.x=h.x,c.y=h.y,h.x=t[0],h.y=t[1];var v=e._RayLineIntersection(f,l,c,h,p);return v&&e._updateISC(i,s,f,c,h,p,t.length/2,o),o.dist!=Infinity?o:null},e.ClosestEdge=function(t,n,r,i){var s=t.length-2,o=e._tp,u=o[0],a=o[2],f=o[3],l=o[4];u.x=n,u.y=r,i==null&&(i={dist:0,edge:0,point:{x:0,y:0},norm:{x:0,y:0}}),i.dist=Infinity;for(var c=0;c<s;c+=2)a.x=t[c],a.y=t[c+1],f.x=t[c+2],f.y=t[c+3],e._pointLineDist(u,a,f,c>>1,i);a.x=f.x,a.y=f.y,f.x=t[0],f.y=t[1],e._pointLineDist(u,a,f,s>>1,i);var h=1/i.dist;return i.norm.x=(n-i.point.x)*h,i.norm.y=(r-i.point.y)*h,i},e._pointLineDist=function(e,t,n,r,i){var s=e.x,o=e.y,u=t.x,a=t.y,f=n.x,l=n.y,c=s-u,h=o-a,p=f-u,d=l-a,v=c*p+h*d,m=p*p+d*d,g=v/m,y,b;g<0||u==f&&a==l?(y=u,b=a):g>1?(y=f,b=l):(y=u+g*p,b=a+g*d);var w=s-y,E=o-b,S=Math.sqrt(w*w+E*E);S<i.dist&&(i.dist=S,i.edge=r,i.point.x=y,i.point.y=b)},e._updateISC=function(t,n,r,i,s,o,u,a){var f=e._P.dist(r,o);if(f<a.dist){var l=1/e._P.dist(i,s),c=-(s.y-i.y)*l,h=(s.x-i.x)*l,p=2*(t*c+n*h);a.dist=f,a.norm.x=c,a.norm.y=h,a.refl.x=-p*c+t,a.refl.y=-p*h+n,a.edge=u}},e._getPoints=function(e,t,n){var r=e.length,i=[];n<t&&(n+=r);for(var s=t;s<=n;s++)i.push(e[s%r]);return i},e._firstWithFlag=function(e,t){var n=e.length;for(;;){t=(t+1)%n;if(e[t].flag)return t}},e._PointInTriangle=function(e,t,n,r,i,s,o,u){var a=o-n,f=u-r,l=i-n,c=s-r,h=e-n,p=t-r,d=a*a+f*f,v=a*l+f*c,m=a*h+f*p,g=l*l+c*c,y=l*h+c*p,b=1/(d*g-v*v),w=(g*m-v*y)*b,E=(d*y-v*m)*b;return w>=0&&E>=0&&w+E<1},e._RayLineIntersection=function(t,n,r,i,s){var o=t.x-n.x,u=r.x-i.x,a=t.y-n.y,f=r.y-i.y,l=o*f-a*u;if(l==0)return null;var c=t.x*n.y-t.y*n.x,h=r.x*i.y-r.y*i.x,p=s,d=1/l;return p.x=(c*u-o*h)*d,p.y=(c*f-a*h)*d,e._InRect(p,r,i)?a>0&&p.y>t.y||a<0&&p.y<t.y?null:o>0&&p.x>t.x||o<0&&p.x<t.x?null:p:null},e._GetLineIntersection=function(t,n,r,i,s){var o=t.x-n.x,u=r.x-i.x,a=t.y-n.y,f=r.y-i.y,l=o*f-a*u;if(l==0)return null;var c=t.x*n.y-t.y*n.x,h=r.x*i.y-r.y*i.x,p=s;return p.x=(c*u-o*h)/l,p.y=(c*f-a*h)/l,e._InRect(p,t,n)&&e._InRect(p,r,i)?p:null},e._InRect=function(e,t,n){return t.x==n.x?e.y>=Math.min(t.y,n.y)&&e.y<=Math.max(t.y,n.y):t.y==n.y?e.x>=Math.min(t.x,n.x)&&e.x<=Math.max(t.x,n.x):e.x>=Math.min(t.x,n.x)&&e.x<=Math.max(t.x,n.x)&&e.y>=Math.min(t.y,n.y)&&e.y<=Math.max(t.y,n.y)?!0:!1},e._convex=function(e,t,n,r,i,s){return(t-r)*(i-n)+(n-e)*(s-r)>=0},e._P=function(e,t){this.x=e,this.y=t,this.flag=!1},e._P.prototype.toString=function(){return"Point ["+this.x+", "+this.y+"]"},e._P.dist=function(e,t){var n=t.x-e.x,r=t.y-e.y;return Math.sqrt(n*n+r*r)},e._tp=[];for(var t=0;t<10;t++)e._tp.push(new e._P(0,0));return e}),define("transectTextView",["baseView","point","polyK"],function(e,t,n){var r=e.extend({tagName:"li",classname:"TransectTextView",events:{"click .toggle":"toggleTextForm","click .text-data":"toggleTextForm","click .destroy":"destroy","keypress :input":"updateText","keyup :input":"updateText",'change select[name="text-font-family"]':"updateText",'change input[name="text-font-size"]':"updateText",'change input[name="text-font-color"]':"updateText",mouseover:"onMouseOver",mouseout:"onMouseOut"}});return r.prototype.template=new EJS({url:"/transect_maker/ejs/transect_text.ejs"}),r.prototype.initialize=function(e,t,n){this.app=e,this.transectTextsView=n,this.transectText=t,this.render(),this.listenTo(this.transectText,"change:x",this.renderTransectText.bind(this)),this.listenTo(this.transectText,"change:y",this.renderTransectText.bind(this)),this.listenTo(this.transectText,"change:edit",this.editTransectText.bind(this)),this.listenTo(this.transectText,"change:text",this.renderTransectText.bind(this)),this.listenTo(this.transectText,"change:age",this.updateTscBBox.bind(this)),this.listenTo(this.transectText,"destroy",this.delete.bind(this)),this.listenTo(this.transectText.get("settings"),"change",this.renderTransectText.bind(this)),this.listenTo(this.app.ZonesCollection,"remove",this.updateText.bind(this)),this.listenTo(this.app.TransectsCollection,"remove",this.updateText.bind(this))},r.prototype.updateText=function(e){if(e!==this.transectText.get("transect")&&e!==this.transectText.get("zone"))return;this.transectText.updateTransectAndZone(),this.render()},r.prototype.render=function(){return this.$el.html(this.template.render(this.transectText.toJSON())),this.$toggle=this.$(".toggle"),this.$textForm=this.$(".text-form"),this.$textData=this.$(".text-data"),this.$textText=this.$("textarea[name*=text-name]")[0],this.$textFontSize=this.$("input[name*=text-font-size]")[0],this.$textFontColor=this.$("input[name*=text-font-color]")[0],this.editTransectText(),this.renderTransectText(),this},r.prototype.renderTransectText=function(){this.set=this.app.Canvas.set();if(this.element===undefined||this.boundingBox===undefined)this.backgroundBox=this.app.Canvas.rect(),this.element=this.app.Canvas.text(),this.boundingBox=this.app.Canvas.rect(),this.set.push(this.backgroundBox),this.set.push(this.element),this.set.push(this.boundingBox),this.app.TextsSet.push(this.set),this.boundingBox.attr({fill:"#f1f1f1","fill-opacity":0,r:"2px"}),this.boundingBox.hover(this.onMouseOver.bind(this),this.onMouseOut.bind(this)),this.boundingBox.drag(this.dragMove.bind(this),this.dragStart.bind(this),this.dragEnd.bind(this));this.element.attr({text:this.transectText.get("text"),x:this.transectText.get("x"),y:this.transectText.get("y"),"font-size":this.transectText.get("settings").get("fontSize"),"font-family":this.transectText.get("settings").get("fontFamily"),fill:this.transectText.get("settings").get("fill")}),this.backgroundBox.attr({fill:this.isWithinBounds()?"#fff":"#ff0000","fill-opacity":1,r:"2px"}),this.backgroundBox.attr({width:this.element.getBBox().width,height:this.element.getBBox().height,x:this.element.getBBox().x,y:this.element.getBBox().y}),this.boundingBox.attr({width:this.element.getBBox().width,height:this.element.getBBox().height,x:this.element.getBBox().x,y:this.element.getBBox().y}),this.updateTscBBox(),this.renderTooltip()},r.prototype.updateTscBBox=function(){var e=this.transectText.get("transect"),t=this.transectText.get("zone"),n=this.element.getBBox(),r=n.x,i=n.y+n.height,s=n.x2,o=n.y2-n.height,r=Math.round(e.getRelativeX(r)*1e3)/10,s=Math.round(e.getRelativeX(s)*1e3)/10,i=Math.round(t.getAbsoluteAge(i)*100)/100,o=Math.round(t.getAbsoluteAge(o)*100)/100;this.transectText.set({bBox:{x1:r,x2:s,y1:i,y2:o}})},r.prototype.renderTooltip=function(){var e=this.transectText.get("text")+"<br/>";e+=this.transectText.get("zone").get("name")+"<br/>",e+=this.transectText.get("transect").get("name")+"<br/>",e+="Font Family: "+this.transectText.get("settings").get("fontFamily")+"<br/>",e+="Font Size: "+this.transectText.get("settings").get("fontSize")+"<br/>",$(this.boundingBox.node).qtip({content:{text:e},position:{my:"top left",target:"mouse"}})},r.prototype.dragStart=function(e,t,n){},r.prototype.dragMove=function(e,t,n,r,i){var s=this.app.TransectsCollection.getTransectForX(i.offsetX),o=this.app.ZonesCollection.getZoneForY(i.offsetY);s!==null&&o!==null&&(this.transectText.set({x:i.offsetX,y:i.offsetY}),this.transectText.updateTransectAndZone())},r.prototype.dragEnd=function(e){},r.prototype.onMouseOver=function(){this.transectTextsView.undelegateEvents(),this.backgroundBox.attr({fill:"#fdcc59"}),this.$el.addClass("hover")},r.prototype.onMouseOut=function(){this.transectTextsView.delegateEvents(),this.backgroundBox.attr({fill:this.isWithinBounds()?"#fff":"#ff0000"}),this.$el.removeClass("hover")},r.prototype.toggleTextForm=function(){this.render(),this.transectText.set({edit:!this.transectText.get("edit")})},r.prototype.editTransectText=function(){this.transectText.get("edit")?(this.$textForm.removeClass("hide"),this.$textData.addClass("hide"),this.$toggle.removeClass("hide-data"),this.$toggle.addClass("show-data")):(this.$textForm.addClass("hide"),this.$textData.removeClass("hide"),this.$toggle.removeClass("show-data"),this.$toggle.addClass("hide-data"))},r.prototype.updateText=function(e){e.keyCode==transectApp.ESC&&this.toggleTextForm();var t=this.$textText.value;this.transectText.set({text:t});var n=this.$("select[name='text-font-family'] option:selected").val();this.transectText.get("settings").set({fontSize:this.$textFontSize.value,fill:this.$textFontColor.value,fontFamily:n})},r.prototype.isWithinBounds=function(){var e=this.transectText.get("transect").getPolyKPointsArray(),t=this.transectText.get("zone").getPolyKPointsArray(),r=this.element.getBBox();return n.ContainsPoint(e,r.x,r.y)&&n.ContainsPoint(e,r.x2,r.y2)&&n.ContainsPoint(t,r.x,r.y)&&n.ContainsPoint(t,r.x2,r.y2)},r.prototype.delete=function(){this.backgroundBox!==undefined&&this.backgroundBox.remove(),this.element!==undefined&&this.element.remove(),this.boundingBox!==undefined&&this.boundingBox.remove(),this.set!==undefined&&this.set.remove(),this.$el.remove(),this.remove()},r.prototype.destroy=function(){this.transectText.destroy()},r}),define("transectText",["baseModel","settings"],function(e,t){var n=e.extend({classname:"TransectText",constructor:function(n,r){var i=new t,s=[{edit:!1,text:n.text||_.uniqueId("Text "),x:n.x?parseInt(n.x):0,y:n.y?parseInt(n.y):0,age:0,transect:null,zone:null,settings:i,bBox:null,app:r}];e.apply(this,s)}});return n.prototype.initialize=function(){this.updateTransectAndZone()},n.prototype.updateTransectAndZone=function(){var e=this.get("zone")===null?this.get("app").ZonesCollection.getZoneForY(this.get("y")):this.get("app").ZonesCollection.getZoneInNeighborhoodForY(this.get("y"),this.get("zone")),t=this.get("zone")===null?this.get("app").TransectsCollection.getTransectForX(this.get("x")):this.get("app").TransectsCollection.getTransectInNeighborhoodForX(this.get("x"),this.get("transect"));e!==null&&t!==null&&(this.set({transect:t,zone:e}),this.updateRelativeCoordinates())},n.prototype.updateRelativeCoordinates=function(e){this.set({relativeX:this.get("transect").getRelativeX(this.get("x")),relativeY:this.get("zone").getRelativeY(this.get("y")),age:this.get("zone").getAbsoluteAge(this.get("y"))})},n.prototype.toJSON=function(){var e=_.clone(this.attributes);return delete e.transect,delete e.zone,delete e.app,e},n}),define("transectTextsView",["baseView","transectTextView","transectText"],function(e,t,n){var r=e.extend({el:"#texts-list",classname:"TransectTextsView"});return r.prototype.template=new EJS({url:"../../../commons/ejs/data_tbl.ejs"}),r.prototype.initialize=function(e){this.app=e,this.transectTexts=this.app.TransectTextsCollection,this.enTransectTexts=!1,this.render(),this.listenToActionEvents(),this.listenTo(this.transectTexts,"add",this.addTransectText.bind(this))},r.prototype.render=function(){this.$el.html(this.template.render({name:"Transect Texts"})),this.$textsList=this.$(".data-list"),this.renderTransectTexts()},r.prototype.renderTransectTexts=function(){this.set==undefined&&(this.set=this.app.Canvas.set()),this.transectTexts.each(this.addTransectText.bind(this))},r.prototype.listenToActionEvents=function(){$("#canvas").bind("dblclick",this.createTransectText.bind(this))},r.prototype.addTransectText=function(e){var n=new t(this.app,e,this);this.$textsList.append(n.el),this.set.push(n.element)},r.prototype.createTransectText=function(e){if(this.enTransectTexts){var t=this.transectTexts.findWhere({x:e.offsetX,y:e.offsetY})||new n({x:e.offsetX,y:e.offsetY},this.app);if(t.get("transect")===null||t.get("zone")===null){t.destroy();return}this.transectTexts.add(t)}},r.prototype.toggleTransectTexts=function(){$("a[href='#add-transect-text']").parent().hasClass("active")?($("a[href='#add-transect-text']").parent().removeClass("active"),this.enTransectTexts=!1):($("a[href='#add-transect-text']").parent().addClass("active"),this.enTransectTexts=!0)},r}),define("zoneView",["baseView"],function(e){var t=e.extend({tagName:"li",classname:"ZoneView",events:{"click .toggle":"toggleZoneForm","click .zone-data":"toggleZoneForm","keypress :input":"updateZone","keyup :input":"updateZone",mouseover:"onMouseOver",mouseout:"onMouseOut"}});return t.prototype.template=new EJS({url:"../../../transect_maker/ejs/zone.ejs"}),t.prototype.initialize=function(e){this.zone=e,this.listenTo(this.zone,"change:edit",this.toggleEditStatus.bind(this)),this.listenTo(this.zone,"change:name",this.render.bind(this)),this.listenTo(this.zone,"change:description",this.render.bind(this)),this.listenTo(this.zone,"destroy",this.delete.bind(this)),this.render()},t.prototype.render=function(){this.$el.html(this.template.render(this.zone.toJSON())),this.$toggle=this.$(".toggle"),this.$zoneForm=this.$(".zone-form"),this.$zoneData=this.$(".zone-data"),this.$zoneName=this.$('input[name="zone-name"]')[0],this.$zoneDescription=this.$('textarea[name="zone-description"]')[0]},t.prototype.toggleZoneForm=function(){this.render(),this.zone.set({edit:!this.zone.get("edit")})},t.prototype.toggleEditStatus=function(){this.zone.get("edit")?(this.$zoneForm.removeClass("hide"),this.$zoneData.addClass("hide"),this.$toggle.removeClass("hide-data"),this.$toggle.addClass("show-data")):(this.$zoneForm.addClass("hide"),this.$zoneData.removeClass("hide"),this.$toggle.removeClass("show-data"),this.$toggle.addClass("hide-data"))},t.prototype.onMouseOver=function(){this.$el.addClass("hover"),this.zone.get("topMarker").set({hover:!0}),this.zone.get("baseMarker").set({hover:!0})},t.prototype.onMouseOut=function(){this.$el.removeClass("hover"),this.zone.get("topMarker").set({hover:!1}),this.zone.get("baseMarker").set({hover:!1})},t.prototype.updateZone=function(e){if(e.keyCode==transectApp.ENTER||e.keyCode==transectApp.ESC){var t=this.$zoneName.value,n=this.$zoneDescription.value;this.zone.set({name:t,description:n}),this.toggleZoneForm()}},t.prototype.delete=function(){this.element!==undefined&&this.element.remove(),this.$el.remove(),this.remove()},t.prototype.destroy=function(){this.zone.destroy()},t}),define("zonesView",["baseView","zoneView","zone"],function(e,t,n){var r=e.extend({el:"#zones-list",classname:"ZonesView"});return r.prototype.template=new EJS({url:"../../../commons/ejs/data_tbl.ejs"}),r.prototype.initialize=function(e){this.app=e,this.zones=this.app.ZonesCollection,this.render(),this.listenTo(this.zones,"add",this.render.bind(this)),this.listenTo(this.zones,"reset",this.resetZones.bind(this))},r.prototype.render=function(){this.$el.html(this.template.render({name:"Zones"})),this.$zonesTable=this.$(".data-list"),this.zones.each(this.addZone.bind(this))},r.prototype.addZone=function(e){var n=new t(e);this.$zonesTable.append(n.el)},r.prototype.resetZones=function(){this.$zonesTable.html(""),this.zones.each(this.addZone,this),this.app.PointsCollection.updatePoints(),this.app.TransectTextsCollection.updateTransectTexts()},r}),define("pointView",["baseView"],function(e){var t=e.extend({tagName:"li",classname:"PointView",events:{'change input[name="relative-y"]':"updatePoint",'change input[name="relative-x"]':"updatePoint","click .point-data":"togglePointForm","click .arrow":"togglePointForm",mouseover:"onMouseOver",mouseout:"onMouseOut"}});return t.prototype.template=new EJS({url:"/transect_maker/ejs/point.ejs"}),t.prototype.statusBoxTemplate=new EJS({url:"/transect_maker/ejs/status_box.ejs"}),t.prototype.initialize=function(e,t){this.app=e,this.point=t,this.render(),this.listenTo(this.point,"destroy",this.removeElement.bind(this)),this.listenTo(this.point,"change:age",this.render.bind(this)),this.listenTo(this.point,"change:edit",this.toggleEditStatus.bind(this)),this.listenTo(this.point,"change:x",this.renderPoint.bind(this)),this.listenTo(this.point,"change:y",this.renderPoint.bind(this)),this.listenTo(this.app.ZonesCollection,"remove",this.updatePoint.bind(this)),this.listenTo(this.app.TransectsCollection,"remove",this.updatePoint.bind(this))},t.prototype.updatePoint=function(e){if(e!==this.point.get("transect")&&e!==this.point.get("zone"))return;this.point.updateTransectAndZone(),this.render(),this.toggleEditStatus()},t.prototype.render=function(){this.$el.html(this.template.render(this.point.toJSON())),this.$toggle=this.$(".toggle"),this.$pointForm=this.$(".point-form"),this.$pointData=this.$(".point-data"),this.$pointName=this.$('input[name="point-name"]'),this.$pointAge=this.$('input[name="point-age"]'),this.$pointRelativeX=this.$('input[name="relative-x"]'),this.$pointRelativeY=this.$('input[name="relative-y"]'),this.renderPoint()},t.prototype.renderPoint=function(){this.element===undefined&&(this.element=this.app.Canvas.circle(this.point.get("x"),this.point.get("y"),4),this.app.PointsSet.push(this.element),this.element.hover(this.onMouseOver.bind(this),this.onMouseOut.bind(this)),this.element.click(this.onClick.bind(this)),this.element.drag(this.onDragMove.bind(this),this.onDragStart.bind(this),this.onDragEnd.bind(this)),this.element.attr({fill:"#000000"})),this.renderTooltip(),this.updateStatusBox(),this.updateElement(),this.point.updateTransectAndZone()},t.prototype.renderTooltip=function(){var e=this.point.get("name")+"<br/>";this.point.get("zone")&&(e+=this.point.get("zone").get("name")+"<br/>"),this.point.get("transect")&&(e+=this.point.get("transect").get("name")),$(this.element.node).qtip({content:{text:e},position:{my:"bottom left",target:"mouse"}})},t.prototype.updateElement=function(){this.element.attr({cx:this.point.get("x"),cy:this.point.get("y")}),this.renderTooltip(),this.updateStatusBox()},t.prototype.updateStatusBox=function(){this.app.StatusBox.html(this.statusBoxTemplate.render(this.point.toStatusJSON()))},t.prototype.setFinishedMode=function(){this.element.attr({r:4,fill:"#000000",stroke:"#000000"}),this.$el.removeClass("hover")},t.prototype.setEditMode=function(){this.element.attr({r:8,fill:"#FF0033",stroke:"#FF0033"}),this.$el.addClass("hover")},t.prototype.onMouseOver=function(){this.app.supressDoubleClick=!0,this.updateStatusBox(),this.setEditMode()},t.prototype.onMouseOut=function(){this.app.supressDoubleClick=!1,this.setFinishedMode()},t.prototype.onClick=function(){this.app.CurrentPolygon!==null&&this.app.CurrentPolygon.get("draw")&&this.app.CurrentPolygon.get("points").add(this.point)},t.prototype.onDblClick=function(e){},t.prototype.removeElement=function(){this.element.remove()},t.prototype.onDragStart=function(e,t,n){},t.prototype.onDragMove=function(e,t,n,r,i){var s=i.offsetX,o=i.offsetY;this.app.Cursor.get("lockH")&&(o=this.point.get("y")),this.app.Cursor.get("lockV")&&(s=this.point.get("x")),this.point.set({x:s,y:o}),this.point.updateTransectAndZone(),this.zone=this.point.get("zone")},t.prototype.onDragEnd=function(e){var t=this.app.TransectsCollection.getTransectForX(e.offsetX),n=this.app.ZonesCollection.getZoneForY(e.offsetY),r=this.point.get("x"),i=this.point.get("y");if(t===null){t=this.point.get("transect");var s=t.get("wellRight").get("x");r>s&&(r=s-1);var s=t.get("wellLeft").get("x");r<s&&(r=s+1)}if(n===null){n=this.point.get("zone");var o=n.get("baseMarker").get("y");i>o&&(i=o-1);var o=n.get("topMarker").get("y");i<o&&(i=o+1)}this.point.set({x:r,y:i}),this.point.updateTransectAndZone()},t.prototype.togglePointForm=function(){this.render(),this.point.set({edit:!this.point.get("edit")})},t.prototype.toggleEditStatus=function(){this.point.get("edit")?(this.$pointForm.removeClass("hide"),this.$pointData.addClass("hide"),this.$toggle.removeClass("hide-data"),this.$toggle.addClass("show-data"),this.setEditMode()):(this.$pointForm.addClass("hide"),this.$toggle.removeClass("show-data"),this.$pointData.removeClass("hide"),this.$toggle.addClass("hide-data"),this.setFinishedMode())},t.prototype.updatePoint=function(e){(e.keyCode==TimescaleApp.ENTER||e.keyCode==TimescaleApp.ESC)&&this.togglePolygonForm();var t=this.$pointRelativeX.val()*1/100,n=(100-this.$pointRelativeY.val()*1)/100,r=this.point.get("transect").getAbsoluteX(t),i=this.point.get("zone").getAbsoluteY(n);this.point.set({x:r,y:i})},t}),define("lineView",["baseView"],function(e){var t=e.extend({tagName:"li",classname:"LineView",events:{"click .line-name":"toggleLineForm","click .line-data":"toggleLineForm","keypress :input":"updateLine","keyup :input":"updateLine",mouseover:"onMouseOver",mouseout:"onMouseOut"}});return t.prototype.template=new EJS({url:"../../../transect_maker/ejs/line.ejs"}),t.prototype.initialize=function(e,t){this.app=e,this.line=t,this.listenTo(this.line,"destroy",this.removeElement.bind(this)),this.listenTo(this.line,"change:edit",this.toggleEditStatus.bind(this)),this.listenTo(this.line,"change:name",this.renderLine.bind(this)),this.listenTo(this.line.get("point1"),"change",this.renderLine.bind(this)),this.listenTo(this.line.get("point2"),"change",this.renderLine.bind(this)),this.listenTo(this.line,"change:pattern",this.render.bind(this)),this.render()},t.prototype.render=function(){this.$el.html(this.template.render(this.line.toJSON())),this.$toggle=this.$(".toggle"),this.$lineForm=this.$(".line-form"),this.$lineData=this.$(".line-data"),this.$lineName=this.$('input[name="line-name"]')[0],this.$linePattern=this.$("select.line-pattern"),this.$linePattern.change(this.updateLine.bind(this)),this.renderLine()},t.prototype.renderLine=function(){this.element===undefined&&(this.element=this.app.Canvas.path(),this.app.LinesSet.push(this.element));var e="M"+this.line.get("point1").get("x")+","+this.line.get("point1").get("y");e+=this.line.getPath(),this.element.attr({path:e}),this.element.hover(this.onMouseOver.bind(this),this.onMouseOut.bind(this)),this.setFinishedMode(),this.renderTooltip()},t.prototype.renderTooltip=function(){var e=this.line.get("name");$(this.element.node).qtip({content:{text:e},position:{my:"bottom left",target:"mouse"}})},t.prototype.onMouseOut=function(){this.setFinishedMode()},t.prototype.onMouseOver=function(){this.setEditMode()},t.prototype.removeElement=function(){this.remove(),this.element.remove()},t.prototype.toggleLineForm=function(){this.render(),this.line.set({edit:!this.line.get("edit")})},t.prototype.toggleEditStatus=function(){this.line.get("edit")?(this.$lineForm.removeClass("hide"),this.$lineData.addClass("hide"),this.$toggle.removeClass("hide-data"),this.$toggle.addClass("show-data")):(this.$lineForm.addClass("hide"),this.$lineData.removeClass("hide"),this.$toggle.removeClass("show-data"),this.$toggle.addClass("hide-data"))},t.prototype.setFinishedMode=function(){this.element.attr({"stroke-width":2,stroke:transectApp.lineMouseOut,fill:"none"}),this.$el.removeClass("hover")},t.prototype.setEditMode=function(){this.element.attr({"stroke-width":6,stroke:transectApp.lineMouseOver,fill:"none"}),this.$el.addClass("hover")},t.prototype.updateLine=function(e){var t=this.$("select.line-pattern option:selected").val();this.line.set({pattern:t})},t}),define("points",["baseCollection","point"],function(e,t){var n=e.extend({classname:"Points",model:t});return n.prototype.updatePoints=function(){return this.each(function(e){e.updateTransectAndZone()}),!0},n.prototype.add=function(t){if(t===undefined)return;var n=this.any(function(e){return e.get("x")==t.x&&e.get("y")==t.y});n||e.prototype.add.call(this,t)},n.prototype.getPolyKPointsArray=function(){var e=[];return this.each(function(t){e.push(t.get("x")),e.push(t.get("y"))}),e},n}),define("lines",["baseCollection","line"],function(e,t){var n=e.extend({classname:"Lines",model:t});return n.prototype.findLineForPoints=function(e){var t=transectApp.PointsCollection.findWhere({x:e.x1,y:e.y1}),n=transectApp.PointsCollection.findWhere({x:e.x2,y:e.y2});return this.findWhere({point1:t,point2:n})},n}),define("polygon",["baseModel","points","lines","polyK"],function(e,t,n,r){var i=e.extend({classname:"Polygon",constructor:function(r,i){var s=[{id:_.uniqueId("polygon_"),hover:!1,edit:!1,draw:!1,toFront:!1,name:r&&r.name?r.name:_.uniqueId("Polygon "),patternName:r?r.patternName:null,points:new t,lines:new n,description:r!==undefined&&r.description?r.description:null}];e.apply(this,s)}});return i.prototype.getPolyKPointsArray=function(){var e=[];return this.get("points").each(function(t){e.push(t.get("x")),e.push(t.get("y"))}),e},i.prototype.isSimple=function(){var e=this.getPolyKPointsArray();return r.IsSimple(e)},i.prototype.toJSON=function(){var e=_.clone(this.attributes);return delete e.lines,e},i}),define("polygons",["baseCollection","polygon"],function(e,t){var n=e.extend({classname:"Polygons",model:t,comparator:function(e){var t=e.get("points"),n=Infinity;return t.each(function(e){e.get("y")<=n&&(n=e.get("y"))}),n}});return n}),define("line",["baseModel","transects","polygons","polyK"],function(e,t,n,r){var i=e.extend({classname:"Line",constructor:function(r,i,s){var o=[{edit:!1,name:r.name||_.uniqueId("Line "),pattern:"default",point1:i,point2:s,transects:new t,polygons:new n}];e.apply(this,o)}});return i.prototype.jaggedDistance=10,i.prototype.waveHeight=5,i.prototype.getPatternPoints=function(){var e=numeric.linspace(this.point1.get("x"),this.point2.get("x"),steps),t=numeric.linspace(this.point1.get("y"),this.point2.get("y"),steps)},i.prototype.getPolyKPointsArray=function(){var e=[];return e.push(this.get("point1").get("x")),e.push(this.get("point1").get("y")),e.push(this.get("point2").get("x")),e.push(this.get("point2").get("y")),e},i.prototype.slope=function(){var e=(this.get("point1").get("y")-this.get("point2").get("y"))/(this.get("point1").get("x")-this.get("point2").get("x"));return e},i.prototype.coincides=function(e){var t=e.getPolyKPointsArray(),n=this.getPolyKPointsArray(),i=[],s=3;return i.push(this.pointAtADistanceFromXY(n[0],n[1],s)),i.push(this.pointAtADistanceFromXY(n[0],n[1],-s)),i.push(this.pointAtADistanceFromXY(n[2],n[3],-s)),i.push(this.pointAtADistanceFromXY(n[2],n[3],s)),i=_.flatten(i),r.ContainsPoint(i,t[0],t[1])&&r.ContainsPoint(i,t[2],t[3])?!0:!1},i.prototype.getPath=function(){return this.getPathFromPattern(this.get("pattern"))},i.prototype.getPathFromPattern=function(e){switch(e){case"default":return this.getStraightPath();case"jagged":return this.getJaggedPath();case"wavy":return this.getWavyPath();case"lapping":return this.getJaggedPath()}},i.prototype.getStraightPath=function(){var e=",L"+this.get("point2").get("x")+","+this.get("point2").get("y");return e},i.prototype.getJaggedPath=function(){var e=this.get("point1").get("y")-this.get("point2").get("y"),t=this.get("point1").get("x")-this.get("point2").get("x"),n=e/t,r=Math.round(Math.abs(this.get("point1").get("y")-this.get("point2").get("y"))/10),i=numeric.linspace(this.get("point1").get("x"),this.get("point2").get("x"),r),s=numeric.linspace(this.get("point1").get("y"),this.get("point2").get("y"),r),o="";if(i.length==0)return this.getStraightPath();for(var u=0;u<i.length;u++)u!=0&&(e>0&&n>0||e<0&&n<0?(o+=",L"+(i[u-1]+this.jaggedDistance)+","+s[u-1],o+=",L"+(i[u]-this.jaggedDistance)+","+s[u],u<i.length-1?o+=",L"+(i[u]+this.jaggedDistance)+","+s[u]:o+=",L"+i[u]+","+s[u]):(o+=",L"+(i[u-1]-this.jaggedDistance)+","+s[u-1],o+=",L"+(i[u]+this.jaggedDistance)+","+s[u],u<i.length-1?o+=",L"+(i[u]-this.jaggedDistance)+","+s[u]:o+=",L"+i[u]+","+s[u]));return o},i.prototype.getWavyPath=function(){var e=Math.round(Math.abs(this.get("point1").get("y")-this.get("point2").get("y"))/3),t=Math.round(Math.abs(this.get("point1").get("x")-this.get("point2").get("x"))/3),n=Math.max(t,e),r=numeric.linspace(this.get("point1").get("x"),this.get("point2").get("x"),n),i=numeric.linspace(this.get("point1").get("y"),this.get("point2").get("y"),n),s="";if(n==0)return this.getStraightPath();for(var o=0;o<n;o++){var u=r.length>0?r[o]:this.get("point1").get("x"),a=i.length>0?i[o]:this.get("point1").get("y");o!=0&&(o%2==1?(o%4==3?plPoint=this.pointAtADistanceFromXY(u,a,-this.waveHeight):plPoint=this.pointAtADistanceFromXY(u,a,this.waveHeight),s+=",S"+plPoint[0]+","+plPoint[1]):s+=","+u+","+a)}return s+=",L"+this.get("point2").get("x")+","+this.get("point2").get("y"),s},i.prototype.pointAtADistanceFromXY=function(e,t,n){var r=(this.get("point1").get("x")-this.get("point2").get("x"))/(this.get("point2").get("y")-this.get("point1").get("y")),i,s;return r===Infinity||r===-Infinity?(i=e,s=t+n):(i=e+n/Math.sqrt(1+r*r),s=t+r*(i-e)),[i,s]},i}),define("polygonView",["baseView","pointView","lineView","point","points","line","lines","polyK"],function(e,t,n,r,i,s,o,u){var a=e.extend({tagName:"li",classname:"PolygonView",events:{"click .toggle":"togglePolygonForm","click .toggle-polygon":"togglePolygonForm","click .polygon-data":"togglePolygonForm","click a.polygon-list-tool":"showList","click .destroy":"destroy","click .to-front":"toFront","keypress :input":"updatePolygon","keyup :input":"updatePolygon","click label.polygon-line-data":"showPolygonLinesList","click label.polygon-point-data":"showPolygonPointsList","click label.polygon-pattern-data":"showPolygonPatternsList",mouseover:"onMouseOver",mouseout:"onMouseOut"}});return a.prototype.template=new EJS({url:"/transect_maker/ejs/polygon.ejs"}),a.prototype.initialize=function(e,t){this.app=e,this.polygon=t,this.pointsSet=this.app.Canvas.set(),this.linesSet=this.app.Canvas.set(),this.render(),this.listenToActionEvents(),this.listenTo(this.polygon,"change:edit",this.toggleEditStatus.bind(this)),this.listenTo(this.polygon,"change:draw",this.setRenderMode.bind(this)),this.listenTo(this.polygon,"change:name",this.updatePolygonView.bind(this)),this.listenTo(this.polygon,"change:description",this.updatePolygonView.bind(this)),this.listenTo(this.polygon,"change:patternName",this.updatePolygonView.bind(this)),this.listenTo(this.polygon.get("points"),"change",this.renderPolygonElement.bind(this)),this.listenTo(this.polygon.get("lines"),"change",this.renderPolygonElement.bind(this)),this.listenTo(this.polygon.get("points"),"add",this.addPointToPolygon.bind(this)),this.listenTo(this.polygon.get("points"),"reset",this.resetPolygonPoints.bind(this)),this.listenTo(this.polygon.get("lines"),"add",this.addLineToPolygon.bind(this)),this.listenTo(this.polygon.get("lines"),"reset",this.resetPolygonLines.bind(this)),this.listenTo(this.polygon.get("lines"),"remove",this.updatePolygonLines.bind(this)),this.listenTo(this.polygon,"destroy",this.delete.bind(this))},a.prototype.updatePolygonLines=function(){},a.prototype.updatePolygonView=function(e){this.$polygonData.html(this.polygon.get("name")+" → "+this.polygon.get("patternName")),this.renderPolygonElement(),this.setPolygonFill(),this.toggleEditStatus()},a.prototype.render=function(){this.$el.html(this.template.render(this.polygon.toJSON())),this.$togglePolygon=this.$(".toggle-polygon"),this.$polygonForm=this.$(".polygon-form"),this.$polygonData=this.$(".polygon-data"),this.$polygonName=this.$('input[name="polygon-name"]')[0],this.$polygonDescription=this.$('textarea[name="polygon-description"]')[0],this.$linesList=this.$(".lines-list"),this.$pointsList=this.$(".points-list"),this.$patternsList=this.$(".patterns-list"),this.$polygonPattern=this.$("select.polygon-pattern"),this.$patternImage=this.$(".patterns-image"),this.$polygonPattern.change(this.updatePolygonPattern.bind(this)),this.renderPoints()},a.prototype.renderPoints=function(){this.polygon.get("points").each(this.addPoint.bind(this))},a.prototype.showPolygonLinesList=function(){this.$linesList.hasClass("hide")?this.$linesList.removeClass("hide"):this.$linesList.addClass("hide")},a.prototype.showPolygonPointsList=function(){this.$pointsList.hasClass("hide")?this.$pointsList.removeClass("hide"):this.$pointsList.addClass("hide")},a.prototype.showPolygonPatternsList=function(){this.$patternsList.hasClass("hide")?this.$patternsList.removeClass("hide"):this.$patternsList.addClass("hide")},a.prototype.updatePolygonPattern=function(){var e=this.$("select.polygon-pattern option:selected").val();this.polygon.set({patternName:e})},a.prototype.listenToActionEvents=function(){$("#canvas").bind("dblclick",this.addPoint.bind(this))},a.prototype.addPointToPolygon=function(e){var n=new t(this.app,e);this.$pointsList.append(n.el),this.pointsSet.push(n.element),this.polygon.get("points").length>1&&this.resetLines(),this.app.PointsCollection.add(e),this.updateCanvasDimensions(e)},a.prototype.isSimple=function(e){var t=this.polygon.getPolyKPointsArray();return u.IsSimple(t)},a.prototype.updateCanvasDimensions=function(e){this.app.Canvas.setSize(Math.max(this.app.Canvas.width,e.get("x")),Math.max(this.app.Canvas.height,e.get("y")+100))},a.prototype.resetLines=function(){var e=[],t=this.polygon.get("points").at(this.polygon.get("points").length-2),n=this.polygon.get("points").first(),r=this.app.LinesCollection.findWhere({point1:t,point2:n})||this.app.LinesCollection.findWhere({point1:n,point2:t});r!==undefined&&r.get("polygons").length<2&&r.destroy(),t=this.polygon.get("points").at(this.polygon.get("points").length-2),n=this.polygon.get("points").last();var i=this.app.LinesCollection.findWhere({point1:t,point2:n})||this.app.LinesCollection.findWhere({point1:n,point2:t})||new s({},t,n);i.get("polygons").add(this.polygon),t=this.polygon.get("points").last(),n=this.polygon.get("points").first();var o=this.app.LinesCollection.findWhere({point1:t,point2:n})||this.app.LinesCollection.findWhere({point1:n,point2:t})||new s({},t,n);o.get("polygons").add(this.polygon),this.polygon.get("lines").add([i,o]),this.renderPolygonElement(),this.setRenderFill(),this.bringToFront()},a.prototype.bringToFront=function(){this.app.PolygonsSet.toFront(),this.element.toFront(),this.app.MarkersSet.toFront(),this.app.WellsSet.toFront(),this.app.LinesSet.toFront(),this.app.PointsSet.toFront(),this.app.TextsSet.toFront()},a.prototype.addLineToPolygon=function(e){this.app.LinesCollection.add(e);var t=new n(this.app,e);this.linesSet.push(t.element),this.$linesList.append(t.el)},a.prototype.resetPolygonLines=function(){this.polygon.get("lines").each(this.addLineToPolygon,this)},a.prototype.resetPolygonPoints=function(){this.polygon.get("points").each(this.addPointToPolygon,this)},a.prototype.addPoint=function(e){if(this.app.supressDoubleClick)return;if(!this.polygon.get("draw"))return;var t=e.offsetX,n=e.offsetY;this.polygon.get("points").length>0&&this.app.Cursor.get("lockH")&&(n=this.polygon.get("points").last().get("y")),this.polygon.get("points").length>0&&this.app.Cursor.get("lockV")&&(t=this.polygon.get("points").last().get("x"));var i=this.app.PointsCollection.findWhere({x:t,y:n})||new r({x:t,y:n},this.app);if(i.get("transect")===null||i.get("zone")===null){i.destroy();return}this.polygon.get("points").add(i)},a.prototype.setRenderFill=function(){if(this.element===undefined)return;this.element.attr({opacity:.5,stroke:0,fill:TimescaleApp.renderFill})},a.prototype.setRenderErrorFill=function(){if(this.element===undefined)return;this.element.attr({opacity:.5,stroke:0,fill:"#FF0000"})},a.prototype.setPolygonFill=function(){if(this.element===undefined)return;var e=this.polygon.get("patternName"),t=e?"url('/pattern_manager/patterns/"+tscApp.PATTERNS[e]+"')":TimescaleApp.polygonFill;this.element.attr({opacity:.5,stroke:0,fill:t});var n=t+" no-repeat";this.$patternImage.css("background",n)},a.prototype.toggleEditStatus=function(){if(this.element===undefined)return;this.polygon.get("edit")?(this.$polygonForm.removeClass("hide"),this.$polygonData.addClass("hide"),this.$togglePolygon.removeClass("hide-data"),this.$togglePolygon.addClass("show-data")):(this.$polygonForm.addClass("hide"),this.$polygonData.removeClass("hide"),this.$togglePolygon.removeClass("show-data"),this.$togglePolygon.addClass("hide-data"))},a.prototype.getConvexHull=function(){var e=[],t=this.polygon.get("points").toArray();t.sort(sortPointX),t.sort(sortPointY);var n=chainHull_2D(t,t.length,e);_.invoke(this.polygon.get("points").toArray(),"destroy"),this.polygon.get("points").reset(e)},a.prototype.getPath=function(){var e="M",t=this;return this.polygon.get("points").each(function(n,r,i){if(r==0)e+=n.get("x")+","+n.get("y");else{var o=t.polygon.get("lines").findWhere({point1:i[r-1],point2:n});if(o!==undefined)e+=o.getPath();else{o=t.polygon.get("lines").findWhere({point1:n,point2:i[r-1]});if(o!==undefined){var u=new s({},i[r-1],n);e+=u.getPathFromPattern(o.get("pattern")),u.destroy()}}if(r>0&&r===i.length-1){o=t.polygon.get("lines").findWhere({point1:n,point2:i[0]});if(o!==undefined)e+=o.getPath();else{o=t.polygon.get("lines").findWhere({point1:i[0],point2:n});if(o!==undefined){var u=new s({},n,i[0]);e+=u.getStraightPath(),u.destroy()}}}}}),e},a.prototype.renderPolygonElement=function(){this.element!==undefined&&this.element.remove(),this.element=this.app.Canvas.path(this.getPath()),this.element.hover(this.onMouseOver.bind(this),this.onMouseOut.bind(this)),this.app.PolygonsSet.push(this.element),this.renderTooltip(),this.setRenderMode(),this.bringToFront()},a.prototype.renderTooltip=function(){$(this.element.node).qtip({content:{text:this.polygon.get("name")+"【"+this.polygon.get("patternName")+"】<br>"+(this.polygon.get("description")||"No description yet!")},position:{my:"bottom left",target:"mouse"}})},a.prototype.onMouseOver=function(){if(!this.element)return;this.glow!==undefined&&this.glow.remove(),this.glow=this.element.glow({color:TimescaleApp.glowColor,width:40,opacity:1}),this.glow.show(),this.$el.addClass("hover")},a.prototype.onMouseOut=function(){if(!this.element)return;this.polygon.isSimple()?this.setPolygonFill():this.setRenderErrorFill(),this.glow!==undefined&&this.glow.hide(),this.$el.removeClass("hover")},a.prototype.moveToBottom=function(){this.element.toBack(),this.app.transectImageElement!==undefined&&this.app.transectImageElement.toBack()},a.prototype.togglePolygonForm=function(){this.polygon.set({edit:!this.polygon.get("edit")})},a.prototype.showList=function(e){this.$(".polygon-settings").removeClass("active");var t="."+e.target.getAttribute("href").slice(1)+"-tab";this.$(t).addClass("active")},a.prototype.delete=function(){this.element!==undefined&&this.element.remove(),this.linesSet!==undefined&&this.linesSet.remove(),this.pointsSet!==undefined&&this.pointsSet.remove(),this.glow!==undefined&&this.glow.remove(),this.$el.remove(),this.remove()},a.prototype.destroy=function(){this.polygon.destroy()},a.prototype.updatePolygon=function(e){(e.keyCode==TimescaleApp.ENTER||e.keyCode==TimescaleApp.ESC)&&this.togglePolygonForm(),this.polygon.set({name:this.$polygonName.value,description:this.$polygonDescription.value})},a.prototype.setRenderMode=function(){this.polygon.get("draw")?(this.setRenderFill(),this.$el.addClass("highlight")):(this.polygon.isSimple()?this.setPolygonFill():this.setRenderErrorFill(),this.$el.removeClass("highlight"))},a.prototype.toFront=function(){this.element&&this.bringToFront()},a}),define("polygonsView",["baseView","polygonView","polygon"],function(e,t,n){var r=e.extend({el:"#polygons-list",classname:"PolygonsView"});return r.prototype.template=new EJS({url:"/commons/ejs/data_tbl.ejs"}),r.prototype.initialize=function(e){this.app=e,CurrentPolygon=null,this.polygonsCollection=this.app.PolygonsCollection,this.enPolygons=!1,this.render(),this.listenToActionEvents(),this.listenTo(this.polygonsCollection,"add",this.addPolygon.bind(this))},r.prototype.render=function(){this.$el.html(this.template.render({name:"Polygons"})),this.$polygonsList=this.$(".data-list"),this.renderPolygons()},r.prototype.renderPolygons=function(){this.polygonsCollection.each(this.addPolygon.bind(this))},r.prototype.listenToActionEvents=function(){$('a[href="#new-polygon"]').click(this.createPolygon.bind(this))},r.prototype.addPolygon=function(e){var n=new t(this.app,e);this.$polygonsList.append(n.el)},r.prototype.togglePolygons=function(){$("a[href='#add-polygon']").parent().hasClass("hide")?($("a[href='#add-polygon']").parent().removeClass("hide"),$("a[href='#new-polygon']").parent().addClass("hide"),this.enPolygons=!1):($("a[href='#add-polygon']").parent().addClass("hide"),$("a[href='#new-polygon']").parent().removeClass("hide"),this.enPolygons=!0,this.createPolygon())},r.prototype.createPolygon=function(){if(!this.enPolygons)return;this.checkAndDeleteCurrentPolygon(),this.disableAllPolygons(),this.app.CurrentPolygon=new n,this.polygonsCollection.add(this.app.CurrentPolygon),this.disableAllPolygons(),this.app.CurrentPolygon.set({draw:!0})},r.prototype.checkAndDeleteCurrentPolygon=function(){this.app.CurrentPolygon&&(this.app.CurrentPolygon.set({draw:!1}),this.app.CurrentPolygon.get("points").length<3&&this.app.CurrentPolygon.destroy())},r.prototype.disableAllPolygons=function(){this.polygonsCollection.each(function(e){e.set("draw",!1)})},r}),define("dataImportView",["baseView"],function(e){var t=e.extend({el:".container",classname:"DataImportView"});return t.prototype.initialize=function(){this.$dataStatus=this.$(".data-status")},t}),define("dataExportView",["baseView"],function(e){var t=e.extend({el:"#export-panel",classname:"DataExportView",events:{"click a.show-data":"showData"}});return t.prototype.template=new EJS({url:"/transect_maker/ejs/data_export_panel.ejs"}),t.prototype.transectWellDataTemplate=new EJS({url:"/transect_maker/ejs/wells_data.ejs"}),t.prototype.transectDataLayout=new EJS({url:"/transect_maker/ejs/transect_data_layout.ejs"}),t.prototype.initialize=function(e){this.app=e,this.markers=this.app.TransectMarkersCollection,this.polygons=this.app.PolygonsCollection,this.render(),this.$canvas=$("#canvas")},t.prototype.render=function(){this.exporter=this.app.exporter,this.transects=this.app.TransectsCollection,this.$el.html(this.template.render({transects:this.transects.toJSON()})),this.$transectData=this.$(".transect-data"),this.$showData=this.$(".show-data"),this.$dataTable=this.$(".data-table"),this.$dataRaw=this.$(".data-raw"),this.$dataJSON=this.$(".data-json"),this.$textData=this.$("textarea[name*=transect-data-text]")[0],this.$textJSON=this.$("textarea[name*=transect-data-json]")[0],this.$showTable=this.$('a[href="#show-table"]'),this.$showRaw=this.$('a[href="#show-raw"]'),this.$showJSON=this.$('a[href="#show-raw"]'),this.exporter.export(),this.renderWellsData(),this.renderTransectsData(),this.renderDataInText()},t.prototype.isAgeSet=function(){for(var e=0;e<this.markers.length;e++){var t=this.markers.at(e);if(t.get("age")==null)return!1}return!0},t.prototype.renderWellsData=function(){var e=this.exporter.wellsData;for(var t in e)this.$("#"+t).html(this.transectWellDataTemplate.render(e[t]))},t.prototype.renderTransectsData=function(){var e=this.exporter.transectsData;for(var t in e)this.$("#"+t).html(this.transectDataLayout.render(e[t]))},t.prototype.renderDataInText=function(){this.$textData.value=this.exporter.getText()},t.prototype.renderDataInJSON=function(){this.$textJSON.value=this.exporter.getJSON()},t.prototype.toggleExportView=function(e){$("#loading").removeClass("hide"),$("a[href='#export-data']").parent().hasClass("active")?($("a[href='#export-data']").parent().removeClass("active"),$(".display-panel").addClass("hide"),this.$canvas.removeClass("hide")):($(".maker-tools").parent().removeClass("active"),$("a[href='#export-data']").parent().addClass("active"),$(".display-panel").addClass("hide"),this.$el.removeClass("hide"));try{this.render(),$("#loading").addClass("hide")}catch(t){$("#loading").addClass("hide")}},t.prototype.showData=function(e){this.$transectData.addClass("hide"),this.$showData.removeClass("alert"),$(e.target).addClass("alert");var t=$(e.target).attr("href");t==="#show-table"?this.$dataTable.removeClass("hide"):t==="#show-raw"?this.$dataRaw.removeClass("hide"):t==="#show-json"&&this.$dataJSON.removeClass("hide")},t}),define("file",["baseModel"],function(e){var t=e.extend({classname:"File",constructor:function(t,n){var r=[{name:t.name,isFile:t.isFile,isDirectory:t.isDirectory,size:t.Size||0,fullPath:t.fullPath,url:t.toURL(),selected:!1,type:null,size:0,modificationTime:null}];e.apply(this,r)}});return t.prototype.initialize=function(e,t){var n=this.get("name").split(".").pop();this.set({type:n})},t.prototype.updateFileData=function(e){var t=new Date(e.modificationTime);this.set({size:e.size,modificationTime:t.getTime()})},t}),define("files",["baseCollection","file"],function(e,t){var n=e.extend({classname:"Files",model:t});return n.prototype.comparator=function(e){return-e.get("modificationTime")},n}),define("fileView",["baseView"],function(e){var t=e.extend({tagName:"div",classname:"FileView",events:{dblclick:"open",click:"select","blur .file-name":"blur"}});return t.prototype.template=new EJS({url:"/file_system/ejs/file.ejs"}),t.prototype.initialize=function(e,t,n,r){this.app=r,this.fileSystem=n,this.files=t,this.file=e,this.listenTo(this.file,"change:selected",this.setSelected.bind(this)),this.listenTo(this.file,"change:name",this.rename.bind(this)),this.listenToActionEvents(),this.render()},t.prototype.listenToActionEvents=function(){$('a[href="#delete-file"]').click(this.deleteFile.bind(this)),$('a[href="#load-data"]').click(this.loadData.bind(this))},t.prototype.render=function(){var e=this.file.toJSON();this.$el.html(this.template.render(e)),this.$file=this.$(".file"),this.$fileName=this.$(".file-name")[0]},t.prototype.deleteFile=function(){var e=this;if(!e.file.get("selected"))return;e.file.get("isFile")?e.fileSystem.get("fs").root.getFile(e.file.get("fullPath"),{},function(t){t.remove(function(){console.log("File removed."),e.file.destroy()},e.errorHandler.bind(this))},e.errorHandler.bind(this)):e.fileSystem.get("fs").root.getDirectory(e.file.get("fullPath"),{},function(t){t.removeRecursively(function(){console.log("Directory removed."),e.file.destroy()},e.errorHandler.bind(this))},e.errorHandler.bind(this))},t.prototype.select=function(){var e=this;this.files.each(function(t){t==e.file?t.set({selected:!t.get("selected")}):t.set({selected:!1})})},t.prototype.setSelected=function(){this.file.get("selected")?this.$file.addClass("active"):this.$file.removeClass("active")},t.prototype.blur=function(){this.file.set({name:this.$fileName.textContent})},t.prototype.rename=function(){var e=this;e.file.get("isFile")?e.fileSystem.get("fs").root.getFile(e.file.get("fullPath"),{},function(t){var n=e.file.get("fullPath").split("/");n.pop(),n=n.join("/"),n===""&&(n="/"),e.fileSystem.get("fs").root.getDirectory(n,{},function(n){t.moveTo(n,e.file.get("name")),e.fileSystem.set({update:!e.fileSystem.get("update")})},e.errorHandler.bind(this))},e.errorHandler.bind(this)):e.fileSystem.get("fs").root.getDirectory(e.file.get("fullPath"),{},function(t){var n=e.file.get("fullPath").split("/");n.pop(),n=n.join("/"),n===""&&(n="/"),e.fileSystem.get("fs").root.getDirectory(n,{},function(n){t.moveTo(n,e.file.get("name")),e.fileSystem.set({update:!e.fileSystem.get("update")})},e.errorHandler.bind(this))},e.errorHandler.bind(this))},t.prototype.open=function(){var e=this;e.file.get("isFile")||this.fileSystem.set({path:this.file.get("fullPath")})},t.prototype.errorHandler=function(e){console.log("Error: "+e.name+" "+e.message)},t.prototype.loadData=function(){var e=this;if(e.file.get("isDirectory")||!e.file.get("selected"))return;$("#loading").removeClass("hide"),e.fileSystem.get("fs").root.getFile(e.file.get("fullPath"),{},function(t){t.file(function(t){var n=new FileReader;n.onloadend=function(t){e.showCanvas(),e.app.loader.loadData(this.result),$("#loading").addClass("hide")},n.readAsText(t)},e.errorHandler.bind(e))},e.errorHandler.bind(e))},t.prototype.showCanvas=function(){$("#canvas").removeClass("hide"),$("#file-system-panel").addClass("hide"),$("a[href='#file-system']").parent().removeClass("active")},t}),define("filesView",["baseView","fileView","file"],function(e,t,n){var r=e.extend({classname:"FilesView",el:"#files-list",events:{}});return r.prototype.template=new EJS({url:"/file_system/ejs/files.ejs"}),r.prototype.initialize=function(e,t,n){this.app=n,this.fileSystem=t,this.files=e,this.listenTo(this.files,"add",this.render.bind(this)),this.listenTo(this.files,"remove",this.render.bind(this)),this.listenToActionEvents(),this.render()},r.prototype.listenToActionEvents=function(e){$('a[href="#create-file"]').unbind().click(this.createNewFile.bind(this)),$('a[href="#create-dir"]').unbind().click(this.createNewDir.bind(this)),$('a[href="#save-project"]').click(this.saveProject.bind(this))},r.prototype.render=function(){this.$el.html(this.template.render()),this.$list=this.$(".list"),this.files.each(this.addFile.bind(this))},r.prototype.addFile=function(e){var n=new t(e,this.files,this.fileSystem,this.app);this.$list.append(n.el)},r.prototype.createNewFile=function(){var e=this;e.fileSystem.get("fs").root.getDirectory(e.fileSystem.get("path"),{},function(t){e.newFile(t,_.uniqueId("new-file-"))},e.errorHandler.bind(e))},r.prototype.newFile=function(e,t,n){var r=this;e.getFile(t,{create:!0,exclusive:!0},function(e){r.createFile(e,n)},r.errorHandler.bind(r))},r.prototype.createFile=function(e,t){var r=this.fileSystem.get("path");r==="/"?r=[""]:r=this.fileSystem.get("path").split("/"),r.push(e.name),r=r.join("/");if(r===e.fullPath){var i=new n(e);this.files.add(i)}t!==undefined&&t(e)},r.prototype.createNewDir=function(){var e=this;e.fileSystem.get("fs").root.getDirectory(e.fileSystem.get("path"),{},function(t){e.newDir(t,_.uniqueId("new-folder-"))},e.errorHandler.bind(e))},r.prototype.newDir=function(e,t,n){var r=this;e.getDirectory(t,{create:!0},function(e){r.createFile(e,n)},r.errorHandler.bind(r))},r.prototype.saveProject=function(){$("#loading").removeClass("hide");var e=this,t=e.getTimeStamp(),n=this.app.type+"-"+t;e.fileSystem.get("fs").root.getDirectory(e.fileSystem.get("path"),{},function(r){e.newDir(r,n,function(n){var r=e.app.type+"-data-"+t+".json",i=e.app.type+"-data-"+t+".txt",s=e.app.exporter.getJSON(),o=e.app.exporter.getText();e.newFile(n,r,function(t){e.writeJSONToAFile(t,s),e.newFile(n,i,function(t){e.writeTextToAFile(t,o),$("#loading").addClass("hide")})})})},e.errorHandler.bind(e)),this.fileSystem.set({update:!this.fileSystem.get("update")})},r.prototype.writeJSONToAFile=function(e,t){var t=t;if(e.isDirectory)return;var n=this;n.fileSystem.get("fs").root.getFile(e.fullPath,{create:!0},function(e){e.createWriter(function(e){e.onwriteend=function(e){console.log("Write completed.")},e.onerror=function(e){console.log("Write failed: "+e.toString())};var n=new Blob([t],{type:"application/json"});e.write(n)},n.errorHandler.bind(this))},n.errorHandler.bind(this))},r.prototype.writeTextToAFile=function(e,t){var t=t;if(e.isDirectory)return;var n=this;n.fileSystem.get("fs").root.getFile(e.fullPath,{create:!0},function(e){e.createWriter(function(e){e.onwriteend=function(e){console.log("Write completed.")},e.onerror=function(e){console.log("Write failed: "+e.toString())};var n=new Blob([t],{type:"text/plain"});e.write(n)},n.errorHandler.bind(this))},n.errorHandler.bind(this))},r.prototype.getTimeStamp=function(){var e=new Date,t=e.getUTCMonth()+"-"+e.getUTCDate()+"-";return t+=e.getUTCFullYear()+"-"+e.getHours()+"_",t+=e.getMinutes()+"_"+e.getSeconds(),t},r.prototype.errorHandler=function(e){console.log("Error: "+e.name+" "+e.message)},r}),define("fileSystem",["baseModel"],function(e){var t=e.extend({classname:"FileSystem",constructor:function(t,n){var r=[{fs:t.fs,path:"/",update:!1}];e.apply(this,r)}});return t}),define("fileSystemView",["baseView","file","files","filesView","fileSystem"],function(e,t,n,r,i){var s=e.extend({classname:"FileSystemView",el:"#file-system-panel",events:{"click a[href='#parent-dir']":"parentDir","click a.path-breadcrumb":"setDir"}});return s.prototype.template=new EJS({url:"/file_system/ejs/file_system_panel.ejs"}),s.prototype.initialize=function(e){this.app=e,this.$canvas=$("#canvas");var t=1073741824;this.requestFileSystem(t)},s.prototype.requestFileSystem=function(e){window.requestFileSystem=window.requestFileSystem||window.webkitRequestFileSystem,window.requestFileSystem&&window.requestFileSystem(window.PERSISTENT,e,this.render.bind(this),this.errorHandler.bind(this))},s.prototype.render=function(e){this.fileSystem=new i({fs:e}),this.renderDirs(),this.listenTo(this.fileSystem,"change:path",this.renderDirs.bind(this)),this.listenTo(this.fileSystem,"change:update",this.renderDirs.bind(this))},s.prototype.renderDirs=function(){this.$el.html(this.template.render(this.fileSystem.toJSON()));var e=this,t=this.fileSystem.get("path");this.files=new n,this.filesView=new r(this.files,this.fileSystem,this.app),this.fileSystem.get("fs").root.getDirectory(t,{},function(t){if(t.isDirectory){var n=t.createReader();n.readEntries(e.readDir.bind(e))}},e.errorHandler),this.readDir()},s.prototype.readDir=function(e){var n=this;if(e===undefined||!e.length)return;if(n.fileSystem.get("update")){n.fileSystem.set({update:!1});return}_.invoke(n.files.toArray(),"destroy"),e.forEach(function(e){var r=new t(e);e.getMetadata(function(e){r.updateFileData(e),n.files.add(r)})})},s.prototype.parentDir=function(){var e=this.fileSystem.get("path");if(e==="/")return;e=e.split("/"),e.pop(),e=e.join("/"),this.fileSystem.set({path:e})},s.prototype.setDir=function(e){var t=$(e.target).attr("path");t===""&&(t="/"),this.fileSystem.set({path:t})},s.prototype.toggleView=function(e){$("a[href='#file-system']").parent().hasClass("active")?($("a[href='#file-system']").parent().removeClass("active"),$(".display-panel").addClass("hide"),this.$canvas.removeClass("hide")):($(".maker-tools").parent().removeClass("active"),$("a[href='#file-system']").parent().addClass("active"),$(".display-panel").addClass("hide"),this.$el.removeClass("hide"),this.app.exporter.export())},s.prototype.errorHandler=function(e){console.log("Error: "+e.name+" "+e.message)},s}),define("loader",["transectMarker","transectWell","polygon","point","transectText"],function(e,t,n,r,i){var s=function(e){this.app=e,this.polygons=this.app.PolygonsCollection,this.zones=this.app.ZonesCollection,this.transects=this.app.TransectsCollection,this.markers=this.app.TransectMarkersCollection,this.wells=this.app.TransectWellsCollection,this.texts=this.app.TransectTextsCollection,this.points=this.app.PointsCollection,this.lines=this.app.LinesCollection};return s.prototype.loadFromLocalStorage=function(){this.loadData(localStorage.transectApp)},s.prototype.loadData=function(e){this.savedData=JSON.parse(e),this.reset(),this.load()},s.prototype.reset=function(){_.invoke(this.markers.toArray(),"destroy"),_.invoke(this.wells.toArray(),"destroy"),_.invoke(this.polygons.toArray(),"destroy"),_.invoke(this.zones.toArray(),"destroy"),_.invoke(this.transects.toArray(),"destroy"),_.invoke(this.texts.toArray(),"destroy"),_.invoke(this.points.toArray(),"destroy"),_.invoke(this.lines.toArray(),"destroy"),this.app.referenceColumn&&this.app.referenceColumn.set({columnId:"none"})},s.prototype.load=function(){this.loadImage(),this.loadReferenceColumnData(),this.loadWellsAndTransects(),this.loadPolygons(),this.loadTexts(),this.updateLines()},s.prototype.loadImage=function(){this.app.TransectImage.set(this.savedData.image)},s.prototype.loadReferenceColumnData=function(){var e=this;e.savedData.referenceColumn&&e.savedData.referenceColumn.columnId!=="none"?(e.app.referenceColumn.set({columnId:e.savedData.referenceColumn.columnId,columnData:e.savedData.referenceColumn.columnData,top:e.savedData.referenceColumn.top,base:e.savedData.referenceColumn.base}),e.updateMarkerPositions()):e.loadMarkersAndZones()},s.prototype.updateMarkerPositions=function(){var e=this;e.savedData.markers.forEach(function(t){var n=e.app.TransectMarkersCollection.findWhere({age:t.age});n&&n.set({y:t.y})})},s.prototype.loadMarkersAndZones=function(){var t=this;t.savedData.zones.forEach(function(n,r){var i=t.markers.findWhere({y:n.topMarker.y})||new e(n.topMarker),s=t.markers.findWhere({y:n.baseMarker.y})||new e(n.baseMarker);t.markers.add(i),t.markers.add(s)}),t.savedData.zones.forEach(function(e,n){var r=t.markers.findWhere({y:e.topMarker.y}),i=t.markers.findWhere({y:e.baseMarker.y}),s=t.zones.findWhere({topMarker:r,baseMarker:i});s!==undefined&&s.set({name:e.name,description:e.description})})},s.prototype.loadWellsAndTransects=function(){var e=this;e.savedData.transects.forEach(function(n,r){var i=e.wells.findWhere({x:n.wellLeft.x}),s=e.wells.findWhere({x:n.wellRight.x});i===undefined&&(i=new t(n.wellLeft),e.wells.add(i)),s===undefined&&(s=new t(n.wellRight),e.wells.add(s))}),e.savedData.transects.forEach(function(t,n){var r=e.wells.findWhere({x:t.wellLeft.x}),i=e.wells.findWhere({x:t.wellRight.x}),s=e.transects.findWhere({wellLeft:r,wellRight:i});s!==undefined&&s.set({name:t.name,description:t.description})})},s.prototype.loadPolygons=function(){var e=this;e.savedData.polygons.forEach(function(t){e.createPolygon(t)})},s.prototype.createPolygon=function(e){var t=this,i=t.polygons.findWhere({id:e.id,name:e.name,patternName:e.patternName})||new n({id:e.id,name:e.name,description:e.description});this.polygons.add(i),e.points.forEach(function(e){var n=t.points.findWhere({x:e.x,y:e.y})||new r({x:e.x,y:e.y},t.app);i.get("points").add(n)}),i.set({patternName:e.patternName})},s.prototype.loadTexts=function(){var e=this;e.savedData.texts.forEach(function(t){var n=e.texts.findWhere({text:t.text,x:t.x,y:t.y})||new i(t,e.app);e.texts.add(n),n.get("settings").set(t.settings)})},s.prototype.updateLines=function(){var e=this;e.savedData.lines.forEach(function(t){var n=e.points.findWhere({x:t.point1.x,y:t.point1.y}),r=e.points.findWhere({x:t.point2.x,y:t.point2.y}),i=e.lines.findWhere({point1:n,point2:r})||e.lines.findWhere({point1:r,point2:n});i&&i.set({name:t.name,pattern:i.get("pattern")==="default"?t.pattern:i.get("pattern")})})},s}),define("transectTexts",["baseCollection","transectText"],function(e,t){var n=e.extend({classname:"TransectTexts",model:t});return n.prototype.updateTransectTexts=function(){return this.each(function(e){e.updateTransectAndZone()}),!0},n.prototype.comparator=function(e){return e.get("y")},n}),define("exporter",["polygon","polygons","point","points","line","lines","transects","transectTexts","polyK"],function(e,t,n,r,i,s,o,u,a){var f=function(e){this.app=e};return f.prototype.initialize=function(){var e=this;this.PRECISION=transectApp.precision,this.texts=this.app.TransectTextsCollection,this.polygons=this.app.PolygonsCollection,this.transects=this.app.TransectsCollection,this.markers=this.app.TransectMarkersCollection,this.zones=this.app.ZonesCollection,this.transectImage=this.app.TransectImage,this.texts.sort(),this.polygons.sort(),this.app.PointsCollection.updatePoints(),this.texts.updateTransectTexts(),e.transectsData={},this.app.TransectsCollection.each(function(n){e.transectsData[n.get("id")]={data:n,polygons:new t,points:new r,texts:new u,matrixPositions:[],matrixAges:[],matrix:{}}}),e.wellsData={},this.app.TransectWellsCollection.each(function(n){e.wellsData[n.get("id")]={data:n,points:new r,polygons:new t,referencePoints:[]}}),e.points=new r,e.lines=new s},f.prototype.export=function(){this.initialize(),this.processData(),this.updateWells(),this.sortData(),this.processTexts()},f.prototype.processTexts=function(){var e=this;e.texts.each(function(t){var n=t.get("transect").id;e.transectsData[n].texts.add(t)})},f.prototype.sortData=function(){var e=this;for(var t in e.transectsData)e.sortTransectsData(e.transectsData[t]),e.sortMatrixDataAndUpdateEndPoints(e.transectsData[t]);for(var t in e.wellsData)e.sortWellsData(e.wellsData[t])},f.prototype.sortMatrixDataAndUpdateEndPoints=function(e){var t=[],n=[];for(var r in e.matrixPositions)e.matrixPositions[r]<3?t.push(e.matrixPositions[r]):e.matrixPositions[r]>97&&n.push(e.matrixPositions[r]);t.sort(function(e,t){return e-t}),n.sort(function(e,t){return t-e});for(var r in e.matrixAges){var i=e.matrix[e.matrixAges[r]];for(var s in t)if(t[s]in i){var o=i[t[s]];delete i[t[s]],i[0]=o,e.matrixPositions.indexOf(0)<0&&e.matrixPositions.push(0);break}for(var s in n)if(n[s]in i){var o=i[n[s]];delete i[n[s]],i[100]=o,e.matrixPositions.indexOf(100)<0&&e.matrixPositions.push(100);break}}},f.prototype.sortTransectsData=function(e){e.matrixPositions=_.uniq(e.matrixPositions),e.matrixAges=_.uniq(e.matrixAges),e.matrixPositions=_.sortBy(e.matrixPositions,function(e){return parseInt(e)}),e.matrixAges=_.sortBy(e.matrixAges,function(e){return parseFloat(e)})},f.prototype.sortWellsData=function(e){e.referencePoints=_.uniq(e.referencePoints),e.referencePoints=_.sortBy(e.referencePoints,function(e){return e.point.get("age")})},f.prototype.processData=function(){this.polygons.each(this.processPolygon.bind(this))},f.prototype.processPolygon=function(e){var t=this.getUnderlyingTransects(e);this.slicePolygon(e,t)},f.prototype.getUnderlyingTransects=function(e){var t=this,n=new o,r=[];e.get("points").each(function(e){var n=e.get("transect"),i=t.transects.indexOf(n);r=_.union(r,i)});var i=_.min(r),s=_.max(r);for(var u=i;u<=s;u++)n.add(t.transects.at(u));return n},f.prototype.slicePolygon=function(n,r){var i=this,s=r.length,o=new t,u=new e;u.get("points").add(n.get("points").clone().toArray()),u.get("lines").add(n.get("lines").clone().toArray()),o.add(u);for(var f=0;f<r.length;f++){var l=r.at(f),c=new t;for(var h=0;h<o.length;h++){var p=o.at(h),d=i.getLineSegmentForWell(l.get("wellRight")),v=p.getPolyKPointsArray();a.GetArea(v)>0&&(v=a.Reverse(v));try{var m=a.Slice(v,d[0],d[1],d[2],d[3]),m=i.getPolygonsFromPolyKPolygonsArray(m);c.add(m.toArray())}catch(g){}}o=c}for(var h=0;h<o.length;h++){var p=o.at(h),l=i.getTransectForPolygon(p,r);if(l===null)continue;var y=l.get("id");p.set({patternName:n.get("patternName")}),p.set({description:n.get("description")}),i.updatePolygonLines(p,n),i.updatePointsOnWell(l.get("wellLeft"),p.get("lines"),n);var f=r.toArray().indexOf(l);f==s-1&&i.updatePointsOnWell(l.get("wellRight"),p.get("lines"),n),i.transectsData[y].points.add(p.get("points").toArray()),i.transectsData[y].polygons.add(p),i.updateTransectMatrix(l,p)}},f.prototype.getTransectForPolygon=function(e,t){for(var n=0;n<t.length;n++){var r=t.at(n),i=r.getPolyKPointsArray(),s=!0;for(var o=0;o<e.get("points").length;o++){var u=e.get("points").at(o);if(!a.ContainsPoint(i,u.get("x"),u.get("y"))){s=!1;break}}if(s)return r}return null},f.prototype.updateTransectMatrix=function(e,t){var n=this,r=t.get("points"),i=n.transectsData[e.get("id")].matrix,s=n.transectsData[e.get("id")].matrixAges,o=n.transectsData[e.get("id")].matrixPositions;r.each(function(t){var n=t.get("age"),r=Math.round(t.get("relativeX")*1e4)/100,u=t.get("transect");u!==e&&(u.get("wellLeft")===e.get("wellRight")?r=101:r=-1),n in i||(i[String(n)]={}),s.indexOf(n)<0&&s.push(n),o.indexOf(n)<0&&o.push(r),i[String(n)][String(r)]=t.get("name")})},f.prototype.updatePointsOnWell=function(e,t,n){var r=this;t.each(function(t){r.isCloseToWell(e,t)&&(r.wellsData[e.get("id")].polygons.add(n),r.wellsData[e.get("id")].points.add(t.get("point1")),r.wellsData[e.get("id")].points.add(t.get("point2")))})},f.prototype.updateWells=function(){var e=this;for(var t in e.wellsData)e.updateWell(e.wellsData[t])},f.prototype.updateWell=function(e){var t=this;e.points.sortBy(function(e){return e.get("y")}),e.points.each(function(n,r){var i=t.getPointPattern(n,e.polygons),s=null,o=null;i!=null&&(s=i.get("patternName"),o=i.get("name")),e.referencePoints.push({point:n,pattern:s?s:"TOP",name:o?o:""})})},f.prototype.getPointPattern=function(e,n){var r=new t;return n.each(function(t){var n=t.getPolyKPointsArray();(a.ContainsPoint(n,e.get("x")+1,e.get("y")-3)||a.ContainsPoint(n,e.get("x")-1,e.get("y")-3)||a.ContainsPoint(n,e.get("x"),e.get("y")-3))&&r.add(t)}),r.length==0?null:(r.sort(),r.last())},f.prototype.isCloseToWell=function(e,t){var n=this,r=n.getLineSegmentForWell(e),i=5,s=[r[0]+i,r[1],r[0]-i,r[1],r[2]-i,r[3],r[2]+i,r[3]],o=t.getPolyKPointsArray();return a.ContainsPoint(s,o[0],o[1])&&a.ContainsPoint(s,o[2],o[3])?!0:!1},f.prototype.updatePolygonLines=function(e,t){var n=this,r=e.get("points"),o=new s;r.each(function(s,o){if(o>0){var u=r.at(o-1),a=s,f=n.lines.findWhere({point1:u,point2:a})||n.lines.findWhere({point1:a,point2:u})||new i({},u,a);n.lines.add(f),n.updateLineStyleFromOriginalPolygon(f,t),e.get("lines").add(f)}});var u=r.last(),a=r.first(),f=n.lines.findWhere({point1:u,point2:a})||n.lines.findWhere({point1:a,point2:u})||new i({},u,a);n.lines.add(f),n.updateLineStyleFromOriginalPolygon(f,t),e.get("lines").add(f)},f.prototype.updateLineStyleFromOriginalPolygon=function(e,t){var n=this,r=t.get("lines");for(var i=0;i<r.length;i++){var s=r.at(i);if(s.coincides(e)){e.set({pattern:s.get("pattern")});break}}},f.prototype.getLineSegmentForWell=function(e){return[Math.floor(e.get("x")),0,Math.floor(e.get("x")),this.app.Canvas.height]},f.prototype.getPolygonsFromPolyKPolygonsArray=function(e){var n=new t;for(var r in e)n.add(this.getPointsFromPolykPolygon(e[r]));return n},f.prototype.getPointsFromPolykPolygon=function(t){var r=new e;for(var i=0;i<t.length;i+=2){var s=this.points.findWhere({x:Math.floor(t[i]),y:Math.floor(t[i+1])})||new n({x:Math.floor(t[i]),y:Math.floor(t[i+1])},this.app);this.points.add(s),r.get("points").add(s)}return r},f.prototype.getText=function(){var e=this,t=e.getMetaColumn();for(var n=0;n<e.transects.length;n++){var r=e.transects.at(n);if(n==0){var i=r.get("wellLeft").id;t+=e.getWellOutputText(i)}t+=e.getTransectOutputText(r.id);var s=r.get("wellRight").id;t+=e.getWellOutputText(s)}return t},f.prototype.getMetaColumn=function(){var e=this,t="\n\nTRANSECTS	:	";for(var n=0;n<e.transects.length;n++){var r=e.transects.at(n);if(n==0){var i=r.get("wellLeft");t+=i.get("name")+"	"}t+=r.get("name")+"	";var s=r.get("wellRight");t+=s.get("name")+"	"}return t+="\n\n",t},f.prototype.getTransectOutputText=function(e){var t=this,n=t.transectsData[e],r="\n\n";return r+=n.data.get("name")+"	",r+="transect	",r+=n.data.get("width")+"	",r+=CssToTscColor(n.data.get("settings").get("backgroundColor"))+"	",r+=n.data.get("status")+"	",r+=t.getTransectMatrixText(e),r+=t.getTransectPolygonsListText(e),r+=t.getTextLabelsOutput(e),r},f.prototype.getTransectMatrixText=function(e){var t=this,n=t.transectsData[e],r=n.matrixAges,i=n.matrixPositions.sort(function(e,t){return parseFloat(e)-parseFloat(t)}),s="\n		";for(var o=0;o<i.length;o++)s+=i[o]+"	";for(var o=0;o<r.length;o++){var u=String(r[o]);s+="\n	",s+=u+"	";for(var a=0;a<i.length;a++){var f=i[a];s+=(n.matrix[String(u)][String(f)]||"")+"	"}}return s},f.prototype.getTransectPolygonsListText=function(e){var t=this,n=t.transectsData[e],r="";for(var i=0;i<n.polygons.length;i++){var s=n.polygons.at(i);r+="\n",r+="POLYGON	",r+="pattern: "+(s.get("patternName")||"None")+"	",r+=s.get("description")||"	";var o=s.get("lines"),u=s.get("points");for(var a=0;a<u.length;a++){var f=u.at(a),l=u.at((a+1)%u.length),c=o.findWhere({point1:f,point2:l})||o.findWhere({point1:l,point2:f}),h=c.get("pattern");r+="\n	",r+=f.get("name").substring(1),h!=="default"&&(r+="\n		",r+=h)}}return r},f.prototype.getWellOutputText=function(e){var t=this,n=t.wellsData[e],r="\n\n";r+=n.data.get("name")+"	",r+="facies	",r+=n.data.get("width")+"	",r+=CssToTscColor(n.data.get("settings").get("backgroundColor"))+"	",r+"\n";for(var i in n.referencePoints)r+="\n",r+="	",r+=(n.referencePoints[i].pattern||"None")+"	",r+=(n.referencePoints[i].name||"")+"	",r+=n.referencePoints[i].point.get("age")+"	",r+="CALIBRATION = ",r+=Math.round((1-n.referencePoints[i].point.get("relativeY"))*1e3)/10+" % up the ",r+=n.referencePoints[i].point.get("zone").get("name")+"	";return r},f.prototype.getTextLabelsOutput=function(e){var t="",n=this.transectsData[e].texts;return n.each(function(e){var n=e.get("bBox"),r=e.get("text").split("\n").join(""),i=e.get("settings").get("fontFamily").split(",")[0];t+="\n",t+="TEXT	"+n.y1+"	"+n.x1,t+="	"+r,t+="	font-family: "+i+"; font-size: "+e.get("settings").get("fontSize")+";",t+="	"+Math.round((n.y1-n.y2)*100)/100+"	"+Math.round((n.x2-n.x1)*100)/100}),t},f.prototype.getJSON=function(){var e={};return e.transects=this.transects.toJSON(),e.markers=this.markers.toJSON(),e.zones=this.zones.toJSON(),e.polygons=this.polygons.toJSON(),e.texts=this.texts.toJSON(),e.image=this.transectImage.toJSON(),e.points=this.app.PointsCollection.toJSON(),e.lines=this.app.LinesCollection.toJSON(),e.referenceColumn=this.app.referenceColumn.toJSON(),JSON.stringify(e)},f}),define("zones",["baseCollection","zone"],function(e,t){var n=e.extend({classname:"Zones",model:t});return n.prototype.comparator=function(e){return e.get("topMarker").get("y")},n.prototype.getZoneForY=function(e){var t=null;return this.each(function(n){n.isYInsideZone(e)&&(t=n)}),t},n.prototype.getZoneInNeighborhoodForY=function(e,t){var n=this.indexOf(t),r=this.at(n-1),i=this.at(n+1);return t.isYInsideZone(e)?t:r&&r.isYInsideZone(e)?r:i&&i.isYInsideZone(e)?i:null},n}),define("transectWells",["baseCollection","transectWell"],function(e,t){var n=e.extend({classname:"TransectWells",model:t});return n.prototype.comparator=function(e){return e.get("x")},n}),define("transectMarkers",["baseCollection","transectMarker"],function(e,t){var n=e.extend({classname:"TransectMarkers",model:t});return n.prototype.comparator=function(e){return e.get("y")},n}),define("referenceBlock",["baseModel","settings"],function(e,t){var n=e.extend({classname:"ReferenceBlock",constructor:function(n,r){var i=[{edit:!1,hover:!1,name:n.name||_.uniqueId("ReferenceBlock "),description:n.description,settings:new t,top:n.top||null,base:n.base||null,blockColumn:n.blockColumn||null}];e.apply(this,i)}});return n.prototype.initialize=function(){this.get("settings").set({backgroundColor:"#FF0000"})},n.prototype.toJSON=function(){var e=_.clone(this.attributes);return delete e.blockColumn,e},n}),define("referenceBlocks",["baseCollection","referenceBlock"],function(e,t){var n=e.extend({classname:"ReferenceBlocks",model:t});return n}),define("referenceBlockMarker",["baseModel","referenceBlocks"],function(e,t){var n=e.extend({classname:"ReferenceBlockMarker",constructor:function(n,r){var i=[{name:n.name||"TOP",edit:!1,hover:!1,y:parseInt(n.y),id:_.uniqueId("block-marker-"),age:n.age?parseFloat(n.age):null,blockColumn:n.blockColumn||null,style:"solid",app:r||null,blocks:new t,marker:null}];e.apply(this,i)}});return n.prototype.initialize=function(){},n.prototype.toJSON=function(){var e=_.clone(this.attributes);return delete e.blocks,delete e.blockColumn,delete e.marker,delete e.app,e},n}),define("referenceBlockMarkers",["baseCollection","referenceBlockMarker"],function(e,t){var n=e.extend({classname:"ReferenceBlockMarkers",model:t});return n.prototype.comparator=function(e){return e.get("y")},n}),define("referenceBlockColumn",["baseModel","referenceBlocks","referenceBlockMarkers","settings"],function(e,t,n,r){var i=e.extend({classname:"ReferenceBlockColumn",constructor:function(i){var s=[{x:i.x||0,id:i.id||_.uniqueId("column-"),name:i.name||_.uniqueId("Column "),width:parseInt(i.width)||200,height:100,description:i.description||null,blockMarkers:new n,blocks:new t,settings:new r}];e.apply(this,s)}});return i.prototype.comparator=function(e){return e.get("x")},i.prototype.toJSON=function(){var e=_.clone(this.attributes);return e},i}),define("referenceColumn",["baseModel","referenceBlockColumn"],function(e,t){var n=e.extend({classname:"ReferenceColumn",constructor:function(t){var n=[{columnId:t.columnId||"none",column:t.column||null,top:t.top||0,base:t.base||15,columnsData:t.columnsData||null}];e.apply(this,n)}});return n.prototype.toJSON=function(){var e=_.clone(this.attributes);return e},n}),define("referenceBlockView",["baseView"],function(e){var t=e.extend({tagName:"li",classname:"ReferenceBlockView",events:{"click .toggle":"toggleBlockForm","click .block-data":"toggleBlockForm","click .destroy":"destroy","keypress :input":"updateBlock","keyup :input":"updateBlock",'change input[name="block-color"]':"updateBlock","change select.block-line-style":"updateBlock",mouseover:"onMouseOver",mouseout:"onMouseOut"}});return t.prototype.template=new EJS({url:"/reference_column_maker/ejs/block.ejs"}),t.prototype.initialize=function(e,t){this.app=e,this.block=t,this.top=this.block.get("top"),this.base=this.block.get("base"),this.blockSet===undefined&&(this.blockSet=this.app.Canvas.set(),this.app.BlocksSet.push(this.blockSet)),this.render(),this.listenTo(this.block,"change:edit",this.editBlock.bind(this)),this.listenTo(this.block,"change:hover",this.setHoverStatus.bind(this)),this.listenTo(this.block,"change:name",this.renderBlock.bind(this)),this.listenTo(this.block,"change:description",this.renderBlock.bind(this)),this.listenTo(this.block.get("blockColumn"),"change:x",this.renderBlock.bind(this)),this.listenTo(this.block.get("blockColumn"),"change:width",this.renderBlock.bind(this)),this.listenTo(this.top,"change:y",this.renderBlock.bind(this)),this.listenTo(this.top,"change:age",this.render.bind(this)),this.listenTo(this.base,"change:y",this.renderBlock.bind(this)),this.listenTo(this.base,"change:age",this.render.bind(this)),this.listenTo(this.block.get("settings"),"change",this.renderBlock.bind(this)),this.listenTo(this.block,"destroy",this.delete.bind(this))},t.prototype.render=function(){this.$el.html(this.template.render(this.block.toJSON())),this.$toggle=this.$(".toggle"),this.$blockForm=this.$(".block-form"),this.$blockData=this.$(".block-data"),this.$blockName=this.$('input[name="block-name"]')[0],this.$topAge=this.$('input[name="top-age"]')[0],this.$baseAge=this.$('input[name="base-age"]')[0],this.$blockColor=this.$('input[name="block-color"]')[0],this.$blockDescription=this.$('textarea[name="block-description"]')[0],this.editBlock(),this.renderBlock()},t.prototype.renderBlock=function(){this.bgBox===undefined&&(this.bgBox=this.app.Canvas.rect(),this.blockText=this.app.Canvas.text(),this.bBox=this.app.Canvas.rect(),this.blockSet.push(this.bgBox),this.blockSet.push(this.blockText),this.blockSet.push(this.bBox),this.app.MarkersSet.toFront(),this.app.BlockMarkersSet.toFront(),this.bBox.hover(this.onMouseOver.bind(this),this.onMouseOut.bind(this))),this.bgBox.attr({"stroke-width":0,fill:this.block.get("settings").get("backgroundColor"),x:this.block.get("blockColumn").get("x"),y:this.top.get("y"),width:this.block.get("blockColumn").get("width"),height:this.base.get("y")-this.top.get("y")});var e=Math.round(this.block.get("blockColumn").get("x")+this.block.get("blockColumn").get("width")/2),t=Math.round((this.top.get("y")+this.base.get("y"))/2),n=Math.min(Math.round(this.base.get("y")-this.top.get("y")),16);this.blockText.attr({x:e,y:t,text:this.block.get("name"),"font-size":n}),this.bBox.attr({"stroke-width":2,opacity:0,fill:"#FFF",x:this.block.get("blockColumn").get("x"),y:this.top.get("y"),width:this.block.get("blockColumn").get("width"),height:this.base.get("y")-this.top.get("y")}),this.renderTooltip()},t.prototype.renderTooltip=function(){$(this.bBox.node).qtip({content:{text:this.block.get("name")+"<br>"+(this.block.get("description")||"No description yet!")},position:{my:"bottom left",target:"mouse"}})},t.prototype.onMouseOver=function(){this.$el.addClass("hover"),this.block.set({hover:!0})},t.prototype.onMouseOut=function(){this.$el.removeClass("hover"),this.block.set({hover:!1})},t.prototype.setHoverStatus=function(){this.block.get("hover")?(this.$el.addClass("hover"),this.glow=this.bBox.glow()):(this.glow&&this.glow.remove(),this.$el.removeClass("hover"))},t.prototype.toggleBlockForm=function(){this.render(),this.block.set({edit:!this.block.get("edit")})},t.prototype.editBlock=function(){this.block.get("edit")?(this.$blockForm.removeClass("hide"),this.$blockData.addClass("hide"),this.$toggle.removeClass("hide-data"),this.$toggle.addClass("show-data")):(this.$blockForm.addClass("hide"),this.$blockData.removeClass("hide"),this.$toggle.removeClass("show-data"),this.$toggle.addClass("hide-data"))},t.prototype.delete=function(){this.blockText&&this.blockText.remove(),this.bgBox&&this.bgBox.remove(),this.bBox&&this.bBox.remove(),this.glow&&this.glow.remove(),this.$el.remove(),this.remove()},t.prototype.destroy=function(){this.block.get("base").set({name:"TOP"}),this.block.destroy()},t.prototype.updateBlock=function(e){var t=this.$blockName.value,n=this.$blockDescription.value,r=this.$blockColor.value,i=this.$("select.block-line-style option:selected").val();this.block.set({name:t,description:n});if(e.keyCode===TimescaleApp.ENTER||e.keyCode===TimescaleApp.ESC)this.block.get("base").set({name:t+" Base",age:parseFloat(this.$baseAge.value||0)}),this.block.get("top").set({age:parseFloat(this.$topAge.value||0)}),this.toggleBlockForm();this.block.get("settings").set({backgroundColor:r}),this.base.set({style:i})},t}),define("referenceBlockMarkerView",["baseView"],function(e){var t=e.extend({classname:"ReferenceBlockMarkerView"});return t.prototype.statusBoxTemplate=new EJS({url:"/reference_column_maker/ejs/status_box.ejs"}),t.prototype.initialize=function(e,t){this.app=e,this.blockMarker=t,this.render(),this.listenTo(this.blockMarker.get("blockColumn"),"change:x",this.renderBlockMarker.bind(this)),this.listenTo(this.blockMarker.get("blockColumn"),"change:width",this.renderBlockMarker.bind(this)),this.listenTo(this.blockMarker,"change:hover",this.setHoverStatus.bind(this)),this.listenTo(this.blockMarker,"change",this.renderBlockMarker.bind(this)),this.listenTo(this.blockMarker,"destroy",this.delete.bind(this)),this.listenTo(this.blockMarker.get("blocks"),"remove",this.checkAndDelete.bind(this)),this.render()},t.prototype.render=function(){this.renderBlockMarker()},t.prototype.renderBlockMarker=function(){this.element===undefined&&(this.element=this.app.Canvas.path(),this.element.attr({"stroke-width":2,stroke:"#0000FF"}),this.element.hover(this.onMouseOver.bind(this),this.onMouseOut.bind(this)),this.element.drag(this.dragMove.bind(this),this.dragStart.bind(this),this.dragEnd.bind(this)),this.app.BlockMarkersSet.push(this.element),this.app.MarkersSet.toFront()),this.blockMarker.get("marker")&&this.listenTo(this.blockMarker.get("marker"),"change:y",this.updateBlockMakereY.bind(this));var e=this.blockMarker.get("style"),t=[];e==="dashed"?t=["-"]:e==="dotted"&&(t=["."]),this.element.attr({path:this.getPath(),"stroke-dasharray":t}),this.resizeCanvas(),this.updateStatusBox(),this.renderTooltip()},t.prototype.renderTooltip=function(){var e=this;$(this.element.node).qtip({content:{text:this.blockMarker.get("name")+"("+this.blockMarker.get("age")+" myr )"},position:{my:"bottom left",target:"mouse"}})},t.prototype.resizeCanvas=function(){var e=Math.max(this.app.Canvas.height,this.blockMarker.get("y")+100);this.blockMarker.get("blockColumn").set({height:e}),this.app.Canvas.setSize(this.app.Canvas.width,e)},t.prototype.updateBlockMakereY=function(){this.blockMarker.get("marker")&&this.blockMarker.set({y:this.blockMarker.get("marker").get("y")})},t.prototype.updateStatusBox=function(){this.app.StatusBox&&this.app.StatusBox.html(this.statusBoxTemplate.render(this.blockMarker.toJSON()))},t.prototype.getPath=function(){var e=this.blockMarker.get("blockColumn").get("x")+this.blockMarker.get("blockColumn").get("width");return"M"+this.blockMarker.get("blockColumn").get("x")+","+this.blockMarker.get("y")+"H"+e},t.prototype.dragStart=function(e,t,n){var r=this.blockMarker.get("blockColumn").get("blockMarkers"),i=r.indexOf(this.blockMarker);this.prevMarker=r.at(i-1),this.nextMarker=r.at(i+1)},t.prototype.dragMove=function(e,t,n,r,i){if(this.prevMarker&&this.nextMarker&&(this.prevMarker.get("y")+2>i.offsetY||i.offsetY>this.nextMarker.get("y")-2))return;if(!this.prevMarker&&this.nextMarker&&i.offsetY>this.nextMarker.get("y")-2)return;if(this.prevMarker&&!this.nextMarker&&this.prevMarker.get("y")+2>i.offsetY)return;this.blockMarker.set({y:i.offsetY})},t.prototype.onMouseOver=function(){this.$el.addClass("hover"),this.blockMarker.set({hover:!0})},t.prototype.onMouseOut=function(){this.$el.removeClass("hover"),this.blockMarker.set({hover:!1})},t.prototype.setHoverStatus=function(){this.blockMarker.get("hover")?(this.element.attr({"stroke-width":5}),this.$el.addClass("hover")):(this.element.attr({"stroke-width":2}),this.$el.removeClass("hover"))},t.prototype.dragEnd=function(e){},t.prototype.delete=function(){this.element!==undefined&&this.element.remove(),this.$el.remove(),this.remove()},t.prototype.checkAndDelete=function(){this.blockMarker.get("blocks").length==0&&this.destroy()},t.prototype.destroy=function(){this.blockMarker.destroy()},t}),define("referenceBlockColumnView",["baseView","referenceBlockView","referenceBlockMarkerView","referenceBlock","referenceBlockMarker"],function(e,t,n,r,i){var s=e.extend({tagName:"li",classname:"ReferenceBlockColumnView",events:{"click .toggle":"ReferencetoggleBlockColumnForm","click .block-column-data":"ReferencetoggleBlockColumnForm","click .destroy":"destroy","click label.block-column-blocks-data":"showBlocksList","keypress :input":"ReferenceupdateBlockColumn","keyup :input":"ReferenceupdateBlockColumn",'change input[name="block-column-bg-color"]':"ReferenceupdateBlockColumn",mouseover:"onMouseOver",mouseout:"onMouseOut"}});return s.prototype.template=new EJS({url:"/reference_column_maker/ejs/block_column.ejs"}),s.prototype.initialize=function(e,t){this.app=e,this.blockColumn=t,this.render(),this.listenTo(this.blockColumn,"change:edit",this.editBlockColumn.bind(this)),this.listenTo(this.blockColumn,"change",this.renderBlockColumn.bind(this)),this.listenTo(this.blockColumn.get("settings"),"change",this.renderBlockColumn.bind(this)),this.listenTo(this.blockColumn.get("blockMarkers"),"add",this.addBlockMarker.bind(this)),this.listenTo(this.blockColumn.get("blocks"),"remove",this.removeBlock.bind(this)),this.listenTo(this.blockColumn.get("blocks"),"add",this.addBlock.bind(this)),this.listenTo(this.blockColumn,"destroy",this.delete.bind(this))},s.prototype.render=function(){this.$el.html(this.template.render(this.blockColumn.toJSON())),this.$toggle=this.$(".toggle"),this.$blockColumnForm=this.$(".block-column-form"),this.$blockColumnData=this.$(".block-column-data"),this.$blockColumnName=this.$('input[name="block-column-name"]')[0],this.$blockColumnWidth=this.$('input[name="block-column-width"]')[0],this.$blockColumnBgColor=this.$('input[name="block-column-bg-color"]')[0],this.$blockColumnDescription=this.$('textarea[name="block-column-description"]')[0],this.$blocksList=this.$(".blocks-list"),this.renderBlockColumn()},s.prototype.renderBlockColumn=function(){this.element===undefined&&(this.element=this.app.Canvas.rect(this.blockColumn.get("x"),0,this.blockColumn.get("width"),this.app.Canvas.height),this.element.dblclick(this.createBlockMarker.bind(this)),this.app.MarkersSet.toFront()),this.element.attr({x:this.blockColumn.get("x"),width:this.blockColumn.get("width"),height:this.blockColumn.get("height"),fill:this.blockColumn.get("settings").get("backgroundColor")}),this.resizeCanvas(),this.updateBlockColumns()},s.prototype.resizeCanvas=function(){var e=Math.max(this.app.Canvas.width,this.blockColumn.get("x")+this.blockColumn.get("width"));this.app.Canvas.setSize(e,this.app.Canvas.height)},s.prototype.resetBlocks=function(){this.$blocksList.html(""),this.blockColumn.get("blocks").each(this.addBlock.bind(this))},s.prototype.ReferencerenderBlocks=function(){this.blockColumn.get("blocks").each(this.addBlockMarker.bind(this))},s.prototype.ReferencetoggleBlockColumnForm=function(){this.renderBlockColumn(),this.blockColumn.set({edit:!this.blockColumn.get("edit")})},s.prototype.editBlockColumn=function(){this.blockColumn.get("edit")?(this.$blockColumnForm.removeClass("hide"),this.$blockColumnData.addClass("hide"),this.$toggle.removeClass("hide-data"),this.$toggle.addClass("show-data")):(this.$blockColumnForm.addClass("hide"),this.$blockColumnData.removeClass("hide"),this.$toggle.removeClass("show-data"),this.$toggle.addClass("hide-data"))},s.prototype.delete=function(){this.element!==undefined&&this.element.remove(),this.$el.remove(),this.remove()},s.prototype.ReferenceupdateBlockColumn=function(e){e.keyCode==13&&this.ReferencetoggleBlockColumnForm();var t=this.$blockColumnName.value,n=this.$blockColumnDescription.value,r=this.$blockColumnWidth.value,i=this.$blockColumnBgColor.value;this.blockColumn.set({name:t,description:n,width:parseInt(r)||0}),this.blockColumn.get("settings").set({backgroundColor:i})},s.prototype.createBlockMarker=function(e){if(!this.app.enBlocks)return;var t=new i({y:e.offsetY,blockColumn:this.blockColumn},this.app);this.blockColumn.get("blockMarkers").add(t)},s.prototype.addBlockMarker=function(e){var t=new n(this.app,e),i=this,s=this.blockColumn.get("blocks"),o=this.blockColumn.get("blockMarkers");o.sort();var u=o.indexOf(e),a,f;if(o.length>1){u==0?(a=o.at(u),f=o.at(u+1)):(a=o.at(u-1),f=o.at(u));var l=s.findWhere({top:a,base:f})||new r({top:a,base:f,blockColumn:i.blockColumn});a.get("blocks").add(l),f.get("blocks").add(l),f.set({name:l.get("name")+" Base"}),s.add(l)}},s.prototype.removeBlock=function(e){var t=e.get("top"),n=e.get("top")},s.prototype.addBlock=function(e){var n=new t(this.app,e);this.$blocksList.append(n.el)},s.prototype.updateBlockColumns=function(){var e=this;if(!this.app.ReferenceBlockColumnsCollection)return;var t=this.app.ReferenceBlockColumnsCollection.indexOf(this.blockColumn);this.app.ReferenceBlockColumnsCollection.each(function(n,r){if(r>t){var i=e.app.ReferenceBlockColumnsCollection.at(r-1),s=i.get("x")+i.get("width");n.set({x:s})}})},s.prototype.showBlocksList=function(){this.$blocksList.hasClass("hide")?this.$blocksList.removeClass("hide"):this.$blocksList.addClass("hide")},s.prototype.delete=function(){_.invoke(this.blockColumn.get("blocks").toArray(),"destroy"),this.element&&this.element.remove(),this.$el.remove(),this.remove()},s.prototype.destroy=function(){this.blockColumn.destroy()},s}),define("referenceColumnSideView",["baseView","referenceColumn","referenceBlockColumn","referenceBlockColumnView","referenceColumnSideView","referenceBlockMarker","referenceBlock","transectMarker"],function(e,t,n,r,i,s,o,u){var i=e.extend({el:"#ref-col-set-list",classname:"ReferenceColumnSideView",events:{"keypress :input":"updateReferenceColumnSettings","keyup :input":"updateReferenceColumnSettings","click input[type=radio]":"updateReferenceColumnSettings","dragover #reference-column-box":"dataDragover","drop #reference-column-box":"dataDrop"}});return i.prototype.template=new EJS({url:"/reference_column_maker/ejs/reference_column.ejs"}),i.prototype.settingsTemplate=new EJS({url:"/reference_column_maker/ejs/reference_column_settings.ejs"}),i.prototype.initialize=function(e){this.app=e,this.app.refCol={},this.zones=this.app.ZonesCollection,this.markers=this.app.TransectMarkersCollection,this.referenceColumn=new t({top:0,base:15}),this.app.referenceColumn=this.referenceColumn,this.listenTo(this.referenceColumn,"change:columnsData",this.render.bind(this)),this.listenTo(this.referenceColumn,"change:columnId",this.render.bind(this)),this.listenTo(this.referenceColumn,"change:top",this.render.bind(this)),this.listenTo(this.referenceColumn,"change:base",this.render.bind(this)),this.renderReferenceColumnCanvas(),this.loadReferenceColumnData()},i.prototype.listenToActionEvents=function(){var e=this;this.$enRefPanel=$("a[href='#show-ref-panel']"),this.$enRefPanel.click(function(){e.$refPanel.toggleClass("hidden")})},i.prototype.renderReferenceColumnCanvas=function(){this.$refPanel=$("#ref-panel"),this.$refPanel.html(this.template.render({})),this.app.refCol.$canvas=$("#ref-canvas"),this.$canvas=this.app.refCol.$canvas,this.app.refCol.Canvas=new Raphael(this.$canvas[0],0,0),this.app.refCol.MarkersSet=this.app.refCol.Canvas.set(),this.app.refCol.BlockMarkersSet=this.app.refCol.Canvas.set(),this.app.refCol.BlocksSet=this.app.refCol.Canvas.set(),this.listenToActionEvents()},i.prototype.loadReferenceColumnData=function(){var e=this;$.get("/commons/json/default-reference-column-data.json",function(t){e.referenceColumn.set({columnsData:t.referenceBlockColumns})})},i.prototype.render=function(){var e=this;e.$el.html(e.settingsTemplate.render(e.referenceColumn.toJSON())),this.$topAge=this.$('input[name="top-age"]'),this.$baseAge=this.$('input[name="base-age"]'),this.updateReferenceColumn()},i.prototype.updateReferenceColumnSettings=function(e){var t=this;this.$columnId=this.$('input[name="ref-column"]:checked'),t.referenceColumn.set({columnId:t.$columnId.val()}),(e.keyCode==TimescaleApp.ENTER||e.keyCode==TimescaleApp.ESC)&&t.referenceColumn.set({top:parseFloat(t.$topAge.val()),base:parseFloat(t.$baseAge.val())})},i.prototype.getColumnData=function(e){var t=null;return this.referenceColumn.get("columnsData").forEach(function(n){n.id===e&&(t=n)}),t},i.prototype.updateReferenceColumn=function(e,t,n){_.invoke(this.markers.toArray(),"destroy"),_.invoke(this.zones.toArray(),"destroy"),this.referenceColumn.get("column")&&this.referenceColumn.get("column").destroy();if(this.referenceColumn.get("top")>this.referenceColumn.get("base")||this.referenceColumn.get("columnId")==="none")return;var r=this.getColumnData(this.referenceColumn.get("columnId"));r?(this.referenceColumn.set({column:this.loadBlockColumn(r)}),this.resizeReferenceColumnCanvas()):this.referenceColumn.set({columnId:"none"})},i.prototype.loadBlockColumn=function(e){var t=this;e.x=0;var i=new n(e),s=new r(this.app.refCol,i);return t.addBlockMarkers(e,i),i},i.prototype.resizeReferenceColumnCanvas=function(){var e=this.referenceColumn.get("column").get("width"),t=this.referenceColumn.get("column").get("blockMarkes")?this.referenceColumn.get("column").get("blockMarkes").last().get("y")+100:0;t=Math.max(this.app.Canvas.height,t),this.app.refCol.Canvas.setSize(e,t),this.app.Canvas.setSize(this.app.Canvas.width,t)},i.prototype.addBlockMarkers=function(e,t){var n=this,r=n.referenceColumn.get("top"),i=n.referenceColumn.get("base");e.blockMarkers.forEach(function(s,o){if(s.age<r||s.age>i)return;n.addBlockMarkerToColumn(s,t,o,e)})},i.prototype.addBlockMarkerToColumn=function(e,t,n,r){var i=this;e.y=50*(n+1);var o=t.get("blockMarkers").findWhere({age:e.age})||new s({y:e.y,blockColumn:t,age:e.age},this.app);t.get("blockMarkers").add(o);var a=i.markers.findWhere({age:e.age})||new u(e);i.markers.add(a),o.set({name:e.name,marker:a}),a.set({name:e.name});if(n>0){var f=i.zones.last(),l=t.get("blocks").last(),c=r.blocks[n-1];f.set({name:c.name,description:c.description}),l.set({name:c.name,description:c.description}),l.get("settings").set({backgroundColor:c.settings.backgroundColor})}},i.prototype.updateBlockNames=function(e,t){var n=this;e.blocks.forEach(function(e,r,i){var s=t.get("blockMarkers").findWhere({age:e.top.age}),o=t.get("blockMarkers").findWhere({age:e.base.age}),u=n.markers.findWhere({age:e.top.age}),a=n.markers.findWhere({age:e.base.age});if(u!==null&&a!==null){var f=n.zones.findWhere({topMarker:u,baseMarker:a});f&&f.set({name:e.name,description:e.description})}if(s!==null&&o!==null){var l=t.get("blocks").findWhere({top:s,base:o});l&&(l.set({name:e.name,description:e.description}),l.get("settings").set({backgroundColor:e.settings.backgroundColor}))}})},i.prototype.dataDragover=function(e){var e=e.originalEvent;e.stopPropagation(),e.preventDefault()},i.prototype.dataDrop=function(e){$("#loading").removeClass("hide");var t=this,e=e.originalEvent;e.stopPropagation(),e.preventDefault();var n=e.dataTransfer.files[0],r=n.name.split(".").pop(),i=new FileReader;i.onloadend=function(e){r==="json"&&t.referenceColumn.set({columnsData:JSON.parse(this.result).referenceBlockColumns}),$("#loading").addClass("hide")},i.readAsText(n)},i}),define("transectAppView",["baseView","cursorView","transectsView","transectImageView","transectMarkersView","transectWellsView","transectTextsView","zonesView","polygonsView","dataImportView","dataExportView","fileSystemView","transectImage","loader","exporter","transects","transectTexts","polygons","lines","points","zones","transectWells","transectMarkers","referenceColumnSideView"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x){var T=e.extend({el:".container",classname:"TransectAppView",events:{"click a.transect-settings":"showSettings","click a.maker-tools":"enableTool","click a.continue":"showCanvas","dragover #data-box":"dataDragover","drop #data-box":"dataDrop"}});return T.prototype.initialize=function(){this.transectApp={type:"transect"},this.transectApp.TransectsCollection=new v,this.transectApp.TransectTextsCollection=new m,this.transectApp.PolygonsCollection=new g,this.transectApp.LinesCollection=new y,this.transectApp.PointsCollection=new b,this.transectApp.ZonesCollection=new w,this.transectApp.TransectWellsCollection=new E,this.transectApp.TransectMarkersCollection=new S,this.transectApp.CurrentPolygon=null,this.transectApp.x=0,this.transectApp.y=0,this.transectApp.width=2e3,this.transectApp.height=2e3,this.transectApp.StatusBox=$(".status-box"),this.$introScreen=this.$("#intro-screen"),this.transectApp.$canvas=this.$("#canvas"),this.$canvas=this.transectApp.$canvas,this.$displayPanels=this.$(".display-panel"),this.transectApp.TransectImage=new h({}),this.transectApp.Canvas=new Raphael(this.$canvas[0],this.transectApp.width,this.transectApp.height),this.transectApp.TextsSet=this.transectApp.Canvas.set(),this.transectApp.MarkersSet=this.transectApp.Canvas.set(),this.transectApp.WellsSet=this.transectApp.Canvas.set(),this.transectApp.PointsSet=this.transectApp.Canvas.set(),this.transectApp.LinesSet=this.transectApp.Canvas.set(),this.transectApp.PolygonsSet=this.transectApp.Canvas.set(),this.transectApp.loader=new p(this.transectApp),this.transectApp.exporter=new d(this.transectApp),this.listenToActionEvents(),this.render()},T.prototype.listenToActionEvents=function(){var e=this;$(".close-reveal-modal").click(function(e){$(e.target).parent().foundation("reveal","close")}),$("a[href=#continue-load-from-local-storage]").click(function(t){$(t.target).parent().foundation("reveal","close"),e.loadFromLocalStorage()}),$("a[href=#continue-save-to-local-storage]").click(function(t){$(t.target).parent().foundation("reveal","close"),e.saveToLocalStorage()})},T.prototype.showCanvas=function(){this.$canvas.removeClass("hide"),this.$introScreen.addClass("hide")},T.prototype.render=function(){this.dataImportView=new f(this.transectApp),this.dataExportView=new l(this.transectApp),this.fileSystemView=new c(this.transectApp),this.cursorView=new t(this.transectApp),this.transectImageView=new r(this.transectApp),this.transectMarkersView=new i(this.transectApp),this.zonesView=new u(this.transectApp),this.transectWellsView=new s(this.transectApp),this.transectsView=new n(this.transectApp),this.transectTextsView=new o(this.transectApp),this.polygonsView=new a(this.transectApp),this.referenceColumnSideView=new x(this.transectApp,"#reference-column-settings"),$(".linked").scroll(function(){$(".linked").scrollTop($(this).scrollTop())})},T.prototype.showSettings=function(e){var t=e.target.getAttribute("href")+"-list";$(t).hasClass("active")?($(t).removeClass("active"),$(e.target).removeClass("active"),$(e.target).parent().removeClass("active"),this.$("#sections-panel").removeClass("active")):(this.$(".settings-content").removeClass("active"),this.$(".settings-links").removeClass("active"),this.$(".transect-settings").removeClass("active"),$(t).addClass("active"),$(e.target).addClass("active"),$(e.target).parent().addClass("active"),this.$("#sections-panel").addClass("active"))},T.prototype.showExportDataPanel=function(e){this.$exportPanel.hasClass("active")||this.dataExportView.render()},T.prototype.exportCanvasAsImage=function(){},T.prototype.saveToLocalStorage=function(){this.transectApp.exporter.export(),localStorage.transectApp=this.transectApp.exporter.getJSON()},T.prototype.loadFromLocalStorage=function(){$("#loading").removeClass("hide"),this.showCanvas(),this.transectApp.loader.loadFromLocalStorage(),$("#loading").addClass("hide")},T.prototype.dataDragover=function(e){var e=e.originalEvent;e.stopPropagation(),e.preventDefault()},T.prototype.dataDrop=function(e){$("#loading").removeClass("hide");var t=this,e=e.originalEvent;e.stopPropagation(),e.preventDefault();var n=e.dataTransfer.files[0],r=n.name.split(".").pop(),i=new FileReader;i.onloadend=function(e){t.showCanvas(),r==="json"&&t.transectApp.loader.loadData(this.result),$("#loading").addClass("hide")},i.readAsText(n)},T.prototype.enableTool=function(e){var t=e.target.getAttribute("href");if(t==="#new-polygon"||t==="#lock-cursor-h"||t==="#lock-cursor-v")return;this.transectMarkersView.enMarkers&&this.transectMarkersView.toggleMarkers(),this.transectWellsView.enWells&&this.transectWellsView.toggleWells(),this.transectTextsView.enTransectTexts&&this.transectTextsView.toggleTransectTexts(),this.polygonsView.enPolygons&&this.polygonsView.togglePolygons(),this.transectApp.Cursor.get("lockH")&&this.cursorView.toggleHlock(),this.transectApp.Cursor.get("lockV")&&this.cursorView.toggleVlock(),this.polygonsView.checkAndDeleteCurrentPolygon();switch(t){case"#add-marker":this.transectMarkersView.toggleMarkers();break;case"#add-well":this.transectWellsView.toggleWells();break;case"#add-transect-text":this.transectTextsView.toggleTransectTexts();break;case"#add-polygon":this.polygonsView.togglePolygons();break;case"#export-data":this.dataExportView.toggleExportView();break;case"#file-system":this.fileSystemView.toggleView();break;case"#save-to-local-storage":$("#quick-save-data").foundation("reveal","open");break;case"#reload-data":$("#load-saved-data").foundation("reveal","open");default:}},T}),requirejs.config({paths:{baseView:"/commons/js/views/base_view",baseModel:"/commons/js/models/base_model",baseCollection:"/commons/js/collections/base_collection",app:"/commons/js/models/app",cursorView:"/commons/js/views/cursor_view",cursor:"/commons/js/models/cursor",transectImageView:"/transect_maker/js/views/transect_image_view",transectImage:"/transect_maker/js/models/transect_image",transectMarkersView:"/transect_maker/js/views/transect_markers_view",transectMarkerView:"/transect_maker/js/views/transect_marker_view",transectMarker:"/transect_maker/js/models/transect_marker",transectMarkers:"/transect_maker/js/collections/transect_markers",transectWellsView:"/transect_maker/js/views/transect_wells_view",transectWellView:"/transect_maker/js/views/transect_well_view",transectWell:"/transect_maker/js/models/transect_well",transectWells:"/transect_maker/js/collections/transect_wells",zoneView:"/transect_maker/js/views/zone_view",zonesView:"/transect_maker/js/views/zones_view",zone:"/transect_maker/js/models/zone",zones:"/transect_maker/js/collections/zones",transectView:"/transect_maker/js/views/transect_view",transectsView:"/transect_maker/js/views/transects_view",transect:"/transect_maker/js/models/transect",transects:"/transect_maker/js/collections/transects",polygonView:"/transect_maker/js/views/polygon_view",polygonsView:"/transect_maker/js/views/polygons_view",polygon:"/transect_maker/js/models/polygon",polygons:"/transect_maker/js/collections/polygons",pointView:"/transect_maker/js/views/point_view",point:"/transect_maker/js/models/point",points:"/transect_maker/js/collections/points",lineView:"/transect_maker/js/views/line_view",line:"/transect_maker/js/models/line",lines:"/transect_maker/js/collections/lines",transectTextView:"/transect_maker/js/views/transect_text_view",transectTextsView:"/transect_maker/js/views/transect_texts_view",transectText:"/transect_maker/js/models/transect_text",transectTexts:"/transect_maker/js/collections/transect_texts",exporter:"/transect_maker/js/utils/exporter",dataExportView:"/transect_maker/js/views/data_export_view",loader:"/transect_maker/js/utils/loader",dataImportView:"/transect_maker/js/views/data_import_view",transectAppView:"/transect_maker/js/views/transect_app_view",settings:"/commons/js/models/settings",polyK:"/commons/js/lib/polyK",file:"/file_system/js/models/file",files:"/file_system/js/collections/files",fileView:"/file_system/js/views/file_view",filesView:"/file_system/js/views/files_view",fileSystem:"/file_system/js/models/file_system",fileSystemView:"/file_system/js/views/file_system_view",referenceColumnLoader:"/reference_column_maker/js/utils/loader",referenceColumn:"/reference_column_maker/js/models/reference_column",referenceBlock:"/reference_column_maker/js/models/reference_block",referenceBlocks:"/reference_column_maker/js/collections/reference_blocks",referenceBlockMarker:"/reference_column_maker/js/models/reference_block_marker",referenceBlockMarkers:"/reference_column_maker/js/collections/reference_block_markers",referenceBlockColumn:"/reference_column_maker/js/models/reference_block_column",referenceBlockColumns:"/reference_column_maker/js/collections/reference_block_columns",referenceBlockView:"/reference_column_maker/js/views/reference_block_view",referenceBlockMarkerView:"/reference_column_maker/js/views/reference_block_marker_view",referenceBlockColumnView:"/reference_column_maker/js/views/reference_block_column_view",referenceBlockColumnsView:"/reference_column_maker/js/views/reference_block_columns_view",referenceColumnSideView:"/reference_column_maker/js/views/reference_column_side_view"}});var transectApp=transectApp||{};requirejs(["transectAppView"],function(e){var t=new e}),define("transect_maker/js/transect_app",function(){});