/*
		PolyK library
		url: http://polyk.ivank.net
		Released under MIT licence.
		
		Copyright (c) 2012 Ivan Kuckir

		Permission is hereby granted, free of charge, to any person
		obtaining a copy of this software and associated documentation
		files (the "Software"), to deal in the Software without
		restriction, including without limitation the rights to use,
		copy, modify, merge, publish, distribute, sublicense, and/or sell
		copies of the Software, and to permit persons to whom the
		Software is furnished to do so, subject to the following
		conditions:

		The above copyright notice and this permission notice shall be
		included in all copies or substantial portions of the Software.

		THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
		EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
		OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
		NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
		HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
		WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
		FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
		OTHER DEALINGS IN THE SOFTWARE.
	*/

define("baseView",[],function(){var e=Backbone.View.extend({});return e.prototype.wrapString=function(e,t,n,r){n=n||"\n",t=t||75,r=r||!1;if(!e)return e;var i=".{1,"+t+"}(\\s|$)"+(r?"|.{"+t+"}|.+$":"|\\S+?(\\s|$)");return e.match(RegExp(i,"g")).join(n)},e}),define("baseModel",[],function(){var e=Backbone.Model.extend({localStorage:new Backbone.LocalStorage("timescale-creator")});return e}),define("cursor",["baseModel"],function(e){var t=e.extend({constructor:function(t,n){var r=[{lockH:!1,lockV:!1}];e.apply(this,r)}});return t});var transectApp=transectApp||{};define("cursorView",["baseView","cursor"],function(e,t){var n=e.extend({el:".main",classname:"CursorView",events:{keypress:"togglelock",'click a[href="#lock-cursor-h"]':"toggleHlock",'click a[href="#lock-cursor-v"]':"toggleVlock"}});return n.prototype.initialize=function(){this.cursor=new t,transectApp.Cursor=this.cursor,this.$hLock=this.$('a[href="#lock-cursor-h"]'),this.$vLock=this.$('a[href="#lock-cursor-v"]')},n.prototype.togglelock=function(e){e.keyCode==transectApp.KEY_1&&this.toggleHlock(),e.keyCode==transectApp.KEY_2&&this.toggleVlock()},n.prototype.toggleHlock=function(){this.$hLock.parent().toggleClass("active"),this.cursor.set({lockH:!this.cursor.get("lockH")})},n.prototype.toggleVlock=function(){this.$vLock.parent().toggleClass("active"),this.cursor.set({lockV:!this.cursor.get("lockV")})},n}),define("transectView",["baseView"],function(e){var t=e.extend({tagName:"li",classname:"TransectView",events:{"click .toggle":"toggleTransectForm","click .transect-data":"toggleTransectForm","keypress :input":"updateTransect","keyup :input":"updateTransect",mouseover:"onMouseOver",mouseout:"onMouseOut"}});return t.prototype.template=new EJS({url:"../../../transect_maker/ejs/transect.ejs"}),t.prototype.initialize=function(e){this.transect=e,this.listenTo(this.transect,"change:edit",this.toggleEditStatus.bind(this)),this.render()},t.prototype.render=function(){this.$el.html(this.template.render(this.transect.toJSON())),this.$transectForm=this.$(".transect-form"),this.$transectData=this.$(".transect-data"),this.$destroy=this.$(".destroy"),this.$toggle=this.$(".toggle"),this.$update=this.$(".update"),this.$name=this.$("input[name*=transect-name]")[0],this.$description=this.$("textarea[name*=transect-description]")[0]},t.prototype.toggleTransectForm=function(){this.render(),this.transect.set({edit:!this.transect.get("edit")})},t.prototype.toggleEditStatus=function(){this.transect.get("edit")?(this.$transectForm.removeClass("hide"),this.$transectData.addClass("hide"),this.$toggle.removeClass("hide-data"),this.$toggle.addClass("show-data")):(this.$transectForm.addClass("hide"),this.$transectData.removeClass("hide"),this.$toggle.removeClass("show-data"),this.$toggle.addClass("hide-data"))},t.prototype.onMouseOver=function(){this.$el.addClass("hover"),this.transect.get("wellLeft").set({hover:!0}),this.transect.get("wellRight").set({hover:!0})},t.prototype.onMouseOut=function(){this.$el.removeClass("hover"),this.transect.get("wellLeft").set({hover:!1}),this.transect.get("wellRight").set({hover:!1})},t.prototype.updateTransect=function(e){(e.keyCode==transectApp.ENTER||e.keyCode==transectApp.ESC)&&this.toggleTransectForm();var t=this.$name.value,n=this.$description.value;this.transect.set({name:t,description:n})},t}),define("baseCollection",[],function(){var e=Backbone.Collection.extend({localStorage:new Backbone.LocalStorage("timescale-creator")});return e}),define("settings",["baseModel"],function(e){var t=e.extend({classname:"Settings",constructor:function(t,n){var r=[{fontFamily:t?t.fontFamily:"Arial, Helvetica, sans-serif",fontVariant:t?t.fontVariant:"normal",fontWeight:t?t.fontWeight:"normal",fontStretch:t?t.fontStretch:"normal",fontSize:t?t.fontSize:12,backgroundColor:t&&t.backgroundColor?TscToCssColor(t.backgroundColor):"#DDDDDD",fill:t&&t.fill?TscToCssColor(t.fill):"#000000",strokeWidth:t?t.strokeWidth:3,strokeColor:t?t.strokeColor:"#000000"}];e.apply(this,r)}});return t}),define("transect",["baseModel","settings"],function(e,t){var n=e.extend({classname:"Transect",constructor:function(n,r,i){var s=[{name:n.name||_.uniqueId("Transect-"),id:_.uniqueId("transect-"),description:n.description||null,wellLeft:r,wellRight:i,settings:new t,width:500,status:"on"}];e.apply(this,s)}});return n.prototype.isXInsideTransect=function(e){return this.get("wellLeft").get("x")<=e&&e<this.get("wellRight").get("x")?!0:!1},n.prototype.getRelativeX=function(e){if(this.get("wellLeft").get("x")<=e&&e<this.get("wellRight").get("x")){var t=(e-this.get("wellLeft").get("x"))/(this.get("wellRight").get("x")-this.get("wellLeft").get("x"));return Math.round(t*1e3)/1e3}return null},n.prototype.getPolyKPointsArray=function(){return[this.get("wellLeft").get("x"),0,this.get("wellRight").get("x"),0,this.get("wellRight").get("x"),transectApp.Canvas.height,this.get("wellLeft").get("x"),transectApp.Canvas.height]},n});var transectApp=transectApp||{};define("transects",["baseCollection","transect"],function(e,t){var n=e.extend({classname:"Transects",model:t});return n.prototype.getTransectForX=function(e){var t=null;return this.each(function(n){n.isXInsideTransect(e)&&(t=n)}),t},n}),define("transectsView",["baseView","transectView","transects"],function(e,t,n){var r=e.extend({el:"#transects-list",classname:"TransectsView"});return r.prototype.template=new EJS({url:"/commons/ejs/data_tbl.ejs"}),r.prototype.initialize=function(){this.transects=transectApp.TransectsCollection,this.render(),this.listenTo(this.transects,"add",this.addTransect.bind(this)),this.listenTo(this.transects,"reset",this.render.bind(this))},r.prototype.render=function(){this.$el.html(this.template.render({name:"Transect"})),this.$transectsTable=this.$(".data-list"),this.transects.each(this.addTransect.bind(this))},r.prototype.addTransect=function(e){var n=new t(e);this.$transectsTable.append(n.el)},r.prototype.resetTransect=function(){this.$transectsTable(""),this.transects.each(this.addTransect,this)},r}),define("transectImage",["baseModel"],function(e){var t=e.extend({classname:"TransectImage",constructor:function(t,n){var r=[{x:"x"in t?t.x:0,y:"y"in t?t.y:0,width:"width"in t?t.width:null,height:"height"in t?t.height:null,origWidth:"origWidth"in t?t.origWidth:null,origHeight:"origHeight"in t?t.origHeight:null,angle:"angle"in t?t.angle:0,preserveAspectRatio:"preserveAspectRatio"in t?t.preserveAspectRatio:!0,data:"data"in t?t.data:null}];e.apply(this,r)}});return t});var transectApp=transectApp||{};define("transectImageView",["baseView","transectImage"],function(e,t){var n=e.extend({el:"#bg-image-settings-list",classname:"TransectImageView",events:{'change input[name="width"]':"updateImageWidth",'change input[name="height"]':"updateImageHeight",'change input[name="preserve-aspect-ratio"]':"updateImage",'change input[name="angle"]':"updateImage","dragover #image-box":"imageDragover","drop #image-box":"imageDrop"}});return n.prototype.template=new EJS({url:"/transect_maker/ejs/transect_image_settings.ejs"}),n.prototype.initialize=function(){this.transectImage=transectApp.TransectImage,this.listenTo(this.transectImage,"change",this.renderImage.bind(this)),this.render()},n.prototype.render=function(){this.$el.html(this.template.render(this.transectImage.toJSON())),this.$width=this.$('input[name="width"]')[0],this.$height=this.$('input[name="height"]')[0],this.$preserveAspectRatio=this.$('input[name="preserve-aspect-ratio"]')[0],this.$angle=this.$('input[name="angle"]')[0]},n.prototype.renderImage=function(){if(this.transectImage.get("data")===null)return;this.element===undefined&&(this.element=transectApp.Canvas.image(this.transectImage.get("data")),this.element.toBack(),transectApp.transectImageElement=this.element),this.element.attr({x:this.transectImage.get("x"),y:this.transectImage.get("y"),width:this.transectImage.get("width"),height:this.transectImage.get("height")}),(this.transectImage.get("origHeight")==null||this.transectImage.get("origWidth")==null)&&this.transectImage.set({origWidth:this.transectImage.get("width"),origHeight:this.transectImage.get("height")}),this.rotate(this.transectImage.get("angle")),this.updateHtmlElements(),this.resizeCanvas()},n.prototype.updateHtmlElements=function(){if(this.transectImage.get("data")===null)return;this.$width.value=this.transectImage.get("width"),this.$height.value=this.transectImage.get("height"),this.$angle.value=this.transectImage.get("angle")},n.prototype.rotate=function(e){if(this.transectImage.get("data")===null)return;var t="t0,0r"+e;this.element.transform(t)},n.prototype.resizeCanvas=function(){if(this.transectImage.get("data")===null)return;var e=this.element.getBBox(),t="t"+ -e.x+","+ -e.y+"r"+this.transectImage.get("angle");this.element.transform(t),transectApp.Canvas.setSize(e.width+50,e.height+50)},n.prototype.updateImageWidth=function(){if(this.transectImage.get("data")===null)return;if(this.transectImage.get("preserveAspectRatio")){var e=parseInt(this.$width.value)*this.transectImage.get("origHeight")/this.transectImage.get("origWidth");this.$height.value=e}this.updateImage()},n.prototype.updateImageHeight=function(){if(this.transectImage.get("data")===null)return;if(this.transectImage.get("preserveAspectRatio")){var e=parseInt(this.$height.value)*this.transectImage.get("origWidth")/this.transectImage.get("origHeight");this.$width.value=e}this.updateImage()},n.prototype.updateImage=function(){if(this.transectImage.get("data")===null)return;this.transectImage.set({width:parseInt(this.$width.value),height:parseInt(this.$height.value),angle:parseFloat(this.$angle.value),preserveAspectRatio:this.$preserveAspectRatio.checked})},n.prototype.imageDragover=function(e){var e=e.originalEvent;e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"},n.prototype.imageDrop=function(e){var e=e.originalEvent;e.stopPropagation(),e.preventDefault();var t=e.dataTransfer.files[0];if(t.type==="image/png"||t.type==="image/jpg"||t.type==="image/jpeg"||t.type==="image/gif"){var n=new FileReader;n.onload=this.readImage.bind(this),n.readAsDataURL(t)}},n.prototype.readImage=function(e){var t=this,n=new Image;$(n).load(function(){transectApp.TransectImage.set({data:e.target.result,width:n.width,height:n.height})}),n.src=e.target.result},n}),define("transectMarkerView",["baseView"],function(e){var t=e.extend({tagName:"li",classname:"TransectMarkerView",events:{"click .toggle":"toggleMarkerForm","click .marker-data":"toggleMarkerForm","click .destroy":"destroy","keypress :input":"updateMarker","keyup :input":"updateMarker",mouseover:"onMouseOver",mouseout:"onMouseOut"}});return t.prototype.template=new EJS({url:"/transect_maker/ejs/transect_marker.ejs"}),t.prototype.initialize=function(e,t){this.transectMarkersView=t,this.transectMarker=e,this.render(),this.listenTo(this.transectMarker,"change:edit",this.editTransectMarker.bind(this)),this.listenTo(this.transectMarker,"change:y",this.renderMarker.bind(this)),this.listenTo(this.transectMarker,"change:age",this.renderMarker.bind(this)),this.listenTo(this.transectMarker,"change:name",this.renderMarker.bind(this)),this.listenTo(this.transectMarker,"change:hover",this.setHoverStatus.bind(this)),this.listenTo(this.transectMarker,"destroy",this.delete.bind(this))},t.prototype.render=function(){return this.$el.html(this.template.render(this.transectMarker.toJSON())),this.$toggle=this.$(".toggle"),this.$markerForm=this.$(".marker-form"),this.$markerData=this.$(".marker-data"),this.$markerName=this.$('input[name="marker-name"]')[0],this.$markerAge=this.$('input[name="marker-age"]')[0],this.editTransectMarker(),this.renderMarker(),this},t.prototype.renderMarker=function(){this.element===undefined&&(this.element=transectApp.Canvas.path(),this.element.attr({"stroke-width":2,stroke:"#900000"}),this.element.hover(this.onMouseOver.bind(this),this.onMouseOut.bind(this)),this.element.drag(this.dragMove.bind(this),this.dragStart.bind(this),this.dragEnd.bind(this)),this.renderTooltip(),this.element.toFront(),transectApp.MarkersSet.push(this.element)),this.element.attr({path:this.getPath()}),transectApp.PointsCollection.updatePoints(),transectApp.TransectTextsCollection.updateTransectTexts()},t.prototype.renderTooltip=function(){$(this.element.node).qtip({content:{text:this.transectMarker.get("name")+"【"+(this.transectMarker.get("age")||"-")+" myr】"},position:{my:"bottom left",target:"mouse"}})},t.prototype.getPath=function(){return"M0,"+this.transectMarker.get("y")+"H"+transectApp.Canvas.width},t.prototype.dragStart=function(e,t,n){},t.prototype.dragMove=function(e,t,n,r,i){transectApp.PointsCollection.updatePoints()&&this.transectMarker.set({y:i.offsetY})},t.prototype.dragEnd=function(e){},t.prototype.onMouseOver=function(){this.transectMarkersView.undelegateEvents(),this.$el.addClass("hover"),this.transectMarker.set({hover:!0})},t.prototype.onMouseOut=function(){this.transectMarkersView.delegateEvents(),this.$el.removeClass("hover"),this.transectMarker.set({hover:!1})},t.prototype.setHoverStatus=function(){this.transectMarker.get("hover")?(this.element.attr({"stroke-width":5}),this.$el.addClass("hover")):(this.element.attr({"stroke-width":2}),this.$el.removeClass("hover"))},t.prototype.toggleMarkerForm=function(){this.render(),this.transectMarker.set({edit:!this.transectMarker.get("edit")})},t.prototype.editTransectMarker=function(){this.transectMarker.get("edit")?(this.$markerForm.removeClass("hide"),this.$markerData.addClass("hide"),this.$toggle.removeClass("hide-data"),this.$toggle.addClass("show-data")):(this.$markerForm.addClass("hide"),this.$markerData.removeClass("hide"),this.$toggle.removeClass("show-data"),this.$toggle.addClass("hide-data"))},t.prototype.updateMarker=function(e){e.keyCode==13&&this.toggleMarkerForm();var t=this.$markerName.value,n=parseFloat(this.$markerAge.value)||0;this.transectMarker.set({name:t,age:n})},t.prototype.delete=function(){this.element!==undefined&&this.element.remove(),this.$el.remove(),this.remove()},t.prototype.destroy=function(){this.transectMarker.destroy()},t}),define("transectMarker",["baseModel"],function(e){var t=e.extend({classname:"TransectMarker",constructor:function(t,n){var r=[{edit:!1,name:t.name||_.uniqueId("Time Line "),y:t.y,age:t.age!==undefined?t.age:null,hover:!1}];e.apply(this,r)}});return t}),define("zone",["baseModel"],function(e){var t=e.extend({classname:"Zone",constructor:function(t,n,r){var i=[{edit:!1,name:t.name||_.uniqueId("Zone "),description:t.description||null,topMarker:n,baseMarker:r}];e.apply(this,i)}});return t.prototype.isYInsideZone=function(e){return this.get("topMarker").get("y")<=e&&e<this.get("baseMarker").get("y")?!0:!1},t.prototype.getRelativeY=function(e){if(this.get("topMarker").get("y")<=e&&e<this.get("baseMarker").get("y")){var t=(e-this.get("topMarker").get("y"))/(this.get("baseMarker").get("y")-this.get("topMarker").get("y"));return Math.round(t*1e3)/1e3}return null},t.prototype.getAbsoluteAge=function(e){if(this.get("topMarker").get("y")<=e&&e<this.get("baseMarker").get("y")&&this.get("topMarker").get("age")!=null&&this.get("baseMarker").get("age")!=null){var t=(e-this.get("topMarker").get("y"))/(this.get("baseMarker").get("y")-this.get("topMarker").get("y"));return age=t*(this.get("baseMarker").get("age")-this.get("topMarker").get("age"))+this.get("topMarker").get("age"),Math.round(age*100)/100}return null},t}),define("transectMarkersView",["baseView","transectMarkerView","transectMarker","zone"],function(e,t,n,r){var i=e.extend({el:"#markers-list",classname:"TransectMarkersView"});return i.prototype.template=new EJS({url:"../../../commons/ejs/data_tbl.ejs"}),i.prototype.initialize=function(){this.transectZones=transectApp.ZonesCollection,this.transectMarkers=transectApp.TransectMarkersCollection,this.enMarkers=!1,this.listenTo(this.transectMarkers,"add",this.render.bind(this)),this.listenTo(this.transectMarkers,"remove",this.render.bind(this)),this.listenToActionEvents(),this.render()},i.prototype.listenToActionEvents=function(){$("#canvas").bind("dblclick",this.createMarker.bind(this))},i.prototype.render=function(){this.$el.html(this.template.render({name:"Markers"})),this.$markersTable=this.$(".data-list"),this.renderMarkers()},i.prototype.renderMarkers=function(){this.transectMarkers.each(this.addMarker.bind(this))},i.prototype.addMarker=function(e){var n=new t(e,this);this.$markersTable.append(n.el),this.updateZones(),transectApp.PointsCollection.updatePoints(),transectApp.TransectTextsCollection.updateTransectTexts()},i.prototype.toggleMarkers=function(e){$("a[href='#add-marker']").parent().hasClass("active")?($("a[href='#add-marker']").parent().removeClass("active"),this.enMarkers=!1):($("a[href='#add-marker']").parent().addClass("active"),this.enMarkers=!0)},i.prototype.createMarker=function(e){this.enMarkers&&this.transectMarkers.add(new n({y:e.offsetY}))},i.prototype.updateZones=function(){var e=[];this.transectMarkers.each(function(t,n,i){n>0&&e.push(new r({name:"Zone "+n},i[n-1],t))}),this.transectZones.reset(e)},i}),define("transectWellView",["baseView"],function(e){var t=e.extend({tagName:"li",classname:"TransectWellView",events:{"click .toggle":"toggleWellForm","click .well-data":"toggleWellForm","click .destroy":"destroy","keypress :input":"updateWell","keyup :input":"updateWell",mouseover:"onMouseOver",mouseout:"onMouseOut"}});return t.prototype.template=new EJS({url:"../../../transect_maker/ejs/transect_well.ejs"}),t.prototype.initialize=function(e,t){this.transectWell=e,this.transectWellsView=t,this.render(),this.listenTo(this.transectWell,"change:edit",this.editTransectWell.bind(this)),this.listenTo(this.transectWell,"change:x",this.renderWell.bind(this)),this.listenTo(this.transectWell,"change:name",this.renderWell.bind(this)),this.listenTo(this.transectWell,"change:lat",this.renderWell.bind(this)),this.listenTo(this.transectWell,"change:lon",this.renderWell.bind(this)),this.listenTo(this.transectWell,"change:hover",this.setHoverStatus.bind(this)),this.listenTo(this.transectWell,"destroy",this.delete.bind(this))},t.prototype.render=function(){this.$el.html(this.template.render(this.transectWell.toJSON())),this.$toggle=this.$(".toggle"),this.$wellForm=this.$(".well-form"),this.$wellData=this.$(".well-data"),this.$wellName=this.$('input[name="well-name"]')[0],this.$wellLat=this.$('input[name="well-lat"]')[0],this.$wellLon=this.$('input[name="well-lon"]')[0],this.editTransectWell(),this.renderWell()},t.prototype.renderWell=function(){this.element===undefined&&(this.element=transectApp.Canvas.path(),this.element.attr({"stroke-width":2,stroke:"#900000"}),transectApp.WellsSet.push(this.element),this.element.hover(this.onMouseOver.bind(this),this.onMouseOut.bind(this)),this.element.drag(this.dragMove.bind(this),this.dragStart.bind(this),this.dragEnd.bind(this)),this.renderTooltip()),this.element.attr({path:this.getPath()})},t.prototype.renderTooltip=function(){$(this.element.node).qtip({content:{text:this.transectWell.get("name")},position:{my:"left bottom",at:"left middle",target:"mouse"}})},t.prototype.getPath=function(){return"M"+this.transectWell.get("x")+",0"+"V"+transectApp.Canvas.height},t.prototype.dragStart=function(e,t,n){},t.prototype.dragMove=function(e,t,n,r,i){transectApp.PointsCollection.updatePoints()&&this.transectWell.set({x:i.offsetX})},t.prototype.dragEnd=function(e){},t.prototype.onMouseOver=function(){this.transectWellsView.undelegateEvents(),this.transectWell.set({hover:!0})},t.prototype.onMouseOut=function(){this.transectWellsView.delegateEvents(),this.transectWell.set({hover:!1})},t.prototype.setHoverStatus=function(){this.transectWell.get("hover")?(this.element.attr({"stroke-width":5}),this.$el.addClass("hover")):(this.element.attr({"stroke-width":2}),this.$el.removeClass("hover"))},t.prototype.toggleWellForm=function(){this.render(),this.transectWell.set({edit:!this.transectWell.get("edit")})},t.prototype.editTransectWell=function(){this.transectWell.get("edit")?(this.$wellForm.removeClass("hide"),this.$wellData.addClass("hide"),this.$toggle.removeClass("hide-data"),this.$toggle.addClass("show-data")):(this.$wellForm.addClass("hide"),this.$wellData.removeClass("hide"),this.$toggle.removeClass("show-data"),this.$toggle.addClass("hide-data"))},t.prototype.updateWell=function(e){(e.keyCode==transectApp.ENTER||e.keyCode==transectApp.ESC)&&this.toggleWellForm();var t=this.$wellName.value,n=parseFloat(this.$wellLat.value),r=parseFloat(this.$wellLon.value);this.transectWell.set({name:t,lat:n,lon:r})},t.prototype.delete=function(){this.element!==undefined&&this.element.remove(),this.$el.remove(),this.remove()},t.prototype.destroy=function(){this.transectWell.destroy()},t}),define("transectWell",["baseModel","settings"],function(e,t){var n=e.extend({classname:"TransectWell",constructor:function(n,r){var i=[{edit:!1,name:n.name||_.uniqueId("Well "),id:n.id||_.uniqueId("well-"),x:n.x,lat:null,lon:null,settings:new t,width:100,hover:!1}];e.apply(this,i)}});return n}),define("transectWellsView",["baseView","transectWellView","transectWell","transect"],function(e,t,n,r){var i=e.extend({el:"#wells-list",classname:"TransectWellsView"});return i.prototype.template=new EJS({url:"../../../commons/ejs/data_tbl.ejs"}),i.prototype.initialize=function(){this.transectWells=transectApp.TransectWellsCollection,this.enWells=!1,this.render(),this.listenToActionEvents(),this.listenTo(this.transectWells,"add",this.addWell.bind(this)),this.listenTo(this.transectWells,"remove",this.addWell.bind(this))},i.prototype.render=function(){this.$el.html(this.template.render({name:"Reference Wells"})),this.$wellsTable=this.$(".data-list"),this.renderWells()},i.prototype.listenToActionEvents=function(){$("#canvas").bind("dblclick",this.createWell.bind(this))},i.prototype.renderWells=function(){this.transectWells.each(this.addWell.bind(this))},i.prototype.addWell=function(e){var n=new t(e,this);this.$wellsTable.append(n.el),this.updateTransects(),transectApp.PointsCollection.updatePoints(),transectApp.TransectTextsCollection.updateTransectTexts()},i.prototype.toggleWells=function(e){$("a[href='#add-well']").parent().hasClass("active")?($("a[href='#add-well']").parent().removeClass("active"),this.enWells=!1):($("a[href='#add-well']").parent().addClass("active"),this.enWells=!0)},i.prototype.createWell=function(e){this.enWells&&this.transectWells.add(new n({x:e.offsetX}))},i.prototype.wellAdded=function(){this.render()},i.prototype.updateTransects=function(){var e=[];this.transectWells.each(function(t,n,i){n>0&&e.push(new r({name:"Transect "+n},i[n-1],t))}),transectApp.TransectsCollection.reset(e)},i}),define("point",["baseModel"],function(e){var t=e.extend({classname:"Point",constructor:function(t,n){var r=[{edit:!1,name:t.name||_.uniqueId("X"),x:t.x?parseInt(t.x):0,y:t.y?parseInt(t.y):0,age:0,relativeX:null,relativeY:null,transect:null,zone:null}];e.apply(this,r)}});return t.prototype.initialize=function(){this.updateTransectAndZone()},t.prototype.updateTransectAndZone=function(){var e=transectApp.ZonesCollection.getZoneForY(this.get("y")),t=transectApp.TransectsCollection.getTransectForX(this.get("x"));e!==null&&t!==null&&(this.set({transect:t,zone:e}),this.updateRelativeCoordinates())},t.prototype.updateRelativeCoordinates=function(){this.set({relativeX:this.get("transect").getRelativeX(this.get("x")),relativeY:this.get("zone").getRelativeY(this.get("y")),age:this.get("zone").getAbsoluteAge(this.get("y"))})},t.prototype.toJSON=function(){var e=_.clone(this.attributes);return delete e.transect,delete e.zone,e},t.prototype.toStatusJSON=function(){var e=_.clone(this.attributes);return e},t}),define("transectTextView",["baseView","point"],function(e,t){var n=e.extend({tagName:"li",classname:"TransectTextView",events:{"click .toggle":"toggleTextForm","click .text-data":"toggleTextForm","click .destroy":"destroy","keypress :input":"updateText","keyup :input":"updateText",'change select[name="text-font-family"]':"updateText",'change input[name="text-font-size"]':"updateText",'change input[name="text-font-color"]':"updateText",mouseover:"onMouseOver",mouseout:"onMouseOut"}});return n.prototype.template=new EJS({url:"/transect_maker/ejs/transect_text.ejs"}),n.prototype.initialize=function(e,t){this.transectTextsView=t,this.transectText=e,this.render(),this.listenTo(this.transectText,"change:x",this.renderTransectText.bind(this)),this.listenTo(this.transectText,"change:y",this.renderTransectText.bind(this)),this.listenTo(this.transectText,"change:edit",this.editTransectText.bind(this)),this.listenTo(this.transectText,"change:text",this.renderTransectText.bind(this)),this.listenTo(this.transectText,"destroy",this.delete.bind(this)),this.listenTo(this.transectText.get("settings"),"change",this.renderTransectText.bind(this))},n.prototype.render=function(){return this.$el.html(this.template.render(this.transectText.toJSON())),this.$toggle=this.$(".toggle"),this.$textForm=this.$(".text-form"),this.$textData=this.$(".text-data"),this.$textText=this.$("textarea[name*=text-name]")[0],this.$textFontSize=this.$("input[name*=text-font-size]")[0],this.$textFontColor=this.$("input[name*=text-font-color]")[0],this.editTransectText(),this.renderTransectText(),this},n.prototype.renderTransectText=function(){this.set=transectApp.Canvas.set();if(this.element===undefined||this.boundingBox===undefined)this.backgroundBox=transectApp.Canvas.rect(),this.element=transectApp.Canvas.text(),this.boundingBox=transectApp.Canvas.rect(),this.set.push(this.backgroundBox),this.set.push(this.element),this.set.push(this.boundingBox),transectApp.TextsSet.push(this.set),this.boundingBox.attr({fill:"#f1f1f1","fill-opacity":0,r:"2px"}),this.backgroundBox.attr({fill:"#fff","fill-opacity":1,r:"2px"}),this.boundingBox.hover(this.onMouseOver.bind(this),this.onMouseOut.bind(this)),this.boundingBox.drag(this.dragMove.bind(this),this.dragStart.bind(this),this.dragEnd.bind(this));this.element.attr({"font-size":this.transectText.get("settings").get("fontSize"),"font-family":this.transectText.get("settings").get("fontFamily"),fill:this.transectText.get("settings").get("fill")}),this.element.attr({text:this.transectText.get("text"),x:this.transectText.get("x"),y:this.transectText.get("y")}),this.backgroundBox.attr({width:this.element.getBBox().width,height:this.element.getBBox().height,x:this.element.getBBox().x,y:this.element.getBBox().y}),this.boundingBox.attr({width:this.element.getBBox().width,height:this.element.getBBox().height,x:this.element.getBBox().x,y:this.element.getBBox().y}),this.updateTscBBox(),this.renderTooltip()},n.prototype.updateTscBBox=function(){var e=this.transectText.get("transect"),t=this.transectText.get("zone"),n=this.element.getBBox(),r=n.x,i=n.y+n.height,s=n.x2,o=n.y2-n.height,r=Math.round(e.getRelativeX(r)*1e3)/10,s=Math.round(e.getRelativeX(s)*1e3)/10,i=t.getAbsoluteAge(i),o=t.getAbsoluteAge(o);this.transectText.set({bBox:{x1:r,x2:s,y1:i,y2:o}})},n.prototype.renderTooltip=function(){var e=this.transectText.get("text")+"<br/>";e+=this.transectText.get("zone").get("name")+"<br/>",e+=this.transectText.get("transect").get("name")+"<br/>",e+="Font Family: "+this.transectText.get("settings").get("fontFamily")+"<br/>",e+="Font Size: "+this.transectText.get("settings").get("fontSize")+"<br/>",$(this.boundingBox.node).qtip({content:{text:e},position:{my:"top left",target:"mouse"}})},n.prototype.dragStart=function(e,t,n){},n.prototype.dragMove=function(e,t,n,r,i){var s=transectApp.TransectsCollection.getTransectForX(i.offsetX),o=transectApp.ZonesCollection.getZoneForY(i.offsetY);s!==null&&o!==null&&(this.transectText.set({x:i.offsetX,y:i.offsetY}),this.transectText.updateTransectAndZone())},n.prototype.dragEnd=function(e){},n.prototype.onMouseOver=function(){this.transectTextsView.undelegateEvents(),this.backgroundBox.attr({fill:"#fdcc59"}),this.$el.addClass("hover")},n.prototype.onMouseOut=function(){this.transectTextsView.delegateEvents(),this.backgroundBox.attr({fill:"fff"}),this.$el.removeClass("hover")},n.prototype.toggleTextForm=function(){this.render(),this.transectText.set({edit:!this.transectText.get("edit")})},n.prototype.editTransectText=function(){this.transectText.get("edit")?(this.$textForm.removeClass("hide"),this.$textData.addClass("hide"),this.$toggle.removeClass("hide-data"),this.$toggle.addClass("show-data")):(this.$textForm.addClass("hide"),this.$textData.removeClass("hide"),this.$toggle.removeClass("show-data"),this.$toggle.addClass("hide-data"))},n.prototype.updateText=function(e){e.keyCode==transectApp.ESC&&this.toggleTextForm();var t=this.$textText.value;this.transectText.set({text:t});var n=this.$("select[name='text-font-family'] option:selected").val();this.transectText.get("settings").set({fontSize:this.$textFontSize.value,fill:this.$textFontColor.value,fontFamily:n})},n.prototype.delete=function(){this.backgroundBox!==undefined&&this.backgroundBox.remove(),this.element!==undefined&&this.element.remove(),this.boundingBox!==undefined&&this.boundingBox.remove(),this.set!==undefined&&this.set.remove(),this.$el.remove(),this.remove()},n.prototype.destroy=function(){this.transectText.destroy()},n}),define("transectText",["baseModel","settings"],function(e,t){var n=e.extend({classname:"TransectText",constructor:function(n,r){var i=new t,s=[{edit:!1,text:n.text||_.uniqueId("Text "),x:n.x?parseInt(n.x):0,y:n.y?parseInt(n.y):0,age:0,transect:null,zone:null,settings:i,bBox:null}];e.apply(this,s)}});return n.prototype.initialize=function(){this.updateTransectAndZone()},n.prototype.updateTransectAndZone=function(){var e=transectApp.ZonesCollection.getZoneForY(this.get("y")),t=transectApp.TransectsCollection.getTransectForX(this.get("x"));e!==null&&t!==null&&(this.set({transect:t,zone:e}),this.updateRelativeCoordinates())},n.prototype.updateRelativeCoordinates=function(e){this.set({relativeX:this.get("transect").getRelativeX(this.get("x")),relativeY:this.get("zone").getRelativeY(this.get("y")),age:this.get("zone").getAbsoluteAge(this.get("y"))})},n.prototype.toJSON=function(){var e=_.clone(this.attributes);return delete e.transect,delete e.zone,e},n}),define("transectTextsView",["baseView","transectTextView","transectText"],function(e,t,n){var r=e.extend({el:"#texts-list",classname:"TransectTextsView"});return r.prototype.template=new EJS({url:"../../../commons/ejs/data_tbl.ejs"}),r.prototype.initialize=function(){this.transectTexts=transectApp.TransectTextsCollection,this.enTransectTexts=!1,this.render(),this.listenToActionEvents(),this.listenTo(this.transectTexts,"add",this.render.bind(this))},r.prototype.render=function(){this.$el.html(this.template.render({name:"Transect Texts"})),this.$textsList=this.$(".data-list"),this.renderTransectTexts()},r.prototype.renderTransectTexts=function(){this.set==undefined&&(this.set=transectApp.Canvas.set()),this.transectTexts.each(this.addTransectText.bind(this))},r.prototype.listenToActionEvents=function(){$("#canvas").bind("dblclick",this.createTransectText.bind(this))},r.prototype.addTransectText=function(e){var n=new t(e,this);this.$textsList.append(n.el),this.set.push(n.element)},r.prototype.createTransectText=function(e){if(this.enTransectTexts){var t=this.transectTexts.findWhere({x:e.offsetX,y:e.offsetY})||new n({x:e.offsetX,y:e.offsetY});if(t.get("transect")===null||t.get("zone")===null){t.destroy();return}this.transectTexts.add(t)}},r.prototype.toggleTransectTexts=function(){$("a[href='#add-transect-text']").parent().hasClass("active")?($("a[href='#add-transect-text']").parent().removeClass("active"),this.enTransectTexts=!1):($("a[href='#add-transect-text']").parent().addClass("active"),this.enTransectTexts=!0)},r}),define("zoneView",["baseView"],function(e){var t=e.extend({tagName:"li",classname:"ZoneView",events:{"click .toggle":"toggleZoneForm","click .zone-data":"toggleZoneForm","keypress :input":"updateZone","keyup :input":"updateZone",mouseover:"onMouseOver",mouseout:"onMouseOut"}});return t.prototype.template=new EJS({url:"../../../transect_maker/ejs/zone.ejs"}),t.prototype.initialize=function(e){this.zone=e,this.listenTo(this.zone,"change:edit",this.toggleEditStatus.bind(this)),this.render()},t.prototype.render=function(){this.$el.html(this.template.render(this.zone.toJSON())),this.$toggle=this.$(".toggle"),this.$zoneForm=this.$(".zone-form"),this.$zoneData=this.$(".zone-data"),this.$zoneName=this.$('input[name="zone-name"]')[0],this.$zoneDescription=this.$('textarea[name="zone-description"]')[0]},t.prototype.toggleZoneForm=function(){this.render(),this.zone.set({edit:!this.zone.get("edit")})},t.prototype.toggleEditStatus=function(){this.zone.get("edit")?(this.$zoneForm.removeClass("hide"),this.$zoneData.addClass("hide"),this.$toggle.removeClass("hide-data"),this.$toggle.addClass("show-data")):(this.$zoneForm.addClass("hide"),this.$zoneData.removeClass("hide"),this.$toggle.removeClass("show-data"),this.$toggle.addClass("hide-data"))},t.prototype.onMouseOver=function(){this.$el.addClass("hover"),this.zone.get("topMarker").set({hover:!0}),this.zone.get("baseMarker").set({hover:!0})},t.prototype.onMouseOut=function(){this.$el.removeClass("hover"),this.zone.get("topMarker").set({hover:!1}),this.zone.get("baseMarker").set({hover:!1})},t.prototype.updateZone=function(e){(e.keyCode==transectApp.ENTER||e.keyCode==transectApp.ESC)&&this.toggleZoneForm();var t=this.$zoneName.value,n=this.$zoneDescription.value;this.zone.set({name:t,description:n})},t}),define("zonesView",["baseView","zoneView","zone"],function(e,t,n){var r=e.extend({el:"#zones-list",classname:"ZonesView"});return r.prototype.template=new EJS({url:"../../../commons/ejs/data_tbl.ejs"}),r.prototype.initialize=function(){this.zones=transectApp.ZonesCollection,this.render(),this.listenTo(this.zones,"add",this.addZone.bind(this)),this.listenTo(this.zones,"reset",this.resetZones.bind(this))},r.prototype.render=function(){this.$el.html(this.template.render({name:"Zones"})),this.$zonesTable=this.$(".data-list")},r.prototype.addZone=function(e){var n=new t(e);this.$zonesTable.append(n.el)},r.prototype.resetZones=function(){this.$zonesTable.html(""),this.zones.each(this.addZone,this)},r}),define("pointView",["baseView"],function(e){var t=e.extend({tagName:"li",classname:"PointView",events:{"click .toggle":"togglePointForm",mouseover:"onMouseOver",mouseout:"onMouseOut"}});return t.prototype.template=new EJS({url:"/transect_maker/ejs/point.ejs"}),t.prototype.statusBoxTemplate=new EJS({url:"/transect_maker/ejs/status_box.ejs"}),t.prototype.initialize=function(e){this.point=e,this.render(),this.listenTo(this.point,"destroy",this.removeElement.bind(this)),this.listenTo(this.point,"change:edit",this.toggleEditStatus.bind(this)),this.listenTo(this.point,"change",this.render.bind(this))},t.prototype.render=function(){this.$el.html(this.template.render(this.point.toJSON())),this.$toggle=this.$(".toggle"),this.$pointForm=this.$(".point-form"),this.$pointData=this.$(".point-data"),this.$pointName=this.$('input[name="point-name"]')[0],this.$pointAge=this.$('input[name="point-age"]')[0],this.renderPoint()},t.prototype.renderPoint=function(){this.element===undefined&&(this.element=transectApp.Canvas.circle(this.point.get("x"),this.point.get("y"),4),transectApp.PointsSet.push(this.element),this.element.hover(this.onMouseOver.bind(this),this.onMouseOut.bind(this)),this.element.click(this.onClick.bind(this)),this.element.drag(this.onDragMove.bind(this),this.onDragStart.bind(this),this.onDragEnd.bind(this)),this.renderTooltip(),this.element.attr({fill:"#000000"})),this.updateStatusBox(),this.updateElement()},t.prototype.renderTooltip=function(){var e=this.point.get("name")+"<br/>";e+=this.point.get("zone").get("name")+"<br/>",e+=this.point.get("transect").get("name"),$(this.element.node).qtip({content:{text:e},position:{my:"bottom left",target:"mouse"}})},t.prototype.updateElement=function(){this.element.attr({cx:this.point.get("x"),cy:this.point.get("y")}),this.renderTooltip(),this.updateStatusBox()},t.prototype.updateStatusBox=function(){transectApp.StatusBox.html(this.statusBoxTemplate.render(this.point.toStatusJSON()))},t.prototype.setFinishedMode=function(){this.element.attr({r:4,fill:"#000000",stroke:"#000000"}),this.$el.removeClass("hover")},t.prototype.setEditMode=function(){this.element.attr({r:8,fill:"#FF0033",stroke:"#FF0033"}),this.$el.addClass("hover")},t.prototype.onMouseOver=function(){this.updateStatusBox(),this.setEditMode()},t.prototype.onMouseOut=function(){this.setFinishedMode()},t.prototype.onClick=function(){transectApp.CurrentPolygon!==null&&transectApp.CurrentPolygon.get("draw")&&transectApp.CurrentPolygon.get("points").add(this.point)},t.prototype.removeElement=function(){this.element.remove()},t.prototype.onDragStart=function(e,t,n){},t.prototype.onDragMove=function(e,t,n,r,i){var s=transectApp.TransectsCollection.getTransectForX(i.offsetX),o=transectApp.ZonesCollection.getZoneForY(i.offsetY);if(s!==null&&o!==null){var u=i.offsetX,a=i.offsetY;transectApp.Cursor.get("lockH")&&(a=this.point.get("y")),transectApp.Cursor.get("lockV")&&(u=this.point.get("x")),this.point.set({x:u,y:a}),this.point.updateTransectAndZone()}},t.prototype.onDragEnd=function(e){},t.prototype.togglePointForm=function(){this.point.set({edit:!this.point.get("edit")})},t.prototype.toggleEditStatus=function(){this.point.get("edit")?(this.$pointForm.removeClass("hide"),this.$pointData.addClass("hide"),this.$toggle.removeClass("hide-data"),this.$toggle.addClass("show-data"),this.setEditMode()):(this.$pointForm.addClass("hide"),this.$pointData.removeClass("hide"),this.$toggle.removeClass("show-data"),this.$toggle.addClass("hide-data"),this.setFinishedMode())},t}),define("lineView",["baseView"],function(e){var t=e.extend({tagName:"li",classname:"LineView",events:{"click .line-data":"toggleLineForm","keypress :input":"updateLine","keyup :input":"updateLine",mouseover:"onMouseOver",mouseout:"onMouseOut"}});return t.prototype.template=new EJS({url:"../../../transect_maker/ejs/line.ejs"}),t.prototype.initialize=function(e){this.line=e,this.listenTo(this.line,"destroy",this.removeElement.bind(this)),this.listenTo(this.line,"change:edit",this.toggleEditStatus.bind(this)),this.listenTo(this.line,"change:name",this.renderLine.bind(this)),this.listenTo(this.line.get("point1"),"change",this.renderLine.bind(this)),this.listenTo(this.line.get("point2"),"change",this.renderLine.bind(this)),this.listenTo(this.line,"change:pattern",this.render.bind(this)),this.render()},t.prototype.render=function(){this.$el.html(this.template.render(this.line.toJSON())),this.$toggle=this.$(".toggle"),this.$lineForm=this.$(".line-form"),this.$lineData=this.$(".line-data"),this.$lineName=this.$('input[name="line-name"]')[0],this.$linePattern=this.$("select.line-pattern"),this.$linePattern.change(this.updateLine.bind(this)),this.renderLine()},t.prototype.renderLine=function(){this.element===undefined&&(this.element=transectApp.Canvas.path(),transectApp.LinesSet.push(this.element));var e="M"+this.line.get("point1").get("x")+","+this.line.get("point1").get("y");e+=this.line.getPath(),this.element.attr({path:e}),this.element.hover(this.onMouseOver.bind(this),this.onMouseOut.bind(this)),this.setFinishedMode(),this.renderTooltip()},t.prototype.renderTooltip=function(){var e=this.line.get("name");$(this.element.node).qtip({content:{text:e},position:{my:"bottom left",target:"mouse"}})},t.prototype.onMouseOut=function(){this.setFinishedMode()},t.prototype.onMouseOver=function(){this.setEditMode()},t.prototype.removeElement=function(){this.remove(),this.element.remove()},t.prototype.toggleLineForm=function(){this.render(),this.line.set({edit:!this.line.get("edit")})},t.prototype.toggleEditStatus=function(){this.line.get("edit")?(this.$lineForm.removeClass("hide"),this.$lineData.addClass("hide"),this.$toggle.removeClass("hide-data"),this.$toggle.addClass("show-data")):(this.$lineForm.addClass("hide"),this.$lineData.removeClass("hide"),this.$toggle.removeClass("show-data"),this.$toggle.addClass("hide-data"))},t.prototype.setFinishedMode=function(){this.element.attr({"stroke-width":2,stroke:transectApp.lineMouseOut}),this.$el.removeClass("hover")},t.prototype.setEditMode=function(){this.element.attr({"stroke-width":6,stroke:transectApp.lineMouseOver}),this.$el.addClass("hover")},t.prototype.updateLine=function(e){(e.keyCode==transectApp.ENTER||e.keyCode==transectApp.ESC)&&this.toggleLineForm();var t=this.$("select.line-pattern option:selected").val();this.line.set({pattern:t})},t}),define("points",["baseCollection","point"],function(e,t){var n=e.extend({classname:"Points",model:t});return n.prototype.updatePoints=function(){return this.each(function(e){e.updateTransectAndZone()}),!0},n.prototype.add=function(t){if(t===undefined)return;var n=this.any(function(e){return e.get("x")==t.get("x")&&e.get("y")==t.get("y")});n||e.prototype.add.call(this,t)},n.prototype.getPolyKPointsArray=function(){var e=[];return this.each(function(t){e.push(t.get("x")),e.push(t.get("y"))}),e},n}),define("lines",["baseCollection","line"],function(e,t){var n=e.extend({classname:"Lines",model:t});return n.prototype.findLineForPoints=function(e){var t=transectApp.PointsCollection.findWhere({x:e.x1,y:e.y1}),n=transectApp.PointsCollection.findWhere({x:e.x2,y:e.y2});return this.findWhere({point1:t,point2:n})},n}),define("polygon",["baseModel","points","lines"],function(e,t,n){var r=e.extend({classname:"Polygon",constructor:function(r,i){var s=[{hover:!1,edit:!1,draw:!1,name:r&&r.name?r.name:_.uniqueId("Polygon "),patternName:r?r.patternName:null,points:new t,lines:new n,description:r&&r.description?r.description:null}];e.apply(this,s)}});return r.prototype.getPolyKPointsArray=function(e){var t=[];return this.get("points").each(function(e){t.push(e.get("x")),t.push(e.get("y"))}),t},r.prototype.toJSON=function(){var e=_.clone(this.attributes);return delete e.lines,e},r}),define("polygons",["baseCollection","polygon"],function(e,t){var n=e.extend({classname:"Polygons",model:t});return n.prototype.comparator=function(e){var t=e.get("points"),n=null;return t.each(function(e){n==null&&(n=e.get("y")),e.get("y")<n&&(n=e.get("y"))}),n},n}),define("polyK",[],function(){var e={};e.IsSimple=function(t){var n=t.length>>1;if(n<4)return!0;var r=new e._P,i=new e._P,s=new e._P,o=new e._P,u=new e._P;for(var a=0;a<n;a++){r.x=t[2*a],r.y=t[2*a+1],a==n-1?(i.x=t[0],i.y=t[1]):(i.x=t[2*a+2],i.y=t[2*a+3]);for(var f=0;f<n;f++){if(Math.abs(a-f)<2)continue;if(f==n-1&&a==0)continue;if(a==n-1&&f==0)continue;s.x=t[2*f],s.y=t[2*f+1],f==n-1?(o.x=t[0],o.y=t[1]):(o.x=t[2*f+2],o.y=t[2*f+3]);if(e._GetLineIntersection(r,i,s,o,u)!=null)return!1}}return!0},e.IsConvex=function(t){if(t.length<6)return!0;var n=t.length-4;for(var r=0;r<n;r+=2)if(!e._convex(t[r],t[r+1],t[r+2],t[r+3],t[r+4],t[r+5]))return!1;return e._convex(t[n],t[n+1],t[n+2],t[n+3],t[0],t[1])?e._convex(t[n+2],t[n+3],t[0],t[1],t[2],t[3])?!0:!1:!1},e.GetArea=function(e){if(e.length<6)return 0;var t=e.length-2,n=0;for(var r=0;r<t;r+=2)n+=(e[r+2]-e[r])*(e[r+1]+e[r+3]);return n+=(e[0]-e[t])*(e[t+1]+e[1]),-n*.5},e.GetAABB=function(e){var t=Infinity,n=Infinity,r=-t,i=-n;for(var s=0;s<e.length;s+=2)t=Math.min(t,e[s]),r=Math.max(r,e[s]),n=Math.min(n,e[s+1]),i=Math.max(i,e[s+1]);return{x:t,y:n,width:r-t,height:i-n}},e.Reverse=function(e){var t=[];for(var n=e.length-2;n>=0;n-=2)t.push(e[n],e[n+1]);return t},e.Triangulate=function(t){var n=t.length>>1;if(n<3)return[];var r=[],i=[];for(var s=0;s<n;s++)i.push(s);var s=0,o=n;while(o>3){var u=i[(s+0)%o],a=i[(s+1)%o],f=i[(s+2)%o],l=t[2*u],c=t[2*u+1],h=t[2*a],p=t[2*a+1],d=t[2*f],v=t[2*f+1],m=!1;if(e._convex(l,c,h,p,d,v)){m=!0;for(var g=0;g<o;g++){var y=i[g];if(y==u||y==a||y==f)continue;if(e._PointInTriangle(t[2*y],t[2*y+1],l,c,h,p,d,v)){m=!1;break}}}if(m)r.push(u,a,f),i.splice((s+1)%o,1),o--,s=0;else if(s++>3*o)break}return r.push(i[0],i[1],i[2]),r},e.ContainsPoint=function(e,t,n){var r=e.length>>1,i,s,o=e[2*r-2]-t,u=e[2*r-1]-n,a=0;for(var f=0;f<r;f++){i=o,s=u,o=e[2*f]-t,u=e[2*f+1]-n;if(s<0&&u<0)continue;if(s>0&&u>0)continue;if(i<0&&o<0)continue;var l=i+(o-i)*-s/(u-s);if(l==0)return!0;l>0&&a++}return(a&1)==1},e.Slice=function(t,n,r,i,s){if(e.ContainsPoint(t,n,r)||e.ContainsPoint(t,i,s))return[t.slice(0)];var o=new e._P(n,r),u=new e._P(i,s),a=[],f=[];for(var l=0;l<t.length;l+=2)f.push(new e._P(t[l],t[l+1]));for(var l=0;l<f.length;l++){var c=new e._P(0,0);c=e._GetLineIntersection(o,u,f[l],f[(l+1)%f.length],c),c&&(c.flag=!0,a.push(c),f.splice(l+1,0,c),l++)}if(a.length==0)return[t.slice(0)];var h=function(t,n){return e._P.dist(o,t)-e._P.dist(o,n)};a.sort(h);var p=[],d=0;while(a.length>0){var v=f.length,m=a[0],g=a[1],y=f.indexOf(m),b=f.indexOf(g),w=!1;e._firstWithFlag(f,y)==b?w=!0:(m=a[1],g=a[0],y=f.indexOf(m),b=f.indexOf(g),e._firstWithFlag(f,y)==b&&(w=!0));if(w){d--;var E=e._getPoints(f,y,b);p.push(E),f=e._getPoints(f,b,y),m.flag=g.flag=!1,a.splice(0,2),a.length==0&&p.push(f)}else d++,a.reverse();if(d>1)break}var S=[];for(var l=0;l<p.length;l++){var x=p[l],T=[];for(var N=0;N<x.length;N++)T.push(x[N].x,x[N].y);S.push(T)}return S},e.Raycast=function(t,n,r,i,s,o){var u=t.length-2,a=e._tp,f=a[0],l=a[1],c=a[2],h=a[3],p=a[4];f.x=n,f.y=r,l.x=n+i,l.y=r+s,o==null&&(o={dist:0,edge:0,norm:{x:0,y:0},refl:{x:0,y:0}}),o.dist=Infinity;for(var d=0;d<u;d+=2){c.x=t[d],c.y=t[d+1],h.x=t[d+2],h.y=t[d+3];var v=e._RayLineIntersection(f,l,c,h,p);v&&e._updateISC(i,s,f,c,h,p,d/2,o)}c.x=h.x,c.y=h.y,h.x=t[0],h.y=t[1];var v=e._RayLineIntersection(f,l,c,h,p);return v&&e._updateISC(i,s,f,c,h,p,t.length/2,o),o.dist!=Infinity?o:null},e.ClosestEdge=function(t,n,r,i){var s=t.length-2,o=e._tp,u=o[0],a=o[2],f=o[3],l=o[4];u.x=n,u.y=r,i==null&&(i={dist:0,edge:0,point:{x:0,y:0},norm:{x:0,y:0}}),i.dist=Infinity;for(var c=0;c<s;c+=2)a.x=t[c],a.y=t[c+1],f.x=t[c+2],f.y=t[c+3],e._pointLineDist(u,a,f,c>>1,i);a.x=f.x,a.y=f.y,f.x=t[0],f.y=t[1],e._pointLineDist(u,a,f,s>>1,i);var h=1/i.dist;return i.norm.x=(n-i.point.x)*h,i.norm.y=(r-i.point.y)*h,i},e._pointLineDist=function(e,t,n,r,i){var s=e.x,o=e.y,u=t.x,a=t.y,f=n.x,l=n.y,c=s-u,h=o-a,p=f-u,d=l-a,v=c*p+h*d,m=p*p+d*d,g=v/m,y,b;g<0||u==f&&a==l?(y=u,b=a):g>1?(y=f,b=l):(y=u+g*p,b=a+g*d);var w=s-y,E=o-b,S=Math.sqrt(w*w+E*E);S<i.dist&&(i.dist=S,i.edge=r,i.point.x=y,i.point.y=b)},e._updateISC=function(t,n,r,i,s,o,u,a){var f=e._P.dist(r,o);if(f<a.dist){var l=1/e._P.dist(i,s),c=-(s.y-i.y)*l,h=(s.x-i.x)*l,p=2*(t*c+n*h);a.dist=f,a.norm.x=c,a.norm.y=h,a.refl.x=-p*c+t,a.refl.y=-p*h+n,a.edge=u}},e._getPoints=function(e,t,n){var r=e.length,i=[];n<t&&(n+=r);for(var s=t;s<=n;s++)i.push(e[s%r]);return i},e._firstWithFlag=function(e,t){var n=e.length;for(;;){t=(t+1)%n;if(e[t].flag)return t}},e._PointInTriangle=function(e,t,n,r,i,s,o,u){var a=o-n,f=u-r,l=i-n,c=s-r,h=e-n,p=t-r,d=a*a+f*f,v=a*l+f*c,m=a*h+f*p,g=l*l+c*c,y=l*h+c*p,b=1/(d*g-v*v),w=(g*m-v*y)*b,E=(d*y-v*m)*b;return w>=0&&E>=0&&w+E<1},e._RayLineIntersection=function(t,n,r,i,s){var o=t.x-n.x,u=r.x-i.x,a=t.y-n.y,f=r.y-i.y,l=o*f-a*u;if(l==0)return null;var c=t.x*n.y-t.y*n.x,h=r.x*i.y-r.y*i.x,p=s,d=1/l;return p.x=(c*u-o*h)*d,p.y=(c*f-a*h)*d,e._InRect(p,r,i)?a>0&&p.y>t.y||a<0&&p.y<t.y?null:o>0&&p.x>t.x||o<0&&p.x<t.x?null:p:null},e._GetLineIntersection=function(t,n,r,i,s){var o=t.x-n.x,u=r.x-i.x,a=t.y-n.y,f=r.y-i.y,l=o*f-a*u;if(l==0)return null;var c=t.x*n.y-t.y*n.x,h=r.x*i.y-r.y*i.x,p=s;return p.x=(c*u-o*h)/l,p.y=(c*f-a*h)/l,e._InRect(p,t,n)&&e._InRect(p,r,i)?p:null},e._InRect=function(e,t,n){return t.x==n.x?e.y>=Math.min(t.y,n.y)&&e.y<=Math.max(t.y,n.y):t.y==n.y?e.x>=Math.min(t.x,n.x)&&e.x<=Math.max(t.x,n.x):e.x>=Math.min(t.x,n.x)&&e.x<=Math.max(t.x,n.x)&&e.y>=Math.min(t.y,n.y)&&e.y<=Math.max(t.y,n.y)?!0:!1},e._convex=function(e,t,n,r,i,s){return(t-r)*(i-n)+(n-e)*(s-r)>=0},e._P=function(e,t){this.x=e,this.y=t,this.flag=!1},e._P.prototype.toString=function(){return"Point ["+this.x+", "+this.y+"]"},e._P.dist=function(e,t){var n=t.x-e.x,r=t.y-e.y;return Math.sqrt(n*n+r*r)},e._tp=[];for(var t=0;t<10;t++)e._tp.push(new e._P(0,0));return e}),define("line",["baseModel","transects","polygons","polyK"],function(e,t,n,r){var i=e.extend({classname:"Line",constructor:function(r,i,s){var o=[{edit:!1,name:r.name||_.uniqueId("Line "),pattern:"default",point1:i,point2:s,transects:new t,polygons:new n}];e.apply(this,o)}});return i.prototype.jaggedDistance=10,i.prototype.waveHeight=5,i.prototype.getPatternPoints=function(){var e=numeric.linspace(this.point1.get("x"),this.point2.get("x"),steps),t=numeric.linspace(this.point1.get("y"),this.point2.get("y"),steps)},i.prototype.getPolyKPointsArray=function(){var e=[];return e.push(this.get("point1").get("x")),e.push(this.get("point1").get("y")),e.push(this.get("point2").get("x")),e.push(this.get("point2").get("y")),e},i.prototype.slope=function(){var e=(this.get("point1").get("y")-this.get("point2").get("y"))/(this.get("point1").get("x")-this.get("point2").get("x"));return e},i.prototype.coincides=function(e){var t=e.getPolyKPointsArray(),n=this.getPolyKPointsArray(),i=[],s=3;return i.push(this.pointAtADistanceFromXY(n[0],n[1],s)),i.push(this.pointAtADistanceFromXY(n[0],n[1],-s)),i.push(this.pointAtADistanceFromXY(n[2],n[3],-s)),i.push(this.pointAtADistanceFromXY(n[2],n[3],s)),i=_.flatten(i),r.ContainsPoint(i,t[0],t[1])&&r.ContainsPoint(i,t[2],t[3])?!0:!1},i.prototype.getPath=function(){return this.getPathFromPattern(this.get("pattern"))},i.prototype.getPathFromPattern=function(e){switch(e){case"default":return this.getStraightPath();case"jagged":return this.getJaggedPath();case"wavy":return this.getWavyPath();case"lapping":return this.getJaggedPath()}},i.prototype.getStraightPath=function(){var e=",L"+this.get("point2").get("x")+","+this.get("point2").get("y");return e},i.prototype.getJaggedPath=function(){var e=this.get("point1").get("y")-this.get("point2").get("y"),t=this.get("point1").get("x")-this.get("point2").get("x"),n=e/t,r=Math.round(Math.abs(this.get("point1").get("y")-this.get("point2").get("y"))/10),i=numeric.linspace(this.get("point1").get("x"),this.get("point2").get("x"),r),s=numeric.linspace(this.get("point1").get("y"),this.get("point2").get("y"),r),o="";if(i.length==0)return this.getStraightPath();for(var u=0;u<i.length;u++)u!=0&&(e>0&&n>0||e<0&&n<0?(o+=",L"+(i[u-1]+this.jaggedDistance)+","+s[u-1],o+=",L"+(i[u]-this.jaggedDistance)+","+s[u],u<i.length-1?o+=",L"+(i[u]+this.jaggedDistance)+","+s[u]:o+=",L"+i[u]+","+s[u]):(o+=",L"+(i[u-1]-this.jaggedDistance)+","+s[u-1],o+=",L"+(i[u]+this.jaggedDistance)+","+s[u],u<i.length-1?o+=",L"+(i[u]-this.jaggedDistance)+","+s[u]:o+=",L"+i[u]+","+s[u]));return o},i.prototype.getWavyPath=function(){var e=Math.round(Math.abs(this.get("point1").get("y")-this.get("point2").get("y"))/3),t=Math.round(Math.abs(this.get("point1").get("x")-this.get("point2").get("x"))/3),n=Math.max(t,e),r=numeric.linspace(this.get("point1").get("x"),this.get("point2").get("x"),n),i=numeric.linspace(this.get("point1").get("y"),this.get("point2").get("y"),n),s="";if(n==0)return this.getStraightPath();for(var o=0;o<n;o++){var u=r.length>0?r[o]:this.get("point1").get("x"),a=i.length>0?i[o]:this.get("point1").get("y");o!=0&&(o%2==1?(o%4==3?plPoint=this.pointAtADistanceFromXY(u,a,-this.waveHeight):plPoint=this.pointAtADistanceFromXY(u,a,this.waveHeight),s+=",S"+plPoint[0]+","+plPoint[1]):s+=","+u+","+a)}return s+=",L"+this.get("point2").get("x")+","+this.get("point2").get("y"),s},i.prototype.pointAtADistanceFromXY=function(e,t,n){var r=(this.get("point1").get("x")-this.get("point2").get("x"))/(this.get("point2").get("y")-this.get("point1").get("y")),i,s;return r===Infinity||r===-Infinity?(i=e,s=t+n):(i=e+n/Math.sqrt(1+r*r),s=t+r*(i-e)),[i,s]},i}),define("polygonView",["baseView","pointView","lineView","point","points","line","lines","polyK"],function(e,t,n,r,i,s,o,u){var a=e.extend({tagName:"li",classname:"PolygonView",events:{"click .toggle-polygon":"togglePolygonForm","click .polygon-data":"togglePolygonForm","click a.polygon-list-tool":"showList","click .destroy":"destroy","keypress :input":"updatePolygon","keyup :input":"updatePolygon","click label.polygon-line-data":"showPolygonLinesList","click label.polygon-point-data":"showPolygonPointsList","click label.polygon-pattern-data":"showPolygonPatternsList",mouseover:"onMouseOver",mouseout:"onMouseOut"}});return a.prototype.template=new EJS({url:"/transect_maker/ejs/polygon.ejs"}),a.prototype.initialize=function(e){this.polygon=e,this.pointsSet=transectApp.Canvas.set(),this.linesSet=transectApp.Canvas.set(),this.render(),this.listenToActionEvents(),this.listenTo(this.polygon,"change:edit",this.toggleEditStatus.bind(this)),this.listenTo(this.polygon,"change:draw",this.setRenderMode.bind(this)),this.listenTo(this.polygon,"change:name",this.updatePolygonView.bind(this)),this.listenTo(this.polygon,"change:description",this.updatePolygonView.bind(this)),this.listenTo(this.polygon,"change:patternName",this.updatePolygonView.bind(this)),this.listenTo(this.polygon.get("points"),"change",this.renderPolygonElement.bind(this)),this.listenTo(this.polygon.get("lines"),"change",this.renderPolygonElement.bind(this)),this.listenTo(this.polygon.get("points"),"add",this.addPointToPolygon.bind(this)),this.listenTo(this.polygon.get("points"),"reset",this.resetPolygonPoints.bind(this)),this.listenTo(this.polygon.get("lines"),"add",this.addLineToPolygon.bind(this)),this.listenTo(this.polygon.get("lines"),"reset",this.resetPolygonLines.bind(this)),this.listenTo(this.polygon.get("lines"),"remove",this.updatePolygonLines.bind(this)),this.listenTo(this.polygon,"destroy",this.delete.bind(this))},a.prototype.updatePolygonLines=function(){},a.prototype.updatePolygonView=function(e){this.$polygonData.html(this.polygon.get("name")+" → "+this.polygon.get("patternName")),this.renderPolygonElement(),this.setPolygonFill(),this.toggleEditStatus()},a.prototype.render=function(){this.$el.html(this.template.render(this.polygon.toJSON())),this.$togglePolygon=this.$(".toggle-polygon"),this.$polygonForm=this.$(".polygon-form"),this.$polygonData=this.$(".polygon-data"),this.$polygonName=this.$('input[name="polygon-name"]')[0],this.$polygonDescription=this.$('textarea[name="polygon-description"]')[0],this.$linesList=this.$(".lines-list"),this.$pointsList=this.$(".points-list"),this.$patternsList=this.$(".patterns-list"),this.$polygonPattern=this.$("select.polygon-pattern"),this.$patternImage=this.$(".patterns-image"),this.$polygonPattern.change(this.updatePolygonPattern.bind(this)),this.renderPoints()},a.prototype.renderPoints=function(){this.polygon.get("points").each(this.addPoint.bind(this))},a.prototype.showPolygonLinesList=function(){this.$linesList.hasClass("hide")?this.$linesList.removeClass("hide"):this.$linesList.addClass("hide")},a.prototype.showPolygonPointsList=function(){this.$pointsList.hasClass("hide")?this.$pointsList.removeClass("hide"):this.$pointsList.addClass("hide")},a.prototype.showPolygonPatternsList=function(){this.$patternsList.hasClass("hide")?this.$patternsList.removeClass("hide"):this.$patternsList.addClass("hide")},a.prototype.updatePolygonPattern=function(){var e=this.$("select.polygon-pattern option:selected").val();this.polygon.set({patternName:e})},a.prototype.listenToActionEvents=function(){$("#canvas").bind("dblclick",this.addPoint.bind(this))},a.prototype.addPointToPolygon=function(e){var n=new t(e);this.$pointsList.append(n.el),this.pointsSet.push(n.element),this.polygon.get("points").length>1&&this.resetLines(),transectApp.PointsCollection.add(e),this.updateCanvasDimensions(e)},a.prototype.isSimple=function(e){var t=this.polygon.getPolyKPointsArray();return u.IsSimple(t)},a.prototype.updateCanvasDimensions=function(e){transectApp.Canvas.setSize(Math.max(transectApp.Canvas.width,e.get("x")),Math.max(transectApp.Canvas.height,e.get("y")+100))},a.prototype.resetLines=function(){var e=[],t=this.polygon.get("points").at(this.polygon.get("points").length-2),n=this.polygon.get("points").first(),r=transectApp.LinesCollection.findWhere({point1:t,point2:n})||transectApp.LinesCollection.findWhere({point1:n,point2:t});r!==undefined&&r.get("polygons").length<2&&r.destroy(),t=this.polygon.get("points").at(this.polygon.get("points").length-2),n=this.polygon.get("points").last();var i=transectApp.LinesCollection.findWhere({point1:t,point2:n})||transectApp.LinesCollection.findWhere({point1:n,point2:t})||new s({},t,n);i.get("polygons").add(this.polygon),t=this.polygon.get("points").last(),n=this.polygon.get("points").first();var o=transectApp.LinesCollection.findWhere({point1:t,point2:n})||transectApp.LinesCollection.findWhere({point1:n,point2:t})||new s({},t,n);o.get("polygons").add(this.polygon),this.polygon.get("lines").add([i,o]),this.renderPolygonElement(),this.setRenderFill(),this.bringToFront()},a.prototype.bringToFront=function(){transectApp.PolygonsSet.toFront(),this.element.toFront(),transectApp.LinesSet.toFront(),transectApp.PointsSet.toFront(),transectApp.TextsSet.toFront(),transectApp.MarkersSet.toFront(),transectApp.WellsSet.toFront()},a.prototype.addLineToPolygon=function(e){transectApp.LinesCollection.add(e);var t=new n(e);this.linesSet.push(t.element),this.$linesList.append(t.el)},a.prototype.resetPolygonLines=function(){this.polygon.get("lines").each(this.addLineToPolygon,this)},a.prototype.resetPolygonPoints=function(){this.polygon.get("points").each(this.addPointToPolygon,this)},a.prototype.addPoint=function(e){if(!this.polygon.get("draw"))return;var t=e.offsetX,n=e.offsetY;this.polygon.get("points").length>0&&transectApp.Cursor.get("lockH")&&(n=this.polygon.get("points").last().get("y")),this.polygon.get("points").length>0&&transectApp.Cursor.get("lockV")&&(t=this.polygon.get("points").last().get("x"));var i=transectApp.PointsCollection.findWhere({x:t,y:n})||new r({x:t,y:n});if(i.get("transect")===null||i.get("zone")===null){i.destroy();return}this.polygon.get("points").add(i)},a.prototype.setRenderFill=function(){if(this.element===undefined)return;this.element.attr({opacity:.5,fill:transectApp.renderFill})},a.prototype.setPolygonFill=function(){if(this.element===undefined)return;var e=this.polygon.get("patternName"),t=e?"url('/pattern_manager/patterns/"+tscApp.PATTERNS[e]+"')":transectApp.polygonFill;this.element.attr({opacity:.8,fill:t});var n=t+" no-repeat";this.$patternImage.css("background",n)},a.prototype.toggleEditStatus=function(){if(this.element===undefined)return;this.polygon.get("edit")?(this.$polygonForm.removeClass("hide"),this.$polygonData.addClass("hide"),this.$togglePolygon.removeClass("hide-data"),this.$togglePolygon.addClass("show-data")):(this.$polygonForm.addClass("hide"),this.$polygonData.removeClass("hide"),this.$togglePolygon.removeClass("show-data"),this.$togglePolygon.addClass("hide-data"))},a.prototype.getConvexHull=function(){var e=[],t=this.polygon.get("points").toArray();t.sort(sortPointX),t.sort(sortPointY);var n=chainHull_2D(t,t.length,e);_.invoke(this.polygon.get("points").toArray(),"destroy"),this.polygon.get("points").reset(e)},a.prototype.getPath=function(){var e="M",t=this;return this.polygon.get("points").each(function(n,r,i){if(r==0)e+=n.get("x")+","+n.get("y");else{var o=t.polygon.get("lines").findWhere({point1:i[r-1],point2:n});if(o!==undefined)e+=o.getPath();else{o=t.polygon.get("lines").findWhere({point1:n,point2:i[r-1]});if(o!==undefined){var u=new s({},i[r-1],n);e+=u.getPathFromPattern(o.get("pattern")),u.destroy()}}if(r>0&&r===i.length-1){o=t.polygon.get("lines").findWhere({point1:n,point2:i[0]});if(o!==undefined)e+=o.getPath();else{o=t.polygon.get("lines").findWhere({point1:i[0],point2:n});if(o!==undefined){var u=new s({},n,i[0]);e+=u.getStraightPath(),u.destroy()}}}}}),e},a.prototype.renderPolygonElement=function(){this.element!==undefined&&this.element.remove(),this.element=transectApp.Canvas.path(this.getPath()),this.element.hover(this.onMouseOver.bind(this),this.onMouseOut.bind(this)),transectApp.PolygonsSet.push(this.element),this.renderTooltip(),this.setRenderMode(),this.bringToFront()},a.prototype.renderTooltip=function(){$(this.element.node).qtip({content:{text:this.polygon.get("name")+"【"+this.polygon.get("patternName")+"】<br>"+(this.polygon.get("description")||"No description yet!")},position:{my:"bottom left",target:"mouse"}})},a.prototype.onMouseOver=function(){if(!this.element)return;this.glow!==undefined&&this.glow.remove(),this.glow=this.element.glow({color:transectApp.glowColor,width:20}),this.glow.show(),this.$el.addClass("hover")},a.prototype.onMouseOut=function(){this.glow!==undefined&&this.glow.hide(),this.$el.removeClass("hover")},a.prototype.moveToBottom=function(){this.element.toBack(),transectApp.transectImageElement!==undefined&&transectApp.transectImageElement.toBack()},a.prototype.togglePolygonForm=function(){this.polygon.set({edit:!this.polygon.get("edit")})},a.prototype.showList=function(e){this.$(".polygon-settings").removeClass("active");var t="."+e.target.getAttribute("href").slice(1)+"-tab";this.$(t).addClass("active")},a.prototype.delete=function(){this.element!==undefined&&this.element.remove(),this.linesSet!==undefined&&this.linesSet.remove(),this.pointsSet!==undefined&&this.pointsSet.remove(),this.glow!==undefined&&this.glow.remove(),this.$el.remove(),this.remove()},a.prototype.destroy=function(){this.polygon.destroy()},a.prototype.updatePolygon=function(e){(e.keyCode==transectApp.ENTER||e.keyCode==transectApp.ESC)&&this.togglePolygonForm(),this.polygon.set({name:this.$polygonName.value,description:this.$polygonDescription.value})},a.prototype.setRenderMode=function(){this.polygon.get("draw")?this.setRenderFill():this.setPolygonFill()},a}),define("polygonsView",["baseView","polygonView","polygon"],function(e,t,n){var r=e.extend({el:"#polygons-list",classname:"PolygonsView"});return r.prototype.template=new EJS({url:"/commons/ejs/data_tbl.ejs"}),r.prototype.initialize=function(){CurrentPolygon=null,this.polygonsCollection=transectApp.PolygonsCollection,this.enPolygons=!1,this.render(),this.listenToActionEvents(),this.listenTo(this.polygonsCollection,"add",this.addPolygon.bind(this))},r.prototype.render=function(){this.$el.html(this.template.render({name:"Polygons"})),this.$polygonsList=this.$(".data-list"),this.renderPolygons()},r.prototype.renderPolygons=function(){this.polygonsCollection.each(this.addPolygon.bind(this))},r.prototype.listenToActionEvents=function(){$('a[href="#new-polygon"]').click(this.createPolygon.bind(this))},r.prototype.addPolygon=function(e){var n=new t(e);this.$polygonsList.append(n.el)},r.prototype.togglePolygons=function(){$("a[href='#add-polygon']").parent().hasClass("hide")?($("a[href='#add-polygon']").parent().removeClass("hide"),$("a[href='#new-polygon']").parent().addClass("hide"),this.enPolygons=!1):($("a[href='#add-polygon']").parent().addClass("hide"),$("a[href='#new-polygon']").parent().removeClass("hide"),this.enPolygons=!0)},r.prototype.createPolygon=function(){if(!this.enPolygons)return;this.checkAndDeleteCurrentPolygon(),this.disableAllPolygons(),transectApp.CurrentPolygon=new n,this.polygonsCollection.add(transectApp.CurrentPolygon),this.disableAllPolygons(),transectApp.CurrentPolygon.set({draw:!0})},r.prototype.checkAndDeleteCurrentPolygon=function(){transectApp.CurrentPolygon&&(transectApp.CurrentPolygon.set({draw:!1}),transectApp.CurrentPolygon.get("points").length<3&&transectApp.CurrentPolygon.destroy())},r.prototype.disableAllPolygons=function(){this.polygonsCollection.each(function(e){e.set("draw",!1)})},r}),define("dataImportView",["baseView"],function(e){var t=e.extend({el:".container",classname:"DataImportView"});return t.prototype.initialize=function(){this.$dataStatus=this.$(".data-status")},t}),define("dataExportView",["baseView"],function(e){var t=e.extend({el:"#export-panel",classname:"DataExportView",events:{"click a.show-data":"showData"}});return t.prototype.template=new EJS({url:"/transect_maker/ejs/data_export_panel.ejs"}),t.prototype.transectWellDataTemplate=new EJS({url:"/transect_maker/ejs/wells_data.ejs"}),t.prototype.transectDataLayout=new EJS({url:"/transect_maker/ejs/transect_data_layout.ejs"}),t.prototype.initialize=function(){this.markers=transectApp.TransectMarkersCollection,this.polygons=transectApp.PolygonsCollection,this.render(),this.$canvas=$("#canvas")},t.prototype.render=function(){this.exporter=transectApp.exporter,this.transects=transectApp.TransectsCollection,this.$el.html(this.template.render({transects:this.transects.toJSON()})),this.$transectData=this.$(".transect-data"),this.$showData=this.$(".show-data"),this.$dataTable=this.$(".data-table"),this.$dataRaw=this.$(".data-raw"),this.$dataJSON=this.$(".data-json"),this.$textData=this.$("textarea[name*=transect-data-text]")[0],this.$textJSON=this.$("textarea[name*=transect-data-json]")[0],this.$showTable=this.$('a[href="#show-table"]'),this.$showRaw=this.$('a[href="#show-raw"]'),this.$showJSON=this.$('a[href="#show-raw"]'),this.exporter.export(),this.renderWellsData(),this.renderTransectsData(),this.renderDataInText()},t.prototype.isAgeSet=function(){for(var e=0;e<this.markers.length;e++){var t=this.markers.at(e);if(t.get("age")==null)return!1}return!0},t.prototype.renderWellsData=function(){var e=this.exporter.wellsData;for(var t in e)this.$("#"+t).html(this.transectWellDataTemplate.render(e[t]))},t.prototype.renderTransectsData=function(){var e=this.exporter.transectsData;for(var t in e)this.$("#"+t).html(this.transectDataLayout.render(e[t]))},t.prototype.renderDataInText=function(){this.$textData.value=this.exporter.getText()},t.prototype.renderDataInJSON=function(){this.$textJSON.value=this.exporter.getJSON()},t.prototype.toggleExportView=function(e){$("a[href='#export-data']").parent().hasClass("active")?($("a[href='#export-data']").parent().removeClass("active"),this.$el.addClass("hide"),this.$canvas.removeClass("hide")):($("a[href='#export-data']").parent().addClass("active"),this.$el.removeClass("hide"),this.$canvas.addClass("hide")),this.render()},t.prototype.showData=function(e){this.$transectData.addClass("hide"),this.$showData.removeClass("alert"),$(e.target).addClass("alert");var t=$(e.target).attr("href");t==="#show-table"?this.$dataTable.removeClass("hide"):t==="#show-raw"?this.$dataRaw.removeClass("hide"):t==="#show-json"&&this.$dataJSON.removeClass("hide")},t}),define("file",["baseModel"],function(e){var t=e.extend({classname:"File",constructor:function(t,n){var r=[{name:t.name,isFile:t.isFile,isDirectory:t.isDirectory,size:t.Size||0,fullPath:t.fullPath,url:t.toURL(),selected:!1}];e.apply(this,r)}});return t}),define("files",["baseCollection","file"],function(e,t){var n=e.extend({classname:"Files",model:t});return n}),define("fileView",["baseView"],function(e){var t=e.extend({tagName:"div",classname:"FileView",events:{dblclick:"open",click:"select","blur .file-name":"blur"}});return t.prototype.template=new EJS({url:"/file_system/ejs/file.ejs"}),t.prototype.initialize=function(e,t,n){this.fileSystem=n,this.files=t,this.file=e,this.listenTo(this.file,"change:selected",this.setSelected.bind(this)),this.listenTo(this.file,"change:name",this.rename.bind(this)),this.listenToActionEvents(),this.render()},t.prototype.listenToActionEvents=function(){$('a[href="#delete-file"]').click(this.deleteFile.bind(this)),$('a[href="#load-data"]').click(this.loadData.bind(this))},t.prototype.render=function(){var e=this.file.toJSON();this.$el.html(this.template.render(e)),this.$file=this.$(".file"),this.$fileName=this.$(".file-name")[0]},t.prototype.deleteFile=function(){var e=this;if(!e.file.get("selected"))return;e.file.get("isFile")?e.fileSystem.get("fs").root.getFile(e.file.get("fullPath"),{},function(t){t.remove(function(){console.log("File removed."),e.file.destroy()},e.errorHandler.bind(this))},e.errorHandler.bind(this)):e.fileSystem.get("fs").root.getDirectory(e.file.get("fullPath"),{},function(t){t.removeRecursively(function(){console.log("Directory removed."),e.file.destroy()},e.errorHandler.bind(this))},e.errorHandler.bind(this))},t.prototype.select=function(){var e=this;this.files.each(function(t){t==e.file?t.set({selected:!t.get("selected")}):t.set({selected:!1})})},t.prototype.setSelected=function(){this.file.get("selected")?this.$file.addClass("active"):this.$file.removeClass("active")},t.prototype.blur=function(){this.file.set({name:this.$fileName.textContent})},t.prototype.rename=function(){var e=this;e.file.get("isFile")?e.fileSystem.get("fs").root.getFile(e.file.get("fullPath"),{},function(t){var n=e.file.get("fullPath").split("/");n.pop(),n=n.join("/"),n===""&&(n="/"),e.fileSystem.get("fs").root.getDirectory(n,{},function(n){t.moveTo(n,e.file.get("name"))},e.errorHandler.bind(this))},e.errorHandler.bind(this)):e.fileSystem.get("fs").root.getDirectory(e.file.get("fullPath"),{},function(t){var n=e.file.get("fullPath").split("/");n.pop(),n=n.join("/"),n===""&&(n="/"),e.fileSystem.get("fs").root.getDirectory(n,{},function(n){t.moveTo(n,e.file.get("name"))},e.errorHandler.bind(this))},e.errorHandler.bind(this))},t.prototype.open=function(){var e=this;e.file.get("isFile")||this.fileSystem.set({path:this.file.get("fullPath")})},t.prototype.errorHandler=function(e){console.log("Error: "+e.name+" "+e.message)},t.prototype.loadData=function(){var e=this;if(e.file.get("isDirectory")||!e.file.get("selected"))return;e.fileSystem.get("fs").root.getFile(e.file.get("fullPath"),{},function(t){t.file(function(t){var n=new FileReader;n.onloadend=function(t){e.showCanvas(),transectApp.loader.loadData(this.result)},n.readAsText(t)},e.errorHandler.bind(e))},e.errorHandler.bind(e))},t.prototype.showCanvas=function(){$("#canvas").removeClass("hide"),$("#file-system-panel").addClass("hide"),$("a[href='#file-system']").parent().removeClass("active")},t}),define("filesView",["baseView","fileView","file"],function(e,t,n){var r=e.extend({classname:"FilesView",el:"#files-list",events:{}});return r.prototype.template=new EJS({url:"/file_system/ejs/files.ejs"}),r.prototype.initialize=function(e,t){this.fileSystem=t,this.files=e,this.listenTo(this.files,"add",this.render.bind(this)),this.listenTo(this.files,"remove",this.render.bind(this)),this.listenToActionEvents(),this.render()},r.prototype.listenToActionEvents=function(e){$('a[href="#create-file"]').unbind().click(this.createNewFile.bind(this)),$('a[href="#create-dir"]').unbind().click(this.createNewDir.bind(this)),$('a[href="#save-project"]').click(this.saveProject.bind(this))},r.prototype.render=function(){this.$el.html(this.template.render()),this.$list=this.$(".list"),this.files.each(this.addFile.bind(this))},r.prototype.addFile=function(e){var n=new t(e,this.files,this.fileSystem);this.$list.append(n.el)},r.prototype.createNewFile=function(){var e=this;e.fileSystem.get("fs").root.getDirectory(e.fileSystem.get("path"),{},function(t){e.newFile(t,_.uniqueId("new-file-"))},e.errorHandler.bind(e))},r.prototype.newFile=function(e,t,n){var r=this;e.getFile(t,{create:!0,exclusive:!0},function(e){r.createFile(e,n)},r.errorHandler.bind(r))},r.prototype.createFile=function(e,t){var r=this.fileSystem.get("path");r==="/"?r=[""]:r=this.fileSystem.get("path").split("/"),r.push(e.name),r=r.join("/");if(r===e.fullPath){var i=new n(e);this.files.add(i)}t!==undefined&&t(e)},r.prototype.createNewDir=function(){var e=this;e.fileSystem.get("fs").root.getDirectory(e.fileSystem.get("path"),{},function(t){e.newDir(t,_.uniqueId("new-folder-"))},e.errorHandler.bind(e))},r.prototype.newDir=function(e,t,n){var r=this;e.getDirectory(t,{create:!0},function(e){r.createFile(e,n)},r.errorHandler.bind(r))},r.prototype.saveProject=function(){var e=this,t="transect-"+e.getTimeStamp();this.newDir(this.fileSystem.get("fs").root,t,function(t){var n="transect.json",r="transect.txt",i=transectApp.exporter.getJSON(),s=transectApp.exporter.getText();e.newFile(t,n,function(t){e.writeJSONToAFile(t,i)}),e.newFile(t,r,function(t){e.writeTextToAFile(t,s)})})},r.prototype.writeJSONToAFile=function(e,t){var t=t;if(e.isDirectory)return;var n=this;n.fileSystem.get("fs").root.getFile(e.fullPath,{create:!0},function(e){e.createWriter(function(e){e.onwriteend=function(e){console.log("Write completed.")},e.onerror=function(e){console.log("Write failed: "+e.toString())};var n=new Blob([t],{type:"application/json"});e.write(n)},n.errorHandler.bind(this))},n.errorHandler.bind(this))},r.prototype.writeTextToAFile=function(e,t){var t=t;if(e.isDirectory)return;var n=this;n.fileSystem.get("fs").root.getFile(e.fullPath,{create:!0},function(e){e.createWriter(function(e){e.onwriteend=function(e){console.log("Write completed.")},e.onerror=function(e){console.log("Write failed: "+e.toString())};var n=new Blob([t],{type:"text/plain"});e.write(n)},n.errorHandler.bind(this))},n.errorHandler.bind(this))},r.prototype.getTimeStamp=function(){var e=new Date,t=e.getUTCMonth()+"-"+e.getUTCDate()+"-";return t+=e.getUTCFullYear()+"-"+e.getHours()+"_",t+=e.getMinutes()+"_"+e.getSeconds(),t},r.prototype.errorHandler=function(e){console.log("Error: "+e.name+" "+e.message)},r}),define("fileSystem",["baseModel"],function(e){var t=e.extend({classname:"FileSystem",constructor:function(t,n){var r=[{fs:t.fs,path:"/"}];e.apply(this,r)}});return t}),define("fileSystemView",["baseView","file","files","filesView","fileSystem"],function(e,t,n,r,i){var s=e.extend({classname:"FileSystemView",el:"#file-system-panel",events:{"click a[href='#parent-dir']":"parentDir","click a.path-breadcrumb":"setDir"}});return s.prototype.template=new EJS({url:"/file_system/ejs/file_system_panel.ejs"}),s.prototype.initialize=function(){var e=1073741824;navigator.webkitPersistentStorage.requestQuota(e,this.requestFileSystem.bind(this),this.errorHandler.bind(this))},s.prototype.requestFileSystem=function(e){window.webkitRequestFileSystem(window.PERSISTANT,e,this.render.bind(this),this.errorHandler.bind(this))},s.prototype.render=function(e){this.fileSystem=new i({fs:e}),this.$canvas=$("#canvas"),this.renderDirs(),this.listenTo(this.fileSystem,"change:path",this.renderDirs.bind(this))},s.prototype.renderDirs=function(){this.$el.html(this.template.render(this.fileSystem.toJSON()));var e=this,t=this.fileSystem.get("path");this.files=new n,this.filesView=new r(this.files,this.fileSystem),this.fileSystem.get("fs").root.getDirectory(t,{},function(t){if(t.isDirectory){var n=t.createReader();n.readEntries(e.readDir.bind(e))}},e.errorHandler),this.readDir()},s.prototype.readDir=function(e){var n=this;if(e===undefined||!e.length)return;e.forEach(function(e){n.files.add(new t(e))})},s.prototype.parentDir=function(){var e=this.fileSystem.get("path");if(e==="/")return;e=e.split("/"),e.pop(),e=e.join("/"),this.fileSystem.set({path:e})},s.prototype.setDir=function(e){var t=$(e.target).attr("path");t===""&&(t="/"),this.fileSystem.set({path:t})},s.prototype.toggleView=function(e){$("a[href='#file-system']").parent().hasClass("active")?($("a[href='#file-system']").parent().removeClass("active"),this.$el.addClass("hide"),this.$canvas.removeClass("hide")):($("a[href='#file-system']").parent().addClass("active"),this.$el.removeClass("hide"),this.$canvas.addClass("hide"),transectApp.exporter.export())},s.prototype.errorHandler=function(e){console.log("Error: "+e.name+" "+e.message)},s}),define("loader",["transectMarker","transectWell","polygon","point","transectText"],function(e,t,n,r,i){var s=function(){this.polygons=transectApp.PolygonsCollection,this.zones=transectApp.ZonesCollection,this.transects=transectApp.TransectsCollection,this.markers=transectApp.TransectMarkersCollection,this.wells=transectApp.TransectWellsCollection,this.texts=transectApp.TransectTextsCollection};return s.prototype.loadFromLocalStorage=function(){this.loadData(localStorage.transectApp)},s.prototype.loadData=function(e){this.savedData=JSON.parse(e),this.reset(),this.load()},s.prototype.reset=function(){this.polygons.reset(),this.zones.reset(),this.transects.reset(),this.markers.reset(),this.wells.reset(),this.texts.reset()},s.prototype.load=function(){this.loadImage(),this.loadMarkersAndZones(),this.loadWellsAndTransects(),this.loadPolygons(),this.loadTexts()},s.prototype.loadImage=function(){transectApp.TransectImage.set(this.savedData.image)},s.prototype.loadMarkersAndZones=function(){var t=this;t.savedData.zones.forEach(function(n,r){var i=t.markers.findWhere(n.topMarker)||new e(n.topMarker),s=t.markers.findWhere(n.baseMarker)||new e(n.baseMarker);t.markers.add(i),t.markers.add(s);var o=t.zones.findWhere({topMarker:i,baseMarker:s});o!==undefined&&o.set({name:n.name,description:n.description})})},s.prototype.loadWellsAndTransects=function(){var e=this;e.savedData.transects.forEach(function(n,r){var i=e.wells.findWhere(n.wellLeft)||new t(n.wellLeft),s=e.wells.findWhere(n.wellRight)||new t(n.wellRight);e.wells.add(i),e.wells.add(s);var o=e.transects.findWhere({wellLeft:i,wellRight:s});o!==undefined&&o.set({name:n.name,description:n.description})})},s.prototype.loadPolygons=function(){var e=this;e.savedData.polygons.forEach(function(t){e.createPolygon(t)})},s.prototype.createPolygon=function(e){var t=this,i=t.polygons.findWhere({name:e.name,patternName:e.patternName})||new n({name:e.name});this.polygons.add(i),e.points.forEach(function(e){var t=i.get("points").findWhere(e)||new r(e);i.get("points").add(t)}),i.set({patternName:e.patternName})},s.prototype.loadTexts=function(){var e=this;e.savedData.texts.forEach(function(t){var n=e.texts.findWhere({text:t.text,x:t.x,y:t.y})||new i(t);e.texts.add(n),n.get("settings").set(t.settings)})},s}),define("transectTexts",["baseCollection","transectText"],function(e,t){var n=e.extend({classname:"TransectTexts",model:t});return n.prototype.updateTransectTexts=function(){return this.each(function(e){e.updateTransectAndZone()}),!0},n}),define("exporter",["polygon","polygons","point","points","line","lines","transects","transectTexts","polyK"],function(e,t,n,r,i,s,o,u,a){var f=function(){this.PRECISION=transectApp.precision,this.STEPS=transectApp.steps};return f.prototype.initialize=function(){var e=this;this.texts=transectApp.TransectTextsCollection,this.polygons=transectApp.PolygonsCollection,this.transects=transectApp.TransectsCollection,this.zones=transectApp.ZonesCollection,this.transectImage=transectApp.TransectImage,e.transectsData={},transectApp.TransectsCollection.each(function(n){e.transectsData[n.get("id")]={data:n,polygons:new t,points:new r,texts:new u,matrixPositions:[],matrixAges:[],matrix:{}}}),e.wellsData={},transectApp.TransectWellsCollection.each(function(t){e.wellsData[t.get("id")]={data:t,referencePoints:[]}}),e.points=new r,e.lines=new s},f.prototype.export=function(){this.initialize(),this.processData(),this.sortData(),this.processTexts()},f.prototype.processTexts=function(){var e=this;e.texts.each(function(t){var n=t.get("transect").id;e.transectsData[n].texts.add(t)})},f.prototype.sortData=function(){var e=this;for(var t in e.transectsData)e.sortTransectsData(e.transectsData[t]);for(var t in e.wellsData)e.sortWellsData(e.wellsData[t])},f.prototype.sortTransectsData=function(e){e.matrixPositions=_.uniq(e.matrixPositions),e.matrixAges=_.uniq(e.matrixAges),e.matrixPositions=_.sortBy(e.matrixPositions,function(e){return parseInt(e)}),e.matrixAges=_.sortBy(e.matrixAges,function(e){return parseFloat(e)})},f.prototype.sortWellsData=function(e){e.referencePoints=_.uniq(e.referencePoints),e.referencePoints=_.sortBy(e.referencePoints,function(e){return e.point.get("age")})},f.prototype.processData=function(){this.polygons.each(this.processPolygon.bind(this))},f.prototype.processPolygon=function(e){var t=this.getUnderlyingTransects(e);this.slicePolygon(e,t)},f.prototype.getUnderlyingTransects=function(e){var t=this,n=new o,r=[];e.get("points").each(function(e){var n=e.get("transect"),i=t.transects.indexOf(n);r=_.union(r,i)});var i=_.min(r),s=_.max(r);for(var u=i;u<=s;u++)n.add(t.transects.at(u));return n},f.prototype.slicePolygon=function(n,r){var i=this,s=r.length,o=new t,u=new e;u.get("points").add(n.get("points").clone().toArray()),u.get("lines").add(n.get("lines").clone().toArray()),o.add(u);for(var f=0;f<r.length;f++){var l=r.at(f),c=new t;for(var h=0;h<o.length;h++){var p=o.at(h),d=i.getLineSegmentForWell(l.get("wellRight")).getPolyKPointsArray(),v=p.getPolyKPointsArray();a.GetArea(v)>0&&(v=a.Reverse(v));var m=a.Slice(v,d[0],d[1],d[2],d[3]),m=i.getPolygonsFromPolyKPolygonsArray(m);c.add(m.toArray())}o=c}for(var h=0;h<o.length;h++){var p=o.at(h),l=i.getTransectForPolygon(p,r);if(l===null)continue;var g=l.get("id");p.set({patternName:n.get("patternName")}),i.updatePolygonLines(p,n),i.updatePointsOnWell(l.get("wellLeft"),p.get("lines"),n);var f=r.toArray().indexOf(l);f==s-1&&i.updatePointsOnWell(l.get("wellRight"),p.get("lines"),n),i.transectsData[g].points.add(p.get("points")),i.transectsData[g].polygons.add(p),i.updateTransectMatrix(l,p)}},f.prototype.getTransectForPolygon=function(e,t){for(var n=0;n<t.length;n++){var r=t.at(n),i=r.getPolyKPointsArray(),s=!0;for(var o=0;o<e.get("points").length;o++){var u=e.get("points").at(o);if(!a.ContainsPoint(i,u.get("x"),u.get("y"))){s=!1;break}}if(s)return r}return null},f.prototype.updateTransectMatrix=function(e,t){var n=this,r=t.get("points"),i=n.transectsData[e.get("id")].matrix,s=n.transectsData[e.get("id")].matrixAges,o=n.transectsData[e.get("id")].matrixPositions;r.each(function(t){var r=t.get("age"),u=n.PRECISION*Math.round(t.get("relativeX")*100/n.PRECISION),a=t.get("transect");a!==e&&(a.get("wellLeft")===e.get("wellRight")?u=100:u=0),r in i||(i[String(r)]={}),s.indexOf(r)<0&&s.push(r),o.indexOf(r)<0&&o.push(u),i[String(r)][String(u)]=t.get("name")})},f.prototype.updatePointsOnWell=function(e,t,n){var r=this;t.each(function(t){if(r.isCloseToWell(e,t))if(t.get("point1").get("y")<t.get("point2").get("y")){_.findWhere(r.wellsData[e.get("id")].referencePoints,{point:t.get("point1")})||r.wellsData[e.get("id")].referencePoints.push({point:t.get("point1"),pattern:"TOP"});var i=_.findWhere(r.wellsData[e.get("id")].referencePoints,{point:t.get("point2")});if(i==undefined)r.wellsData[e.get("id")].referencePoints.push({point:t.get("point2"),pattern:n.get("patternName")||"None",name:n.get("name")});else{var s=r.wellsData[e.get("id")].referencePoints.indexOf(i);r.wellsData[e.get("id")].referencePoints[s].name=n.get("name"),r.wellsData[e.get("id")].referencePoints[s].pattern=n.get("patternName")||"None"}}else{_.findWhere(r.wellsData[e.get("id")].referencePoints,{point:t.get("point2")})||r.wellsData[e.get("id")].referencePoints.push({point:t.get("point2"),pattern:"TOP"});var i=_.findWhere(r.wellsData[e.get("id")].referencePoints,{point:t.get("point1")});if(i===undefined)r.wellsData[e.get("id")].referencePoints.push({point:t.get("point1"),pattern:n.get("patternName")||"None",name:n.get("name")});else{var s=r.wellsData[e.get("id")].referencePoints.indexOf(i);r.wellsData[e.get("id")].referencePoints[s].name=n.get("name"),r.wellsData[e.get("id")].referencePoints[s].pattern=n.get("patternName")||"None"}}})},f.prototype.isCloseToWell=function(e,t){var n=this,r=n.getLineSegmentForWell(e),i=r.getPolyKPointsArray(),s=5,o=[i[0]+s,i[1],i[0]-s,i[1],i[2]-s,i[3],i[2]+s,i[3]],u=t.getPolyKPointsArray();return a.ContainsPoint(o,u[0],u[1])&&a.ContainsPoint(o,u[2],u[3])?!0:!1},f.prototype.updatePolygonLines=function(e,t){var n=this,r=e.get("points"),o=new s;r.each(function(s,o){if(o>0){var u=r.at(o-1),a=s,f=n.lines.findWhere({point1:u,point2:a})||n.lines.findWhere({point1:a,point2:u})||new i({},u,a);n.lines.add(f),n.updateLineStyleFromOriginalPolygon(f,t),e.get("lines").add(f)}});var u=r.last(),a=r.first(),f=n.lines.findWhere({point1:u,point2:a})||n.lines.findWhere({point1:a,point2:u})||new i({},u,a);n.lines.add(f),n.updateLineStyleFromOriginalPolygon(f,t),e.get("lines").add(f)},f.prototype.updateLineStyleFromOriginalPolygon=function(e,t){var n=this,r=t.get("lines");for(var i=0;i<r.length;i++){var s=r.at(i);if(s.coincides(e)){e.set({pattern:s.get("pattern")});break}}},f.prototype.getLineSegmentForWell=function(e){var t=this.points.findWhere({x:Math.floor(e.get("x")),y:0})||new n({x:Math.floor(e.get("x")),y:0}),r=this.points.findWhere({x:Math.floor(e.get("x")),y:Math.floor(transectApp.Canvas.height)})||new n({x:Math.floor(e.get("x")),y:Math.floor(transectApp.Canvas.height)});this.points.add(t),this.points.add(r);var s=this.lines.findWhere({point1:t,point2:r})||this.lines.findWhere({point1:r,point2:t})||new i({},t,r);return this.lines.add(s),s},f.prototype.getPolygonsFromPolyKPolygonsArray=function(e){var n=new t;for(var r in e)n.add(this.getPointsFromPolykPolygon(e[r]));return n},f.prototype.getPointsFromPolykPolygon=function(t){var r=new e;for(var i=0;i<t.length;i+=2){var s=this.points.findWhere({x:Math.floor(t[i]),y:Math.floor(t[i+1])})||new n({x:Math.floor(t[i]),y:Math.floor(t[i+1])});this.points.add(s),r.get("points").add(s)}return r},f.prototype.getText=function(){var e=this,t="";for(var n=0;n<e.transects.length;n++){var r=e.transects.at(n);if(n==0){var i=r.get("wellLeft").id;t+=e.getWellOutputText(i)}t+=e.getTransectOutputText(r.id);var s=r.get("wellRight").id;t+=e.getWellOutputText(s)}return t},f.prototype.getTransectOutputText=function(e){var t=this,n=t.transectsData[e],r="\n\n";return r+=n.data.get("name")+"	",r+="transect	",r+=n.data.get("width")+"	",r+=CssToTscColor(n.data.get("settings").get("backgroundColor"))+"	",r+=n.data.get("status")+"	",r+=t.getTransectMatrixText(e),r+=t.getTransectPolygonsListText(e),r+=t.getTextLabelsOutput(e),r},f.prototype.getTransectMatrixText=function(e){var t=this,n=t.transectsData[e],r=n.matrixAges,i=n.matrixPositions,s="\n		";for(var o=0;o<i.length;o++)s+=i[o]+"	";for(var o=0;o<r.length;o++){var u=String(r[o]);s+="\n	",s+=u+"	";for(var a=0;a<i.length;a++){var f=i[a];s+=(n.matrix[String(u)][String(f)]||"")+"	"}}return s},f.prototype.getTransectPolygonsListText=function(e){var t=this,n=t.transectsData[e],r="";for(var i=0;i<n.polygons.length;i++){var s=n.polygons.at(i);r+="\n",r+="POLYGON	",r+="pattern: "+(s.get("patternName")||"None")+"	",r+=s.get("description")||"	";var o=s.get("lines"),u=s.get("points");for(var a=0;a<u.length;a++){var f=u.at(a),l=u.at((a+1)%u.length),c=o.findWhere({point1:f,point2:l})||o.findWhere({point1:l,point2:f}),h=c.get("pattern");r+="\n	",r+=f.get("name").substring(1),h!=="default"&&(r+="\n		",r+=h)}}return r},f.prototype.getWellOutputText=function(e){var t=this,n=t.wellsData[e],r="\n\n";r+=n.data.get("name")+"	",r+="facies	",r+=n.data.get("width")+"	",r+=CssToTscColor(n.data.get("settings").get("backgroundColor"))+"	",r+"\n";for(var i in n.referencePoints)r+="\n",r+="	",r+=(n.referencePoints[i].pattern||"None")+"	",r+=(n.referencePoints[i].name||"")+"	",r+=n.referencePoints[i].point.get("age")+"	",r+="CALIBRATION = "+Math.round(n.referencePoints[i].point.get("relativeY")*1e3)/10+"	";return r},f.prototype.getTextLabelsOutput=function(e){var t="",n=this.transectsData[e].texts;return n.each(function(e){var n=e.get("bBox"),r=e.get("text").split("\n").join(""),i=e.get("settings").get("fontFamily").split(",")[0];t+="\n",t+="TEXT	"+n.y1+"	"+n.x1,t+="	"+r,t+="	font-family: "+i+"; font-size: "+e.get("settings").get("fontSize")+";",t+="	"+n.y2+"	"+n.x2}),t},f.prototype.getJSON=function(){var e={};return e.transects=this.transects.toJSON(),e.zones=this.zones.toJSON(),e.polygons=this.polygons.toJSON(),e.texts=this.texts.toJSON(),e.image=this.transectImage.toJSON(),JSON.stringify(e)},f});var transectApp=transectApp||{};define("transectAppView",["baseView","cursorView","transectsView","transectImageView","transectMarkersView","transectWellsView","transectTextsView","zonesView","polygonsView","dataImportView","dataExportView","fileSystemView","transectImage","loader","exporter"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d){var v=e.extend({el:".container",classname:"TransectAppView",events:{"click a.transect-settings":"showSettings","click a.transect-tools":"enableTool","click a.continue":"showCanvas","dragover #data-box":"dataDragover","drop #data-box":"dataDrop"}});return v.prototype.initialize=function(){transectApp.CurrentPolygon=null,this.x=0,this.y=0,this.width=2e3,this.height=2e3,transectApp.StatusBox=$(".status-box"),this.$introScreen=this.$("#intro-screen"),this.$canvas=this.$("#canvas"),this.$displayPanels=this.$(".display-panel"),transectApp.TransectImage=new h({}),transectApp.Canvas=new Raphael(this.$canvas[0],this.width,this.height),transectApp.loader=new p,transectApp.exporter=new d,transectApp.TextsSet=transectApp.Canvas.set(),transectApp.MarkersSet=transectApp.Canvas.set(),transectApp.WellsSet=transectApp.Canvas.set(),transectApp.PointsSet=transectApp.Canvas.set(),transectApp.LinesSet=transectApp.Canvas.set(),transectApp.PolygonsSet=transectApp.Canvas.set(),transectApp.PolygonCount=0,transectApp.TextCount=0,this.render()},v.prototype.showCanvas=function(){this.$canvas.removeClass("hide"),this.$introScreen.addClass("hide")},v.prototype.render=function(){this.cursorView=new t,this.transectsView=new n,this.transectMarkersView=new i,this.transectWellsView=new s,this.transectTextsView=new o,this.zonesView=new u,this.polygonsView=new a,this.dataImportView=new f,this.dataExportView=new l,this.transectImageView=new r,this.fileSystemView=new c},v.prototype.showSettings=function(e){var t=e.target.getAttribute("href")+"-list";$(t).hasClass("active")?($(t).removeClass("active"),$(e.target).removeClass("active"),$(e.target).parent().removeClass("active"),this.$("#sections-panel").removeClass("active")):(this.$(".settings-content").removeClass("active"),this.$(".settings-links").removeClass("active"),this.$(".transect-settings").removeClass("active"),$(t).addClass("active"),$(e.target).addClass("active"),$(e.target).parent().addClass("active"),this.$("#sections-panel").addClass("active"))},v.prototype.showExportDataPanel=function(e){this.$exportPanel.hasClass("active")||this.dataExportView.render()},v.prototype.exportCanvasAsImage=function(){},v.prototype.saveToLocalStorage=function(){transectApp.exporter.export(),localStorage.transectApp=transectApp.exporter.getJSON()},v.prototype.loadFromLocalStorage=function(){this.showCanvas(),transectApp.loader.loadFromLocalStorage()},v.prototype.dataDragover=function(e){var e=e.originalEvent;e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"},v.prototype.dataDrop=function(e){var t=this,e=e.originalEvent;e.stopPropagation(),e.preventDefault();var n=e.dataTransfer.files[0];if(n.type==="application/json"){var r=new FileReader;r.onloadend=function(e){t.showCanvas(),transectApp.loader.loadData(this.result)},r.readAsText(n)}},v.prototype.enableTool=function(e){var t=e.target.getAttribute("href");if(t==="#new-polygon"||t==="#lock-cursor-h"||t==="#lock-cursor-v")return;this.transectMarkersView.enMarkers&&this.transectMarkersView.toggleMarkers(),this.transectWellsView.enWells&&this.transectWellsView.toggleWells(),this.transectTextsView.enTransectTexts&&this.transectTextsView.toggleTransectTexts(),this.polygonsView.enPolygons&&this.polygonsView.togglePolygons(),this.polygonsView.checkAndDeleteCurrentPolygon();switch(t){case"#add-marker":this.transectMarkersView.toggleMarkers();break;case"#add-well":this.transectWellsView.toggleWells();break;case"#add-transect-text":this.transectTextsView.toggleTransectTexts();break;case"#add-polygon":this.polygonsView.togglePolygons();break;case"#export-data":this.dataExportView.toggleExportView();break;case"#file-system":this.fileSystemView.toggleView();break;case"#save-to-local-storage":this.saveToLocalStorage();break;case"#reload-data":this.loadFromLocalStorage();default:}},v}),define("zones",["baseCollection","zone"],function(e,t){var n=e.extend({classname:"Zones",model:t});return n.prototype.getZoneForY=function(e){var t=null;return this.each(function(n){n.isYInsideZone(e)&&(t=n)}),t},n}),define("transectWells",["baseCollection","transectWell"],function(e,t){var n=e.extend({classname:"TransectWells",model:t});return n.prototype.comparator=function(e){return e.get("x")},n}),define("transectMarkers",["baseCollection","transectMarker"],function(e,t){var n=e.extend({classname:"TransectMarkers",model:t});return n.prototype.comparator=function(e){return e.get("y")},n}),requirejs.config({paths:{baseView:"/commons/js/views/base_view",baseModel:"/commons/js/models/base_model",baseCollection:"/commons/js/collections/base_collection",app:"/commons/js/models/app",cursorView:"/commons/js/views/cursor_view",cursor:"/commons/js/models/cursor",transectImageView:"/transect_maker/js/views/transect_image_view",transectImage:"/transect_maker/js/models/transect_image",transectMarkersView:"/transect_maker/js/views/transect_markers_view",transectMarkerView:"/transect_maker/js/views/transect_marker_view",transectMarker:"/transect_maker/js/models/transect_marker",transectMarkers:"/transect_maker/js/collections/transect_markers",transectWellsView:"/transect_maker/js/views/transect_wells_view",transectWellView:"/transect_maker/js/views/transect_well_view",transectWell:"/transect_maker/js/models/transect_well",transectWells:"/transect_maker/js/collections/transect_wells",zoneView:"/transect_maker/js/views/zone_view",zonesView:"/transect_maker/js/views/zones_view",zone:"/transect_maker/js/models/zone",zones:"/transect_maker/js/collections/zones",transectView:"/transect_maker/js/views/transect_view",transectsView:"/transect_maker/js/views/transects_view",transect:"/transect_maker/js/models/transect",transects:"/transect_maker/js/collections/transects",polygonView:"/transect_maker/js/views/polygon_view",polygonsView:"/transect_maker/js/views/polygons_view",polygon:"/transect_maker/js/models/polygon",polygons:"/transect_maker/js/collections/polygons",pointView:"/transect_maker/js/views/point_view",point:"/transect_maker/js/models/point",points:"/transect_maker/js/collections/points",lineView:"/transect_maker/js/views/line_view",line:"/transect_maker/js/models/line",lines:"/transect_maker/js/collections/lines",transectTextView:"/transect_maker/js/views/transect_text_view",transectTextsView:"/transect_maker/js/views/transect_texts_view",transectText:"/transect_maker/js/models/transect_text",transectTexts:"/transect_maker/js/collections/transect_texts",exporter:"/transect_maker/js/utils/exporter",dataExportView:"/transect_maker/js/views/data_export_view",loader:"/transect_maker/js/utils/loader",dataImportView:"/transect_maker/js/views/data_import_view",transectAppView:"/transect_maker/js/views/transect_app_view",settings:"/commons/js/models/settings",polyK:"/commons/js/lib/polyK",file:"/file_system/js/models/file",files:"/file_system/js/collections/files",fileView:"/file_system/js/views/file_view",filesView:"/file_system/js/views/files_view",fileSystem:"/file_system/js/models/file_system",fileSystemView:"/file_system/js/views/file_system_view"}});var transectApp=transectApp||{};requirejs(["transectAppView","transects","transectTexts","polygons","lines","points","zones","transectWells","transectMarkers"],function(e,t,n,r,i,s,o,u,a){transectApp.TransectsCollection=new t,transectApp.TransectTextsCollection=new n,transectApp.PolygonsCollection=new r,transectApp.LinesCollection=new i,transectApp.PointsCollection=new s,transectApp.ZonesCollection=new o,transectApp.TransectWellsCollection=new u,transectApp.TransectMarkersCollection=new a;var f=new e}),define("transect_maker/js/transect_app",function(){});