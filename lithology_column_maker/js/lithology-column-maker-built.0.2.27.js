define("baseView",[],function(){var e=Backbone.View.extend({});return e.prototype.wrapString=function(e,t,n,r){n=n||"\n",t=t||75,r=r||!1;if(!e)return e;var i=".{1,"+t+"}(\\s|$)"+(r?"|.{"+t+"}|.+$":"|\\S+?(\\s|$)");return e.match(RegExp(i,"g")).join(n)},e}),define("baseModel",[],function(){var e=Backbone.Model.extend({sync:function(){return!1}});return _.extend(this.Backbone.Events),e.prototype.update=function(){this.trigger("update")},e.prototype.toggle=function(){this.trigger("toggle")},e}),define("cursor",["baseModel"],function(e){var t=e.extend({constructor:function(t,n){var r=[{lockH:!1,lockV:!1}];e.apply(this,r)}});return t}),define("cursorView",["baseView","cursor"],function(e,t){var n=e.extend({el:".main",classname:"CursorView",events:{keypress:"togglelock",'click a[href="#lock-cursor-h"]':"toggleHlock",'click a[href="#lock-cursor-v"]':"toggleVlock"}});return n.prototype.initialize=function(e){this.app=e,this.cursor=new t,this.app.Cursor=this.cursor,this.$hLock=this.$('a[href="#lock-cursor-h"]'),this.$vLock=this.$('a[href="#lock-cursor-v"]')},n.prototype.togglelock=function(e){e.keyCode==TimescaleApp.KEY_MINUS&&this.toggleHlock(),e.keyCode==TimescaleApp.KEY_EQUAL&&this.toggleVlock()},n.prototype.toggleHlock=function(){this.$vLock.parent().hasClass("active")&&this.toggleVlock(),this.$hLock.parent().toggleClass("active"),this.cursor.set({lockH:!this.cursor.get("lockH")})},n.prototype.toggleVlock=function(){this.$hLock.parent().hasClass("active")&&this.toggleHlock(),this.$vLock.parent().toggleClass("active"),this.cursor.set({lockV:!this.cursor.get("lockV")})},n}),define("file",["baseModel"],function(e){var t=e.extend({classname:"File",constructor:function(t,n){var r=[{name:t.name,isFile:t.isFile,isDirectory:t.isDirectory,size:t.Size||0,fullPath:t.fullPath,url:t.toURL(),selected:!1,type:null,size:0,modificationTime:null}];e.apply(this,r)}});return t.prototype.initialize=function(e,t){var n=this.get("name").split(".").pop();this.set({type:n})},t.prototype.updateFileData=function(e){var t=new Date(e.modificationTime);this.set({size:e.size,modificationTime:t.getTime()})},t}),define("baseCollection",[],function(){var e=Backbone.Collection.extend({});return e}),define("files",["baseCollection","file"],function(e,t){var n=e.extend({classname:"Files",model:t});return n.prototype.comparator=function(e){return-e.get("modificationTime")},n}),define("fileView",["baseView"],function(e){var t=e.extend({tagName:"div",classname:"FileView",events:{dblclick:"open",click:"select","blur .file-name":"blur"}});return t.prototype.template=new EJS({url:"/file_system/ejs/file.ejs"}),t.prototype.initialize=function(e,t,n,r){this.app=r,this.fileSystem=n,this.files=t,this.file=e,this.listenTo(this.file,"change:selected",this.setSelected.bind(this)),this.listenTo(this.file,"change:name",this.rename.bind(this)),this.listenTo(this.file,"destroy",this.delete.bind(this)),this.listenToActionEvents(),this.render()},t.prototype.listenToActionEvents=function(){$('a[href="#delete-file"]').click(this.deleteFile.bind(this)),$('a[href="#load-data"]').click(this.loadData.bind(this))},t.prototype.render=function(){var e=this.file.toJSON();this.$el.html(this.template.render(e)),this.$file=this.$(".file"),this.$fileName=this.$(".file-name")[0]},t.prototype.deleteFile=function(){var e=this;if(!e.file.get("selected"))return;e.file.get("isFile")?e.fileSystem.get("fs").root.getFile(e.file.get("fullPath"),{},function(t){t.remove(function(){console.log("File removed."),e.file.destroy()},e.errorHandler.bind(this))},e.errorHandler.bind(this)):e.fileSystem.get("fs").root.getDirectory(e.file.get("fullPath"),{},function(t){t.removeRecursively(function(){console.log("Directory removed."),e.file.destroy()},e.errorHandler.bind(this))},e.errorHandler.bind(this))},t.prototype.select=function(){var e=this;this.files.each(function(t){t==e.file?t.set({selected:!t.get("selected")}):t.set({selected:!1})})},t.prototype.setSelected=function(){this.file.get("selected")?this.$file.addClass("active"):this.$file.removeClass("active")},t.prototype.blur=function(){this.file.set({name:this.$fileName.textContent})},t.prototype.rename=function(){var e=this;e.file.get("isFile")?e.fileSystem.get("fs").root.getFile(e.file.get("fullPath"),{},function(t){var n=e.file.get("fullPath").split("/");n.pop(),n=n.join("/"),n===""&&(n="/"),e.fileSystem.get("fs").root.getDirectory(n,{},function(n){t.moveTo(n,e.file.get("name")),e.file.destroy()},e.errorHandler.bind(this))},e.errorHandler.bind(this)):e.fileSystem.get("fs").root.getDirectory(e.file.get("fullPath"),{},function(t){var n=e.file.get("fullPath").split("/");n.pop(),n=n.join("/"),n===""&&(n="/"),e.fileSystem.get("fs").root.getDirectory(n,{},function(n){t.moveTo(n,e.file.get("name")),e.file.destroy()},e.errorHandler.bind(this))},e.errorHandler.bind(this))},t.prototype.open=function(){var e=this;e.file.get("isFile")||this.fileSystem.set({path:this.file.get("fullPath")})},t.prototype.errorHandler=function(e){console.log("Error: "+e.name+" "+e.message)},t.prototype.loadData=function(){var e=this;if(e.file.get("isDirectory")||!e.file.get("selected"))return;e.fileSystem.get("fs").root.getFile(e.file.get("fullPath"),{},function(t){t.file(function(t){var n=new FileReader;n.onloadend=function(t){e.showCanvas(),e.app.loader.loadData(this.result)},n.readAsText(t)},e.errorHandler.bind(e))},e.errorHandler.bind(e))},t.prototype.showCanvas=function(){$("#canvas").removeClass("hide"),$("#file-system-panel").addClass("hide"),$("a[href='#file-system']").parent().removeClass("active")},t.prototype.delete=function(){this.$el.remove(),this.remove()},t}),define("filesView",["baseView","fileView","file"],function(e,t,n){var r=e.extend({classname:"FilesView",el:"#files-list",events:{}});return r.prototype.template=new EJS({url:"/file_system/ejs/files.ejs"}),r.prototype.initialize=function(e,t,n){this.app=n,this.fileSystem=t,this.files=e,this.listenTo(this.files,"add",this.render.bind(this)),this.listenTo(this.files,"remove",this.delFile.bind(this)),this.listenToActionEvents(),this.render()},r.prototype.listenToActionEvents=function(e){$('a[href="#create-file"]').unbind().click(this.createNewFile.bind(this)),$('a[href="#create-dir"]').unbind().click(this.createNewDir.bind(this)),$('a[href="#save-project"]').click(this.saveProject.bind(this))},r.prototype.render=function(){this.$el.html(this.template.render()),this.$list=this.$(".list"),this.files.each(this.addFile.bind(this))},r.prototype.addFile=function(e){var n=new t(e,this.files,this.fileSystem,this.app);this.$list.append(n.el)},r.prototype.createNewFile=function(){var e=this;e.fileSystem.get("fs").root.getDirectory(e.fileSystem.get("path"),{},function(t){e.newFile(t,_.uniqueId("new-file-"))},e.errorHandler.bind(e))},r.prototype.newFile=function(e,t,n){var r=this;e.getFile(t,{create:!0,exclusive:!0},function(e){r.createFile(e,n)},r.errorHandler.bind(r))},r.prototype.createFile=function(e,t){var r=this.fileSystem.get("path");r==="/"?r=[""]:r=this.fileSystem.get("path").split("/"),r.push(e.name),r=r.join("/");if(r===e.fullPath){var i=new n(e);this.files.add(i)}t!==undefined&&t(e)},r.prototype.createNewDir=function(){var e=this;e.fileSystem.get("fs").root.getDirectory(e.fileSystem.get("path"),{},function(t){e.newDir(t,_.uniqueId("new-folder-"))},e.errorHandler.bind(e))},r.prototype.newDir=function(e,t,n){var r=this;e.getDirectory(t,{create:!0},function(e){r.createFile(e,n)},r.errorHandler.bind(r))},r.prototype.saveProject=function(){var e=this,t=e.getTimeStamp(),n=this.app.type+"-"+t;e.fileSystem.get("fs").root.getDirectory(e.fileSystem.get("path"),{},function(r){e.newDir(r,n,function(n){var r=e.app.type+"-data-"+t+".json",i=e.app.type+"-data-"+t+".txt",s=e.app.exporter.getJSON(),o=e.app.exporter.getText();e.newFile(n,r,function(t){e.writeJSONToAFile(t,s),e.newFile(n,i,function(t){e.writeTextToAFile(t,o)})})})},e.errorHandler.bind(e)),this.fileSystem.set({update:!this.fileSystem.get("update")})},r.prototype.writeJSONToAFile=function(e,t){var t=t;if(e.isDirectory)return;var n=this;n.fileSystem.get("fs").root.getFile(e.fullPath,{create:!0},function(e){e.createWriter(function(e){e.onwriteend=function(e){console.log("Write completed.")},e.onerror=function(e){console.log("Write failed: "+e.toString())};var n=new Blob([t],{type:"application/json"});e.write(n)},n.errorHandler.bind(this))},n.errorHandler.bind(this))},r.prototype.writeTextToAFile=function(e,t){var t=t;if(e.isDirectory)return;var n=this;n.fileSystem.get("fs").root.getFile(e.fullPath,{create:!0},function(e){e.createWriter(function(e){e.onwriteend=function(e){console.log("Write completed.")},e.onerror=function(e){console.log("Write failed: "+e.toString())};var n=new Blob([t],{type:"text/plain"});e.write(n)},n.errorHandler.bind(this))},n.errorHandler.bind(this))},r.prototype.getTimeStamp=function(){var e=new Date,t=e.getUTCMonth()+"-"+e.getUTCDate()+"-";return t+=e.getUTCFullYear()+"-"+e.getHours()+"_",t+=e.getMinutes()+"_"+e.getSeconds(),t},r.prototype.errorHandler=function(e){console.log("Error: "+e.name+" "+e.message)},r.prototype.delFile=function(){this.fileSystem.set({update:!this.fileSystem.get("update")})},r}),define("fileSystem",["baseModel"],function(e){var t=e.extend({classname:"FileSystem",constructor:function(t,n){var r=[{fs:t.fs,path:"/",update:!1}];e.apply(this,r)}});return t}),define("fileSystemView",["baseView","file","files","filesView","fileSystem"],function(e,t,n,r,i){var s=e.extend({classname:"FileSystemView",el:"#file-system-panel",events:{"click a[href='#parent-dir']":"parentDir","click a.path-breadcrumb":"setDir"}});return s.prototype.template=new EJS({url:"/file_system/ejs/file_system_panel.ejs"}),s.prototype.initialize=function(e){this.app=e,this.$canvas=$("#canvas");var t=1073741824;navigator&&navigator.webkitPersistentStorage&&navigator.webkitPersistentStorage.requestQuota(t,this.requestFileSystem.bind(this),this.errorHandler.bind(this))},s.prototype.requestFileSystem=function(e){window.webkitRequestFileSystem(webkitStorageInfo.PERSISTENT,e,this.render.bind(this),this.errorHandler.bind(this))},s.prototype.updateQuota=function(){var e=this;window.webkitStorageInfo.queryUsageAndQuota(webkitStorageInfo.PERSISTENT,function(t,n){e.$quota.html("Used "+parseInt(t/1e5)/10+" mb of "+parseInt(n/1e5)/10+" mb.")},e.errorHandler.bind(e))},s.prototype.render=function(e){this.fileSystem=new i({fs:e}),this.renderDirs(),this.listenTo(this.fileSystem,"change:path",this.renderDirs.bind(this)),this.listenTo(this.fileSystem,"change:update",this.renderDirs.bind(this))},s.prototype.renderDirs=function(){this.$el.html(this.template.render(this.fileSystem.toJSON())),this.$quota=this.$(".quota");var e=this,t=this.fileSystem.get("path");this.files=new n,this.filesView=new r(this.files,this.fileSystem,this.app),this.fileSystem.get("fs").root.getDirectory(t,{},function(t){if(t.isDirectory){var n=t.createReader();n.readEntries(e.readDir.bind(e))}},e.errorHandler),this.readDir(),this.updateQuota()},s.prototype.readDir=function(e){var n=this;if(e===undefined||!e.length)return;if(n.fileSystem.get("update")){n.fileSystem.set({update:!1});return}e.forEach(function(e){var r=new t(e);e.getMetadata(function(e){r.updateFileData(e),n.files.add(r)})})},s.prototype.parentDir=function(){var e=this.fileSystem.get("path");if(e==="/")return;e=e.split("/"),e.pop(),e=e.join("/"),this.fileSystem.set({path:e})},s.prototype.setDir=function(e){var t=$(e.target).attr("path");t===""&&(t="/"),this.fileSystem.set({path:t})},s.prototype.toggleView=function(e){$("a[href='#file-system']").parent().hasClass("active")?($("a[href='#file-system']").parent().removeClass("active"),$(".display-panel").addClass("hide"),this.$canvas.removeClass("hide")):($(".maker-tools").parent().removeClass("active"),$("a[href='#file-system']").parent().addClass("active"),$(".display-panel").addClass("hide"),this.$el.removeClass("hide"),this.app.exporter.export())},s.prototype.errorHandler=function(e){console.log("Error: "+e.name+" "+e.message)},s}),define("marker",["baseModel"],function(e){var t=e.extend({classname:"Marker",constructor:function(t,n){var r=[{edit:!1,name:t.name||_.uniqueId("Time Line "),y:t.y,age:t.age!==undefined?t.age:null,hover:!1}];e.apply(this,r)}});return t.prototype.dragEnd=function(){this.trigger("dragEnd")},t}),define("markers",["baseCollection","marker"],function(e,t){var n=e.extend({classname:"Markers",model:t});return n.prototype.comparator=function(e){return e.get("y")},n}),define("markerView",["baseView"],function(e){var t=e.extend({tagName:"li",classname:"MarkerView",events:{"click .toggle":"toggleMarkerForm","click .marker-data":"toggleMarkerForm","click .destroy":"destroy","keypress :input":"updateMarker","keyup :input":"updateMarker",mouseover:"onMouseOver",mouseout:"onMouseOut"}});return t.prototype.template=new EJS({url:"/commons/ejs/marker.ejs"}),t.prototype.initialize=function(e,t,n){this.app=e,this.markersView=n,this.marker=t,this.render(),this.listenTo(this.marker,"change:edit",this.editMarker.bind(this)),this.listenTo(this.marker,"change:hover",this.setHoverStatus.bind(this)),this.listenTo(this.marker,"update",this.renderMarker.bind(this)),this.listenTo(this.marker,"change:y",this.renderMarker.bind(this)),this.listenTo(this.marker,"destroy",this.delete.bind(this))},t.prototype.render=function(){this.$el.html(this.template.render(this.marker.toJSON())),this.$toggle=this.$(".toggle"),this.$markerForm=this.$(".marker-form"),this.$markerData=this.$(".marker-data"),this.$markerName=this.$('input[name="marker-name"]')[0],this.$markerAge=this.$('input[name="marker-age"]')[0],this.editMarker(),this.renderMarker()},t.prototype.renderMarker=function(){this.element===undefined&&(this.element=this.app.Canvas.path(),this.element.attr({"stroke-width":2,stroke:"#900000"}),this.element.hover(this.onMouseOver.bind(this),this.onMouseOut.bind(this)),this.element.drag(this.dragMove.bind(this),this.dragStart.bind(this),this.dragEnd.bind(this)),this.element.toFront(),this.app.MarkersSet.push(this.element)),this.element.attr({path:this.getPath()}),this.app.type!=="transect"&&this.resizeCanvas(),this.renderTooltip()},t.prototype.renderTooltip=function(){var e=this.marker.get("age")===null?"-":this.marker.get("age");$(this.element.node).qtip({content:{text:this.marker.get("name")+"【"+e+" myr】"},position:{my:"bottom left",target:"mouse"}})},t.prototype.getPath=function(){return"M0,"+this.marker.get("y")+"H"+(this.app.width||this.app.Canvas.width)},t.prototype.dragStart=function(e,t,n){var r=this.app.MarkersCollection,i=r.indexOf(this.marker);this.prevMarker=r.at(i-1),this.nextMarker=r.at(i+1)},t.prototype.dragMove=function(e,t,n,r,i){var s=i.offsetX,o=i.offsetY;if(this.app.type==="transect"){var u=ViewboxToCanvas(this.app,i.offsetX,i.offsetY);s=u.x,o=u.y}if(this.prevMarker&&this.nextMarker&&(this.prevMarker.get("y")+2>o||o>this.nextMarker.get("y")-2))return;if(!this.prevMarker&&this.nextMarker&&o>this.nextMarker.get("y")-2)return;if(this.prevMarker&&!this.nextMarker&&this.prevMarker.get("y")+2>o)return;this.marker.set({y:o})},t.prototype.dragEnd=function(e){this.marker.dragEnd()},t.prototype.onMouseOver=function(){this.markersView.undelegateEvents(),this.$el.addClass("hover"),this.marker.set({hover:!0})},t.prototype.onMouseOut=function(){this.markersView.delegateEvents(),this.$el.removeClass("hover"),this.marker.set({hover:!1})},t.prototype.setHoverStatus=function(){this.marker.get("hover")?(this.element.attr({"stroke-width":5}),this.$el.addClass("hover")):(this.element.attr({"stroke-width":2}),this.$el.removeClass("hover"))},t.prototype.toggleMarkerForm=function(){this.render(),this.marker.set({edit:!this.marker.get("edit")})},t.prototype.editMarker=function(){this.marker.get("edit")?(this.$markerForm.removeClass("hide"),this.$markerData.addClass("hide"),this.$toggle.removeClass("hide-data"),this.$toggle.addClass("show-data")):(this.$markerForm.addClass("hide"),this.$markerData.removeClass("hide"),this.$toggle.removeClass("show-data"),this.$toggle.addClass("hide-data"))},t.prototype.updateMarker=function(e){e.keyCode==13&&this.toggleMarkerForm();var t=this.$markerName.value,n=parseFloat(this.$markerAge.value)||0;this.marker.set({name:t,age:n}),this.marker.update()},t.prototype.delete=function(){this.element!==undefined&&this.element.remove(),this.$el.remove(),this.remove()},t.prototype.destroy=function(){var e=this.app.ZonesCollection.findWhere({topMarker:this.marker}),t=this.app.ZonesCollection.findWhere({baseMarker:this.marker});this.marker.destroy(),e&&e.destroy(),t&&t.destroy()},t.prototype.resizeCanvas=function(){var e=Math.max(this.app.Canvas.height,this.marker.get("y")+100);this.app.Canvas.setSize(this.app.Canvas.width,e)},t}),define("zone",["baseModel"],function(e){var t=e.extend({classname:"Zone",constructor:function(t,n,r,i){this.app=i;var s=[{edit:!1,name:t.name||_.uniqueId("Zone "),description:t.description||null,topMarker:n,baseMarker:r,toggle:!1}];e.apply(this,s)}});return t.prototype.isYInsideZone=function(e){return this.get("topMarker").get("y")<=e&&e<this.get("baseMarker").get("y")?!0:!1},t.prototype.getRelativeY=function(e){if(this.get("topMarker").get("y")<=e&&e<this.get("baseMarker").get("y")){var t=(e-this.get("topMarker").get("y"))/(this.get("baseMarker").get("y")-this.get("topMarker").get("y"));return Math.round(t*1e3)/1e3}return null},t.prototype.getAbsoluteY=function(e){var t=this.get("topMarker").get("y")+(this.get("baseMarker").get("y")-this.get("topMarker").get("y"))*e;return t},t.prototype.getAbsoluteAge=function(e){if(this.get("topMarker").get("y")<=e&&e<this.get("baseMarker").get("y")&&this.get("topMarker").get("age")!=null&&this.get("baseMarker").get("age")!=null){var t=(e-this.get("topMarker").get("y"))/(this.get("baseMarker").get("y")-this.get("topMarker").get("y"));return age=t*(this.get("baseMarker").get("age")-this.get("topMarker").get("age"))+this.get("topMarker").get("age"),Math.round(age*100)/100}return null},t.prototype.getPolyKPointsArray=function(){return[0,this.get("topMarker").get("y"),0,this.get("baseMarker").get("y"),this.app.width,this.get("baseMarker").get("y"),this.app.width,this.get("topMarker").get("y")]},t}),define("markersView",["baseView","markerView","marker","zone"],function(e,t,n,r){var i=e.extend({el:"#markers-list",classname:"MarkersView"});return i.prototype.template=new EJS({url:"/commons/ejs/data_tbl.ejs"}),i.prototype.initialize=function(e){this.app=e,this.zones=this.app.ZonesCollection,this.markers=this.app.MarkersCollection,this.enMarkers=!1,this.listenTo(this.markers,"add",this.render.bind(this)),this.listenTo(this.markers,"remove",this.render.bind(this)),this.listenToActionEvents(),this.render()},i.prototype.listenToActionEvents=function(){$("#canvas").bind("dblclick",this.createMarker.bind(this))},i.prototype.render=function(){this.$el.html(this.template.render({name:"Markers"})),this.$markersTable=this.$(".data-list"),this.renderMarkers()},i.prototype.renderMarkers=function(){this.markers.each(this.addMarker.bind(this))},i.prototype.addMarker=function(e){var n=new t(this.app,e,this);this.$markersTable.append(n.el),this.updateZones()},i.prototype.toggleMarkers=function(e){$("a[href='#add-marker']").parent().hasClass("active")?($("a[href='#add-marker']").parent().removeClass("active"),this.enMarkers=!1):($("a[href='#add-marker']").parent().addClass("active"),this.enMarkers=!0)},i.prototype.createMarker=function(e){if(this.enMarkers){var t=e.offsetX,r=e.offsetY;this.app.type==="transect"&&(r=ViewboxToCanvas(this.app,t,r).y),this.markers.add(new n({y:r}))}},i.prototype.updateZones=function(){var e=this,t=[];this.markers.sort(),this.markers.each(function(n,i,s){if(i>0){var o=e.zones.findWhere({topMarker:s[i-1],baseMarker:n})||new r({name:"New Zone "+i},s[i-1],n,e.app);e.zones.add(o),i<e.markers.length-1&&(o=e.zones.findWhere({topMarker:s[i-1],baseMarker:s[i+1]}),o&&t.push(o))}}),_.invoke(t,"destroy")},i}),define("zones",["baseCollection","zone"],function(e,t){var n=e.extend({classname:"Zones",model:t});return n.prototype.comparator=function(e){return e.get("topMarker").get("y")},n.prototype.getZoneForY=function(e){var t=null;return this.each(function(n){n.isYInsideZone(e)&&(t=n)}),t},n.prototype.getZoneInNeighborhoodForY=function(e,t){this.sort();if(!t)return null;var n=this.indexOf(t),r=this.at(n-1),i=this.at(n+1);return t.isYInsideZone(e)?t:r&&r.isYInsideZone(e)?r:i&&i.isYInsideZone(e)?i:null},n}),define("zoneView",["baseView"],function(e){var t=e.extend({tagName:"li",classname:"ZoneView",events:{"click .toggle":"toggleZoneForm","click .zone-data":"toggleZoneForm","keypress :input":"updateZone","keyup :input":"updateZone",mouseover:"onMouseOver",mouseout:"onMouseOut"}});return t.prototype.template=new EJS({url:"/commons/ejs/zone.ejs"}),t.prototype.initialize=function(e){this.zone=e,this.listenTo(this.zone,"change:edit",this.toggleEditStatus.bind(this)),this.listenTo(this.zone.get("topMarker"),"dragEnd",this.markersMoved.bind(this)),this.listenTo(this.zone.get("baseMarker"),"dragEnd",this.markersMoved.bind(this)),this.listenTo(this.zone,"destroy",this.delete.bind(this)),this.render()},t.prototype.render=function(){this.$el.html(this.template.render(this.zone.toJSON())),this.$toggle=this.$(".toggle"),this.$zoneForm=this.$(".zone-form"),this.$zoneData=this.$(".zone-data"),this.$zoneName=this.$('input[name="zone-name"]')[0],this.$zoneDescription=this.$('textarea[name="zone-description"]')[0]},t.prototype.toggleZoneForm=function(){this.render(),this.zone.set({edit:!this.zone.get("edit")})},t.prototype.toggleEditStatus=function(){this.zone.get("edit")?(this.$zoneForm.removeClass("hide"),this.$zoneData.addClass("hide"),this.$toggle.removeClass("hide-data"),this.$toggle.addClass("show-data")):(this.$zoneForm.addClass("hide"),this.$zoneData.removeClass("hide"),this.$toggle.removeClass("show-data"),this.$toggle.addClass("hide-data"))},t.prototype.onMouseOver=function(){this.$el.addClass("hover"),this.zone.get("topMarker").set({hover:!0}),this.zone.get("baseMarker").set({hover:!0})},t.prototype.onMouseOut=function(){this.$el.removeClass("hover"),this.zone.get("topMarker").set({hover:!1}),this.zone.get("baseMarker").set({hover:!1})},t.prototype.updateZone=function(e){(e.keyCode==TimescaleApp.ENTER||e.keyCode==TimescaleApp.ESC)&&this.toggleZoneForm();var t=this.$zoneName.value,n=this.$zoneDescription.value.split("\n").join(" ");this.zone.set({name:t,description:n})},t.prototype.delete=function(){this.element!==undefined&&this.element.remove(),this.$el.remove(),this.remove()},t.prototype.destroy=function(){this.zone.destroy()},t.prototype.toggleZone=function(){this.zone.set({toggle:!this.zone.get("toggle")})},t.prototype.markersMoved=function(){this.zone.update()},t}),define("zonesView",["baseView","zoneView","zone"],function(e,t,n){var r=e.extend({el:"#zones-list",classname:"ZonesView"});return r.prototype.template=new EJS({url:"../../../commons/ejs/data_tbl.ejs"}),r.prototype.initialize=function(e){this.app=e,this.zones=this.app.ZonesCollection,this.render(),this.listenTo(this.zones,"add",this.render.bind(this))},r.prototype.render=function(){this.$el.html(this.template.render({name:"Zones"})),this.$zonesTable=this.$(".data-list"),this.zones.each(this.addZone.bind(this))},r.prototype.addZone=function(e){var n=new t(e);this.$zonesTable.append(n.el)},r}),define("settings",["baseModel"],function(e){var t=e.extend({classname:"Settings",constructor:function(t,n){var r=[{fontFamily:t?t.fontFamily:"Arial, Helvetica, sans-serif",fontVariant:t?t.fontVariant:"normal",fontWeight:t?t.fontWeight:"normal",fontStretch:t?t.fontStretch:"normal",fontSize:t?t.fontSize:12,backgroundColor:t&&t.backgroundColor?t.backgroundColor:"#DDDDDD",strokeWidth:t?t.strokeWidth:3,strokeColor:t?t.strokeColor:"#000000"}];e.apply(this,r)}});return t}),define("lithology",["baseModel","settings"],function(e,t){var n=e.extend({classname:"Lithology",constructor:function(n,r){var i=[{edit:!1,hover:!1,id:_.uniqueId("lithology-id"),name:n.name||_.uniqueId("Lithology "),description:n.description,settings:new t,top:n.top||null,base:n.base||null,lithologyGroup:n.lithologyGroup||null,pattern:n.pattern||null,app:r||null}];e.apply(this,i)}});return n.prototype.initialize=function(){this.get("settings").set({backgroundColor:"#EEEEEE"})},n.prototype.toJSON=function(){var e=_.clone(this.attributes);return delete e.lithologyColumn,delete e.lithologyGroup,delete e.app,e},n.prototype.getPatternName=function(){return this.get("pattern")?this.get("app").patternsData[this.get("pattern")].name:null},n}),define("lithologys",["baseCollection","lithology"],function(e,t){var n=e.extend({classname:"Lithologys",model:t});return n.prototype.comparator=function(e){return e.get("top").get("y")},n}),define("lithologyMarker",["baseModel","lithologys"],function(e,t){var n=e.extend({classname:"LithologyMarker",constructor:function(n,r){var i=[{id:_.uniqueId("lithology-marker-id"),name:"TOP",edit:!1,hover:!1,y:parseInt(n.y),id:_.uniqueId("lithology-marker-"),age:null,relativeY:null,lithologyGroup:n.lithologyGroup||null,lithologyGroupMarker:n.lithologyGroupMarker||null,style:"solid",app:r||null,zone:null,lithologys:new t}];e.apply(this,i)}});return n.prototype.initialize=function(){this.updateZone()},n.prototype.toJSON=function(){var e=_.clone(this.attributes);return delete e.lithologyGroup,delete e.lithologyGroupMarker,delete e.lithologys,delete e.lithologyColumn,delete e.app,e},n.prototype.updateZone=function(){var e=this.get("zone")===null?this.get("app").ZonesCollection.getZoneForY(this.get("y")):this.get("app").ZonesCollection.getZoneInNeighborhoodForY(this.get("y"),this.get("zone"));e!==null&&(this.set({zone:e}),this.updateRelativeCoordinates())},n.prototype.updateRelativeCoordinates=function(){this.set({relativeY:this.get("zone").getRelativeY(this.get("y")),age:this.get("zone").getAbsoluteAge(this.get("y"))})},n}),define("lithologyMarkers",["baseCollection","lithologyMarker"],function(e,t){var n=e.extend({classname:"LithologyMarkers",model:t});return n.prototype.comparator=function(e){return e.get("y")},n}),define("lithologyGroup",["baseModel","settings","lithologys","lithologyMarkers"],function(e,t,n,r){var i=e.extend({classname:"LithologyGroup",constructor:function(i,s){var o=[{edit:!1,hover:!1,id:_.uniqueId("lithology-group-id-"),name:i.name||_.uniqueId("Group "),description:i.description,settings:new t,top:i.top||null,base:i.base||null,lithologyColumn:i.lithologyColumn||null,lithologyMarkers:new r,lithologys:new n}];e.apply(this,o)}});return i.prototype.initialize=function(){this.get("settings").set({backgroundColor:"#FFFFFF"})},i.prototype.toJSON=function(){var e=_.clone(this.attributes);return delete e.lithologyColumn,e},i}),define("lithologyGroups",["baseCollection","lithologyGroup"],function(e,t){var n=e.extend({classname:"LithologyGroups",model:t});return n}),define("lithologyGroupMarker",["baseModel","lithologyGroups"],function(e,t){var n=e.extend({classname:"LithologyGroupMarker",constructor:function(n,r){var i=[{id:_.uniqueId("lithology-group-marker-id"),name:"TOP",edit:!1,hover:!1,y:parseInt(n.y),id:_.uniqueId("lithology-marker-"),age:null,relativeY:null,lithologyColumn:n.lithologyColumn||null,style:"solid",app:r||null,zone:null,lithologyGroups:new t}];e.apply(this,i)}});return n.prototype.initialize=function(){this.updateZone()},n.prototype.toJSON=function(){var e=_.clone(this.attributes);return delete e.lithologyGroups,delete e.lithologyColumn,delete e.app,e},n.prototype.updateZone=function(){var e=this.get("zone")===null?this.get("app").ZonesCollection.getZoneForY(this.get("y")):this.get("app").ZonesCollection.getZoneInNeighborhoodForY(this.get("y"),this.get("zone"));e!==null&&(this.set({zone:e}),this.updateRelativeCoordinates())},n.prototype.updateRelativeCoordinates=function(){this.set({relativeY:this.get("zone").getRelativeY(this.get("y")),age:this.get("zone").getAbsoluteAge(this.get("y"))})},n}),define("lithologyGroupMarkers",["baseCollection","lithologyGroupMarker"],function(e,t){var n=e.extend({classname:"LithologyGroupMarkers",model:t});return n.prototype.comparator=function(e){return e.get("y")},n}),define("lithologyColumn",["baseModel","lithologyMarkers","lithologys","lithologyGroups","lithologyGroupMarkers","settings"],function(e,t,n,r,i,s){var o=e.extend({classname:"LithologyColumn",constructor:function(o){var u=[{x:o.x||0,id:_.uniqueId("column-"),name:o.name||_.uniqueId("Column "),width:parseInt(o.width)||400,description:o.description||null,lithologyMarkers:new t,lithologys:new n,lithologyGroupMarkers:new i,lithologyGroups:new r,settings:new s}];e.apply(this,u)}});return o.prototype.comparator=function(e){return e.get("x")},o.prototype.toJSON=function(){var e=_.clone(this.attributes);return delete e.lithologys,e},o}),define("lithologyColumns",["baseCollection","lithologyColumn"],function(e,t){var n=e.extend({classname:"LithologyColumns",model:t});return n}),define("lithologyMarkerView",["baseView"],function(e){var t=e.extend({classname:"LithologyMarkerView"});return t.prototype.statusBoxTemplate=new EJS({url:"/lithology_column_maker/ejs/status_box.ejs"}),t.prototype.initialize=function(e,t){this.app=e,this.lithologyMarker=t,this.listenTo(this.lithologyMarker.get("lithologyGroup").get("lithologyColumn"),"change:x",this.renderLithologyMarker.bind(this)),this.listenTo(this.lithologyMarker.get("lithologyGroup").get("lithologyColumn"),"change:width",this.renderLithologyMarker.bind(this)),this.listenTo(this.lithologyMarker,"change:hover",this.setHoverStatus.bind(this)),this.listenTo(this.lithologyMarker,"change",this.renderLithologyMarker.bind(this)),this.listenTo(this.lithologyMarker,"destroy",this.delete.bind(this)),this.listenTo(this.lithologyMarker.get("lithologys"),"remove",this.checkAndDelete.bind(this)),this.listenTo(this.app.ZonesCollection,"remove",this.updateLithologyMarker.bind(this)),this.listenTo(this.app.ZonesCollection,"change",this.updateLithologyMarker.bind(this)),this.lithologyMarker.get("lithologyGroupMarker")&&this.listenTo(this.lithologyMarker.get("lithologyGroupMarker"),"change:y",this.moveLithologyMarkerWithGroupMarker.bind(this)),this.render()},t.prototype.render=function(){this.renderLithologyMarker()},t.prototype.renderLithologyMarker=function(){this.element===undefined&&(this.element=this.app.Canvas.path(),this.element.attr({"stroke-width":2,stroke:"#0000FF"}),this.element.hover(this.onMouseOver.bind(this),this.onMouseOut.bind(this)),this.element.drag(this.dragMove.bind(this),this.dragStart.bind(this),this.dragEnd.bind(this)),this.app.LithologyMarkersSet.push(this.element),this.app.MarkersSet.toFront());var e=this.lithologyMarker.get("style"),t=[];e==="dashed"?t=["-"]:e==="dotted"&&(t=["."]),this.element.attr({path:this.getPath(),"stroke-dasharray":t}),this.lithologyMarker.updateZone(),this.updateStatusBox(),this.lithologyMarker.get("lithologyGroupMarker")&&this.lithologyMarker.get("lithologyGroupMarker").set({y:this.lithologyMarker.get("y")})},t.prototype.moveLithologyMarkerWithGroupMarker=function(){this.lithologyMarker.set({y:this.lithologyMarker.get("lithologyGroupMarker").get("y")})},t.prototype.updateStatusBox=function(){this.app.StatusBox.html(this.statusBoxTemplate.render(this.lithologyMarker.toJSON()))},t.prototype.getPath=function(){var e=Math.floor(this.lithologyMarker.get("lithologyGroup").get("lithologyColumn").get("width")/2),t=this.lithologyMarker.get("lithologyGroup").get("lithologyColumn").get("x")+e,n=t+e;return"M"+t+","+this.lithologyMarker.get("y")+"H"+n},t.prototype.dragStart=function(e,t,n){var r=this.lithologyMarker.get("lithologyGroup").get("lithologyMarkers"),i=r.indexOf(this.lithologyMarker);this.prevMarker=r.at(i-1),this.nextMarker=r.at(i+1)},t.prototype.dragMove=function(e,t,n,r,i){if(this.prevMarker&&this.nextMarker&&(this.prevMarker.get("y")+2>i.offsetY||i.offsetY>this.nextMarker.get("y")-2))return;if(!this.prevMarker&&this.nextMarker&&i.offsetY>this.nextMarker.get("y")-2)return;if(this.prevMarker&&!this.nextMarker&&this.prevMarker.get("y")+2>i.offsetY)return;this.lithologyMarker.set({y:i.offsetY})},t.prototype.onMouseOver=function(){this.$el.addClass("hover"),this.lithologyMarker.set({hover:!0})},t.prototype.onMouseOut=function(){this.$el.removeClass("hover"),this.lithologyMarker.set({hover:!1})},t.prototype.setHoverStatus=function(){this.lithologyMarker.get("hover")?(this.element.attr({"stroke-width":5}),this.$el.addClass("hover")):(this.element.attr({"stroke-width":2}),this.$el.removeClass("hover"))},t.prototype.dragEnd=function(e){},t.prototype.delete=function(){this.element!==undefined&&this.element.remove(),this.$el.remove(),this.remove()},t.prototype.checkAndDelete=function(){this.lithologyMarker.get("lithologys").length==0&&this.destroy()},t.prototype.destroy=function(){this.lithologyMarker.destroy()},t.prototype.updateLithologyMarker=function(e){if(e!==this.lithologyMarker.get("zone"))return;this.lithologyMarker.updateZone(),this.render()},t}),define("lithologyView",["baseView","lithologyMarker"],function(e,t){var n=e.extend({tagName:"li",classname:"LithologyView",events:{"click .toggle":"toggleLithologyForm","click .lithology-data":"toggleLithologyForm","click .data-labels":"toggleLithologyForm","click .destroy":"destroy","keypress :input":"updateLithology","keyup :input":"updateLithology",'change input[name="lithology-name"]':"updateLithology",'change input[name="lithology-color"]':"updateLithology",'change input[name="lithology-base-relativeY"]':"updateLithology","change select.lithology-line-style":"updateLithology",mouseover:"onMouseOver",mouseout:"onMouseOut"}});return n.prototype.template=new EJS({url:"/lithology_column_maker/ejs/lithology.ejs"}),n.prototype.initialize=function(e,t){this.app=e,this.lithology=t,this.top=this.lithology.get("top"),this.base=this.lithology.get("base"),this.lithologySet===undefined&&(this.lithologySet=this.app.Canvas.set(),this.app.LithologysSet.push(this.lithologySet)),this.listenTo(this.lithology,"change:edit",this.editLithology.bind(this)),this.listenTo(this.lithology,"change:hover",this.setHoverStatus.bind(this)),this.listenTo(this.lithology,"change:name",this.renderLithology.bind(this)),this.listenTo(this.lithology,"change:description",this.renderLithology.bind(this)),this.listenTo(this.lithology,"change:pattern",this.renderLithology.bind(this)),this.listenTo(this.lithology.get("lithologyGroup").get("lithologyColumn"),"change:x",this.renderLithology.bind(this)),this.listenTo(this.lithology.get("lithologyGroup").get("lithologyColumn"),"change:width",this.renderLithology.bind(this)),this.listenTo(this.top,"change:y",this.renderLithology.bind(this)),this.listenTo(this.top,"change:age",this.renderTooltip.bind(this)),this.listenTo(this.top,"change:relativeY",this.renderTooltip.bind(this)),this.listenTo(this.base,"change:y",this.renderLithology.bind(this)),this.listenTo(this.base,"change:age",this.renderTooltip.bind(this)),this.listenTo(this.base,"change:relativeY",this.renderTooltip.bind(this)),this.listenTo(this.lithology.get("settings"),"change",this.renderLithology.bind(this)),this.listenTo(this.lithology,"destroy",this.delete.bind(this)),this.render()},n.prototype.render=function(){var e=this.lithology.toJSON();e.app=this.app,this.$el.html(this.template.render(e)),this.$toggle=this.$(".toggle"),this.$lithologyForm=this.$(".lithology-form"),this.$lithologyData=this.$(".lithology-data"),this.$lithologyName=this.$('input[name="lithology-name"]')[0],this.$lithologyAge=this.$('input[name="lithology-age"]')[0],this.$lithologyDescription=this.$('textarea[name="lithology-description"]')[0],this.$patternsList=this.$(".patterns-list"),this.$lithologyPattern=this.$("select.lithology-pattern"),this.$lithologyImage=this.$(".lithology-image"),this.$lithologyBaseRelativeY=this.$('input[name="lithology-base-relativeY"]')[0],this.$lithologyPattern.change(this.updateLithologyPattern.bind(this)),this.editLithology(),this.renderLithology()},n.prototype.updateLithologyPattern=function(){var e=this.$("select.lithology-pattern option:selected").val();this.lithology.set({pattern:e})},n.prototype.setLithologyFill=function(){if(this.lithBox===undefined)return;var e=this.lithology.get("pattern"),t=e?"url('/pattern_manager/patterns/"+this.app.patternsData[e].image+"')":"#EEEEEE",n=e?parseFloat(this.app.patternsData[e].width)/100:1,r=Math.round(this.lithology.get("lithologyGroup").get("lithologyColumn").get("width")*n/2);this.lithBox.attr({fill:t,width:r});var i=t+" repeat-x";this.$lithologyImage.css("background",i)},n.prototype.renderLithology=function(){this.lithBox===undefined&&(this.bgBox=this.app.Canvas.rect(),this.lithBox=this.app.Canvas.rect(),this.lithologyText=this.app.Canvas.text(),this.bBox=this.app.Canvas.rect(),this.lithologySet.push(this.lithBox),this.lithologySet.push(this.lithologyText),this.lithologySet.push(this.bBox),this.app.MarkersSet.toFront(),this.app.LithologyMarkersSet.toFront(),this.app.LithologyGroupMarkersSet.toFront(),this.bBox.hover(this.onMouseOver.bind(this),this.onMouseOut.bind(this)),this.bBox.dblclick(this.createLithologyMarker.bind(this))),this.bgBox.attr({"stroke-width":0,fill:"#FFFFFF",x:this.lithology.get("lithologyGroup").get("lithologyColumn").get("x")+this.lithology.get("lithologyGroup").get("lithologyColumn").get("width")/2,y:this.top.get("y"),width:this.lithology.get("lithologyGroup").get("lithologyColumn").get("width")/2,height:this.base.get("y")-this.top.get("y"),opacity:.5}),this.lithBox.attr({"stroke-width":0,fill:this.lithology.get("settings").get("backgroundColor"),x:this.lithology.get("lithologyGroup").get("lithologyColumn").get("x")+this.lithology.get("lithologyGroup").get("lithologyColumn").get("width")/2,y:this.top.get("y"),width:this.lithology.get("lithologyGroup").get("lithologyColumn").get("width")/2,height:this.base.get("y")-this.top.get("y"),opacity:.5});var e=Math.round(this.lithology.get("lithologyGroup").get("lithologyColumn").get("x")+this.lithology.get("lithologyGroup").get("lithologyColumn").get("width")/2+this.lithology.get("lithologyGroup").get("lithologyColumn").get("width")/4),t=Math.round((this.top.get("y")+this.base.get("y"))/2),n=Math.min(Math.round(this.base.get("y")-this.top.get("y")),16);this.lithologyText.attr({x:e,y:t,text:this.lithology.get("name"),"font-size":n}),this.bBox.attr({"stroke-width":2,opacity:0,fill:"#FFF",x:this.lithology.get("lithologyGroup").get("lithologyColumn").get("x")+this.lithology.get("lithologyGroup").get("lithologyColumn").get("width")/2,y:this.top.get("y"),width:this.lithology.get("lithologyGroup").get("lithologyColumn").get("width")/2,height:this.base.get("y")-this.top.get("y")}),this.setLithologyFill(),this.renderTooltip()},n.prototype.createLithologyMarker=function(e){if(!this.app.enLithologys)return;var n=this.lithology.get("lithologyGroup").get("lithologyColumn").get("lithologyMarkers").findWhere({y:e.offsetY})||new t({y:e.offsetY,lithologyGroup:this.lithology.get("lithologyGroup")},this.app);this.lithology.get("lithologyGroup").get("lithologyMarkers").add(n),this.lithology.get("lithologyGroup").get("lithologyColumn").get("lithologyMarkers").add(n),this.lithology.destroy()},n.prototype.renderTooltip=function(){$(this.bBox.node).qtip({content:{text:this.lithology.get("name")+"<br>"+(this.lithology.get("description")||"No description yet!")},position:{my:"bottom left",target:"mouse"}})},n.prototype.onMouseOver=function(){this.$el.addClass("hover"),this.lithology.set({hover:!0})},n.prototype.onMouseOut=function(){this.$el.removeClass("hover"),this.lithology.set({hover:!1})},n.prototype.setHoverStatus=function(){this.lithology.get("hover")?(this.$el.addClass("hover"),this.glow=this.bgBox.glow()):(this.glow&&this.glow.remove(),this.$el.removeClass("hover"))},n.prototype.toggleLithologyForm=function(){this.render(),this.lithology.set({edit:!this.lithology.get("edit")})},n.prototype.editLithology=function(){this.lithology.get("edit")?(this.$lithologyForm.removeClass("hide"),this.$lithologyData.addClass("hide"),this.$toggle.removeClass("hide-data"),this.$toggle.addClass("show-data")):(this.$lithologyForm.addClass("hide"),this.$lithologyData.removeClass("hide"),this.$toggle.removeClass("show-data"),this.$toggle.addClass("hide-data"))},n.prototype.delete=function(){this.lithologyText&&this.lithologyText.remove(),this.bgBox&&this.bgBox.remove(),this.lithBox&&this.lithBox.remove(),this.bBox&&this.bBox.remove(),this.glow&&this.glow.remove(),this.$el.remove(),this.remove()},n.prototype.destroy=function(){this.lithology.get("base").set({name:"TOP"}),this.lithology.destroy()},n.prototype.updateLithology=function(e){(e.keyCode===TimescaleApp.ENTER||e.keyCode===TimescaleApp.ESC)&&this.toggleLithologyForm();var t=this.$lithologyName.value,n=this.$lithologyDescription.value,r=this.$("select.lithology-line-style option:selected").val(),i=this.base.get("zone").getAbsoluteY(1-parseFloat(this.$lithologyBaseRelativeY.value)/100);this.base.set({y:i}),this.lithology.set({name:t,description:n}),this.lithology.get("base").set({name:t+" Base"}),this.base.set({style:r})},n}),define("lithologyGroupView",["baseView","lithologyMarker","lithologyMarkerView","lithology","lithologyView"],function(e,t,n,r,i){var s=e.extend({tagName:"li",classname:"LithologyGroupView",events:{"click .toggle":"toggleLithologyGroupForm","click .lithology-group-data":"toggleLithologyGroupForm","click .data-labels":"toggleLithologyGroupForm","click .destroy":"destroy","click label.lithology-group-lithologys-data":"showLithologysList","keypress :input":"updateLithologyGroup","keyup :input":"updateLithologyGroup",'change input[name="lithology-group-color"]':"updateLithologyGroup","change select.lithology-group-line-style":"updateLithologyGroup",mouseover:"onMouseOver",mouseout:"onMouseOut"}});return s.prototype.template=new EJS({url:"/lithology_column_maker/ejs/lithology_group.ejs"}),s.prototype.initialize=function(e,t){this.app=e,this.lithologyGroup=t,this.top=this.lithologyGroup.get("top"),this.base=this.lithologyGroup.get("base"),this.lithologyGroupSet===undefined&&(this.lithologyGroupSet=this.app.Canvas.set(),this.app.LithologyGroupsSet.push(this.lithologyGroupSet)),this.listenTo(this.lithologyGroup,"change:edit",this.render.bind(this)),this.listenTo(this.lithologyGroup,"change:hover",this.setHoverStatus.bind(this)),this.listenTo(this.lithologyGroup,"change:name",this.renderLithologyGroup.bind(this)),this.listenTo(this.lithologyGroup,"change:description",this.renderLithologyGroup.bind(this)),this.listenTo(this.lithologyGroup.get("lithologyColumn"),"change:x",this.renderLithologyGroup.bind(this)),this.listenTo(this.lithologyGroup.get("lithologyColumn"),"change:width",this.renderLithologyGroup.bind(this)),this.listenTo(this.top,"change:y",this.renderLithologyGroup.bind(this)),this.listenTo(this.top,"change:age",this.renderTooltip.bind(this)),this.listenTo(this.top,"change:relativeY",this.renderTooltip.bind(this)),this.listenTo(this.base,"change:y",this.renderLithologyGroup.bind(this)),this.listenTo(this.base,"change:age",this.renderTooltip.bind(this)),this.listenTo(this.base,"change:relativeY",this.renderTooltip.bind(this)),this.listenTo(this.lithologyGroup.get("lithologyMarkers"),"add",this.addLithologyMarker.bind(this)),this.listenTo(this.lithologyGroup.get("lithologys"),"add",this.render.bind(this)),this.listenTo(this.lithologyGroup.get("settings"),"change",this.renderLithologyGroup.bind(this)),this.listenTo(this.lithologyGroup,"destroy",this.delete.bind(this)),this.render(),this.initializeLithologyMarkers()},s.prototype.render=function(){this.$el.html(this.template.render(this.lithologyGroup.toJSON())),this.$toggle=this.$(".toggle"),this.$lithologyGroupForm=this.$(".lithology-group-form"),this.$lithologyGroupData=this.$(".lithology-group-data"),this.$lithologyGroupName=this.$('input[name="lithology-group-name"]')[0],this.$lithologyGroupAge=this.$('input[name="lithology-group-age"]')[0],this.$lithologyGroupColor=this.$('input[name="lithology-group-color"]')[0],this.$lithologyGroupDescription=this.$('textarea[name="lithology-group-description"]')[0],this.$lithologysList=this.$(".lithologys-list"),this.editLithologyGroup(),this.renderLithologyGroup(),this.lithologyGroup.get("lithologys").each(this.addLithology.bind(this))},s.prototype.renderLithologyGroup=function(){this.renderLithologyGroupBlock()},s.prototype.renderLithologyGroupBlock=function(){var e=Math.floor(this.lithologyGroup.get("lithologyColumn").get("width")/2);this.bgBox===undefined&&(this.bgBox=this.app.Canvas.rect(),this.lithologyGroupText=this.app.Canvas.text(),this.bBox=this.app.Canvas.rect(),this.bgLithBox=this.app.Canvas.rect(),this.lithologyGroupSet.push(this.bgLithBox),this.lithologyGroupSet.push(this.bgBox),this.lithologyGroupSet.push(this.lithologyGroupText),this.lithologyGroupSet.push(this.bBox),this.app.MarkersSet.toFront(),this.app.LithologyMarkersSet.toFront(),this.app.LithologyGroupMarkersSet.toFront(),this.bBox.hover(this.onMouseOver.bind(this),this.onMouseOut.bind(this)),this.bgLithBox.dblclick(this.createLithologyMarker.bind(this))),this.bgBox.attr({"stroke-width":2,stroke:"#000000",fill:this.lithologyGroup.get("settings").get("backgroundColor"),x:this.lithologyGroup.get("lithologyColumn").get("x"),y:this.top.get("y"),width:e,height:this.base.get("y")-this.top.get("y"),opacity:.5}),this.bgLithBox.attr({"stroke-width":0,stroke:"#000000",fill:"#FFFFFF",x:this.lithologyGroup.get("lithologyColumn").get("x")+e,y:this.top.get("y"),width:e,height:this.base.get("y")-this.top.get("y"),opacity:.5});var t=Math.round(this.lithologyGroup.get("lithologyColumn").get("x")+e/2),n=Math.round((this.top.get("y")+this.base.get("y"))/2),r=Math.min(Math.round(this.base.get("y")-this.top.get("y")),16);this.lithologyGroupText.attr({x:t,y:n,text:this.lithologyGroup.get("name"),"font-size":r}),this.bBox.attr({"stroke-width":0,stroke:"#000000",opacity:0,fill:"#FFFFFF",x:this.lithologyGroup.get("lithologyColumn").get("x"),y:this.top.get("y"),width:e,height:this.base.get("y")-this.top.get("y")}),this.renderTooltip()},s.prototype.createLithologyMarker=function(e){if(!this.app.enLithologys)return;var n=this.lithologyGroup.get("lithologyColumn").get("lithologyMarkers").findWhere({y:e.offsetY})||new t({y:e.offsetY,lithologyGroup:this.lithologyGroup},this.app);this.lithologyGroup.get("lithologyMarkers").add(n),this.lithologyGroup.get("lithologyColumn").get("lithologyMarkers").add(n)},s.prototype.initializeLithologyMarkers=function(){var e=this.lithologyGroup.get("lithologyColumn"),n=e.get("lithologyMarkers").findWhere({y:this.top.get("y")})||new t({y:this.top.get("y"),lithologyGroupMarker:this.top,lithologyGroup:this.lithologyGroup},this.app);this.lithologyGroup.get("lithologyMarkers").add(n);var r=e.get("lithologyMarkers").findWhere({y:this.base.get("y")})||new t({y:this.base.get("y"),lithologyGroupMarker:this.base,lithologyGroup:this.lithologyGroup},this.app);this.lithologyGroup.get("lithologyMarkers").add(r)},s.prototype.addLithologyMarker=function(e){var t=this;t.lithologyGroup.get("lithologyColumn").get("lithologyMarkers").add(e);var i=new n(this.app,e),s=this.lithologyGroup.get("lithologys"),o=this.lithologyGroup.get("lithologyMarkers");o.sort();var u=o.indexOf(e);1;if(o.length>1){if(u<o.length-1){var a=o.at(u),f=o.at(u+1),l=s.findWhere({top:a,base:f})||new r({top:a,base:f,lithologyGroup:t.lithologyGroup},this.app);a.get("lithologys").add(l),f.get("lithologys").add(l),f.set({name:l.get("name")+" Base"}),this.lithologyGroup.get("lithologys").add(l)}if(u>0){var a=o.at(u-1),f=o.at(u),l=s.findWhere({top:a,base:f})||new r({top:a,base:f,lithologyGroup:t.lithologyGroup},this.app);a.get("lithologys").add(l),f.get("lithologys").add(l),f.set({name:l.get("name")+" Base"}),this.lithologyGroup.get("lithologys").add(l)}}},s.prototype.addLithology=function(e){var t=new i(this.app,e);this.$lithologysList.append(t.el)},s.prototype.renderTooltip=function(){$(this.bBox.node).qtip({content:{text:this.lithologyGroup.get("name")+"<br>"+(this.lithologyGroup.get("description")||"No description yet!")},position:{my:"bottom left",target:"mouse"}})},s.prototype.onMouseOver=function(){this.$el.addClass("hover"),this.lithologyGroup.set({hover:!0})},s.prototype.onMouseOut=function(){this.$el.removeClass("hover"),this.lithologyGroup.set({hover:!1})},s.prototype.setHoverStatus=function(){this.lithologyGroup.get("hover")?(this.$el.addClass("hover"),this.glow=this.bBox.glow()):(this.glow&&this.glow.remove(),this.$el.removeClass("hover"))},s.prototype.toggleLithologyGroupForm=function(){this.render(),this.lithologyGroup.set({edit:!this.lithologyGroup.get("edit")})},s.prototype.editLithologyGroup=function(){this.lithologyGroup.get("edit")?(this.$lithologyGroupForm.removeClass("hide"),this.$lithologyGroupData.addClass("hide"),this.$toggle.removeClass("hide-data"),this.$toggle.addClass("show-data")):(this.$lithologyGroupForm.addClass("hide"),this.$lithologyGroupData.removeClass("hide"),this.$toggle.removeClass("show-data"),this.$toggle.addClass("hide-data"))},s.prototype.delete=function(){_.invoke(this.lithologyGroup.get("lithologys").toArray(),"destroy"),this.lithologyGroupText&&this.lithologyGroupText.remove(),this.bgLithBox&&this.bgLithBox.remove(),this.bgBox&&this.bgBox.remove(),this.bBox&&this.bBox.remove(),this.glow&&this.glow.remove(),this.$el.remove(),this.remove()},s.prototype.destroy=function(){this.lithologyGroup.get("base").set({name:"TOP"}),this.lithologyGroup.destroy()},s.prototype.showLithologysList=function(){this.$lithologysList.hasClass("hide")?this.$lithologysList.removeClass("hide"):this.$lithologysList.addClass("hide")},s.prototype.updateLithologyGroup=function(e){(e.keyCode===TimescaleApp.ENTER||e.keyCode===TimescaleApp.ESC)&&this.toggleLithologyGroupForm();var t=this.$lithologyGroupName.value,n=this.$lithologyGroupDescription.value,r=this.$lithologyGroupColor.value,i=this.$("select.lithology-group-line-style option:selected").val();this.lithologyGroup.set({name:t,description:n}),this.lithologyGroup.get("base").set({name:t+" Base"}),this.lithologyGroup.get("settings").set({backgroundColor:r}),this.base.set({style:i})},s}),define("lithologyGroupMarkerView",["baseView"],function(e){var t=e.extend({classname:"LithologyGroupMarkerView"});return t.prototype.statusBoxTemplate=new EJS({url:"/lithology_column_maker/ejs/status_box.ejs"}),t.prototype.initialize=function(e,t){this.app=e,this.lithologyGroupMarker=t,this.render(),this.listenTo(this.lithologyGroupMarker.get("lithologyColumn"),"change:x",this.renderLithologyGroupMarker.bind(this)),this.listenTo(this.lithologyGroupMarker.get("lithologyColumn"),"change:width",this.renderLithologyGroupMarker.bind(this)),this.listenTo(this.lithologyGroupMarker,"change:hover",this.setHoverStatus.bind(this)),this.listenTo(this.lithologyGroupMarker,"change",this.renderLithologyGroupMarker.bind(this)),this.listenTo(this.lithologyGroupMarker,"destroy",this.delete.bind(this)),this.listenTo(this.lithologyGroupMarker.get("lithologyGroups"),"remove",this.checkAndDelete.bind(this)),this.listenTo(this.app.ZonesCollection,"remove",this.updateLithologyGroupMarker.bind(this)),this.listenTo(this.app.ZonesCollection,"change",this.updateLithologyGroupMarker.bind(this))},t.prototype.render=function(){this.renderLithologyGroupMarker()},t.prototype.renderLithologyGroupMarker=function(){this.element===undefined&&(this.element=this.app.Canvas.path(),this.element.attr({"stroke-width":2,stroke:"#0000FF"}),this.element.hover(this.onMouseOver.bind(this),this.onMouseOut.bind(this)),this.element.drag(this.dragMove.bind(this),this.dragStart.bind(this),this.dragEnd.bind(this)),this.app.LithologyGroupMarkersSet.push(this.element),this.app.MarkersSet.toFront());var e=this.lithologyGroupMarker.get("style"),t=[];e==="dashed"?t=["-"]:e==="dotted"&&(t=["."]),this.element.attr({path:this.getPath(),"stroke-dasharray":t}),this.lithologyGroupMarker.updateZone(),this.updateStatusBox()},t.prototype.updateStatusBox=function(){this.app.StatusBox.html(this.statusBoxTemplate.render(this.lithologyGroupMarker.toJSON()))},t.prototype.getPath=function(){var e=this.lithologyGroupMarker.get("lithologyColumn").get("x")+Math.round(this.lithologyGroupMarker.get("lithologyColumn").get("width")/2);return"M"+this.lithologyGroupMarker.get("lithologyColumn").get("x")+","+this.lithologyGroupMarker.get("y")+"H"+e},t.prototype.dragStart=function(e,t,n){var r=this.lithologyGroupMarker.get("lithologyColumn").get("lithologyGroupMarkers"),i=r.indexOf(this.lithologyGroupMarker);this.prevMarker=r.at(i-1),this.nextMarker=r.at(i+1)},t.prototype.dragMove=function(e,t,n,r,i){if(this.prevMarker&&this.nextMarker&&(this.prevMarker.get("y")+2>i.offsetY||i.offsetY>this.nextMarker.get("y")-2))return;if(!this.prevMarker&&this.nextMarker&&i.offsetY>this.nextMarker.get("y")-2)return;if(this.prevMarker&&!this.nextMarker&&this.prevMarker.get("y")+2>i.offsetY)return;this.lithologyGroupMarker.set({y:i.offsetY})},t.prototype.onMouseOver=function(){this.$el.addClass("hover"),this.lithologyGroupMarker.set({hover:!0})},t.prototype.onMouseOut=function(){this.$el.removeClass("hover"),this.lithologyGroupMarker.set({hover:!1})},t.prototype.setHoverStatus=function(){this.lithologyGroupMarker.get("hover")?(this.element.attr({"stroke-width":5}),this.$el.addClass("hover")):(this.element.attr({"stroke-width":2}),this.$el.removeClass("hover"))},t.prototype.dragEnd=function(e){},t.prototype.delete=function(){this.element!==undefined&&this.element.remove(),this.$el.remove(),this.remove()},t.prototype.checkAndDelete=function(){this.lithologyGroupMarker.get("lithologyGroups").length==0&&this.destroy()},t.prototype.destroy=function(){this.lithologyGroupMarker.destroy()},t.prototype.updateLithologyGroupMarker=function(e){if(e!==this.lithologyGroupMarker.get("zone"))return;this.lithologyGroupMarker.updateZone(),this.render()},t}),define("lithologyColumnView",["baseView","lithologyGroupView","lithologyGroupMarkerView","lithologyGroup","lithologyGroupMarker"],function(e,t,n,r,i){var s=e.extend({tagName:"li",classname:"LithologyColumnView",events:{"click .toggle":"toggleLithologyColumnForm","click .lithology-column-data":"toggleLithologyColumnForm","click .data-labels":"toggleLithologyColumnForm","click .destroy":"destroy","click label.lithology-column-lithologys-data":"showLithologyGroupsList","keypress :input":"updateLithologyColumn","keyup :input":"updateLithologyColumn",'change input[name="lithology-column-bg-color"]':"updateLithologyColumn",mouseover:"onMouseOver",mouseout:"onMouseOut"}});return s.prototype.template=new EJS({url:"/lithology_column_maker/ejs/lithology_column.ejs"}),s.prototype.colInfoTemplate=new EJS({url:"/lithology_column_maker/ejs/lithology_column_info.ejs"}),s.prototype.initialize=function(e,t){this.app=e,this.lithologyColumn=t,this.render(),this.listenTo(this.lithologyColumn,"change:edit",this.editLithologyColumn.bind(this)),this.listenTo(this.lithologyColumn,"change",this.renderLithologyColumn.bind(this)),this.listenTo(this.lithologyColumn.get("settings"),"change",this.renderLithologyColumn.bind(this)),this.listenTo(this.lithologyColumn.get("lithologyGroupMarkers"),"add",this.addLithologyGroupMarker.bind(this)),this.listenTo(this.lithologyColumn.get("lithologyGroups"),"remove",this.removeLithology.bind(this)),this.listenTo(this.lithologyColumn.get("lithologyGroups"),"add",this.addLithologyGroup.bind(this)),this.listenTo(this.lithologyColumn,"destroy",this.delete.bind(this))},s.prototype.render=function(){this.$el.html(this.template.render(this.lithologyColumn.toJSON())),this.$lithologyGroupsList=this.$(".lithology-groups-list"),this.renderColumnInfo()},s.prototype.renderColumnInfo=function(){this.$(".column-info").html(this.colInfoTemplate.render(this.lithologyColumn.toJSON())),this.$toggle=this.$(".toggle"),this.$lithologyColumnForm=this.$(".lithology-column-form"),this.$lithologyColumnData=this.$(".lithology-column-data"),this.$lithologyColumnName=this.$('input[name="lithology-column-name"]')[0],this.$lithologyColumnWidth=this.$('input[name="lithology-column-width"]')[0],this.$lithologyColumnBgColor=this.$('input[name="lithology-column-bg-color"]')[0],this.$lithologyColumnDescription=this.$('textarea[name="lithology-column-description"]')[0],this.renderLithologyColumn(),this.resizeCanvas()},s.prototype.renderLithologyColumn=function(){this.element===undefined&&(this.element=this.app.Canvas.rect(),this.headingBox=this.app.Canvas.rect(),this.headingText=this.app.Canvas.text(),this.element.dblclick(this.createLithologyGroupMarker.bind(this)),this.app.MarkersSet.toFront()),this.element.attr({x:this.lithologyColumn.get("x"),y:0,width:this.lithologyColumn.get("width"),fill:this.lithologyColumn.get("settings").get("backgroundColor"),height:this.app.Canvas.height,opacity:.5}),this.headingBox.attr({x:this.lithologyColumn.get("x"),y:0,width:this.lithologyColumn.get("width"),fill:"#FFFFFF",height:50,opacity:.5});var e=Math.round(this.lithologyColumn.get("x")+this.lithologyColumn.get("width")/2),t=25,n=24;this.headingText.attr({x:e,y:t,text:this.lithologyColumn.get("name"),"font-size":n}),this.updateLithologyColumns()},s.prototype.resetLithologyGroups=function(){this.$lithologyGroupsList.html(""),this.lithologyColumn.get("lithologyGroups").each(this.addLithology.bind(this))},s.prototype.renderLithologys=function(){this.lithologyColumn.get("lithologyGroups").each(this.addLithologyGroupMarker.bind(this))},s.prototype.toggleLithologyColumnForm=function(){this.renderColumnInfo(),this.lithologyColumn.set({edit:!this.lithologyColumn.get("edit")})},s.prototype.editLithologyColumn=function(){this.lithologyColumn.get("edit")?(this.$lithologyColumnForm.removeClass("hide"),this.$lithologyColumnData.addClass("hide"),this.$toggle.removeClass("hide-data"),this.$toggle.addClass("show-data")):(this.$lithologyColumnForm.addClass("hide"),this.$lithologyColumnData.removeClass("hide"),this.$toggle.removeClass("show-data"),this.$toggle.addClass("hide-data"))},s.prototype.delete=function(){this.element!==undefined&&this.element.remove(),this.$el.remove(),this.remove()},s.prototype.updateLithologyColumn=function(e){(e.keyCode==TimescaleApp.ENTER||e.keyCode==TimescaleApp.ESC)&&this.toggleLithologyColumnForm();var t=this.$lithologyColumnName.value,n=this.$lithologyColumnDescription.value,r=this.$lithologyColumnWidth.value,i=this.$lithologyColumnBgColor.value;this.lithologyColumn.set({name:t,description:n,width:parseInt(r)||0}),this.lithologyColumn.get("settings").set({backgroundColor:i})},s.prototype.createLithologyGroupMarker=function(e){if(!this.app.enLithologys)return;var t=new i({y:e.offsetY,lithologyColumn:this.lithologyColumn},this.app);if(t.get("zone")===null){t.destroy();return}this.lithologyColumn.get("lithologyGroupMarkers").add(t)},s.prototype.addLithologyGroupMarker=function(e){var t=new n(this.app,e),i=this,s=this.lithologyColumn.get("lithologyGroups"),o=this.lithologyColumn.get("lithologyGroupMarkers");o.sort();var u=o.indexOf(e),a,f;if(o.length>1){if(u<o.length-1){var a=o.at(u),f=o.at(u+1),l=s.findWhere({top:a,base:f})||new r({top:a,base:f,lithologyColumn:i.lithologyColumn});a.get("lithologyGroups").add(l),f.get("lithologyGroups").add(l),f.set({name:l.get("name")+" Base"}),s.add(l)}if(u>0){var a=o.at(u-1),f=o.at(u),l=s.findWhere({top:a,base:f})||new r({top:a,base:f,lithologyColumn:i.lithologyColumn});a.get("lithologyGroups").add(l),f.get("lithologyGroups").add(l),f.set({name:l.get("name")+" Base"}),s.add(l)}}this.element.attr({height:this.app.Canvas.height})},s.prototype.removeLithology=function(e){var t=e.get("top"),n=e.get("top")},s.prototype.addLithologyGroup=function(e){var n=new t(this.app,e);this.$lithologyGroupsList.append(n.el)},s.prototype.updateLithologyColumns=function(){var e=this,t=this.app.LithologyColumnsCollection.indexOf(this.lithologyColumn);this.app.LithologyColumnsCollection.each(function(n,r){if(r>t){var i=e.app.LithologyColumnsCollection.at(r-1),s=i.get("x")+i.get("width");n.set({x:s})}})},s.prototype.showLithologyGroupsList=function(){this.$lithologyGroupsList.hasClass("hide")?this.$lithologyGroupsList.removeClass("hide"):this.$lithologyGroupsList.addClass("hide")},s.prototype.delete=function(){_.invoke(this.lithologyColumn.get("lithologyGroups").toArray(),"destroy"),this.element&&this.element.remove(),this.headingText&&this.headingText.remove(),this.headingBox&&this.headingBox.remove(),this.$el.remove(),this.remove()},s.prototype.destroy=function(){this.lithologyColumn.destroy()},s.prototype.resizeCanvas=function(){var e=Math.max(this.app.Canvas.width,this.lithologyColumn.get("x")+this.lithologyColumn.get("width"));this.app.Canvas.setSize(e,this.app.Canvas.height)},s}),define("lithologyColumnsView",["baseView","lithologyColumnView","lithologyColumn"],function(e,t,n){var r=e.extend({el:"#columns-list",classname:"LithologyColumns"});return r.prototype.template=new EJS({url:"/commons/ejs/data_tbl.ejs"}),r.prototype.initialize=function(e){this.app=e,this.lithologyColumns=this.app.LithologyColumnsCollection,this.listenTo(this.lithologyColumns,"add",this.addLithologyColumn.bind(this)),this.listenToActionEvents(),this.render()},r.prototype.listenToActionEvents=function(){$('a[href="#new-column"]').bind("click",this.createLithologyColumn.bind(this))},r.prototype.render=function(){this.$el.html(this.template.render()),this.$columnsList=this.$(".data-list")},r.prototype.addLithologyColumn=function(e){var n=new t(this.app,e);this.$columnsList.append(n.el)},r.prototype.createLithologyColumn=function(){var e=0;this.lithologyColumns.length>0&&(e=this.lithologyColumns.last().get("x")+this.lithologyColumns.last().get("width"));var t="Column "+this.lithologyColumns.length;this.lithologyColumns.add(new n({x:e,name:t}))},r}),define("dataExportView",["baseView"],function(e){var t=e.extend({el:"#export-panel",classname:"DataExportView",events:{"click a.show-data":"showData"}});return t.prototype.template=new EJS({url:"/lithology_column_maker/ejs/data_export_panel.ejs"}),t.prototype.lithologyColumnDataTemplate=new EJS({url:"/lithology_column_maker/ejs/lithology_column_data.ejs"}),t.prototype.initialize=function(e){this.app=e,this.exporter=this.app.exporter,this.markers=this.app.MarkersCollection,this.lithologyColumns=this.app.LithologyColumnsCollection,this.render(),this.$canvas=$("#canvas")},t.prototype.render=function(){this.exporter.export(),this.$el.html(this.template.render({lithologyColumns:this.lithologyColumns.toJSON()})),this.$lithologyColumnsData=this.$(".lithology-columns-data"),this.$showData=this.$(".show-data"),this.$dataTable=this.$(".data-table"),this.$dataRaw=this.$(".data-raw"),this.$dataJSON=this.$(".data-json"),this.$textData=this.$("textarea[name*=lithology-columns-data-text]")[0],this.$textJSON=this.$("textarea[name*=lithology-columns-data-json]")[0],this.$showTable=this.$('a[href="#show-table"]'),this.$showRaw=this.$('a[href="#show-raw"]'),this.$showJSON=this.$('a[href="#show-raw"]'),this.renderDataInText(),this.renderDataInTable()},t.prototype.renderDataInTable=function(){var e=this;this.lithologyColumns.each(function(t){var n=t.id;e.$("#"+n).html(e.lithologyColumnDataTemplate.render(t.toJSON()))})},t.prototype.toggleExportView=function(e){$("#loading").removeClass("hide"),$("a[href='#export-data']").parent().hasClass("active")?($("a[href='#export-data']").parent().removeClass("active"),$(".display-panel").addClass("hide"),this.$canvas.removeClass("hide")):($(".maker-tools").parent().removeClass("active"),$("a[href='#export-data']").parent().addClass("active"),$(".display-panel").addClass("hide"),this.$el.removeClass("hide"));try{this.render(),$("#loading").addClass("hide")}catch(t){$("#loading").addClass("hide")}},t.prototype.renderDataInText=function(){this.$textData.value=this.exporter.getText()},t.prototype.showData=function(e){this.$lithologyColumnsData.addClass("hide"),this.$showData.removeClass("alert"),$(e.target).addClass("alert");var t=$(e.target).attr("href");t==="#show-table"?this.$dataTable.removeClass("hide"):t==="#show-raw"?this.$dataRaw.removeClass("hide"):t==="#show-json"&&this.$dataJSON.removeClass("hide")},t}),define("loader",["zone","marker","lithologyColumn","lithologyGroupMarker","lithologyMarker"],function(e,t,n,r,i){var s=function(e){this.app=e,this.zones=this.app.ZonesCollection,this.markers=this.app.MarkersCollection,this.lithologyColumns=this.app.LithologyColumnsCollection};return s.prototype.loadFromLocalStorage=function(){this.loadData(localStorage.lithologyApp)},s.prototype.loadData=function(e){this.savedData=JSON.parse(e),this.reset(),this.load()},s.prototype.reset=function(){_.invoke(this.markers.toArray(),"destroy"),_.invoke(this.zones.toArray(),"destroy"),_.invoke(this.lithologyColumns.toArray(),"destroy")},s.prototype.load=function(){this.loadImage(),this.loadMarkersAndZones(),this.loadLithologyColumns()},s.prototype.loadImage=function(){this.app.ImageOb.set(this.savedData.image)},s.prototype.loadMarkersAndZones=function(){var e=this;e.savedData.zones.forEach(function(n,r){var i=e.markers.findWhere({y:n.topMarker.y})||new t(n.topMarker),s=e.markers.findWhere({y:n.baseMarker.y})||new t(n.baseMarker);e.markers.add(i),e.markers.add(s)}),e.savedData.zones.forEach(function(t,n){var r=e.markers.findWhere({y:t.topMarker.y}),i=e.markers.findWhere({y:t.baseMarker.y}),s=e.zones.findWhere({topMarker:r,baseMarker:i});s!==undefined&&s.set({name:t.name,description:t.description})})},s.prototype.loadLithologyColumns=function(){var e=this;this.savedData.lithologyColumns.forEach(function(t){var r=new n(t);e.lithologyColumns.add(r),e.addLithologyGroupMarkers(t,r),e.updateLithologyGroups(t,r),e.deleteUnnecessaryLithologyGroups(t,r)})},s.prototype.addLithologyGroupMarkers=function(e,t){var n=this;e.lithologyGroupMarkers.forEach(function(e){n.addLithologyGroupMarkerToColumn(e,t)})},s.prototype.addLithologyGroupMarkerToColumn=function(e,t){var n=this,i=t.get("lithologyGroupMarkers").findWhere({y:e.y})||new r({name:e.name,y:e.y,lithologyColumn:t},this.app);t.get("lithologyGroupMarkers").add(i)},s.prototype.updateLithologyGroups=function(e,t){var n=this;e.lithologyGroups.forEach(function(e){var r=t.get("lithologyGroupMarkers").findWhere({y:e.top.y}),i=t.get("lithologyGroupMarkers").findWhere({y:e.base.y});if(r!==null&&i!==null){var s=t.get("lithologyGroups").findWhere({top:r,base:i});s.set({edit:!0,id:e.id,name:e.name,description:e.description}),s.get("settings").set(e.settings),s.set({edit:!1}),n.updateLithologyGroupWithLithologys(e,s),n.updateLithologys(e,s),n.deleteUnnecessaryLithologys(e,s)}})},s.prototype.updateLithologyGroupWithLithologys=function(e,t){var n=this;e.lithologyMarkers.forEach(function(e){n.addLithologyMarkerToGroup(e,t)})},s.prototype.addLithologyMarkerToGroup=function(e,t){var n=this,r=t.get("lithologyColumn"),s=r.get("lithologyMarkers").findWhere({y:e.y})||new i({name:e.name,y:e.y,lithologyGroup:t},this.app);t.get("lithologyMarkers").add(s)},s.prototype.updateLithologys=function(e,t){var n=this,r=t.get("lithologyColumn");e.lithologys.forEach(function(n){var i=t.get("lithologyMarkers").findWhere({y:n.top.y})||r.get("lithologyMarkers").findWhere({y:n.top.y}),s=t.get("lithologyMarkers").findWhere({y:n.base.y})||r.get("lithologyMarkers").findWhere({y:n.base.y});if(i!==null&&s!==null){var o=t.get("lithologys").findWhere({top:i,base:s});o.set({edit:!0,id:n.id,name:n.name,pattern:n.pattern,description:n.description}),t.get("settings").set(e.settings),o.set({edit:!1})}})},s.prototype.groupExists=function(e,t){var n=!1;for(var r=0;r<t.lithologyGroups.length;r++)if(t.lithologyGroups[r].id===e){n=!0;break}return n},s.prototype.lithologyExists=function(e,t){var n=!1;for(var r=0;r<t.lithologys.length;r++)if(t.lithologys[r].id===e){n=!0;break}return n},s.prototype.deleteUnnecessaryLithologyGroups=function(e,t){var n=this;t.get("lithologyGroups").each(function(t){n.groupExists(t.id,e)||t.destroy()})},s.prototype.deleteUnnecessaryLithologys=function(e,t){var n=this;t.get("lithologys").each(function(t){n.lithologyExists(t.id,e)||t.destroy()})},s}),define("exporter",[],function(){var e=function(e){this.app=e};return e.prototype.initialize=function(){this.imageOb=this.app.ImageOb,this.markers=this.app.MarkersCollection,this.zones=this.app.ZonesCollection,this.lithologyColumns=this.app.LithologyColumnsCollection},e.prototype.export=function(){this.initialize()},e.prototype.getText=function(){var e=this,t="\n\n";return t+=e.getMetaColumnData(),this.lithologyColumns.each(function(n){t+=e.getLithologyColumnData(n)}),t},e.prototype.getMetaColumnData=function(){var e="Lithologys	:";return this.lithologyColumns.each(function(t){e+="	"+t.get("name")}),e},e.prototype.getLithologyColumnData=function(e){var t=this,n="\n\n"+e.get("name");return n+="	facies",n+="	"+e.get("width"),n+="	"+CssToTscColor(e.get("settings").get("backgroundColor")),n+="	notitle",n+="	",n+="	"+(e.get("description")||""),e.get("lithologyGroups").each(function(e){n+=t.getLithologyGroupData(e)}),n},e.prototype.getLithologyGroupData=function(e){var t=this,n="\n"+e.get("name");return n+="	Primary",n+="	",n+="	"+(e.get("description")||""),e.get("lithologys").each(function(e){n+=t.getLithologyData(e)}),n},e.prototype.getLithologyData=function(e){var t="\n";return e.get("top").get("lithologys").length<2&&(t+="	TOP",t+="	",t+="	"+(e.get("top").get("age")||"n/a"),t+="	"+(e.get("description")||"")+"CALIBRATION = "+Math.round((1-e.get("top").get("relativeY"))*1e3)*1/10+"% up the "+e.get("top").get("zone").get("name"),t+="\n"),t+="	"+(e.getPatternName()||""),t+="	"+e.get("name"),t+="	"+(e.get("base").get("age")||"n/a"),t+="	"+(e.get("description")||"")+"CALIBRATION = "+Math.round((1-e.get("base").get("relativeY"))*1e3)*1/10+"% up the "+e.get("base").get("zone").get("name"),t},e.prototype.getJSON=function(){var e={};debugger;return e.image=this.imageOb.toJSON(),e.zones=this.zones.toJSON(),e.lithologyColumns=this.lithologyColumns.toJSON(),e.referenceColumn=this.app.referenceColumn.toJSON(),JSON.stringify(e)},e}),define("referenceBlock",["baseModel","settings"],function(e,t){var n=e.extend({classname:"ReferenceBlock",constructor:function(n,r){var i=[{edit:!1,hover:!1,name:n.name||_.uniqueId("ReferenceBlock "),description:n.description,settings:new t,top:n.top||null,base:n.base||null,blockColumn:n.blockColumn||null}];e.apply(this,i)}});return n.prototype.initialize=function(){this.get("settings").set({backgroundColor:"#FF0000"})},n.prototype.toJSON=function(){var e=_.clone(this.attributes);return delete e.blockColumn,e},n}),define("referenceBlocks",["baseCollection","referenceBlock"],function(e,t){var n=e.extend({classname:"ReferenceBlocks",model:t});return n}),define("referenceBlockMarker",["baseModel","referenceBlocks"],function(e,t){var n=e.extend({classname:"ReferenceBlockMarker",constructor:function(n,r){var i=[{name:n.name||"TOP",edit:!1,hover:!1,y:parseInt(n.y),id:_.uniqueId("block-marker-"),age:n.age?parseFloat(n.age):null,blockColumn:n.blockColumn||null,style:"solid",app:r||null,blocks:new t,marker:null}];e.apply(this,i)}});return n.prototype.initialize=function(){},n.prototype.toJSON=function(){var e=_.clone(this.attributes);return delete e.blocks,delete e.blockColumn,delete e.marker,delete e.app,e},n}),define("referenceBlockMarkers",["baseCollection","referenceBlockMarker"],function(e,t){var n=e.extend({classname:"ReferenceBlockMarkers",model:t});return n.prototype.comparator=function(e){return e.get("y")},n}),define("referenceBlockColumn",["baseModel","referenceBlocks","referenceBlockMarkers","settings"],function(e,t,n,r){var i=e.extend({classname:"ReferenceBlockColumn",constructor:function(i){var s=[{x:i.x||0,id:i.id||_.uniqueId("column-"),name:i.name||_.uniqueId("Column "),width:parseInt(i.width)||200,height:100,description:i.description||null,blockMarkers:new n,blocks:new t,settings:new r}];e.apply(this,s)}});return i.prototype.comparator=function(e){return e.get("x")},i.prototype.toJSON=function(){var e=_.clone(this.attributes);return e},i}),define("referenceColumn",["baseModel","referenceBlockColumn"],function(e,t){var n=e.extend({classname:"ReferenceColumn",constructor:function(t){var n=[{columnId:t.columnId||"none",column:t.column||null,top:t.top||0,base:t.base||15,columnsData:t.columnsData||null}];e.apply(this,n)}});return n.prototype.toJSON=function(){var e=_.clone(this.attributes);return e},n}),define("referenceBlockView",["baseView"],function(e){var t=e.extend({tagName:"li",classname:"ReferenceBlockView",events:{"click .toggle":"toggleBlockForm","click .block-data":"toggleBlockForm","click .destroy":"destroy","keypress :input":"updateBlock","keyup :input":"updateBlock",'change input[name="block-color"]':"updateBlock","change select.block-line-style":"updateBlock",mouseover:"onMouseOver",mouseout:"onMouseOut"}});return t.prototype.template=new EJS({url:"/reference_column_maker/ejs/block.ejs"}),t.prototype.initialize=function(e,t){this.app=e,this.block=t,this.top=this.block.get("top"),this.base=this.block.get("base"),this.blockSet===undefined&&(this.blockSet=this.app.Canvas.set(),this.app.BlocksSet.push(this.blockSet)),this.render(),this.listenTo(this.block,"change:edit",this.editBlock.bind(this)),this.listenTo(this.block,"change:hover",this.setHoverStatus.bind(this)),this.listenTo(this.block,"change:name",this.renderBlock.bind(this)),this.listenTo(this.block,"change:description",this.renderBlock.bind(this)),this.listenTo(this.block.get("blockColumn"),"change:x",this.renderBlock.bind(this)),this.listenTo(this.block.get("blockColumn"),"change:width",this.renderBlock.bind(this)),this.listenTo(this.top,"change:y",this.renderBlock.bind(this)),this.listenTo(this.top,"change:age",this.render.bind(this)),this.listenTo(this.base,"change:y",this.renderBlock.bind(this)),this.listenTo(this.base,"change:age",this.render.bind(this)),this.listenTo(this.block.get("settings"),"change",this.renderBlock.bind(this)),this.listenTo(this.block,"destroy",this.delete.bind(this))},t.prototype.render=function(){this.$el.html(this.template.render(this.block.toJSON())),this.$toggle=this.$(".toggle"),this.$blockForm=this.$(".block-form"),this.$blockData=this.$(".block-data"),this.$blockName=this.$('input[name="block-name"]')[0],this.$topAge=this.$('input[name="top-age"]')[0],this.$baseAge=this.$('input[name="base-age"]')[0],this.$blockColor=this.$('input[name="block-color"]')[0],this.$blockDescription=this.$('textarea[name="block-description"]')[0],this.editBlock(),this.renderBlock()},t.prototype.renderBlock=function(){this.bgBox===undefined&&(this.bgBox=this.app.Canvas.rect(),this.blockText=this.app.Canvas.text(),this.bBox=this.app.Canvas.rect(),this.blockSet.push(this.bgBox),this.blockSet.push(this.blockText),this.blockSet.push(this.bBox),this.app.MarkersSet.toFront(),this.app.BlockMarkersSet.toFront(),this.bBox.hover(this.onMouseOver.bind(this),this.onMouseOut.bind(this))),this.bgBox.attr({"stroke-width":0,fill:this.block.get("settings").get("backgroundColor"),x:this.block.get("blockColumn").get("x"),y:this.top.get("y"),width:this.block.get("blockColumn").get("width"),height:this.base.get("y")-this.top.get("y")});var e=Math.round(this.block.get("blockColumn").get("x")+this.block.get("blockColumn").get("width")/2),t=Math.round((this.top.get("y")+this.base.get("y"))/2),n=Math.min(Math.round(this.base.get("y")-this.top.get("y")),16);this.blockText.attr({x:e,y:t,text:this.block.get("name"),"font-size":n}),this.bBox.attr({"stroke-width":2,opacity:0,fill:"#FFF",x:this.block.get("blockColumn").get("x"),y:this.top.get("y"),width:this.block.get("blockColumn").get("width"),height:this.base.get("y")-this.top.get("y")}),this.renderTooltip()},t.prototype.renderTooltip=function(){$(this.bBox.node).qtip({content:{text:this.block.get("name")+"<br>"+(this.block.get("description")||"No description yet!")},position:{my:"bottom left",target:"mouse"}})},t.prototype.onMouseOver=function(){this.$el.addClass("hover"),this.block.set({hover:!0})},t.prototype.onMouseOut=function(){this.$el.removeClass("hover"),this.block.set({hover:!1})},t.prototype.setHoverStatus=function(){this.block.get("hover")?(this.$el.addClass("hover"),this.glow=this.bBox.glow()):(this.glow&&this.glow.remove(),this.$el.removeClass("hover"))},t.prototype.toggleBlockForm=function(){this.render(),this.block.set({edit:!this.block.get("edit")})},t.prototype.editBlock=function(){this.block.get("edit")?(this.$blockForm.removeClass("hide"),this.$blockData.addClass("hide"),this.$toggle.removeClass("hide-data"),this.$toggle.addClass("show-data")):(this.$blockForm.addClass("hide"),this.$blockData.removeClass("hide"),this.$toggle.removeClass("show-data"),this.$toggle.addClass("hide-data"))},t.prototype.delete=function(){this.blockText&&this.blockText.remove(),this.bgBox&&this.bgBox.remove(),this.bBox&&this.bBox.remove(),this.glow&&this.glow.remove(),this.$el.remove(),this.remove()},t.prototype.destroy=function(){this.block.get("base").set({name:"TOP"}),this.block.destroy()},t.prototype.updateBlock=function(e){var t=this.$blockName.value,n=this.$blockDescription.value,r=this.$blockColor.value,i=this.$("select.block-line-style option:selected").val();this.block.set({name:t,description:n});if(e.keyCode===TimescaleApp.ENTER||e.keyCode===TimescaleApp.ESC)this.block.get("base").set({name:t+" Base",age:parseFloat(this.$baseAge.value||0)}),this.block.get("top").set({age:parseFloat(this.$topAge.value||0)}),this.toggleBlockForm();this.block.get("settings").set({backgroundColor:r}),this.base.set({style:i})},t}),define("referenceBlockMarkerView",["baseView"],function(e){var t=e.extend({classname:"ReferenceBlockMarkerView"});return t.prototype.statusBoxTemplate=new EJS({url:"/reference_column_maker/ejs/status_box.ejs"}),t.prototype.initialize=function(e,t){this.app=e,this.blockMarker=t,this.render(),this.listenTo(this.blockMarker.get("blockColumn"),"change:x",this.renderBlockMarker.bind(this)),this.listenTo(this.blockMarker.get("blockColumn"),"change:width",this.renderBlockMarker.bind(this)),this.listenTo(this.blockMarker,"change:hover",this.setHoverStatus.bind(this)),this.listenTo(this.blockMarker,"change",this.renderBlockMarker.bind(this)),this.listenTo(this.blockMarker,"destroy",this.delete.bind(this)),this.listenTo(this.blockMarker.get("blocks"),"remove",this.checkAndDelete.bind(this)),this.render()},t.prototype.render=function(){this.renderBlockMarker()},t.prototype.renderBlockMarker=function(){this.element===undefined&&(this.element=this.app.Canvas.path(),this.element.attr({"stroke-width":2,stroke:"#0000FF"}),this.element.hover(this.onMouseOver.bind(this),this.onMouseOut.bind(this)),this.element.drag(this.dragMove.bind(this),this.dragStart.bind(this),this.dragEnd.bind(this)),this.app.BlockMarkersSet.push(this.element),this.app.MarkersSet.toFront()),this.blockMarker.get("marker")&&this.listenTo(this.blockMarker.get("marker"),"change:y",this.updateBlockMakereY.bind(this));var e=this.blockMarker.get("style"),t=[];e==="dashed"?t=["-"]:e==="dotted"&&(t=["."]),this.element.attr({path:this.getPath(),"stroke-dasharray":t}),this.resizeCanvas(),this.updateStatusBox(),this.renderTooltip()},t.prototype.renderTooltip=function(){var e=this;$(this.element.node).qtip({content:{text:this.blockMarker.get("name")+"("+this.blockMarker.get("age")+" myr )"},position:{my:"bottom left",target:"mouse"}})},t.prototype.resizeCanvas=function(){var e=Math.max(this.app.Canvas.height,this.blockMarker.get("y")+100);this.blockMarker.get("blockColumn").set({height:e}),this.app.Canvas.setSize(this.app.Canvas.width,e)},t.prototype.updateBlockMakereY=function(){this.blockMarker.get("marker")&&this.blockMarker.set({y:this.blockMarker.get("marker").get("y")})},t.prototype.updateStatusBox=function(){this.app.StatusBox&&this.app.StatusBox.html(this.statusBoxTemplate.render(this.blockMarker.toJSON()))},t.prototype.getPath=function(){var e=this.blockMarker.get("blockColumn").get("x")+this.blockMarker.get("blockColumn").get("width");return"M"+this.blockMarker.get("blockColumn").get("x")+","+this.blockMarker.get("y")+"H"+e},t.prototype.dragStart=function(e,t,n){var r=this.blockMarker.get("blockColumn").get("blockMarkers"),i=r.indexOf(this.blockMarker);this.prevMarker=r.at(i-1),this.nextMarker=r.at(i+1)},t.prototype.dragMove=function(e,t,n,r,i){if(this.prevMarker&&this.nextMarker&&(this.prevMarker.get("y")+2>i.offsetY||i.offsetY>this.nextMarker.get("y")-2))return;if(!this.prevMarker&&this.nextMarker&&i.offsetY>this.nextMarker.get("y")-2)return;if(this.prevMarker&&!this.nextMarker&&this.prevMarker.get("y")+2>i.offsetY)return;this.blockMarker.set({y:i.offsetY})},t.prototype.onMouseOver=function(){this.$el.addClass("hover"),this.blockMarker.set({hover:!0})},t.prototype.onMouseOut=function(){this.$el.removeClass("hover"),this.blockMarker.set({hover:!1})},t.prototype.setHoverStatus=function(){this.blockMarker.get("hover")?(this.element.attr({"stroke-width":5}),this.$el.addClass("hover")):(this.element.attr({"stroke-width":2}),this.$el.removeClass("hover"))},t.prototype.dragEnd=function(e){},t.prototype.delete=function(){this.element!==undefined&&this.element.remove(),this.$el.remove(),this.remove()},t.prototype.checkAndDelete=function(){this.blockMarker.get("blocks").length==0&&this.destroy()},t.prototype.destroy=function(){this.blockMarker.destroy()},t}),define("referenceBlockColumnView",["baseView","referenceBlockView","referenceBlockMarkerView","referenceBlock","referenceBlockMarker"],function(e,t,n,r,i){var s=e.extend({tagName:"li",classname:"ReferenceBlockColumnView",events:{"click .toggle":"ReferencetoggleBlockColumnForm","click .block-column-data":"ReferencetoggleBlockColumnForm","click .destroy":"destroy","click label.block-column-blocks-data":"showBlocksList","keypress :input":"ReferenceupdateBlockColumn","keyup :input":"ReferenceupdateBlockColumn",'change input[name="block-column-bg-color"]':"ReferenceupdateBlockColumn",mouseover:"onMouseOver",mouseout:"onMouseOut"}});return s.prototype.template=new EJS({url:"/reference_column_maker/ejs/block_column.ejs"}),s.prototype.initialize=function(e,t){this.app=e,this.blockColumn=t,this.render(),this.listenTo(this.blockColumn,"change:edit",this.editBlockColumn.bind(this)),this.listenTo(this.blockColumn,"change",this.renderBlockColumn.bind(this)),this.listenTo(this.blockColumn.get("settings"),"change",this.renderBlockColumn.bind(this)),this.listenTo(this.blockColumn.get("blockMarkers"),"add",this.addBlockMarker.bind(this)),this.listenTo(this.blockColumn.get("blocks"),"remove",this.removeBlock.bind(this)),this.listenTo(this.blockColumn.get("blocks"),"add",this.addBlock.bind(this)),this.listenTo(this.blockColumn,"destroy",this.delete.bind(this))},s.prototype.render=function(){this.$el.html(this.template.render(this.blockColumn.toJSON())),this.$toggle=this.$(".toggle"),this.$blockColumnForm=this.$(".block-column-form"),this.$blockColumnData=this.$(".block-column-data"),this.$blockColumnName=this.$('input[name="block-column-name"]')[0],this.$blockColumnWidth=this.$('input[name="block-column-width"]')[0],this.$blockColumnBgColor=this.$('input[name="block-column-bg-color"]')[0],this.$blockColumnDescription=this.$('textarea[name="block-column-description"]')[0],this.$blocksList=this.$(".blocks-list"),this.renderBlockColumn()},s.prototype.renderBlockColumn=function(){this.element===undefined&&(this.element=this.app.Canvas.rect(this.blockColumn.get("x"),0,this.blockColumn.get("width"),this.app.Canvas.height),this.element.dblclick(this.createBlockMarker.bind(this)),this.app.MarkersSet.toFront()),this.element.attr({x:this.blockColumn.get("x"),width:this.blockColumn.get("width"),height:this.blockColumn.get("height"),fill:this.blockColumn.get("settings").get("backgroundColor")}),this.resizeCanvas(),this.updateBlockColumns()},s.prototype.resizeCanvas=function(){var e=Math.max(this.app.Canvas.width,this.blockColumn.get("x")+this.blockColumn.get("width"));this.app.Canvas.setSize(e,this.app.Canvas.height)},s.prototype.resetBlocks=function(){this.$blocksList.html(""),this.blockColumn.get("blocks").each(this.addBlock.bind(this))},s.prototype.ReferencerenderBlocks=function(){this.blockColumn.get("blocks").each(this.addBlockMarker.bind(this))},s.prototype.ReferencetoggleBlockColumnForm=function(){this.renderBlockColumn(),this.blockColumn.set({edit:!this.blockColumn.get("edit")})},s.prototype.editBlockColumn=function(){this.blockColumn.get("edit")?(this.$blockColumnForm.removeClass("hide"),this.$blockColumnData.addClass("hide"),this.$toggle.removeClass("hide-data"),this.$toggle.addClass("show-data")):(this.$blockColumnForm.addClass("hide"),this.$blockColumnData.removeClass("hide"),this.$toggle.removeClass("show-data"),this.$toggle.addClass("hide-data"))},s.prototype.delete=function(){this.element!==undefined&&this.element.remove(),this.$el.remove(),this.remove()},s.prototype.ReferenceupdateBlockColumn=function(e){e.keyCode==13&&this.ReferencetoggleBlockColumnForm();var t=this.$blockColumnName.value,n=this.$blockColumnDescription.value,r=this.$blockColumnWidth.value,i=this.$blockColumnBgColor.value;this.blockColumn.set({name:t,description:n,width:parseInt(r)||0}),this.blockColumn.get("settings").set({backgroundColor:i})},s.prototype.createBlockMarker=function(e){if(!this.app.enBlocks)return;var t=new i({y:e.offsetY,blockColumn:this.blockColumn},this.app);this.blockColumn.get("blockMarkers").add(t)},s.prototype.addBlockMarker=function(e){var t=new n(this.app,e),i=this,s=this.blockColumn.get("blocks"),o=this.blockColumn.get("blockMarkers");o.sort();var u=o.indexOf(e),a,f;if(o.length>1){u==0?(a=o.at(u),f=o.at(u+1)):(a=o.at(u-1),f=o.at(u));var l=s.findWhere({top:a,base:f})||new r({top:a,base:f,blockColumn:i.blockColumn});a.get("blocks").add(l),f.get("blocks").add(l),f.set({name:l.get("name")+" Base"}),s.add(l)}},s.prototype.removeBlock=function(e){var t=e.get("top"),n=e.get("top")},s.prototype.addBlock=function(e){var n=new t(this.app,e);this.$blocksList.append(n.el)},s.prototype.updateBlockColumns=function(){var e=this;if(!this.app.ReferenceBlockColumnsCollection)return;var t=this.app.ReferenceBlockColumnsCollection.indexOf(this.blockColumn);this.app.ReferenceBlockColumnsCollection.each(function(n,r){if(r>t){var i=e.app.ReferenceBlockColumnsCollection.at(r-1),s=i.get("x")+i.get("width");n.set({x:s})}})},s.prototype.showBlocksList=function(){this.$blocksList.hasClass("hide")?this.$blocksList.removeClass("hide"):this.$blocksList.addClass("hide")},s.prototype.delete=function(){_.invoke(this.blockColumn.get("blocks").toArray(),"destroy"),this.element&&this.element.remove(),this.$el.remove(),this.remove()},s.prototype.destroy=function(){this.blockColumn.destroy()},s}),define("referenceColumnSideView",["baseView","referenceColumn","referenceBlockColumn","referenceBlockColumnView","referenceColumnSideView","referenceBlockMarker","referenceBlock","marker"],function(e,t,n,r,i,s,o,u){var i=e.extend({el:"#ref-col-set-list",classname:"ReferenceColumnSideView",events:{"keypress :input":"updateReferenceColumnSettings","keyup :input":"updateReferenceColumnSettings","click input[type=radio]":"updateReferenceColumnSettings","dragover #reference-column-box":"dataDragover","drop #reference-column-box":"dataDrop"}});return i.prototype.template=new EJS({url:"/reference_column_maker/ejs/reference_column.ejs"}),i.prototype.settingsTemplate=new EJS({url:"/reference_column_maker/ejs/reference_column_settings.ejs"}),i.prototype.initialize=function(e){this.app=e,this.app.refCol={},this.zones=this.app.ZonesCollection,this.markers=this.app.MarkersCollection,this.referenceColumn=new t({top:0,base:15}),this.app.referenceColumn=this.referenceColumn,this.listenTo(this.referenceColumn,"change:columnsData",this.render.bind(this)),this.listenTo(this.referenceColumn,"change:columnId",this.render.bind(this)),this.listenTo(this.referenceColumn,"change:top",this.render.bind(this)),this.listenTo(this.referenceColumn,"change:base",this.render.bind(this)),this.renderReferenceColumnCanvas(),this.loadReferenceColumnData()},i.prototype.listenToActionEvents=function(){var e=this;this.$enRefPanel=$("a[href='#show-ref-panel']"),this.$enRefPanel.click(function(){e.$refPanel.toggleClass("hidden")})},i.prototype.renderReferenceColumnCanvas=function(){this.$refPanel=$("#ref-panel"),this.$refPanel.html(this.template.render({})),this.app.refCol.$canvas=$("#ref-canvas"),this.$canvas=this.app.refCol.$canvas,this.app.refCol.Canvas=new Raphael(this.$canvas[0],0,0),this.app.refCol.MarkersSet=this.app.refCol.Canvas.set(),this.app.refCol.BlockMarkersSet=this.app.refCol.Canvas.set(),this.app.refCol.BlocksSet=this.app.refCol.Canvas.set(),this.listenToActionEvents()},i.prototype.loadReferenceColumnData=function(){var e=this;$.get("/commons/json/default-reference-column-data.json",function(t){e.referenceColumn.set({columnsData:t.referenceBlockColumns})})},i.prototype.render=function(){var e=this;e.$el.html(e.settingsTemplate.render(e.referenceColumn.toJSON())),this.$topAge=this.$('input[name="top-age"]'),this.$baseAge=this.$('input[name="base-age"]'),this.updateReferenceColumn()},i.prototype.updateReferenceColumnSettings=function(e){var t=this;this.$columnId=this.$('input[name="ref-column"]:checked'),t.referenceColumn.set({columnId:t.$columnId.val()}),(e.keyCode==TimescaleApp.ENTER||e.keyCode==TimescaleApp.ESC)&&t.referenceColumn.set({top:parseFloat(t.$topAge.val()),base:parseFloat(t.$baseAge.val())})},i.prototype.getColumnData=function(e){var t=null;return this.referenceColumn.get("columnsData").forEach(function(n){n.id===e&&(t=n)}),t},i.prototype.updateReferenceColumn=function(e,t,n){_.invoke(this.markers.toArray(),"destroy"),_.invoke(this.zones.toArray(),"destroy"),this.referenceColumn.get("column")&&this.referenceColumn.get("column").destroy();if(this.referenceColumn.get("top")>this.referenceColumn.get("base")||this.referenceColumn.get("columnId")==="none")return;var r=this.getColumnData(this.referenceColumn.get("columnId"));r?(this.referenceColumn.set({column:this.loadBlockColumn(r)}),this.resizeReferenceColumnCanvas()):this.referenceColumn.set({columnId:"none"})},i.prototype.loadBlockColumn=function(e){var t=this;e.x=0;var i=new n(e),s=new r(this.app.refCol,i);return t.addBlockMarkers(e,i),i},i.prototype.resizeReferenceColumnCanvas=function(){var e=this.referenceColumn.get("column").get("width"),t=this.referenceColumn.get("column").get("blockMarkes")?this.referenceColumn.get("column").get("blockMarkes").last().get("y")+100:0;t=Math.max(this.app.Canvas.height,t),this.app.refCol.Canvas.setSize(e,t),this.app.Canvas.setSize(this.app.Canvas.width,t)},i.prototype.addBlockMarkers=function(e,t){var n=this,r=n.referenceColumn.get("top"),i=n.referenceColumn.get("base");e.blockMarkers.forEach(function(s,o){if(s.age<r||s.age>i)return;n.addBlockMarkerToColumn(s,t,o,e)})},i.prototype.addBlockMarkerToColumn=function(e,t,n,r){var i=this;e.y=t.get("blockMarkers").length>0?(t.get("blockMarkers").length+1)*50:50;var o=t.get("blockMarkers").findWhere({age:e.age})||new s({y:e.y,blockColumn:t,age:e.age},this.app);t.get("blockMarkers").add(o);var a=i.markers.findWhere({age:e.age})||new u(e);i.markers.add(a),o.set({name:e.name,marker:a}),a.set({name:e.name});if(n>0){var f=i.zones.last(),l=t.get("blocks").last(),c=r.blocks[n-1];f&&f.set({name:c.name,description:c.description}),l&&(l.set({name:c.name,description:c.description}),l.get("settings").set({backgroundColor:c.settings.backgroundColor}))}},i.prototype.updateBlockNames=function(e,t){var n=this;e.blocks.forEach(function(e,r,i){var s=t.get("blockMarkers").findWhere({age:e.top.age}),o=t.get("blockMarkers").findWhere({age:e.base.age}),u=n.markers.findWhere({age:e.top.age}),a=n.markers.findWhere({age:e.base.age});if(u!==null&&a!==null){var f=n.zones.findWhere({topMarker:u,baseMarker:a});f&&f.set({name:e.name,description:e.description})}if(s!==null&&o!==null){var l=t.get("blocks").findWhere({top:s,base:o});l&&(l.set({name:e.name,description:e.description}),l.get("settings").set({backgroundColor:e.settings.backgroundColor}))}})},i.prototype.dataDragover=function(e){var e=e.originalEvent;e.stopPropagation(),e.preventDefault()},i.prototype.dataDrop=function(e){$("#loading").removeClass("hide");var t=this,e=e.originalEvent;e.stopPropagation(),e.preventDefault();var n=e.dataTransfer.files[0],r=n.name.split(".").pop(),i=new FileReader;i.onloadend=function(e){r==="json"&&t.referenceColumn.set({columnsData:JSON.parse(this.result).referenceBlockColumns}),$("#loading").addClass("hide")},i.readAsText(n)},i}),define("imageOb",["baseModel"],function(e){var t=e.extend({classname:"ImageOb",constructor:function(t,n){var r=[{x:t&&"x"in t?t.x:0,y:t&&"y"in t?t.y:0,width:t&&"width"in t?t.width:null,height:t&&"height"in t?t.height:null,origWidth:t&&"origWidth"in t?t.origWidth:null,origHeight:t&&"origHeight"in t?t.origHeight:null,angle:t&&"angle"in t?t.angle:0,preserveAspectRatio:t&&"preserveAspectRatio"in t?t.preserveAspectRatio:!0,visible:t&&"visible"in t?t.visible:!0,data:t&&"data"in t?t.data:null}];e.apply(this,r)}});return t}),define("imageView",["baseView","imageOb"],function(e,t){var n=e.extend({el:"#bg-image-settings-list",classname:"ImageObView",events:{'change input[name="width"]':"updateImageWidth",'change input[name="height"]':"updateImageHeight",'change input[name="preserve-aspect-ratio"]':"updateImage",'change input[name="image-visible"]':"updateImage",'change input[name="angle"]':"updateImage","dragover #image-box":"imageDragover","drop #image-box":"imageDrop"}});return n.prototype.template=new EJS({url:"/transect_maker/ejs/transect_image_settings.ejs"}),n.prototype.initialize=function(e){this.app=e,this.image=this.app.ImageOb,this.listenTo(this.image,"change:data",this.renderData.bind(this)),this.listenTo(this.image,"change:width",this.renderImage.bind(this)),this.listenTo(this.image,"change:height",this.renderImage.bind(this)),this.listenTo(this.image,"change:angle",this.renderImage.bind(this)),this.listenTo(this.image,"change:preserveAspectRatio",this.renderImage.bind(this)),this.render()},n.prototype.render=function(){this.$el.html(this.template.render(this.image.toJSON())),this.$width=this.$('input[name="width"]')[0],this.$height=this.$('input[name="height"]')[0],this.$preserveAspectRatio=this.$('input[name="preserve-aspect-ratio"]')[0],this.$visible=this.$('input[name="image-visible"]')[0],this.$angle=this.$('input[name="angle"]')[0],this.renderData()},n.prototype.renderData=function(){if(this.image.get("data")===null)return;this.element&&this.element.remove(),this.element=this.app.Canvas.image(this.image.get("data")),this.renderImage()},n.prototype.renderImage=function(){this.element===undefined&&(this.element=this.app.Canvas.image(this.image.get("data"))),this.element.toBack(),this.app.BgRect&&this.app.BgRect.toBack(),this.app.imageElement=this.element,this.element.attr({x:this.image.get("x"),y:this.image.get("y"),width:this.image.get("width"),height:this.image.get("height"),opacity:this.image.get("visible")?1:0}),(this.image.get("origHeight")==null||this.image.get("origWidth")==null)&&this.image.set({origWidth:this.image.get("width"),origHeight:this.image.get("height")}),this.rotate(this.image.get("angle")),this.updateHtmlElements(),this.resizeCanvas()},n.prototype.updateHtmlElements=function(){if(this.image.get("data")===null)return;this.$width.value=this.image.get("width"),this.$height.value=this.image.get("height"),this.$angle.value=this.image.get("angle")},n.prototype.rotate=function(e){if(this.image.get("data")===null)return;var t="t0,0r"+e;this.element.transform(t)},n.prototype.resizeCanvas=function(){if(this.image.get("data")===null)return;var e=this.element.getBBox(),t="t"+ -e.x+","+ -e.y+"r"+this.image.get("angle");this.element.transform(t);var n=e.height+50;this.app.refCol&&this.app.refCol.Canvas&&(n=Math.max(this.app.refCol.Canvas.height,n),this.app.refCol.Canvas.setSize(this.app.refCol.Canvas.width,n)),this.app.type!=="transect"?this.app.Canvas.setSize(e.width+50,n):(this.app.width=e.width+50,this.app.height=n)},n.prototype.updateImageWidth=function(){if(this.image.get("data")===null)return;if(this.image.get("preserveAspectRatio")){var e=parseInt(this.$width.value)*this.image.get("origHeight")/this.image.get("origWidth");this.$height.value=e}this.updateImage()},n.prototype.updateImageHeight=function(){if(this.image.get("data")===null)return;if(this.image.get("preserveAspectRatio")){var e=parseInt(this.$height.value)*this.image.get("origWidth")/this.image.get("origHeight");this.$width.value=e}this.updateImage()},n.prototype.updateImage=function(){if(this.image.get("data")===null)return;this.image.set({width:parseInt(this.$width.value),height:parseInt(this.$height.value),angle:parseFloat(this.$angle.value),preserveAspectRatio:this.$preserveAspectRatio.checked,visible:this.$visible.checked})},n.prototype.imageDragover=function(e){var e=e.originalEvent;e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"},n.prototype.imageDrop=function(e){var e=e.originalEvent;e.stopPropagation(),e.preventDefault();var t=e.dataTransfer.files[0];if(t.type==="image/png"||t.type==="image/jpg"||t.type==="image/jpeg"||t.type==="image/gif"){var n=new FileReader;n.onload=this.readImage.bind(this),n.readAsDataURL(t)}},n.prototype.readImage=function(e){var t=this,n=new Image;$(n).load(function(){t.app.ImageOb.set({data:e.target.result,width:n.width,height:n.height})}),n.src=e.target.result},n}),define("lithologyAppView",["baseView","cursorView","fileSystemView","markers","markersView","zones","zonesView","lithologyColumns","lithologyColumnsView","dataExportView","loader","exporter","referenceColumnSideView","imageView","imageOb"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d){var v=e.extend({el:".container",classname:"LithologyAppView",events:{"click a.lithology-settings":"showSettings","click a.maker-tools":"enableTool","click a.continue":"showCanvas","dragover #data-box":"dataDragover","drop #data-box":"dataDrop"}});return v.prototype.initialize=function(){this.lithologyApp={type:"lithology"},this.lithologyApp.LithologyColumnsCollection=new u,this.lithologyApp.ZonesCollection=new s,this.lithologyApp.MarkersCollection=new r,this.lithologyApp.StatusBox=$(".status-box"),this.$introScreen=this.$("#intro-screen"),this.lithologyApp.$canvas=this.$("#canvas"),this.$canvas=this.lithologyApp.$canvas,this.$displayPanels=this.$(".display-panel"),this.lithologyApp.loader=new l(this.lithologyApp),this.lithologyApp.exporter=new c(this.lithologyApp),this.lithologyApp.ImageOb=new d({}),this.lithologyApp.Canvas=new Raphael(this.$canvas[0],2e3,2e3),this.lithologyApp.MarkersSet=this.lithologyApp.Canvas.set(),this.lithologyApp.LithologyMarkersSet=this.lithologyApp.Canvas.set(),this.lithologyApp.LithologyGroupMarkersSet=this.lithologyApp.Canvas.set(),this.lithologyApp.LithologysSet=this.lithologyApp.Canvas.set(),this.lithologyApp.LithologyGroupsSet=this.lithologyApp.Canvas.set(),this.loadPatternsDataAndRender(),$(".linked").scroll(function(){$(".linked").scrollTop($(this).scrollTop())})},v.prototype.loadPatternsDataAndRender=function(){var e=this;$.get("/pattern_manager/json/patterns.json",function(t){e.lithologyApp.patternsData=t,e.render(),e.listenToActionEvents()})},v.prototype.listenToActionEvents=function(){var e=this;$(".close-reveal-modal").click(function(e){$(e.target).parent().foundation("reveal","close")}),$("a[href=#continue-load-from-local-storage]").click(function(t){$(t.target).parent().foundation("reveal","close"),e.loadFromLocalStorage()}),$("a[href=#continue-save-to-local-storage]").click(function(t){$(t.target).parent().foundation("reveal","close"),e.saveToLocalStorage()})},v.prototype.showCanvas=function(){this.$canvas.removeClass("hide"),this.$introScreen.addClass("hide")},v.prototype.render=function(){this.dataExportView=new f(this.lithologyApp),this.cursorView=new t(this.lithologyApp),this.imageView=new p(this.lithologyApp),this.fileSystemView=new n(this.lithologyApp),this.zonesView=new o(this.lithologyApp),this.markersView=new i(this.lithologyApp),this.lithologyColumnsView=new a(this.lithologyApp),this.referenceColumnSideView=new h(this.lithologyApp,"#reference-column-settings")},v.prototype.showSettings=function(e){var t=e.target.getAttribute("href")+"-list";$(t).hasClass("active")?($(t).removeClass("active"),$(e.target).removeClass("active"),$(e.target).parent().removeClass("active"),this.$("#sections-panel").removeClass("active")):(this.$(".settings-content").removeClass("active"),this.$(".settings-links").removeClass("active"),this.$(".lithology-settings").removeClass("active"),$(t).addClass("active"),$(e.target).addClass("active"),$(e.target).parent().addClass("active"),this.$("#sections-panel").addClass("active"))},v.prototype.showExportDataPanel=function(e){this.$exportPanel.hasClass("active")||this.dataExportView.render()},v.prototype.exportCanvasAsImage=function(){},v.prototype.saveToLocalStorage=function(){this.lithologyApp.exporter.export(),localStorage.lithologyApp=this.lithologyApp.exporter.getJSON()},v.prototype.loadFromLocalStorage=function(){this.showCanvas(),this.lithologyApp.loader.loadFromLocalStorage()},v.prototype.dataDragover=function(e){var e=e.originalEvent;e.stopPropagation(),e.preventDefault()},v.prototype.dataDrop=function(e){var t=this,e=e.originalEvent;e.stopPropagation(),e.preventDefault();var n=e.dataTransfer.files[0];if(n.type==="application/json"){var r=new FileReader;r.onloadend=function(e){t.showCanvas(),t.lithologyApp.loader.loadData(this.result)},r.readAsText(n)}},v.prototype.toggleLithologys=function(e){$("a[href='#add-lithology']").parent().hasClass("active")?($("a[href='#add-lithology']").parent().removeClass("active"),this.lithologyApp.enLithologys=!1):($("a[href='#add-lithology']").parent().addClass("active"),this.lithologyApp.enLithologys=!0)},v.prototype.dataDragover=function(e){var e=e.originalEvent;e.stopPropagation(),e.preventDefault()},v.prototype.dataDrop=function(e){$("#loading").removeClass("hide");var t=this,e=e.originalEvent;e.stopPropagation(),e.preventDefault();var n=e.dataTransfer.files[0],r=n.name.split(".").pop(),i=new FileReader;i.onloadend=function(e){t.showCanvas(),r==="json"&&t.lithologyApp.loader.loadData(this.result),r==="txt"&&t.lithologyApp.loader.loadTextData(this.result),$("#loading").addClass("hide")},i.readAsText(n)},v.prototype.enableTool=function(e){var t=e.target.getAttribute("href");this.markersView.enMarkers&&this.markersView.toggleMarkers(),this.lithologyApp.enLithologys&&this.toggleLithologys();switch(t){case"#add-marker":this.markersView.toggleMarkers();break;case"#export-data":this.dataExportView.toggleExportView();break;case"#file-system":this.fileSystemView.toggleView();break;case"#save-to-local-storage":$("#quick-save-data").foundation("reveal","open");break;case"#reload-data":$("#load-saved-data").foundation("reveal","open");break;case"#new-column":break;case"#add-lithology":this.toggleLithologys();break;default:}},v}),requirejs.config({paths:{baseView:"/commons/js/views/base_view",baseModel:"/commons/js/models/base_model",baseCollection:"/commons/js/collections/base_collection",app:"/commons/js/models/app",settings:"/commons/js/models/settings",cursorView:"/commons/js/views/cursor_view",cursor:"/commons/js/models/cursor",markersView:"/commons/js/views/markers_view",markerView:"/commons/js/views/marker_view",marker:"/commons/js/models/marker",markers:"/commons/js/collections/markers",zoneView:"/commons/js/views/zone_view",zonesView:"/commons/js/views/zones_view",zone:"/commons/js/models/zone",zones:"/commons/js/collections/zones",imageView:"/commons/js/views/image_view",imageOb:"/commons/js/models/image",loader:"/lithology_column_maker/js/utils/loader",exporter:"/lithology_column_maker/js/utils/exporter",dataExportView:"/lithology_column_maker/js/views/data_export_view",lithology:"/lithology_column_maker/js/models/lithology",lithologys:"/lithology_column_maker/js/collections/lithologys",lithologyMarker:"/lithology_column_maker/js/models/lithology_marker",lithologyMarkers:"/lithology_column_maker/js/collections/lithology_markers",lithologyGroupMarker:"/lithology_column_maker/js/models/lithology_group_marker",lithologyGroupMarkers:"/lithology_column_maker/js/collections/lithology_group_markers",lithologyGroup:"/lithology_column_maker/js/models/lithology_group",lithologyGroups:"/lithology_column_maker/js/collections/lithology_groups",lithologyColumn:"/lithology_column_maker/js/models/lithology_column",lithologyColumns:"/lithology_column_maker/js/collections/lithology_columns",lithologyView:"/lithology_column_maker/js/views/lithology_view",lithologyMarkerView:"/lithology_column_maker/js/views/lithology_marker_view",lithologyGroupView:"/lithology_column_maker/js/views/lithology_group_view",lithologyGroupMarkerView:"/lithology_column_maker/js/views/lithology_group_marker_view",lithologyColumnView:"/lithology_column_maker/js/views/lithology_column_view",lithologyColumnsView:"/lithology_column_maker/js/views/lithology_columns_view",polyK:"/commons/js/lib/polyK",file:"/file_system/js/models/file",files:"/file_system/js/collections/files",fileView:"/file_system/js/views/file_view",filesView:"/file_system/js/views/files_view",fileSystem:"/file_system/js/models/file_system",fileSystemView:"/file_system/js/views/file_system_view",lithologyAppView:"/lithology_column_maker/js/views/lithology_app_view",referenceColumnLoader:"/reference_column_maker/js/utils/loader",referenceColumn:"/reference_column_maker/js/models/reference_column",referenceBlock:"/reference_column_maker/js/models/reference_block",referenceBlocks:"/reference_column_maker/js/collections/reference_blocks",referenceBlockMarker:"/reference_column_maker/js/models/reference_block_marker",referenceBlockMarkers:"/reference_column_maker/js/collections/reference_block_markers",referenceBlockColumn:"/reference_column_maker/js/models/reference_block_column",referenceBlockColumns:"/reference_column_maker/js/collections/reference_block_columns",referenceBlockView:"/reference_column_maker/js/views/reference_block_view",referenceBlockMarkerView:"/reference_column_maker/js/views/reference_block_marker_view",referenceBlockColumnView:"/reference_column_maker/js/views/reference_block_column_view",referenceBlockColumnsView:"/reference_column_maker/js/views/reference_block_columns_view",referenceColumnSideView:"/reference_column_maker/js/views/reference_column_side_view"}}),requirejs(["lithologyAppView"],function(e){var t=new e}),define("lithology_column_maker/js/lithology_app",function(){});