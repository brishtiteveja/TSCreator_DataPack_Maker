define("baseView",[],function(){var e=Backbone.View.extend({});return e.prototype.wrapString=function(e,t,n,r){n=n||"\n",t=t||75,r=r||!1;if(!e)return e;var i=".{1,"+t+"}(\\s|$)"+(r?"|.{"+t+"}|.+$":"|\\S+?(\\s|$)");return e.match(RegExp(i,"g")).join(n)},e}),define("baseModel",[],function(){var e=Backbone.Model.extend({localStorage:new Backbone.LocalStorage("timescale-creator")});return e}),define("cursor",["baseModel"],function(e){var t=e.extend({constructor:function(t,n){var r=[{lockH:!1,lockV:!1}];e.apply(this,r)}});return t}),define("cursorView",["baseView","cursor"],function(e,t){var n=e.extend({el:".main",classname:"CursorView",events:{keypress:"togglelock",'click a[href="#lock-cursor-h"]':"toggleHlock",'click a[href="#lock-cursor-v"]':"toggleVlock"}});return n.prototype.initialize=function(e){this.app=e,this.cursor=new t,this.app.Cursor=this.cursor,this.$hLock=this.$('a[href="#lock-cursor-h"]'),this.$vLock=this.$('a[href="#lock-cursor-v"]')},n.prototype.togglelock=function(e){e.keyCode==TimescaleApp.KEY_MINUS&&this.toggleHlock(),e.keyCode==TimescaleApp.KEY_EQUAL&&this.toggleVlock()},n.prototype.toggleHlock=function(){this.$vLock.parent().hasClass("active")&&this.toggleVlock(),this.$hLock.parent().toggleClass("active"),this.cursor.set({lockH:!this.cursor.get("lockH")})},n.prototype.toggleVlock=function(){this.$hLock.parent().hasClass("active")&&this.toggleHlock(),this.$vLock.parent().toggleClass("active"),this.cursor.set({lockV:!this.cursor.get("lockV")})},n}),define("file",["baseModel"],function(e){var t=e.extend({classname:"File",constructor:function(t,n){var r=[{name:t.name,isFile:t.isFile,isDirectory:t.isDirectory,size:t.Size||0,fullPath:t.fullPath,url:t.toURL(),selected:!1,type:null,size:0,modificationTime:null}];e.apply(this,r)}});return t.prototype.initialize=function(e,t){var n=this.get("name").split(".").pop();this.set({type:n})},t.prototype.updateFileData=function(e){var t=new Date(e.modificationTime);this.set({size:e.size,modificationTime:t.getTime()})},t}),define("baseCollection",[],function(){var e=Backbone.Collection.extend({localStorage:new Backbone.LocalStorage("timescale-creator")});return e}),define("files",["baseCollection","file"],function(e,t){var n=e.extend({classname:"Files",model:t});return n.prototype.comparator=function(e){return-e.get("modificationTime")},n}),define("fileView",["baseView"],function(e){var t=e.extend({tagName:"div",classname:"FileView",events:{dblclick:"open",click:"select","blur .file-name":"blur"}});return t.prototype.template=new EJS({url:"/file_system/ejs/file.ejs"}),t.prototype.initialize=function(e,t,n,r){this.app=r,this.fileSystem=n,this.files=t,this.file=e,this.listenTo(this.file,"change:selected",this.setSelected.bind(this)),this.listenTo(this.file,"change:name",this.rename.bind(this)),this.listenToActionEvents(),this.render()},t.prototype.listenToActionEvents=function(){$('a[href="#delete-file"]').click(this.deleteFile.bind(this)),$('a[href="#load-data"]').click(this.loadData.bind(this))},t.prototype.render=function(){var e=this.file.toJSON();this.$el.html(this.template.render(e)),this.$file=this.$(".file"),this.$fileName=this.$(".file-name")[0]},t.prototype.deleteFile=function(){var e=this;if(!e.file.get("selected"))return;e.file.get("isFile")?e.fileSystem.get("fs").root.getFile(e.file.get("fullPath"),{},function(t){t.remove(function(){console.log("File removed."),e.file.destroy()},e.errorHandler.bind(this))},e.errorHandler.bind(this)):e.fileSystem.get("fs").root.getDirectory(e.file.get("fullPath"),{},function(t){t.removeRecursively(function(){console.log("Directory removed."),e.file.destroy()},e.errorHandler.bind(this))},e.errorHandler.bind(this))},t.prototype.select=function(){var e=this;this.files.each(function(t){t==e.file?t.set({selected:!t.get("selected")}):t.set({selected:!1})})},t.prototype.setSelected=function(){this.file.get("selected")?this.$file.addClass("active"):this.$file.removeClass("active")},t.prototype.blur=function(){this.file.set({name:this.$fileName.textContent})},t.prototype.rename=function(){var e=this;e.file.get("isFile")?e.fileSystem.get("fs").root.getFile(e.file.get("fullPath"),{},function(t){var n=e.file.get("fullPath").split("/");n.pop(),n=n.join("/"),n===""&&(n="/"),e.fileSystem.get("fs").root.getDirectory(n,{},function(n){t.moveTo(n,e.file.get("name")),e.fileSystem.set({update:!e.fileSystem.get("update")})},e.errorHandler.bind(this))},e.errorHandler.bind(this)):e.fileSystem.get("fs").root.getDirectory(e.file.get("fullPath"),{},function(t){var n=e.file.get("fullPath").split("/");n.pop(),n=n.join("/"),n===""&&(n="/"),e.fileSystem.get("fs").root.getDirectory(n,{},function(n){t.moveTo(n,e.file.get("name")),e.fileSystem.set({update:!e.fileSystem.get("update")})},e.errorHandler.bind(this))},e.errorHandler.bind(this))},t.prototype.open=function(){var e=this;e.file.get("isFile")||this.fileSystem.set({path:this.file.get("fullPath")})},t.prototype.errorHandler=function(e){console.log("Error: "+e.name+" "+e.message)},t.prototype.loadData=function(){var e=this;if(e.file.get("isDirectory")||!e.file.get("selected"))return;$("#loading").removeClass("hide"),e.fileSystem.get("fs").root.getFile(e.file.get("fullPath"),{},function(t){t.file(function(t){var n=new FileReader;n.onloadend=function(t){e.showCanvas(),e.app.loader.loadData(this.result),$("#loading").addClass("hide")},n.readAsText(t)},e.errorHandler.bind(e))},e.errorHandler.bind(e))},t.prototype.showCanvas=function(){$("#canvas").removeClass("hide"),$("#file-system-panel").addClass("hide"),$("a[href='#file-system']").parent().removeClass("active")},t}),define("filesView",["baseView","fileView","file"],function(e,t,n){var r=e.extend({classname:"FilesView",el:"#files-list",events:{}});return r.prototype.template=new EJS({url:"/file_system/ejs/files.ejs"}),r.prototype.initialize=function(e,t,n){this.app=n,this.fileSystem=t,this.files=e,this.listenTo(this.files,"add",this.render.bind(this)),this.listenTo(this.files,"remove",this.render.bind(this)),this.listenToActionEvents(),this.render()},r.prototype.listenToActionEvents=function(e){$('a[href="#create-file"]').unbind().click(this.createNewFile.bind(this)),$('a[href="#create-dir"]').unbind().click(this.createNewDir.bind(this)),$('a[href="#save-project"]').click(this.saveProject.bind(this))},r.prototype.render=function(){this.$el.html(this.template.render()),this.$list=this.$(".list"),this.files.each(this.addFile.bind(this))},r.prototype.addFile=function(e){var n=new t(e,this.files,this.fileSystem,this.app);this.$list.append(n.el)},r.prototype.createNewFile=function(){var e=this;e.fileSystem.get("fs").root.getDirectory(e.fileSystem.get("path"),{},function(t){e.newFile(t,_.uniqueId("new-file-"))},e.errorHandler.bind(e))},r.prototype.newFile=function(e,t,n){var r=this;e.getFile(t,{create:!0,exclusive:!0},function(e){r.createFile(e,n)},r.errorHandler.bind(r))},r.prototype.createFile=function(e,t){var r=this.fileSystem.get("path");r==="/"?r=[""]:r=this.fileSystem.get("path").split("/"),r.push(e.name),r=r.join("/");if(r===e.fullPath){var i=new n(e);this.files.add(i)}t!==undefined&&t(e)},r.prototype.createNewDir=function(){var e=this;e.fileSystem.get("fs").root.getDirectory(e.fileSystem.get("path"),{},function(t){e.newDir(t,_.uniqueId("new-folder-"))},e.errorHandler.bind(e))},r.prototype.newDir=function(e,t,n){var r=this;e.getDirectory(t,{create:!0},function(e){r.createFile(e,n)},r.errorHandler.bind(r))},r.prototype.saveProject=function(){$("#loading").removeClass("hide");var e=this,t=e.getTimeStamp(),n=this.app.type+"-"+t;e.fileSystem.get("fs").root.getDirectory(e.fileSystem.get("path"),{},function(r){e.newDir(r,n,function(n){var r=e.app.type+"-data-"+t+".json",i=e.app.type+"-data-"+t+".txt",s=e.app.exporter.getJSON(),o=e.app.exporter.getText();e.newFile(n,r,function(t){e.writeJSONToAFile(t,s),e.newFile(n,i,function(t){e.writeTextToAFile(t,o),$("#loading").addClass("hide")})})})},e.errorHandler.bind(e)),this.fileSystem.set({update:!this.fileSystem.get("update")})},r.prototype.writeJSONToAFile=function(e,t){var t=t;if(e.isDirectory)return;var n=this;n.fileSystem.get("fs").root.getFile(e.fullPath,{create:!0},function(e){e.createWriter(function(e){e.onwriteend=function(e){console.log("Write completed.")},e.onerror=function(e){console.log("Write failed: "+e.toString())};var n=new Blob([t],{type:"application/json"});e.write(n)},n.errorHandler.bind(this))},n.errorHandler.bind(this))},r.prototype.writeTextToAFile=function(e,t){var t=t;if(e.isDirectory)return;var n=this;n.fileSystem.get("fs").root.getFile(e.fullPath,{create:!0},function(e){e.createWriter(function(e){e.onwriteend=function(e){console.log("Write completed.")},e.onerror=function(e){console.log("Write failed: "+e.toString())};var n=new Blob([t],{type:"text/plain"});e.write(n)},n.errorHandler.bind(this))},n.errorHandler.bind(this))},r.prototype.getTimeStamp=function(){var e=new Date,t=e.getUTCMonth()+"-"+e.getUTCDate()+"-";return t+=e.getUTCFullYear()+"-"+e.getHours()+"_",t+=e.getMinutes()+"_"+e.getSeconds(),t},r.prototype.errorHandler=function(e){console.log("Error: "+e.name+" "+e.message)},r}),define("fileSystem",["baseModel"],function(e){var t=e.extend({classname:"FileSystem",constructor:function(t,n){var r=[{fs:t.fs,path:"/",update:!1}];e.apply(this,r)}});return t}),define("fileSystemView",["baseView","file","files","filesView","fileSystem"],function(e,t,n,r,i){var s=e.extend({classname:"FileSystemView",el:"#file-system-panel",events:{"click a[href='#parent-dir']":"parentDir","click a.path-breadcrumb":"setDir"}});return s.prototype.template=new EJS({url:"/file_system/ejs/file_system_panel.ejs"}),s.prototype.initialize=function(e){this.app=e,this.$canvas=$("#canvas");var t=1073741824;this.requestFileSystem(t)},s.prototype.requestFileSystem=function(e){window.requestFileSystem=window.requestFileSystem||window.webkitRequestFileSystem,window.requestFileSystem&&window.requestFileSystem(window.PERSISTENT,e,this.render.bind(this),this.errorHandler.bind(this))},s.prototype.render=function(e){this.fileSystem=new i({fs:e}),this.renderDirs(),this.listenTo(this.fileSystem,"change:path",this.renderDirs.bind(this)),this.listenTo(this.fileSystem,"change:update",this.renderDirs.bind(this))},s.prototype.renderDirs=function(){this.$el.html(this.template.render(this.fileSystem.toJSON()));var e=this,t=this.fileSystem.get("path");this.files=new n,this.filesView=new r(this.files,this.fileSystem,this.app),this.fileSystem.get("fs").root.getDirectory(t,{},function(t){if(t.isDirectory){var n=t.createReader();n.readEntries(e.readDir.bind(e))}},e.errorHandler),this.readDir()},s.prototype.readDir=function(e){var n=this;if(e===undefined||!e.length)return;if(n.fileSystem.get("update")){n.fileSystem.set({update:!1});return}_.invoke(n.files.toArray(),"destroy"),e.forEach(function(e){var r=new t(e);e.getMetadata(function(e){r.updateFileData(e),n.files.add(r)})})},s.prototype.parentDir=function(){var e=this.fileSystem.get("path");if(e==="/")return;e=e.split("/"),e.pop(),e=e.join("/"),this.fileSystem.set({path:e})},s.prototype.setDir=function(e){var t=$(e.target).attr("path");t===""&&(t="/"),this.fileSystem.set({path:t})},s.prototype.toggleView=function(e){$("a[href='#file-system']").parent().hasClass("active")?($("a[href='#file-system']").parent().removeClass("active"),$(".display-panel").addClass("hide"),this.$canvas.removeClass("hide")):($(".maker-tools").parent().removeClass("active"),$("a[href='#file-system']").parent().addClass("active"),$(".display-panel").addClass("hide"),this.$el.removeClass("hide"),this.app.exporter.export())},s.prototype.errorHandler=function(e){console.log("Error: "+e.name+" "+e.message)},s}),define("settings",["baseModel"],function(e){var t=e.extend({classname:"Settings",constructor:function(t,n){var r=[{fontFamily:t?t.fontFamily:"Arial, Helvetica, sans-serif",fontVariant:t?t.fontVariant:"normal",fontWeight:t?t.fontWeight:"normal",fontStretch:t?t.fontStretch:"normal",fontSize:t?t.fontSize:12,backgroundColor:t&&t.backgroundColor?TscToCssColor(t.backgroundColor):"#DDDDDD",fill:t&&t.fill?TscToCssColor(t.fill):"#000000",strokeWidth:t?t.strokeWidth:3,strokeColor:t?t.strokeColor:"#000000"}];e.apply(this,r)}});return t}),define("referenceBlock",["baseModel","settings"],function(e,t){var n=e.extend({classname:"ReferenceBlock",constructor:function(n,r){var i=[{edit:!1,hover:!1,name:n.name||_.uniqueId("ReferenceBlock "),description:n.description,settings:new t,top:n.top||null,base:n.base||null,blockColumn:n.blockColumn||null}];e.apply(this,i)}});return n.prototype.initialize=function(){this.get("settings").set({backgroundColor:"#FF0000"})},n.prototype.toJSON=function(){var e=_.clone(this.attributes);return delete e.blockColumn,e},n}),define("referenceBlocks",["baseCollection","referenceBlock"],function(e,t){var n=e.extend({classname:"ReferenceBlocks",model:t});return n}),define("referenceBlockMarker",["baseModel","referenceBlocks"],function(e,t){var n=e.extend({classname:"ReferenceBlockMarker",constructor:function(n,r){var i=[{name:n.name||"TOP",edit:!1,hover:!1,y:parseInt(n.y),id:_.uniqueId("block-marker-"),age:n.age?parseFloat(n.age):null,blockColumn:n.blockColumn||null,style:"solid",app:r||null,blocks:new t,marker:null}];e.apply(this,i)}});return n.prototype.initialize=function(){},n.prototype.toJSON=function(){var e=_.clone(this.attributes);return delete e.blocks,delete e.blockColumn,delete e.marker,delete e.app,e},n}),define("referenceBlockMarkers",["baseCollection","referenceBlockMarker"],function(e,t){var n=e.extend({classname:"ReferenceBlockMarkers",model:t});return n.prototype.comparator=function(e){return e.get("y")},n}),define("referenceBlockColumn",["baseModel","referenceBlocks","referenceBlockMarkers","settings"],function(e,t,n,r){var i=e.extend({classname:"ReferenceBlockColumn",constructor:function(i){var s=[{x:i.x||0,id:i.id||_.uniqueId("column-"),name:i.name||_.uniqueId("Column "),width:parseInt(i.width)||200,height:100,description:i.description||null,blockMarkers:new n,blocks:new t,settings:new r}];e.apply(this,s)}});return i.prototype.comparator=function(e){return e.get("x")},i.prototype.toJSON=function(){var e=_.clone(this.attributes);return e},i}),define("referenceBlockColumns",["baseCollection","referenceBlockColumn"],function(e,t){var n=e.extend({classname:"ReferenceBlockColumns",model:t});return n}),define("referenceBlockView",["baseView"],function(e){var t=e.extend({tagName:"li",classname:"ReferenceBlockView",events:{"click .toggle":"toggleBlockForm","click .block-data":"toggleBlockForm","click .destroy":"destroy","keypress :input":"updateBlock","keyup :input":"updateBlock",'change input[name="block-color"]':"updateBlock","change select.block-line-style":"updateBlock",mouseover:"onMouseOver",mouseout:"onMouseOut"}});return t.prototype.template=new EJS({url:"/reference_column_maker/ejs/block.ejs"}),t.prototype.initialize=function(e,t){this.app=e,this.block=t,this.top=this.block.get("top"),this.base=this.block.get("base"),this.blockSet===undefined&&(this.blockSet=this.app.Canvas.set(),this.app.BlocksSet.push(this.blockSet)),this.render(),this.listenTo(this.block,"change:edit",this.editBlock.bind(this)),this.listenTo(this.block,"change:hover",this.setHoverStatus.bind(this)),this.listenTo(this.block,"change:name",this.renderBlock.bind(this)),this.listenTo(this.block,"change:description",this.renderBlock.bind(this)),this.listenTo(this.block.get("blockColumn"),"change:x",this.renderBlock.bind(this)),this.listenTo(this.block.get("blockColumn"),"change:width",this.renderBlock.bind(this)),this.listenTo(this.top,"change:y",this.renderBlock.bind(this)),this.listenTo(this.top,"change:age",this.render.bind(this)),this.listenTo(this.base,"change:y",this.renderBlock.bind(this)),this.listenTo(this.base,"change:age",this.render.bind(this)),this.listenTo(this.block.get("settings"),"change",this.renderBlock.bind(this)),this.listenTo(this.block,"destroy",this.delete.bind(this))},t.prototype.render=function(){this.$el.html(this.template.render(this.block.toJSON())),this.$toggle=this.$(".toggle"),this.$blockForm=this.$(".block-form"),this.$blockData=this.$(".block-data"),this.$blockName=this.$('input[name="block-name"]')[0],this.$topAge=this.$('input[name="top-age"]')[0],this.$baseAge=this.$('input[name="base-age"]')[0],this.$blockColor=this.$('input[name="block-color"]')[0],this.$blockDescription=this.$('textarea[name="block-description"]')[0],this.editBlock(),this.renderBlock()},t.prototype.renderBlock=function(){this.bgBox===undefined&&(this.bgBox=this.app.Canvas.rect(),this.blockText=this.app.Canvas.text(),this.bBox=this.app.Canvas.rect(),this.blockSet.push(this.bgBox),this.blockSet.push(this.blockText),this.blockSet.push(this.bBox),this.app.MarkersSet.toFront(),this.app.BlockMarkersSet.toFront(),this.bBox.hover(this.onMouseOver.bind(this),this.onMouseOut.bind(this))),this.bgBox.attr({"stroke-width":0,fill:this.block.get("settings").get("backgroundColor"),x:this.block.get("blockColumn").get("x"),y:this.top.get("y"),width:this.block.get("blockColumn").get("width"),height:this.base.get("y")-this.top.get("y")});var e=Math.round(this.block.get("blockColumn").get("x")+this.block.get("blockColumn").get("width")/2),t=Math.round((this.top.get("y")+this.base.get("y"))/2),n=Math.min(Math.round(this.base.get("y")-this.top.get("y")),16);this.blockText.attr({x:e,y:t,text:this.block.get("name"),"font-size":n}),this.bBox.attr({"stroke-width":2,opacity:0,fill:"#FFF",x:this.block.get("blockColumn").get("x"),y:this.top.get("y"),width:this.block.get("blockColumn").get("width"),height:this.base.get("y")-this.top.get("y")}),this.renderTooltip()},t.prototype.renderTooltip=function(){$(this.bBox.node).qtip({content:{text:this.block.get("name")+"<br>"+(this.block.get("description")||"No description yet!")},position:{my:"bottom left",target:"mouse"}})},t.prototype.onMouseOver=function(){this.$el.addClass("hover"),this.block.set({hover:!0})},t.prototype.onMouseOut=function(){this.$el.removeClass("hover"),this.block.set({hover:!1})},t.prototype.setHoverStatus=function(){this.block.get("hover")?(this.$el.addClass("hover"),this.glow=this.bBox.glow()):(this.glow&&this.glow.remove(),this.$el.removeClass("hover"))},t.prototype.toggleBlockForm=function(){this.render(),this.block.set({edit:!this.block.get("edit")})},t.prototype.editBlock=function(){this.block.get("edit")?(this.$blockForm.removeClass("hide"),this.$blockData.addClass("hide"),this.$toggle.removeClass("hide-data"),this.$toggle.addClass("show-data")):(this.$blockForm.addClass("hide"),this.$blockData.removeClass("hide"),this.$toggle.removeClass("show-data"),this.$toggle.addClass("hide-data"))},t.prototype.delete=function(){this.blockText&&this.blockText.remove(),this.bgBox&&this.bgBox.remove(),this.bBox&&this.bBox.remove(),this.glow&&this.glow.remove(),this.$el.remove(),this.remove()},t.prototype.destroy=function(){this.block.get("base").set({name:"TOP"}),this.block.destroy()},t.prototype.updateBlock=function(e){var t=this.$blockName.value,n=this.$blockDescription.value,r=this.$blockColor.value,i=this.$("select.block-line-style option:selected").val();this.block.set({name:t,description:n});if(e.keyCode===TimescaleApp.ENTER||e.keyCode===TimescaleApp.ESC)this.block.get("base").set({name:t+" Base",age:parseFloat(this.$baseAge.value||0)}),this.block.get("top").set({age:parseFloat(this.$topAge.value||0)}),this.toggleBlockForm();this.block.get("settings").set({backgroundColor:r}),this.base.set({style:i})},t}),define("referenceBlockMarkerView",["baseView"],function(e){var t=e.extend({classname:"ReferenceBlockMarkerView"});return t.prototype.statusBoxTemplate=new EJS({url:"/reference_column_maker/ejs/status_box.ejs"}),t.prototype.initialize=function(e,t){this.app=e,this.blockMarker=t,this.render(),this.listenTo(this.blockMarker.get("blockColumn"),"change:x",this.renderBlockMarker.bind(this)),this.listenTo(this.blockMarker.get("blockColumn"),"change:width",this.renderBlockMarker.bind(this)),this.listenTo(this.blockMarker,"change:hover",this.setHoverStatus.bind(this)),this.listenTo(this.blockMarker,"change",this.renderBlockMarker.bind(this)),this.listenTo(this.blockMarker,"destroy",this.delete.bind(this)),this.listenTo(this.blockMarker.get("blocks"),"remove",this.checkAndDelete.bind(this)),this.render()},t.prototype.render=function(){this.renderBlockMarker()},t.prototype.renderBlockMarker=function(){this.element===undefined&&(this.element=this.app.Canvas.path(),this.element.attr({"stroke-width":2,stroke:"#0000FF"}),this.element.hover(this.onMouseOver.bind(this),this.onMouseOut.bind(this)),this.element.drag(this.dragMove.bind(this),this.dragStart.bind(this),this.dragEnd.bind(this)),this.app.BlockMarkersSet.push(this.element),this.app.MarkersSet.toFront()),this.blockMarker.get("marker")&&this.listenTo(this.blockMarker.get("marker"),"change:y",this.updateBlockMakereY.bind(this));var e=this.blockMarker.get("style"),t=[];e==="dashed"?t=["-"]:e==="dotted"&&(t=["."]),this.element.attr({path:this.getPath(),"stroke-dasharray":t}),this.resizeCanvas(),this.updateStatusBox(),this.renderTooltip()},t.prototype.renderTooltip=function(){var e=this;$(this.element.node).qtip({content:{text:this.blockMarker.get("name")+"("+this.blockMarker.get("age")+" myr )"},position:{my:"bottom left",target:"mouse"}})},t.prototype.resizeCanvas=function(){var e=Math.max(this.app.Canvas.height,this.blockMarker.get("y")+100);this.blockMarker.get("blockColumn").set({height:e}),this.app.Canvas.setSize(this.app.Canvas.width,e)},t.prototype.updateBlockMakereY=function(){this.blockMarker.get("marker")&&this.blockMarker.set({y:this.blockMarker.get("marker").get("y")})},t.prototype.updateStatusBox=function(){this.app.StatusBox&&this.app.StatusBox.html(this.statusBoxTemplate.render(this.blockMarker.toJSON()))},t.prototype.getPath=function(){var e=this.blockMarker.get("blockColumn").get("x")+this.blockMarker.get("blockColumn").get("width");return"M"+this.blockMarker.get("blockColumn").get("x")+","+this.blockMarker.get("y")+"H"+e},t.prototype.dragStart=function(e,t,n){var r=this.blockMarker.get("blockColumn").get("blockMarkers"),i=r.indexOf(this.blockMarker);this.prevMarker=r.at(i-1),this.nextMarker=r.at(i+1)},t.prototype.dragMove=function(e,t,n,r,i){if(this.prevMarker&&this.nextMarker&&(this.prevMarker.get("y")+2>i.offsetY||i.offsetY>this.nextMarker.get("y")-2))return;if(!this.prevMarker&&this.nextMarker&&i.offsetY>this.nextMarker.get("y")-2)return;if(this.prevMarker&&!this.nextMarker&&this.prevMarker.get("y")+2>i.offsetY)return;this.blockMarker.set({y:i.offsetY})},t.prototype.onMouseOver=function(){this.$el.addClass("hover"),this.blockMarker.set({hover:!0})},t.prototype.onMouseOut=function(){this.$el.removeClass("hover"),this.blockMarker.set({hover:!1})},t.prototype.setHoverStatus=function(){this.blockMarker.get("hover")?(this.element.attr({"stroke-width":5}),this.$el.addClass("hover")):(this.element.attr({"stroke-width":2}),this.$el.removeClass("hover"))},t.prototype.dragEnd=function(e){},t.prototype.delete=function(){this.element!==undefined&&this.element.remove(),this.$el.remove(),this.remove()},t.prototype.checkAndDelete=function(){this.blockMarker.get("blocks").length==0&&this.destroy()},t.prototype.destroy=function(){this.blockMarker.destroy()},t}),define("referenceBlockColumnView",["baseView","referenceBlockView","referenceBlockMarkerView","referenceBlock","referenceBlockMarker"],function(e,t,n,r,i){var s=e.extend({tagName:"li",classname:"ReferenceBlockColumnView",events:{"click .toggle":"ReferencetoggleBlockColumnForm","click .block-column-data":"ReferencetoggleBlockColumnForm","click .destroy":"destroy","click label.block-column-blocks-data":"showBlocksList","keypress :input":"ReferenceupdateBlockColumn","keyup :input":"ReferenceupdateBlockColumn",'change input[name="block-column-bg-color"]':"ReferenceupdateBlockColumn",mouseover:"onMouseOver",mouseout:"onMouseOut"}});return s.prototype.template=new EJS({url:"/reference_column_maker/ejs/block_column.ejs"}),s.prototype.initialize=function(e,t){this.app=e,this.blockColumn=t,this.render(),this.listenTo(this.blockColumn,"change:edit",this.editBlockColumn.bind(this)),this.listenTo(this.blockColumn,"change",this.renderBlockColumn.bind(this)),this.listenTo(this.blockColumn.get("settings"),"change",this.renderBlockColumn.bind(this)),this.listenTo(this.blockColumn.get("blockMarkers"),"add",this.addBlockMarker.bind(this)),this.listenTo(this.blockColumn.get("blocks"),"remove",this.removeBlock.bind(this)),this.listenTo(this.blockColumn.get("blocks"),"add",this.addBlock.bind(this)),this.listenTo(this.blockColumn,"destroy",this.delete.bind(this))},s.prototype.render=function(){this.$el.html(this.template.render(this.blockColumn.toJSON())),this.$toggle=this.$(".toggle"),this.$blockColumnForm=this.$(".block-column-form"),this.$blockColumnData=this.$(".block-column-data"),this.$blockColumnName=this.$('input[name="block-column-name"]')[0],this.$blockColumnWidth=this.$('input[name="block-column-width"]')[0],this.$blockColumnBgColor=this.$('input[name="block-column-bg-color"]')[0],this.$blockColumnDescription=this.$('textarea[name="block-column-description"]')[0],this.$blocksList=this.$(".blocks-list"),this.renderBlockColumn()},s.prototype.renderBlockColumn=function(){this.element===undefined&&(this.element=this.app.Canvas.rect(this.blockColumn.get("x"),0,this.blockColumn.get("width"),this.app.Canvas.height),this.element.dblclick(this.createBlockMarker.bind(this)),this.app.MarkersSet.toFront()),this.element.attr({x:this.blockColumn.get("x"),width:this.blockColumn.get("width"),height:this.blockColumn.get("height"),fill:this.blockColumn.get("settings").get("backgroundColor")}),this.resizeCanvas(),this.updateBlockColumns()},s.prototype.resizeCanvas=function(){var e=Math.max(this.app.Canvas.width,this.blockColumn.get("x")+this.blockColumn.get("width"));this.app.Canvas.setSize(e,this.app.Canvas.height)},s.prototype.resetBlocks=function(){this.$blocksList.html(""),this.blockColumn.get("blocks").each(this.addBlock.bind(this))},s.prototype.ReferencerenderBlocks=function(){this.blockColumn.get("blocks").each(this.addBlockMarker.bind(this))},s.prototype.ReferencetoggleBlockColumnForm=function(){this.renderBlockColumn(),this.blockColumn.set({edit:!this.blockColumn.get("edit")})},s.prototype.editBlockColumn=function(){this.blockColumn.get("edit")?(this.$blockColumnForm.removeClass("hide"),this.$blockColumnData.addClass("hide"),this.$toggle.removeClass("hide-data"),this.$toggle.addClass("show-data")):(this.$blockColumnForm.addClass("hide"),this.$blockColumnData.removeClass("hide"),this.$toggle.removeClass("show-data"),this.$toggle.addClass("hide-data"))},s.prototype.delete=function(){this.element!==undefined&&this.element.remove(),this.$el.remove(),this.remove()},s.prototype.ReferenceupdateBlockColumn=function(e){e.keyCode==13&&this.ReferencetoggleBlockColumnForm();var t=this.$blockColumnName.value,n=this.$blockColumnDescription.value,r=this.$blockColumnWidth.value,i=this.$blockColumnBgColor.value;this.blockColumn.set({name:t,description:n,width:parseInt(r)||0}),this.blockColumn.get("settings").set({backgroundColor:i})},s.prototype.createBlockMarker=function(e){if(!this.app.enBlocks)return;var t=new i({y:e.offsetY,blockColumn:this.blockColumn},this.app);this.blockColumn.get("blockMarkers").add(t)},s.prototype.addBlockMarker=function(e){var t=new n(this.app,e),i=this,s=this.blockColumn.get("blocks"),o=this.blockColumn.get("blockMarkers");o.sort();var u=o.indexOf(e),a,f;if(o.length>1){u==0?(a=o.at(u),f=o.at(u+1)):(a=o.at(u-1),f=o.at(u));var l=s.findWhere({top:a,base:f})||new r({top:a,base:f,blockColumn:i.blockColumn});a.get("blocks").add(l),f.get("blocks").add(l),f.set({name:l.get("name")+" Base"}),s.add(l)}},s.prototype.removeBlock=function(e){var t=e.get("top"),n=e.get("top")},s.prototype.addBlock=function(e){var n=new t(this.app,e);this.$blocksList.append(n.el)},s.prototype.updateBlockColumns=function(){var e=this;if(!this.app.ReferenceBlockColumnsCollection)return;var t=this.app.ReferenceBlockColumnsCollection.indexOf(this.blockColumn);this.app.ReferenceBlockColumnsCollection.each(function(n,r){if(r>t){var i=e.app.ReferenceBlockColumnsCollection.at(r-1),s=i.get("x")+i.get("width");n.set({x:s})}})},s.prototype.showBlocksList=function(){this.$blocksList.hasClass("hide")?this.$blocksList.removeClass("hide"):this.$blocksList.addClass("hide")},s.prototype.delete=function(){_.invoke(this.blockColumn.get("blocks").toArray(),"destroy"),this.element&&this.element.remove(),this.$el.remove(),this.remove()},s.prototype.destroy=function(){this.blockColumn.destroy()},s}),define("referenceBlockColumnsView",["baseView","referenceBlockColumnView","referenceBlockColumn"],function(e,t,n){var r=e.extend({el:"#columns-list",classname:"ReferenceBlockColumns"});return r.prototype.template=new EJS({url:"/commons/ejs/data_tbl.ejs"}),r.prototype.initialize=function(e){this.app=e,this.referenceBlockColumns=this.app.ReferenceBlockColumnsCollection,this.listenTo(this.referenceBlockColumns,"add",this.ReferenceaddBlockColumn.bind(this)),this.listenToActionEvents(),this.render()},r.prototype.listenToActionEvents=function(){$('a[href="#new-column"').bind("click",this.ReferencecreateBlockColumn.bind(this))},r.prototype.render=function(){this.$el.html(this.template.render()),this.$columnsList=this.$(".data-list")},r.prototype.ReferenceaddBlockColumn=function(e){var n=new t(this.app,e);this.$columnsList.append(n.el)},r.prototype.ReferencecreateBlockColumn=function(){var e=0;this.referenceBlockColumns.length>0&&(e=this.referenceBlockColumns.last().get("x")+this.referenceBlockColumns.last().get("width"));var t="Column "+this.referenceBlockColumns.length;this.referenceBlockColumns.add(new n({x:e,name:t}))},r}),define("dataExportView",["baseView"],function(e){var t=e.extend({el:"#export-panel",classname:"DataExportView",events:{"click a.show-data":"showData"}});return t.prototype.template=new EJS({url:"/reference_column_maker/ejs/data_export_panel.ejs"}),t.prototype.blockColumnDataTemplate=new EJS({url:"/reference_column_maker/ejs/block_column_data.ejs"}),t.prototype.initialize=function(e){this.app=e,this.exporter=this.app.exporter,this.blockColumns=this.app.ReferenceBlockColumnsCollection,this.render(),this.$canvas=$("#canvas")},t.prototype.render=function(){this.exporter.export(),this.$el.html(this.template.render({blockColumns:this.blockColumns.toJSON()})),this.$blockColumnsData=this.$(".block-columns-data"),this.$showData=this.$(".show-data"),this.$dataTable=this.$(".data-table"),this.$dataRaw=this.$(".data-raw"),this.$dataJSON=this.$(".data-json"),this.$textData=this.$("textarea[name*=block-columns-data-text]")[0],this.$textJSON=this.$("textarea[name*=block-columns-data-json]")[0],this.$showTable=this.$('a[href="#show-table"]'),this.$showRaw=this.$('a[href="#show-raw"]'),this.$showJSON=this.$('a[href="#show-raw"]'),this.renderDataInText(),this.renderDataInTable()},t.prototype.renderDataInTable=function(){var e=this;this.blockColumns.each(function(t){var n=t.id;e.$("#"+n).html(e.blockColumnDataTemplate.render(t.toJSON()))})},t.prototype.toggleExportView=function(e){$("#loading").removeClass("hide"),$("a[href='#export-data']").parent().hasClass("active")?($("a[href='#export-data']").parent().removeClass("active"),$(".display-panel").addClass("hide"),this.$canvas.removeClass("hide")):($(".maker-tools").parent().removeClass("active"),$("a[href='#export-data']").parent().addClass("active"),$(".display-panel").addClass("hide"),this.$el.removeClass("hide"));try{this.render(),$("#loading").addClass("hide")}catch(t){$("#loading").addClass("hide")}},t.prototype.renderDataInText=function(){this.$textData.value=this.exporter.getText()},t.prototype.showData=function(e){this.$blockColumnsData.addClass("hide"),this.$showData.removeClass("alert"),$(e.target).addClass("alert");var t=$(e.target).attr("href");t==="#show-table"?this.$dataTable.removeClass("hide"):t==="#show-raw"?this.$dataRaw.removeClass("hide"):t==="#show-json"&&this.$dataJSON.removeClass("hide")},t}),define("loader",["referenceBlockColumn","referenceBlockMarker","referenceBlock"],function(e,t,n){var r=function(e){this.app=e,this.referenceBlockColumns=this.app.ReferenceBlockColumnsCollection};return r.prototype.loadFromLocalStorage=function(){this.loadJSONData(localStorage.referenceColumnApp)},r.prototype.loadData=function(e){this.savedData=JSON.parse(e),this.reset(),this.load()},r.prototype.loadJSONData=function(e){this.loadData(JSON.parse(e))},r.prototype.loadTextData=function(e){this.reset(),this.textData=e,this.parseTextData(e),this.updateYCdtsWrtAge()},r.prototype.parseTextData=function(t){var n=this,r=t.split(/\r\n|\r|\n/g),i=null;for(var s in r){var o=r[s].split("	");if(o.length>2&&o[1].toLowerCase()==="block"){var u=i?i.get("x")+i.get("width"):0;i=new e({name:o[0],x:u}),n.referenceBlockColumns.add(i)}else if(i&&o.length>1){var a=parseFloat(o[2]);o[1].toLowerCase()==="top"&&(a||(a=0,o[2]=0)),a>=0&&n.parseBlockTextData(i,o)}}},r.prototype.parseBlockTextData=function(e,n){var r=e.get("blocks").last(),i=r?r.get("base").get("y"):0,s=i+100,o=e.get("blockMarkers").findWhere({y:i});if(o===undefined)o=new t({name:"top",y:i,blockColumn:e,age:n[2]}),e.get("blockMarkers").add(o);else{var u=e.get("blockMarkers").findWhere({y:s});u===undefined&&(u=new t({y:s,blockColumn:e,age:n[2]}),e.get("blockMarkers").add(u)),u.set({name:n[1]+" base"});var a=e.get("blocks").findWhere({top:o,base:u});a.set({name:n[1]||" ",description:n[4]||null}),a.get("settings").set({backgroundColor:TscToCssColor(n[5])})}},r.prototype.updateYCdtsWrtAge=function(){var e=this,t=this.getMinAge();e.referenceBlockColumns.each(function(n){e.updateColumnYCdtsWrtAge(n,t)})},r.prototype.updateColumnYCdtsWrtAge=function(e,t){var n=this;e.get("blockMarkers").each(function(e){n.updateBlockMarkerYCdtsWrtAge(e,t)})},r.prototype.updateBlockMarkerYCdtsWrtAge=function(e,t){var n=Math.round((e.get("age")-t)*5);e.set({y:n})},r.prototype.getMinAge=function(){var e=this,t=0;return e.referenceBlockColumns.each(function(e){var n=e.get("blockMarkers").first().get("age");t=Math.min(n,t)}),t},r.prototype.reset=function(){_.invoke(this.referenceBlockColumns.toArray(),"destroy")},r.prototype.load=function(){this.loadBlockColumns()},r.prototype.loadBlockColumns=function(){var e=this;this.savedData.referenceBlockColumns.forEach(function(t){e.loadBlockColumn(t)})},r.prototype.loadBlockColumn=function(t){var n=this,r=new e(t);n.referenceBlockColumns.add(r),n.addBlockMarkers(t,r),n.updateBlockNames(t,r)},r.prototype.addBlockMarkers=function(e,t){var n=this;e.blockMarkers.forEach(function(e){n.addBlockMarkerToColumn(e,t)})},r.prototype.addBlockMarkerToColumn=function(e,n){var r=this,i=n.get("blockMarkers").findWhere({y:e.y})||new t({y:e.y,blockColumn:n,age:e.age},this.app);n.get("blockMarkers").add(i),i.set({name:e.name})},r.prototype.updateBlockNames=function(e,t){var n=this;e.blocks.forEach(function(e){var n=t.get("blockMarkers").findWhere({y:e.top.y}),r=t.get("blockMarkers").findWhere({y:e.base.y});if(n!==null&&r!==null){var i=t.get("blocks").findWhere({top:n,base:r});i&&(i.set({name:e.name,description:e.description}),i.get("settings").set({backgroundColor:e.settings.backgroundColor}))}})},r}),define("exporter",[],function(){var e=function(e){this.app=e};return e.prototype.initialize=function(){this.blockColumns=this.app.ReferenceBlockColumnsCollection},e.prototype.export=function(){this.initialize()},e.prototype.getText=function(){var e=this,t="\n\n";return this.blockColumns.each(function(n){t+=e.getBlockColumnData(n)}),t},e.prototype.getMetaColumnData=function(){var e="Blocks:";return this.blockColumns.each(function(t){e+="	"+t.get("name")}),e},e.prototype.getBlockColumnData=function(e){var t=this,n="\n\n"+e.get("name");return n+="	block",n+="	"+e.get("width"),n+="	USGS-Named",n+="	"+(e.get("description")||""),e.get("blocks").each(function(e,r){n+=t.getBlockData(e)}),n},e.prototype.getBlockData=function(e){var t="\n",n=e.get("top");return n.get("blocks").length<2&&(t+="	"+n.get("name"),t+="	"+(n.get("age")||"n/a"),t+="\n"),t+="	"+e.get("name"),t+="	"+(e.get("base").get("age")||"n/a"),t+="	"+e.get("base").get("style"),t+="	"+(e.get("description")||""),t+="	"+CssToTscColor(e.get("settings").get("backgroundColor")),t},e.prototype.getJSON=function(){var e={};return e.referenceBlockColumns=this.blockColumns.toJSON(),JSON.stringify(e)},e}),define("referenceBlockAppView",["baseView","cursorView","fileSystemView","referenceBlockColumns","referenceBlockColumnsView","dataExportView","loader","exporter"],function(e,t,n,r,i,s,o,u){var a=e.extend({el:".container",classname:"ReferenceBlockAppView",events:{"click a.block-settings":"showSettings","click a.maker-tools":"enableTool","click a.continue":"showCanvas","dragover #data-box":"dataDragover","drop #data-box":"dataDrop"}});return a.prototype.initialize=function(){this.referenceColumnApp={type:"reference-block"},this.referenceColumnApp.ReferenceBlockColumnsCollection=new r,this.referenceColumnApp.StatusBox=$(".status-box"),this.$introScreen=this.$("#intro-screen"),this.referenceColumnApp.$canvas=this.$("#canvas"),this.$canvas=this.referenceColumnApp.$canvas,this.$displayPanels=this.$(".display-panel"),this.referenceColumnApp.loader=new o(this.referenceColumnApp),this.referenceColumnApp.exporter=new u(this.referenceColumnApp),this.referenceColumnApp.Canvas=new Raphael(this.$canvas[0],2e3,2e3),this.referenceColumnApp.MarkersSet=this.referenceColumnApp.Canvas.set(),this.referenceColumnApp.BlockMarkersSet=this.referenceColumnApp.Canvas.set(),this.referenceColumnApp.BlocksSet=this.referenceColumnApp.Canvas.set(),this.render(),this.listenToActionEvents()},a.prototype.listenToActionEvents=function(){var e=this;$(".close-reveal-modal").click(function(e){$(e.target).parent().foundation("reveal","close")}),$("a[href=#continue-load-from-local-storage]").click(function(t){$(t.target).parent().foundation("reveal","close"),e.loadFromLocalStorage()}),$("a[href=#continue-save-to-local-storage]").click(function(t){$(t.target).parent().foundation("reveal","close"),e.saveToLocalStorage()})},a.prototype.showCanvas=function(){this.$canvas.removeClass("hide"),this.$introScreen.addClass("hide")},a.prototype.render=function(){this.dataExportView=new s(this.referenceColumnApp),this.cursorView=new t(this.referenceColumnApp),this.fileSystemView=new n(this.referenceColumnApp),this.blockColumnsView=new i(this.referenceColumnApp)},a.prototype.showSettings=function(e){var t=e.target.getAttribute("href")+"-list";$(t).hasClass("active")?($(t).removeClass("active"),$(e.target).removeClass("active"),$(e.target).parent().removeClass("active"),this.$("#sections-panel").removeClass("active")):(this.$(".settings-content").removeClass("active"),this.$(".settings-links").removeClass("active"),this.$(".block-settings").removeClass("active"),$(t).addClass("active"),$(e.target).addClass("active"),$(e.target).parent().addClass("active"),this.$("#sections-panel").addClass("active"))},a.prototype.showExportDataPanel=function(e){this.$exportPanel.hasClass("active")||this.dataExportView.render()},a.prototype.exportCanvasAsImage=function(){},a.prototype.saveToLocalStorage=function(){this.referenceColumnApp.exporter.export(),localStorage.referenceColumnApp=this.referenceColumnApp.exporter.getJSON()},a.prototype.loadFromLocalStorage=function(){this.showCanvas(),this.referenceColumnApp.loader.loadFromLocalStorage()},a.prototype.dataDragover=function(e){var e=e.originalEvent;e.stopPropagation(),e.preventDefault()},a.prototype.dataDrop=function(e){var t=this,e=e.originalEvent;e.stopPropagation(),e.preventDefault();var n=e.dataTransfer.files[0],r=n.name.split(".").pop();if(n.type==="application/json"){var i=new FileReader;i.onloadend=function(e){t.showCanvas(),r==="json"?t.referenceColumnApp.loader.loadData(this.result):r==="txt"&&t.referenceColumnApp.loader.loadTextData(this.result)},i.readAsText(n)}},a.prototype.toggleBlocks=function(e){$("a[href='#add-block']").parent().hasClass("active")?($("a[href='#add-block']").parent().removeClass("active"),this.referenceColumnApp.enBlocks=!1):($("a[href='#add-block']").parent().addClass("active"),this.referenceColumnApp.enBlocks=!0)},a.prototype.dataDragover=function(e){var e=e.originalEvent;e.stopPropagation(),e.preventDefault()},a.prototype.dataDrop=function(e){$("#loading").removeClass("hide");var t=this,e=e.originalEvent;e.stopPropagation(),e.preventDefault();var n=e.dataTransfer.files[0],r=n.name.split(".").pop(),i=new FileReader;i.onloadend=function(e){t.showCanvas(),r==="json"&&t.referenceColumnApp.loader.loadJSONData(this.result),r==="txt"&&t.referenceColumnApp.loader.loadTextData(this.result),$("#loading").addClass("hide")},i.readAsText(n)},a.prototype.enableTool=function(e){var t=e.target.getAttribute("href");this.referenceColumnApp.enBlocks&&this.toggleBlocks();switch(t){case"#export-data":this.dataExportView.toggleExportView();break;case"#file-system":this.fileSystemView.toggleView();break;case"#save-to-local-storage":$("#quick-save-data").foundation("reveal","open");break;case"#reload-data":$("#load-saved-data").foundation("reveal","open");break;case"#new-column":break;case"#add-block":this.toggleBlocks();break;default:}},a}),requirejs.config({paths:{baseView:"/commons/js/views/base_view",baseModel:"/commons/js/models/base_model",baseCollection:"/commons/js/collections/base_collection",app:"/commons/js/models/app",settings:"/commons/js/models/settings",cursorView:"/commons/js/views/cursor_view",cursor:"/commons/js/models/cursor",loader:"/reference_column_maker/js/utils/loader",exporter:"/reference_column_maker/js/utils/exporter",dataExportView:"/reference_column_maker/js/views/reference_data_export_view",referenceBlock:"/reference_column_maker/js/models/reference_block",referenceBlocks:"/reference_column_maker/js/collections/reference_blocks",referenceBlockMarker:"/reference_column_maker/js/models/reference_block_marker",referenceBlockMarkers:"/reference_column_maker/js/collections/reference_block_markers",referenceBlockColumn:"/reference_column_maker/js/models/reference_block_column",referenceBlockColumns:"/reference_column_maker/js/collections/reference_block_columns",referenceBlockView:"/reference_column_maker/js/views/reference_block_view",referenceBlockMarkerView:"/reference_column_maker/js/views/reference_block_marker_view",referenceBlockColumnView:"/reference_column_maker/js/views/reference_block_column_view",referenceBlockColumnsView:"/reference_column_maker/js/views/reference_block_columns_view",polyK:"/commons/js/lib/polyK",file:"/file_system/js/models/file",files:"/file_system/js/collections/files",fileView:"/file_system/js/views/file_view",filesView:"/file_system/js/views/files_view",fileSystem:"/file_system/js/models/file_system",fileSystemView:"/file_system/js/views/file_system_view",referenceBlockAppView:"/reference_column_maker/js/views/reference_block_app_view"}}),requirejs(["referenceBlockAppView"],function(e){var t=new e}),define("reference_column_maker/js/reference_column_app",function(){});