define("baseView",[],function(){var e=Backbone.View.extend({});return e.prototype.wrapString=function(e,t,n,r){n=n||"\n",t=t||75,r=r||!1;if(!e)return e;var i=".{1,"+t+"}(\\s|$)"+(r?"|.{"+t+"}|.+$":"|\\S+?(\\s|$)");return e.match(RegExp(i,"g")).join(n)},e}),define("baseModel",[],function(){var e=Backbone.Model.extend({localStorage:new Backbone.LocalStorage("timescale-creator")});return e}),define("cursor",["baseModel"],function(e){var t=e.extend({constructor:function(t,n){var r=[{lockH:!1,lockV:!1}];e.apply(this,r)}});return t}),define("cursorView",["baseView","cursor"],function(e,t){var n=e.extend({el:".main",classname:"CursorView",events:{keypress:"togglelock",'click a[href="#lock-cursor-h"]':"toggleHlock",'click a[href="#lock-cursor-v"]':"toggleVlock"}});return n.prototype.initialize=function(e){this.app=e,this.cursor=new t,this.app.Cursor=this.cursor,this.$hLock=this.$('a[href="#lock-cursor-h"]'),this.$vLock=this.$('a[href="#lock-cursor-v"]')},n.prototype.togglelock=function(e){e.keyCode==TimescaleApp.KEY_MINUS&&this.toggleHlock(),e.keyCode==TimescaleApp.KEY_EQUAL&&this.toggleVlock()},n.prototype.toggleHlock=function(){this.$vLock.parent().hasClass("active")&&this.toggleVlock(),this.$hLock.parent().toggleClass("active"),this.cursor.set({lockH:!this.cursor.get("lockH")})},n.prototype.toggleVlock=function(){this.$hLock.parent().hasClass("active")&&this.toggleHlock(),this.$vLock.parent().toggleClass("active"),this.cursor.set({lockV:!this.cursor.get("lockV")})},n}),define("file",["baseModel"],function(e){var t=e.extend({classname:"File",constructor:function(t,n){var r=[{name:t.name,isFile:t.isFile,isDirectory:t.isDirectory,size:t.Size||0,fullPath:t.fullPath,url:t.toURL(),selected:!1,type:null,size:0,modificationTime:null}];e.apply(this,r)}});return t.prototype.initialize=function(e,t){var n=this.get("name").split(".").pop();this.set({type:n})},t.prototype.updateFileData=function(e){var t=new Date(e.modificationTime);this.set({size:e.size,modificationTime:t.getTime()})},t}),define("baseCollection",[],function(){var e=Backbone.Collection.extend({localStorage:new Backbone.LocalStorage("timescale-creator")});return e}),define("files",["baseCollection","file"],function(e,t){var n=e.extend({classname:"Files",model:t});return n.prototype.comparator=function(e){return-e.get("modificationTime")},n}),define("fileView",["baseView"],function(e){var t=e.extend({tagName:"div",classname:"FileView",events:{dblclick:"open",click:"select","blur .file-name":"blur"}});return t.prototype.template=new EJS({url:"/file_system/ejs/file.ejs"}),t.prototype.initialize=function(e,t,n,r){this.app=r,this.fileSystem=n,this.files=t,this.file=e,this.listenTo(this.file,"change:selected",this.setSelected.bind(this)),this.listenTo(this.file,"change:name",this.rename.bind(this)),this.listenToActionEvents(),this.render()},t.prototype.listenToActionEvents=function(){$('a[href="#delete-file"]').click(this.deleteFile.bind(this)),$('a[href="#load-data"]').click(this.loadData.bind(this))},t.prototype.render=function(){var e=this.file.toJSON();this.$el.html(this.template.render(e)),this.$file=this.$(".file"),this.$fileName=this.$(".file-name")[0]},t.prototype.deleteFile=function(){var e=this;if(!e.file.get("selected"))return;e.file.get("isFile")?e.fileSystem.get("fs").root.getFile(e.file.get("fullPath"),{},function(t){t.remove(function(){console.log("File removed."),e.file.destroy()},e.errorHandler.bind(this))},e.errorHandler.bind(this)):e.fileSystem.get("fs").root.getDirectory(e.file.get("fullPath"),{},function(t){t.removeRecursively(function(){console.log("Directory removed."),e.file.destroy()},e.errorHandler.bind(this))},e.errorHandler.bind(this))},t.prototype.select=function(){var e=this;this.files.each(function(t){t==e.file?t.set({selected:!t.get("selected")}):t.set({selected:!1})})},t.prototype.setSelected=function(){this.file.get("selected")?this.$file.addClass("active"):this.$file.removeClass("active")},t.prototype.blur=function(){this.file.set({name:this.$fileName.textContent})},t.prototype.rename=function(){var e=this;e.file.get("isFile")?e.fileSystem.get("fs").root.getFile(e.file.get("fullPath"),{},function(t){var n=e.file.get("fullPath").split("/");n.pop(),n=n.join("/"),n===""&&(n="/"),e.fileSystem.get("fs").root.getDirectory(n,{},function(n){t.moveTo(n,e.file.get("name")),e.fileSystem.set({update:!e.fileSystem.get("update")})},e.errorHandler.bind(this))},e.errorHandler.bind(this)):e.fileSystem.get("fs").root.getDirectory(e.file.get("fullPath"),{},function(t){var n=e.file.get("fullPath").split("/");n.pop(),n=n.join("/"),n===""&&(n="/"),e.fileSystem.get("fs").root.getDirectory(n,{},function(n){t.moveTo(n,e.file.get("name")),e.fileSystem.set({update:!e.fileSystem.get("update")})},e.errorHandler.bind(this))},e.errorHandler.bind(this))},t.prototype.open=function(){var e=this;e.file.get("isFile")||this.fileSystem.set({path:this.file.get("fullPath")})},t.prototype.errorHandler=function(e){console.log("Error: "+e.name+" "+e.message)},t.prototype.loadData=function(){var e=this;if(e.file.get("isDirectory")||!e.file.get("selected"))return;$("#loading").removeClass("hide"),e.fileSystem.get("fs").root.getFile(e.file.get("fullPath"),{},function(t){t.file(function(t){var n=new FileReader;n.onloadend=function(t){e.showCanvas(),e.app.loader.loadData(this.result),$("#loading").addClass("hide")},n.readAsText(t)},e.errorHandler.bind(e))},e.errorHandler.bind(e))},t.prototype.showCanvas=function(){$("#canvas").removeClass("hide"),$("#file-system-panel").addClass("hide"),$("a[href='#file-system']").parent().removeClass("active")},t}),define("filesView",["baseView","fileView","file"],function(e,t,n){var r=e.extend({classname:"FilesView",el:"#files-list",events:{}});return r.prototype.template=new EJS({url:"/file_system/ejs/files.ejs"}),r.prototype.initialize=function(e,t,n){this.app=n,this.fileSystem=t,this.files=e,this.listenTo(this.files,"add",this.render.bind(this)),this.listenTo(this.files,"remove",this.render.bind(this)),this.listenToActionEvents(),this.render()},r.prototype.listenToActionEvents=function(e){$('a[href="#create-file"]').unbind().click(this.createNewFile.bind(this)),$('a[href="#create-dir"]').unbind().click(this.createNewDir.bind(this)),$('a[href="#save-project"]').click(this.saveProject.bind(this))},r.prototype.render=function(){this.$el.html(this.template.render()),this.$list=this.$(".list"),this.files.each(this.addFile.bind(this))},r.prototype.addFile=function(e){var n=new t(e,this.files,this.fileSystem,this.app);this.$list.append(n.el)},r.prototype.createNewFile=function(){var e=this;e.fileSystem.get("fs").root.getDirectory(e.fileSystem.get("path"),{},function(t){e.newFile(t,_.uniqueId("new-file-"))},e.errorHandler.bind(e))},r.prototype.newFile=function(e,t,n){var r=this;e.getFile(t,{create:!0,exclusive:!0},function(e){r.createFile(e,n)},r.errorHandler.bind(r))},r.prototype.createFile=function(e,t){var r=this.fileSystem.get("path");r==="/"?r=[""]:r=this.fileSystem.get("path").split("/"),r.push(e.name),r=r.join("/");if(r===e.fullPath){var i=new n(e);this.files.add(i)}t!==undefined&&t(e)},r.prototype.createNewDir=function(){var e=this;e.fileSystem.get("fs").root.getDirectory(e.fileSystem.get("path"),{},function(t){e.newDir(t,_.uniqueId("new-folder-"))},e.errorHandler.bind(e))},r.prototype.newDir=function(e,t,n){var r=this;e.getDirectory(t,{create:!0},function(e){r.createFile(e,n)},r.errorHandler.bind(r))},r.prototype.saveProject=function(){$("#loading").removeClass("hide");var e=this,t=e.getTimeStamp(),n=this.app.type+"-"+t;e.fileSystem.get("fs").root.getDirectory(e.fileSystem.get("path"),{},function(r){e.newDir(r,n,function(n){var r=e.app.type+"-data-"+t+".json",i=e.app.type+"-data-"+t+".txt",s=e.app.exporter.getJSON(),o=e.app.exporter.getText();e.newFile(n,r,function(t){e.writeJSONToAFile(t,s),e.newFile(n,i,function(t){e.writeTextToAFile(t,o),$("#loading").addClass("hide")})})})},e.errorHandler.bind(e)),this.fileSystem.set({update:!this.fileSystem.get("update")})},r.prototype.writeJSONToAFile=function(e,t){var t=t;if(e.isDirectory)return;var n=this;n.fileSystem.get("fs").root.getFile(e.fullPath,{create:!0},function(e){e.createWriter(function(e){e.onwriteend=function(e){console.log("Write completed.")},e.onerror=function(e){console.log("Write failed: "+e.toString())};var n=new Blob([t],{type:"application/json"});e.write(n)},n.errorHandler.bind(this))},n.errorHandler.bind(this))},r.prototype.writeTextToAFile=function(e,t){var t=t;if(e.isDirectory)return;var n=this;n.fileSystem.get("fs").root.getFile(e.fullPath,{create:!0},function(e){e.createWriter(function(e){e.onwriteend=function(e){console.log("Write completed.")},e.onerror=function(e){console.log("Write failed: "+e.toString())};var n=new Blob([t],{type:"text/plain"});e.write(n)},n.errorHandler.bind(this))},n.errorHandler.bind(this))},r.prototype.getTimeStamp=function(){var e=new Date,t=e.getUTCMonth()+"-"+e.getUTCDate()+"-";return t+=e.getUTCFullYear()+"-"+e.getHours()+"_",t+=e.getMinutes()+"_"+e.getSeconds(),t},r.prototype.errorHandler=function(e){console.log("Error: "+e.name+" "+e.message)},r}),define("fileSystem",["baseModel"],function(e){var t=e.extend({classname:"FileSystem",constructor:function(t,n){var r=[{fs:t.fs,path:"/",update:!1}];e.apply(this,r)}});return t}),define("fileSystemView",["baseView","file","files","filesView","fileSystem"],function(e,t,n,r,i){var s=e.extend({classname:"FileSystemView",el:"#file-system-panel",events:{"click a[href='#parent-dir']":"parentDir","click a.path-breadcrumb":"setDir"}});return s.prototype.template=new EJS({url:"/file_system/ejs/file_system_panel.ejs"}),s.prototype.initialize=function(e){this.app=e,this.$canvas=$("#canvas");var t=1073741824;this.requestFileSystem(t)},s.prototype.requestFileSystem=function(e){window.requestFileSystem=window.requestFileSystem||window.webkitRequestFileSystem,window.requestFileSystem&&window.requestFileSystem(window.PERSISTENT,e,this.render.bind(this),this.errorHandler.bind(this))},s.prototype.render=function(e){this.fileSystem=new i({fs:e}),this.renderDirs(),this.listenTo(this.fileSystem,"change:path",this.renderDirs.bind(this)),this.listenTo(this.fileSystem,"change:update",this.renderDirs.bind(this))},s.prototype.renderDirs=function(){this.$el.html(this.template.render(this.fileSystem.toJSON()));var e=this,t=this.fileSystem.get("path");this.files=new n,this.filesView=new r(this.files,this.fileSystem,this.app),this.fileSystem.get("fs").root.getDirectory(t,{},function(t){if(t.isDirectory){var n=t.createReader();n.readEntries(e.readDir.bind(e))}},e.errorHandler),this.readDir()},s.prototype.readDir=function(e){var n=this;if(e===undefined||!e.length)return;if(n.fileSystem.get("update")){n.fileSystem.set({update:!1});return}_.invoke(n.files.toArray(),"destroy"),e.forEach(function(e){var r=new t(e);e.getMetadata(function(e){r.updateFileData(e),n.files.add(r)})})},s.prototype.parentDir=function(){var e=this.fileSystem.get("path");if(e==="/")return;e=e.split("/"),e.pop(),e=e.join("/"),this.fileSystem.set({path:e})},s.prototype.setDir=function(e){var t=$(e.target).attr("path");t===""&&(t="/"),this.fileSystem.set({path:t})},s.prototype.toggleView=function(e){$("a[href='#file-system']").parent().hasClass("active")?($("a[href='#file-system']").parent().removeClass("active"),$(".display-panel").addClass("hide"),this.$canvas.removeClass("hide")):($(".maker-tools").parent().removeClass("active"),$("a[href='#file-system']").parent().addClass("active"),$(".display-panel").addClass("hide"),this.$el.removeClass("hide"),this.app.exporter.export())},s.prototype.errorHandler=function(e){console.log("Error: "+e.name+" "+e.message)},s}),define("marker",["baseModel"],function(e){var t=e.extend({classname:"Marker",constructor:function(t,n){var r=[{edit:!1,name:t.name||_.uniqueId("Time Line "),y:t.y,age:t.age!==undefined?t.age:null,hover:!1}];e.apply(this,r)}});return t}),define("markers",["baseCollection","marker"],function(e,t){var n=e.extend({classname:"Markers",model:t});return n.prototype.comparator=function(e){return e.get("y")},n}),define("markerView",["baseView"],function(e){var t=e.extend({tagName:"li",classname:"MarkerView",events:{"click .toggle":"toggleMarkerForm","click .marker-data":"toggleMarkerForm","click .destroy":"destroy","keypress :input":"updateMarker","keyup :input":"updateMarker",mouseover:"onMouseOver",mouseout:"onMouseOut"}});return t.prototype.template=new EJS({url:"/commons/ejs/marker.ejs"}),t.prototype.initialize=function(e,t,n){this.app=e,this.markersView=n,this.marker=t,this.render(),this.listenTo(this.marker,"change:edit",this.editMarker.bind(this)),this.listenTo(this.marker,"change:hover",this.setHoverStatus.bind(this)),this.listenTo(this.marker,"change",this.renderMarker.bind(this)),this.listenTo(this.marker,"destroy",this.delete.bind(this))},t.prototype.render=function(){this.$el.html(this.template.render(this.marker.toJSON())),this.$toggle=this.$(".toggle"),this.$markerForm=this.$(".marker-form"),this.$markerData=this.$(".marker-data"),this.$markerName=this.$('input[name="marker-name"]')[0],this.$markerAge=this.$('input[name="marker-age"]')[0],this.editMarker(),this.renderMarker()},t.prototype.renderMarker=function(){this.element===undefined&&(this.element=this.app.Canvas.path(),this.element.attr({"stroke-width":2,stroke:"#900000"}),this.element.hover(this.onMouseOver.bind(this),this.onMouseOut.bind(this)),this.element.drag(this.dragMove.bind(this),this.dragStart.bind(this),this.dragEnd.bind(this)),this.element.toFront(),this.app.MarkersSet.push(this.element)),this.renderTooltip(),this.element.attr({path:this.getPath()}),this.resizeCanvas()},t.prototype.renderTooltip=function(){var e=this.marker.get("age")===null?"-":this.marker.get("age");$(this.element.node).qtip({content:{text:this.marker.get("name")+"【"+e+" myr】"},position:{my:"bottom left",target:"mouse"}})},t.prototype.getPath=function(){return"M0,"+this.marker.get("y")+"H"+this.app.Canvas.width},t.prototype.dragStart=function(e,t,n){var r=this.app.MarkersCollection,i=r.indexOf(this.marker);this.prevMarker=r.at(i-1),this.nextMarker=r.at(i+1)},t.prototype.dragMove=function(e,t,n,r,i){if(this.prevMarker&&this.nextMarker&&(this.prevMarker.get("y")+2>i.offsetY||i.offsetY>this.nextMarker.get("y")-2))return;if(!this.prevMarker&&this.nextMarker&&i.offsetY>this.nextMarker.get("y")-2)return;if(this.prevMarker&&!this.nextMarker&&this.prevMarker.get("y")+2>i.offsetY)return;this.marker.set({y:i.offsetY})},t.prototype.dragEnd=function(e){this.app.PointsCollection&&this.app.PointsCollection.updatePoints(),this.app.TransectTextsCollection&&this.app.TransectTextsCollection.updateTransectTexts()},t.prototype.onMouseOver=function(){this.markersView.undelegateEvents(),this.$el.addClass("hover"),this.marker.set({hover:!0})},t.prototype.onMouseOut=function(){this.markersView.delegateEvents(),this.$el.removeClass("hover"),this.marker.set({hover:!1})},t.prototype.setHoverStatus=function(){this.marker.get("hover")?(this.element.attr({"stroke-width":5}),this.$el.addClass("hover")):(this.element.attr({"stroke-width":2}),this.$el.removeClass("hover"))},t.prototype.toggleMarkerForm=function(){this.render(),this.marker.set({edit:!this.marker.get("edit")})},t.prototype.editMarker=function(){this.marker.get("edit")?(this.$markerForm.removeClass("hide"),this.$markerData.addClass("hide"),this.$toggle.removeClass("hide-data"),this.$toggle.addClass("show-data")):(this.$markerForm.addClass("hide"),this.$markerData.removeClass("hide"),this.$toggle.removeClass("show-data"),this.$toggle.addClass("hide-data"))},t.prototype.updateMarker=function(e){e.keyCode==13&&this.toggleMarkerForm();var t=this.$markerName.value,n=parseFloat(this.$markerAge.value)||0;this.marker.set({name:t,age:n})},t.prototype.delete=function(){this.element!==undefined&&this.element.remove(),this.$el.remove(),this.remove()},t.prototype.destroy=function(){var e=this.app.ZonesCollection.findWhere({topMarker:this.marker}),t=this.app.ZonesCollection.findWhere({baseMarker:this.marker});this.marker.destroy(),e&&e.destroy(),t&&t.destroy()},t.prototype.resizeCanvas=function(){var e=Math.max(this.app.Canvas.height,this.marker.get("y")+100);this.app.Canvas.setSize(this.app.Canvas.width,e)},t}),define("zone",["baseModel"],function(e){var t=e.extend({classname:"Zone",constructor:function(t,n,r,i){this.app=i;var s=[{edit:!1,name:t.name||_.uniqueId("Zone "),description:t.description||null,topMarker:n,baseMarker:r,toggle:!1}];e.apply(this,s)}});return t.prototype.isYInsideZone=function(e){return this.get("topMarker").get("y")<=e&&e<this.get("baseMarker").get("y")?!0:!1},t.prototype.getRelativeY=function(e){if(this.get("topMarker").get("y")<=e&&e<this.get("baseMarker").get("y")){var t=(e-this.get("topMarker").get("y"))/(this.get("baseMarker").get("y")-this.get("topMarker").get("y"));return Math.round(t*1e3)/1e3}return null},t.prototype.getAbsoluteY=function(e){var t=this.get("topMarker").get("y")+(this.get("baseMarker").get("y")-this.get("topMarker").get("y"))*e;return t},t.prototype.getAbsoluteAge=function(e){if(this.get("topMarker").get("y")<=e&&e<this.get("baseMarker").get("y")&&this.get("topMarker").get("age")!=null&&this.get("baseMarker").get("age")!=null){var t=(e-this.get("topMarker").get("y"))/(this.get("baseMarker").get("y")-this.get("topMarker").get("y"));return age=t*(this.get("baseMarker").get("age")-this.get("topMarker").get("age"))+this.get("topMarker").get("age"),Math.round(age*100)/100}return null},t.prototype.getPolyKPointsArray=function(){return[0,this.get("topMarker").get("y"),0,this.get("baseMarker").get("y"),this.app.Canvas.width,this.get("baseMarker").get("y"),this.app.Canvas.width,this.get("topMarker").get("y")]},t}),define("markersView",["baseView","markerView","marker","zone"],function(e,t,n,r){var i=e.extend({el:"#markers-list",classname:"MarkersView"});return i.prototype.template=new EJS({url:"/commons/ejs/data_tbl.ejs"}),i.prototype.initialize=function(e){this.app=e,this.zones=this.app.ZonesCollection,this.markers=this.app.MarkersCollection,this.enMarkers=!1,this.listenTo(this.markers,"add",this.render.bind(this)),this.listenTo(this.markers,"remove",this.render.bind(this)),this.listenToActionEvents(),this.render()},i.prototype.listenToActionEvents=function(){$("#canvas").bind("dblclick",this.createMarker.bind(this))},i.prototype.render=function(){this.$el.html(this.template.render({name:"Markers"})),this.$markersTable=this.$(".data-list"),this.renderMarkers()},i.prototype.renderMarkers=function(){this.markers.each(this.addMarker.bind(this))},i.prototype.addMarker=function(e){var n=new t(this.app,e,this);this.$markersTable.append(n.el),this.updateZones()},i.prototype.toggleMarkers=function(e){$("a[href='#add-marker']").parent().hasClass("active")?($("a[href='#add-marker']").parent().removeClass("active"),this.enMarkers=!1):($("a[href='#add-marker']").parent().addClass("active"),this.enMarkers=!0)},i.prototype.createMarker=function(e){this.enMarkers&&this.markers.add(new n({y:e.offsetY}))},i.prototype.updateZones=function(){var e=this,t=[];this.markers.sort(),this.markers.each(function(n,i,s){if(i>0){var o=e.zones.findWhere({topMarker:s[i-1],baseMarker:n})||new r({name:"New Zone "+i},s[i-1],n,e.app);e.zones.add(o),i<e.markers.length-1&&(o=e.zones.findWhere({topMarker:s[i-1],baseMarker:s[i+1]}),o&&t.push(o))}}),_.invoke(t,"destroy")},i}),define("zones",["baseCollection","zone"],function(e,t){var n=e.extend({classname:"Zones",model:t});return n.prototype.comparator=function(e){return e.get("topMarker").get("y")},n.prototype.getZoneForY=function(e){var t=null;return this.each(function(n){n.isYInsideZone(e)&&(t=n)}),t},n.prototype.getZoneInNeighborhoodForY=function(e,t){var n=this.indexOf(t),r=this.at(n-1),i=this.at(n+1);return t.isYInsideZone(e)?t:r&&r.isYInsideZone(e)?r:i&&i.isYInsideZone(e)?i:null},n}),define("zoneView",["baseView"],function(e){var t=e.extend({tagName:"li",classname:"ZoneView",events:{"click .toggle":"toggleZoneForm","click .zone-data":"toggleZoneForm","keypress :input":"updateZone","keyup :input":"updateZone",mouseover:"onMouseOver",mouseout:"onMouseOut"}});return t.prototype.template=new EJS({url:"/commons/ejs/zone.ejs"}),t.prototype.initialize=function(e){this.zone=e,this.listenTo(this.zone,"change:edit",this.toggleEditStatus.bind(this)),this.listenTo(this.zone,"change:name",this.render.bind(this)),this.listenTo(this.zone,"change:description",this.render.bind(this)),this.listenTo(this.zone.get("topMarker"),"change",this.toggleZone.bind(this)),this.listenTo(this.zone.get("baseMarker"),"change",this.toggleZone.bind(this)),this.listenTo(this.zone,"destroy",this.delete.bind(this)),this.render()},t.prototype.render=function(){this.$el.html(this.template.render(this.zone.toJSON())),this.$toggle=this.$(".toggle"),this.$zoneForm=this.$(".zone-form"),this.$zoneData=this.$(".zone-data"),this.$zoneName=this.$('input[name="zone-name"]')[0],this.$zoneDescription=this.$('textarea[name="zone-description"]')[0]},t.prototype.toggleZoneForm=function(){this.render(),this.zone.set({edit:!this.zone.get("edit")})},t.prototype.toggleEditStatus=function(){this.zone.get("edit")?(this.$zoneForm.removeClass("hide"),this.$zoneData.addClass("hide"),this.$toggle.removeClass("hide-data"),this.$toggle.addClass("show-data")):(this.$zoneForm.addClass("hide"),this.$zoneData.removeClass("hide"),this.$toggle.removeClass("show-data"),this.$toggle.addClass("hide-data"))},t.prototype.onMouseOver=function(){this.$el.addClass("hover"),this.zone.get("topMarker").set({hover:!0}),this.zone.get("baseMarker").set({hover:!0})},t.prototype.onMouseOut=function(){this.$el.removeClass("hover"),this.zone.get("topMarker").set({hover:!1}),this.zone.get("baseMarker").set({hover:!1})},t.prototype.updateZone=function(e){if(e.keyCode==TimescaleApp.ENTER||e.keyCode==TimescaleApp.ESC){var t=this.$zoneName.value,n=this.$zoneDescription.value;this.zone.set({name:t,description:n}),this.toggleZoneForm()}},t.prototype.delete=function(){this.element!==undefined&&this.element.remove(),this.$el.remove(),this.remove()},t.prototype.destroy=function(){this.zone.destroy()},t.prototype.toggleZone=function(){this.zone.set({toggle:!this.zone.get("toggle")})},t}),define("zonesView",["baseView","zoneView","zone"],function(e,t,n){var r=e.extend({el:"#zones-list",classname:"ZonesView"});return r.prototype.template=new EJS({url:"../../../commons/ejs/data_tbl.ejs"}),r.prototype.initialize=function(e){this.app=e,this.zones=this.app.ZonesCollection,this.render(),this.listenTo(this.zones,"add",this.render.bind(this))},r.prototype.render=function(){this.$el.html(this.template.render({name:"Zones"})),this.$zonesTable=this.$(".data-list"),this.zones.each(this.addZone.bind(this))},r.prototype.addZone=function(e){var n=new t(e);this.$zonesTable.append(n.el)},r}),define("settings",["baseModel"],function(e){var t=e.extend({classname:"Settings",constructor:function(t,n){var r=[{fontFamily:t?t.fontFamily:"Arial, Helvetica, sans-serif",fontVariant:t?t.fontVariant:"normal",fontWeight:t?t.fontWeight:"normal",fontStretch:t?t.fontStretch:"normal",fontSize:t?t.fontSize:12,backgroundColor:t&&t.backgroundColor?t.backgroundColor:"#DDDDDD",strokeWidth:t?t.strokeWidth:3,strokeColor:t?t.strokeColor:"#000000"}];e.apply(this,r)}});return t}),define("block",["baseModel","settings"],function(e,t){var n=e.extend({classname:"Block",constructor:function(n,r){var i=[{edit:!1,hover:!1,name:n.name||_.uniqueId("Block "),description:n.description,settings:new t,top:n.top||null,base:n.base||null,blockColumn:n.blockColumn||null}];e.apply(this,i)}});return n.prototype.initialize=function(){this.get("settings").set({backgroundColor:"#FF0000"})},n.prototype.toJSON=function(){var e=_.clone(this.attributes);return delete e.blockColumn,e},n}),define("blocks",["baseCollection","block"],function(e,t){var n=e.extend({classname:"Blocks",model:t});return n}),define("blockMarker",["baseModel","blocks"],function(e,t){var n=e.extend({classname:"BlockMarker",constructor:function(n,r){var i=[{name:"TOP",edit:!1,hover:!1,y:parseInt(n.y),id:_.uniqueId("block-marker-"),age:null,relativeY:null,blockColumn:n.blockColumn||null,style:"solid",app:r||null,zone:null,blocks:new t}];e.apply(this,i)}});return n.prototype.initialize=function(){this.updateZone()},n.prototype.toJSON=function(){var e=_.clone(this.attributes);return delete e.blocks,delete e.blockColumn,delete e.app,e},n.prototype.updateZone=function(){var e=this.get("zone")===null?this.get("app").ZonesCollection.getZoneForY(this.get("y")):this.get("app").ZonesCollection.getZoneInNeighborhoodForY(this.get("y"),this.get("zone"));e!==null&&(this.set({zone:e}),this.updateRelativeCoordinates())},n.prototype.updateRelativeCoordinates=function(){this.set({relativeY:this.get("zone").getRelativeY(this.get("y")),age:this.get("zone").getAbsoluteAge(this.get("y"))})},n}),define("blockMarkers",["baseCollection","blockMarker"],function(e,t){var n=e.extend({classname:"BlockMarkers",model:t});return n.prototype.comparator=function(e){return e.get("y")},n}),define("blockColumn",["baseModel","blocks","blockMarkers","settings"],function(e,t,n,r){var i=e.extend({classname:"BlockColumn",constructor:function(i){var s=[{x:i.x||0,id:_.uniqueId("column-"),name:i.name||_.uniqueId("Column "),width:parseInt(i.width)||200,description:i.description||null,blockMarkers:new n,blocks:new t,settings:new r}];e.apply(this,s)}});return i.prototype.comparator=function(e){return e.get("x")},i.prototype.toJSON=function(){var e=_.clone(this.attributes);return e},i}),define("blockColumns",["baseCollection","blockColumn"],function(e,t){var n=e.extend({classname:"BlockColumns",model:t});return n}),define("blockView",["baseView"],function(e){var t=e.extend({tagName:"li",classname:"BlockView",events:{"click .toggle":"toggleBlockForm","click .block-data":"toggleBlockForm","click .destroy":"destroy","keypress :input":"updateBlock","keyup :input":"updateBlock",'change input[name="block-color"]':"updateBlock","change select.block-line-style":"updateBlock",mouseover:"onMouseOver",mouseout:"onMouseOut"}});return t.prototype.template=new EJS({url:"/block_column_maker/ejs/block.ejs"}),t.prototype.initialize=function(e,t){this.app=e,this.block=t,this.top=this.block.get("top"),this.base=this.block.get("base"),this.blockSet===undefined&&(this.blockSet=this.app.Canvas.set(),this.app.BlocksSet.push(this.blockSet)),this.render(),this.listenTo(this.block,"change:edit",this.editBlock.bind(this)),this.listenTo(this.block,"change:hover",this.setHoverStatus.bind(this)),this.listenTo(this.block,"change:name",this.renderBlock.bind(this)),this.listenTo(this.block,"change:description",this.renderBlock.bind(this)),this.listenTo(this.block.get("blockColumn"),"change:x",this.renderBlock.bind(this)),this.listenTo(this.block.get("blockColumn"),"change:width",this.renderBlock.bind(this)),this.listenTo(this.top,"change:y",this.renderBlock.bind(this)),this.listenTo(this.top,"change:age",this.renderTooltip.bind(this)),this.listenTo(this.top,"change:relativeY",this.renderTooltip.bind(this)),this.listenTo(this.base,"change:y",this.renderBlock.bind(this)),this.listenTo(this.base,"change:age",this.renderTooltip.bind(this)),this.listenTo(this.base,"change:relativeY",this.renderTooltip.bind(this)),this.listenTo(this.block.get("settings"),"change",this.renderBlock.bind(this)),this.listenTo(this.block,"destroy",this.delete.bind(this))},t.prototype.render=function(){this.$el.html(this.template.render(this.block.toJSON())),this.$toggle=this.$(".toggle"),this.$blockForm=this.$(".block-form"),this.$blockData=this.$(".block-data"),this.$blockName=this.$('input[name="block-name"]')[0],this.$blockAge=this.$('input[name="block-age"]')[0],this.$blockColor=this.$('input[name="block-color"]')[0],this.$blockDescription=this.$('textarea[name="block-description"]')[0],this.editBlock(),this.renderBlock()},t.prototype.renderBlock=function(){this.bgBox===undefined&&(this.bgBox=this.app.Canvas.rect(),this.blockText=this.app.Canvas.text(),this.bBox=this.app.Canvas.rect(),this.blockSet.push(this.bgBox),this.blockSet.push(this.blockText),this.blockSet.push(this.bBox),this.app.MarkersSet.toFront(),this.app.BlockMarkersSet.toFront(),this.bBox.hover(this.onMouseOver.bind(this),this.onMouseOut.bind(this))),this.bgBox.attr({"stroke-width":0,fill:this.block.get("settings").get("backgroundColor"),x:this.block.get("blockColumn").get("x"),y:this.top.get("y"),width:this.block.get("blockColumn").get("width"),height:this.base.get("y")-this.top.get("y")});var e=Math.round(this.block.get("blockColumn").get("x")+this.block.get("blockColumn").get("width")/2),t=Math.round((this.top.get("y")+this.base.get("y"))/2),n=Math.min(Math.round(this.base.get("y")-this.top.get("y")),16);this.blockText.attr({x:e,y:t,text:this.block.get("name"),"font-size":n}),this.bBox.attr({"stroke-width":2,opacity:0,fill:"#FFF",x:this.block.get("blockColumn").get("x"),y:this.top.get("y"),width:this.block.get("blockColumn").get("width"),height:this.base.get("y")-this.top.get("y")}),this.renderTooltip()},t.prototype.renderTooltip=function(){$(this.bBox.node).qtip({content:{text:this.block.get("name")+"<br>"+(this.block.get("description")||"No description yet!")},position:{my:"bottom left",target:"mouse"}})},t.prototype.onMouseOver=function(){this.$el.addClass("hover"),this.block.set({hover:!0})},t.prototype.onMouseOut=function(){this.$el.removeClass("hover"),this.block.set({hover:!1})},t.prototype.setHoverStatus=function(){this.block.get("hover")?(this.$el.addClass("hover"),this.glow=this.bBox.glow()):(this.glow&&this.glow.remove(),this.$el.removeClass("hover"))},t.prototype.toggleBlockForm=function(){this.render(),this.block.set({edit:!this.block.get("edit")})},t.prototype.editBlock=function(){this.block.get("edit")?(this.$blockForm.removeClass("hide"),this.$blockData.addClass("hide"),this.$toggle.removeClass("hide-data"),this.$toggle.addClass("show-data")):(this.$blockForm.addClass("hide"),this.$blockData.removeClass("hide"),this.$toggle.removeClass("show-data"),this.$toggle.addClass("hide-data"))},t.prototype.delete=function(){this.blockText&&this.blockText.remove(),this.bgBox&&this.bgBox.remove(),this.bBox&&this.bBox.remove(),this.glow&&this.glow.remove(),this.$el.remove(),this.remove()},t.prototype.destroy=function(){this.block.get("base").set({name:"TOP"}),this.block.destroy()},t.prototype.updateBlock=function(e){e.keyCode===13&&this.toggleBlockForm();var t=this.$blockName.value,n=this.$blockDescription.value,r=this.$blockColor.value,i=this.$("select.block-line-style option:selected").val();this.block.set({name:t,description:n}),this.block.get("base").set({name:t+" Base"}),this.block.get("settings").set({backgroundColor:r}),this.base.set({style:i})},t}),define("blockMarkerView",["baseView"],function(e){var t=e.extend({classname:"BlockMarkerView"});return t.prototype.statusBoxTemplate=new EJS({url:"/block_column_maker/ejs/status_box.ejs"}),t.prototype.initialize=function(e,t){this.app=e,this.blockMarker=t,this.render(),this.listenTo(this.blockMarker.get("blockColumn"),"change:x",this.renderBlockMarker.bind(this)),this.listenTo(this.blockMarker.get("blockColumn"),"change:width",this.renderBlockMarker.bind(this)),this.listenTo(this.blockMarker,"change:hover",this.setHoverStatus.bind(this)),this.listenTo(this.blockMarker,"change",this.renderBlockMarker.bind(this)),this.listenTo(this.blockMarker,"destroy",this.delete.bind(this)),this.listenTo(this.blockMarker.get("blocks"),"remove",this.checkAndDelete.bind(this)),this.listenTo(this.app.ZonesCollection,"remove",this.updateBlockMarker.bind(this)),this.listenTo(this.app.ZonesCollection,"change",this.updateBlockMarker.bind(this))},t.prototype.render=function(){this.renderBlockMarker()},t.prototype.renderBlockMarker=function(){this.element===undefined&&(this.element=this.app.Canvas.path(),this.element.attr({"stroke-width":2,stroke:"#0000FF"}),this.element.hover(this.onMouseOver.bind(this),this.onMouseOut.bind(this)),this.element.drag(this.dragMove.bind(this),this.dragStart.bind(this),this.dragEnd.bind(this)),this.app.BlockMarkersSet.push(this.element),this.app.MarkersSet.toFront());var e=this.blockMarker.get("style"),t=[];e==="dashed"?t=["-"]:e==="dotted"&&(t=["."]),this.element.attr({path:this.getPath(),"stroke-dasharray":t}),this.blockMarker.updateZone(),this.updateStatusBox()},t.prototype.updateStatusBox=function(){this.app.StatusBox.html(this.statusBoxTemplate.render(this.blockMarker.toJSON()))},t.prototype.getPath=function(){var e=this.blockMarker.get("blockColumn").get("x")+this.blockMarker.get("blockColumn").get("width");return"M"+this.blockMarker.get("blockColumn").get("x")+","+this.blockMarker.get("y")+"H"+e},t.prototype.dragStart=function(e,t,n){var r=this.blockMarker.get("blockColumn").get("blockMarkers"),i=r.indexOf(this.blockMarker);this.prevMarker=r.at(i-1),this.nextMarker=r.at(i+1)},t.prototype.dragMove=function(e,t,n,r,i){if(this.prevMarker&&this.nextMarker&&(this.prevMarker.get("y")+2>i.offsetY||i.offsetY>this.nextMarker.get("y")-2))return;if(!this.prevMarker&&this.nextMarker&&i.offsetY>this.nextMarker.get("y")-2)return;if(this.prevMarker&&!this.nextMarker&&this.prevMarker.get("y")+2>i.offsetY)return;this.blockMarker.set({y:i.offsetY})},t.prototype.onMouseOver=function(){this.$el.addClass("hover"),this.blockMarker.set({hover:!0})},t.prototype.onMouseOut=function(){this.$el.removeClass("hover"),this.blockMarker.set({hover:!1})},t.prototype.setHoverStatus=function(){this.blockMarker.get("hover")?(this.element.attr({"stroke-width":5}),this.$el.addClass("hover")):(this.element.attr({"stroke-width":2}),this.$el.removeClass("hover"))},t.prototype.dragEnd=function(e){},t.prototype.delete=function(){this.element!==undefined&&this.element.remove(),this.$el.remove(),this.remove()},t.prototype.checkAndDelete=function(){this.blockMarker.get("blocks").length==0&&this.destroy()},t.prototype.destroy=function(){this.blockMarker.destroy()},t.prototype.updateBlockMarker=function(e){if(e!==this.blockMarker.get("zone"))return;this.blockMarker.updateZone(),this.render()},t}),define("blockColumnView",["baseView","blockView","blockMarkerView","block","blockMarker"],function(e,t,n,r,i){var s=e.extend({tagName:"li",classname:"BlockColumnView",events:{"click .toggle":"toggleBlockColumnForm","click .block-column-data":"toggleBlockColumnForm","click .destroy":"destroy","click label.block-column-blocks-data":"showBlocksList","keypress :input":"updateBlockColumn","keyup :input":"updateBlockColumn",'change input[name="block-column-bg-color"]':"updateBlockColumn",mouseover:"onMouseOver",mouseout:"onMouseOut"}});return s.prototype.template=new EJS({url:"/block_column_maker/ejs/block_column.ejs"}),s.prototype.initialize=function(e,t){this.app=e,this.blockColumn=t,this.render(),this.listenTo(this.blockColumn,"change:edit",this.editBlockColumn.bind(this)),this.listenTo(this.blockColumn,"change",this.renderBlockColumn.bind(this)),this.listenTo(this.blockColumn.get("settings"),"change",this.renderBlockColumn.bind(this)),this.listenTo(this.blockColumn.get("blockMarkers"),"add",this.addBlockMarker.bind(this)),this.listenTo(this.blockColumn.get("blocks"),"remove",this.removeBlock.bind(this)),this.listenTo(this.blockColumn.get("blocks"),"add",this.addBlock.bind(this)),this.listenTo(this.blockColumn,"destroy",this.delete.bind(this))},s.prototype.render=function(){this.$el.html(this.template.render(this.blockColumn.toJSON())),this.$toggle=this.$(".toggle"),this.$blockColumnForm=this.$(".block-column-form"),this.$blockColumnData=this.$(".block-column-data"),this.$blockColumnName=this.$('input[name="block-column-name"]')[0],this.$blockColumnWidth=this.$('input[name="block-column-width"]')[0],this.$blockColumnBgColor=this.$('input[name="block-column-bg-color"]')[0],this.$blockColumnDescription=this.$('textarea[name="block-column-description"]')[0],this.$blocksList=this.$(".blocks-list"),this.renderBlockColumn()},s.prototype.renderBlockColumn=function(){this.element===undefined&&(this.element=this.app.Canvas.rect(this.blockColumn.get("x"),0,this.blockColumn.get("width"),this.app.Canvas.height),this.element.dblclick(this.createBlockMarker.bind(this)),this.app.MarkersSet.toFront()),this.element.attr({x:this.blockColumn.get("x"),width:this.blockColumn.get("width"),fill:this.blockColumn.get("settings").get("backgroundColor")}),this.updateBlockColumns()},s.prototype.resetBlocks=function(){this.$blocksList.html(""),this.blockColumn.get("blocks").each(this.addBlock.bind(this))},s.prototype.renderBlocks=function(){this.blockColumn.get("blocks").each(this.addBlockMarker.bind(this))},s.prototype.toggleBlockColumnForm=function(){this.renderBlockColumn(),this.blockColumn.set({edit:!this.blockColumn.get("edit")})},s.prototype.editBlockColumn=function(){this.blockColumn.get("edit")?(this.$blockColumnForm.removeClass("hide"),this.$blockColumnData.addClass("hide"),this.$toggle.removeClass("hide-data"),this.$toggle.addClass("show-data")):(this.$blockColumnForm.addClass("hide"),this.$blockColumnData.removeClass("hide"),this.$toggle.removeClass("show-data"),this.$toggle.addClass("hide-data"))},s.prototype.delete=function(){this.element!==undefined&&this.element.remove(),this.$el.remove(),this.remove()},s.prototype.updateBlockColumn=function(e){e.keyCode==13&&this.toggleBlockColumnForm();var t=this.$blockColumnName.value,n=this.$blockColumnDescription.value,r=this.$blockColumnWidth.value,i=this.$blockColumnBgColor.value;this.blockColumn.set({name:t,description:n,width:parseInt(r)||0}),this.blockColumn.get("settings").set({backgroundColor:i})},s.prototype.createBlockMarker=function(e){if(!this.app.enBlocks)return;var t=new i({y:e.offsetY,blockColumn:this.blockColumn},this.app);if(t.get("zone")===null){t.destroy();return}this.blockColumn.get("blockMarkers").add(t)},s.prototype.addBlockMarker=function(e){var t=new n(this.app,e),i=this,s=this.blockColumn.get("blocks"),o=this.blockColumn.get("blockMarkers");o.sort();var u=o.indexOf(e),a,f;if(o.length>1){u==0?(a=o.at(u),f=o.at(u+1)):(a=o.at(u-1),f=o.at(u));var l=s.findWhere({top:a,base:f})||new r({top:a,base:f,blockColumn:i.blockColumn});a.get("blocks").add(l),f.get("blocks").add(l),f.set({name:l.get("name")+" Base"}),s.add(l)}},s.prototype.removeBlock=function(e){var t=e.get("top"),n=e.get("top")},s.prototype.addBlock=function(e){var n=new t(this.app,e);this.$blocksList.append(n.el)},s.prototype.updateBlockColumns=function(){var e=this,t=this.app.BlockColumnsCollection.indexOf(this.blockColumn);this.app.BlockColumnsCollection.each(function(n,r){if(r>t){var i=e.app.BlockColumnsCollection.at(r-1),s=i.get("x")+i.get("width");n.set({x:s})}})},s.prototype.showBlocksList=function(){this.$blocksList.hasClass("hide")?this.$blocksList.removeClass("hide"):this.$blocksList.addClass("hide")},s.prototype.delete=function(){_.invoke(this.blockColumn.get("blocks").toArray(),"destroy"),this.element&&this.element.remove(),this.$el.remove(),this.remove()},s.prototype.destroy=function(){this.blockColumn.destroy()},s}),define("blockColumnsView",["baseView","blockColumnView","blockColumn"],function(e,t,n){var r=e.extend({el:"#columns-list",classname:"BlockColumns"});return r.prototype.template=new EJS({url:"/commons/ejs/data_tbl.ejs"}),r.prototype.initialize=function(e){this.app=e,this.blockColumns=this.app.BlockColumnsCollection,this.listenTo(this.blockColumns,"add",this.addBlockColumn.bind(this)),this.listenToActionEvents(),this.render()},r.prototype.listenToActionEvents=function(){$('a[href="#new-column"').bind("click",this.createBlockColumn.bind(this))},r.prototype.render=function(){this.$el.html(this.template.render()),this.$columnsList=this.$(".data-list")},r.prototype.addBlockColumn=function(e){var n=new t(this.app,e);this.$columnsList.append(n.el)},r.prototype.createBlockColumn=function(){var e=0;this.blockColumns.length>0&&(e=this.blockColumns.last().get("x")+this.blockColumns.last().get("width"));var t="Column "+this.blockColumns.length;this.blockColumns.add(new n({x:e,name:t}))},r}),define("dataExportView",["baseView"],function(e){var t=e.extend({el:"#export-panel",classname:"DataExportView",events:{"click a.show-data":"showData"}});return t.prototype.template=new EJS({url:"/block_column_maker/ejs/data_export_panel.ejs"}),t.prototype.blockColumnDataTemplate=new EJS({url:"/block_column_maker/ejs/block_column_data.ejs"}),t.prototype.initialize=function(e){this.app=e,this.exporter=this.app.exporter,this.markers=this.app.MarkersCollection,this.blockColumns=this.app.BlockColumnsCollection,this.render(),this.$canvas=$("#canvas")},t.prototype.render=function(){this.exporter.export(),this.$el.html(this.template.render({blockColumns:this.blockColumns.toJSON()})),this.$blockColumnsData=this.$(".block-columns-data"),this.$showData=this.$(".show-data"),this.$dataTable=this.$(".data-table"),this.$dataRaw=this.$(".data-raw"),this.$dataJSON=this.$(".data-json"),this.$textData=this.$("textarea[name*=block-columns-data-text]")[0],this.$textJSON=this.$("textarea[name*=block-columns-data-json]")[0],this.$showTable=this.$('a[href="#show-table"]'),this.$showRaw=this.$('a[href="#show-raw"]'),this.$showJSON=this.$('a[href="#show-raw"]'),this.renderDataInText(),this.renderDataInTable()},t.prototype.renderDataInTable=function(){var e=this;this.blockColumns.each(function(t){var n=t.id;e.$("#"+n).html(e.blockColumnDataTemplate.render(t.toJSON()))})},t.prototype.toggleExportView=function(e){$("#loading").removeClass("hide"),$("a[href='#export-data']").parent().hasClass("active")?($("a[href='#export-data']").parent().removeClass("active"),$(".display-panel").addClass("hide"),this.$canvas.removeClass("hide")):($(".maker-tools").parent().removeClass("active"),$("a[href='#export-data']").parent().addClass("active"),$(".display-panel").addClass("hide"),this.$el.removeClass("hide"));try{this.render(),$("#loading").addClass("hide")}catch(t){$("#loading").addClass("hide")}},t.prototype.renderDataInText=function(){this.$textData.value=this.exporter.getText()},t.prototype.showData=function(e){this.$blockColumnsData.addClass("hide"),this.$showData.removeClass("alert"),$(e.target).addClass("alert");var t=$(e.target).attr("href");t==="#show-table"?this.$dataTable.removeClass("hide"):t==="#show-raw"?this.$dataRaw.removeClass("hide"):t==="#show-json"&&this.$dataJSON.removeClass("hide")},t}),define("loader",["zone","marker","blockColumn","blockMarker"],function(e,t,n,r){var i=function(e){this.app=e,this.zones=this.app.ZonesCollection,this.markers=this.app.MarkersCollection,this.blockColumns=this.app.BlockColumnsCollection};return i.prototype.loadFromLocalStorage=function(){this.loadData(localStorage.blockApp)},i.prototype.loadData=function(e){this.savedData=JSON.parse(e),this.reset(),this.load()},i.prototype.loadTextData=function(e){this.reset(),this.textData=e,this.parseTextData(e)},i.prototype.parseTextData=function(e){var t=this,r=e.split("\n"),i=null;for(var s in r){var o=r[s].split("	");for(var u in o)if(o.length>2&&o[u].toLowerCase()==="block"){var a=i?i.get("x")+i.get("width"):0;i=new n({name:o[0],x:a,width:parseInt(o[2])}),t.blockColumns.add(i)}else i!==null&&o.length>2&&t.parseBlockTextData(i,o)}},i.prototype.parseBlockTextData=function(e,t){var n=e.get("blocks").last(),i=n?n.get("base").get("y"):0,s=i+10,o=new r({y:i}),u=new r({y:s}),a=new Block({name:t[1],top:o,base:u});e.get("blocks").add(a)},i.prototype.reset=function(){_.invoke(this.markers.toArray(),"destroy"),_.invoke(this.zones.toArray(),"destroy"),_.invoke(this.blockColumns.toArray(),"destroy")},i.prototype.load=function(){this.loadMarkersAndZones(),this.loadBlockColumns()},i.prototype.loadMarkersAndZones=function(){var e=this;e.savedData.zones.forEach(function(n,r){var i=e.markers.findWhere({y:n.topMarker.y})||new t(n.topMarker),s=e.markers.findWhere({y:n.baseMarker.y})||new t(n.baseMarker);e.markers.add(i),e.markers.add(s)}),e.savedData.zones.forEach(function(t,n){var r=e.markers.findWhere({y:t.topMarker.y}),i=e.markers.findWhere({y:t.baseMarker.y}),s=e.zones.findWhere({topMarker:r,baseMarker:i});s!==undefined&&s.set({name:t.name,description:t.description})})},i.prototype.loadBlockColumns=function(){var e=this;this.savedData.blockColumns.forEach(function(t){var r=new n(t);e.blockColumns.add(r),e.addBlockMarkers(t,r),e.updateBlockNames(t,r)})},i.prototype.addBlockMarkers=function(e,t){var n=this;e.blockMarkers.forEach(function(e){n.addBlockMarkerToColumn(e,t)})},i.prototype.addBlockMarkerToColumn=function(e,t){var n=this,i=t.get("blockMarkers").findWhere({y:e.y})||new r({name:e.name,y:e.y,blockColumn:t},this.app);t.get("blockMarkers").add(i)},i.prototype.updateBlockNames=function(e,t){var n=this;e.blocks.forEach(function(e){var n=t.get("blockMarkers").findWhere({y:e.top.y}),r=t.get("blockMarkers").findWhere({y:e.base.y});if(n!==null&&r!==null){var i=t.get("blocks").findWhere({top:n,base:r});i.set({name:e.name})}})},i}),define("exporter",[],function(){var e=function(e){this.app=e};return e.prototype.initialize=function(){this.markers=this.app.MarkersCollection,this.zones=this.app.ZonesCollection,this.blockColumns=this.app.BlockColumnsCollection},e.prototype.export=function(){this.initialize()},e.prototype.getText=function(){var e=this,t="\n\n";return this.blockColumns.each(function(n){t+=e.getBlockColumnData(n)}),t},e.prototype.getMetaColumnData=function(){var e="Blocks:";return this.blockColumns.each(function(t){e+="	"+t.get("name")}),e},e.prototype.getBlockColumnData=function(e){var t=this,n="\n\n"+e.get("name");return n+="	block",n+="	"+e.get("width"),n+="	USGS-Named",n+="	"+(e.get("description")||""),e.get("blocks").each(function(e,r){n+=t.getBlockData(e)}),n},e.prototype.getBlockData=function(e){var t="\n",n=e.get("top");return n.get("blocks").length<2&&(t+="	"+n.get("name"),t+="	"+(n.get("age")||"n/a"),t+="\n"),t+="	"+e.get("name"),t+="	"+(e.get("base").get("age")||"n/a"),t+="	"+e.get("base").get("style"),t+="	"+(e.get("description")||""),t+="	"+CssToTscColor(e.get("settings").get("backgroundColor")),t},e.prototype.getJSON=function(){var e={};return e.zones=this.zones.toJSON(),e.blockColumns=this.blockColumns.toJSON(),e.referenceColumn=this.app.referenceColumn.toJSON(),JSON.stringify(e)},e}),define("referenceBlock",["baseModel","settings"],function(e,t){var n=e.extend({classname:"ReferenceBlock",constructor:function(n,r){var i=[{edit:!1,hover:!1,name:n.name||_.uniqueId("ReferenceBlock "),description:n.description,settings:new t,top:n.top||null,base:n.base||null,blockColumn:n.blockColumn||null}];e.apply(this,i)}});return n.prototype.initialize=function(){this.get("settings").set({backgroundColor:"#FF0000"})},n.prototype.toJSON=function(){var e=_.clone(this.attributes);return delete e.blockColumn,e},n}),define("referenceBlocks",["baseCollection","referenceBlock"],function(e,t){var n=e.extend({classname:"ReferenceBlocks",model:t});return n}),define("referenceBlockMarker",["baseModel","referenceBlocks"],function(e,t){var n=e.extend({classname:"ReferenceBlockMarker",constructor:function(n,r){var i=[{name:n.name||"TOP",edit:!1,hover:!1,y:parseInt(n.y),id:_.uniqueId("block-marker-"),age:n.age?parseFloat(n.age):null,blockColumn:n.blockColumn||null,style:"solid",app:r||null,blocks:new t,marker:null}];e.apply(this,i)}});return n.prototype.initialize=function(){},n.prototype.toJSON=function(){var e=_.clone(this.attributes);return delete e.blocks,delete e.blockColumn,delete e.marker,delete e.app,e},n}),define("referenceBlockMarkers",["baseCollection","referenceBlockMarker"],function(e,t){var n=e.extend({classname:"ReferenceBlockMarkers",model:t});return n.prototype.comparator=function(e){return e.get("y")},n}),define("referenceBlockColumn",["baseModel","referenceBlocks","referenceBlockMarkers","settings"],function(e,t,n,r){var i=e.extend({classname:"ReferenceBlockColumn",constructor:function(i){var s=[{x:i.x||0,id:i.id||_.uniqueId("column-"),name:i.name||_.uniqueId("Column "),width:parseInt(i.width)||200,height:100,description:i.description||null,blockMarkers:new n,blocks:new t,settings:new r}];e.apply(this,s)}});return i.prototype.comparator=function(e){return e.get("x")},i.prototype.toJSON=function(){var e=_.clone(this.attributes);return e},i}),define("referenceColumn",["baseModel","referenceBlockColumn"],function(e,t){var n=e.extend({classname:"ReferenceColumn",constructor:function(t){var n=[{columnId:t.columnId||"none",column:t.column||null,top:t.top||0,base:t.base||15,columnsData:t.columnsData||null}];e.apply(this,n)}});return n.prototype.toJSON=function(){var e=_.clone(this.attributes);return e},n}),define("referenceBlockView",["baseView"],function(e){var t=e.extend({tagName:"li",classname:"ReferenceBlockView",events:{"click .toggle":"toggleBlockForm","click .block-data":"toggleBlockForm","click .destroy":"destroy","keypress :input":"updateBlock","keyup :input":"updateBlock",'change input[name="block-color"]':"updateBlock","change select.block-line-style":"updateBlock",mouseover:"onMouseOver",mouseout:"onMouseOut"}});return t.prototype.template=new EJS({url:"/reference_column_maker/ejs/block.ejs"}),t.prototype.initialize=function(e,t){this.app=e,this.block=t,this.top=this.block.get("top"),this.base=this.block.get("base"),this.blockSet===undefined&&(this.blockSet=this.app.Canvas.set(),this.app.BlocksSet.push(this.blockSet)),this.render(),this.listenTo(this.block,"change:edit",this.editBlock.bind(this)),this.listenTo(this.block,"change:hover",this.setHoverStatus.bind(this)),this.listenTo(this.block,"change:name",this.renderBlock.bind(this)),this.listenTo(this.block,"change:description",this.renderBlock.bind(this)),this.listenTo(this.block.get("blockColumn"),"change:x",this.renderBlock.bind(this)),this.listenTo(this.block.get("blockColumn"),"change:width",this.renderBlock.bind(this)),this.listenTo(this.top,"change:y",this.renderBlock.bind(this)),this.listenTo(this.top,"change:age",this.render.bind(this)),this.listenTo(this.base,"change:y",this.renderBlock.bind(this)),this.listenTo(this.base,"change:age",this.render.bind(this)),this.listenTo(this.block.get("settings"),"change",this.renderBlock.bind(this)),this.listenTo(this.block,"destroy",this.delete.bind(this))},t.prototype.render=function(){this.$el.html(this.template.render(this.block.toJSON())),this.$toggle=this.$(".toggle"),this.$blockForm=this.$(".block-form"),this.$blockData=this.$(".block-data"),this.$blockName=this.$('input[name="block-name"]')[0],this.$topAge=this.$('input[name="top-age"]')[0],this.$baseAge=this.$('input[name="base-age"]')[0],this.$blockColor=this.$('input[name="block-color"]')[0],this.$blockDescription=this.$('textarea[name="block-description"]')[0],this.editBlock(),this.renderBlock()},t.prototype.renderBlock=function(){this.bgBox===undefined&&(this.bgBox=this.app.Canvas.rect(),this.blockText=this.app.Canvas.text(),this.bBox=this.app.Canvas.rect(),this.blockSet.push(this.bgBox),this.blockSet.push(this.blockText),this.blockSet.push(this.bBox),this.app.MarkersSet.toFront(),this.app.BlockMarkersSet.toFront(),this.bBox.hover(this.onMouseOver.bind(this),this.onMouseOut.bind(this))),this.bgBox.attr({"stroke-width":0,fill:this.block.get("settings").get("backgroundColor"),x:this.block.get("blockColumn").get("x"),y:this.top.get("y"),width:this.block.get("blockColumn").get("width"),height:this.base.get("y")-this.top.get("y")});var e=Math.round(this.block.get("blockColumn").get("x")+this.block.get("blockColumn").get("width")/2),t=Math.round((this.top.get("y")+this.base.get("y"))/2),n=Math.min(Math.round(this.base.get("y")-this.top.get("y")),16);this.blockText.attr({x:e,y:t,text:this.block.get("name"),"font-size":n}),this.bBox.attr({"stroke-width":2,opacity:0,fill:"#FFF",x:this.block.get("blockColumn").get("x"),y:this.top.get("y"),width:this.block.get("blockColumn").get("width"),height:this.base.get("y")-this.top.get("y")}),this.renderTooltip()},t.prototype.renderTooltip=function(){$(this.bBox.node).qtip({content:{text:this.block.get("name")+"<br>"+(this.block.get("description")||"No description yet!")},position:{my:"bottom left",target:"mouse"}})},t.prototype.onMouseOver=function(){this.$el.addClass("hover"),this.block.set({hover:!0})},t.prototype.onMouseOut=function(){this.$el.removeClass("hover"),this.block.set({hover:!1})},t.prototype.setHoverStatus=function(){this.block.get("hover")?(this.$el.addClass("hover"),this.glow=this.bBox.glow()):(this.glow&&this.glow.remove(),this.$el.removeClass("hover"))},t.prototype.toggleBlockForm=function(){this.render(),this.block.set({edit:!this.block.get("edit")})},t.prototype.editBlock=function(){this.block.get("edit")?(this.$blockForm.removeClass("hide"),this.$blockData.addClass("hide"),this.$toggle.removeClass("hide-data"),this.$toggle.addClass("show-data")):(this.$blockForm.addClass("hide"),this.$blockData.removeClass("hide"),this.$toggle.removeClass("show-data"),this.$toggle.addClass("hide-data"))},t.prototype.delete=function(){this.blockText&&this.blockText.remove(),this.bgBox&&this.bgBox.remove(),this.bBox&&this.bBox.remove(),this.glow&&this.glow.remove(),this.$el.remove(),this.remove()},t.prototype.destroy=function(){this.block.get("base").set({name:"TOP"}),this.block.destroy()},t.prototype.updateBlock=function(e){var t=this.$blockName.value,n=this.$blockDescription.value,r=this.$blockColor.value,i=this.$("select.block-line-style option:selected").val();this.block.set({name:t,description:n});if(e.keyCode===TimescaleApp.ENTER||e.keyCode===TimescaleApp.ESC)this.block.get("base").set({name:t+" Base",age:parseFloat(this.$baseAge.value||0)}),this.block.get("top").set({age:parseFloat(this.$topAge.value||0)}),this.toggleBlockForm();this.block.get("settings").set({backgroundColor:r}),this.base.set({style:i})},t}),define("referenceBlockMarkerView",["baseView"],function(e){var t=e.extend({classname:"ReferenceBlockMarkerView"});return t.prototype.statusBoxTemplate=new EJS({url:"/reference_column_maker/ejs/status_box.ejs"}),t.prototype.initialize=function(e,t){this.app=e,this.blockMarker=t,this.render(),this.listenTo(this.blockMarker.get("blockColumn"),"change:x",this.renderBlockMarker.bind(this)),this.listenTo(this.blockMarker.get("blockColumn"),"change:width",this.renderBlockMarker.bind(this)),this.listenTo(this.blockMarker,"change:hover",this.setHoverStatus.bind(this)),this.listenTo(this.blockMarker,"change",this.renderBlockMarker.bind(this)),this.listenTo(this.blockMarker,"destroy",this.delete.bind(this)),this.listenTo(this.blockMarker.get("blocks"),"remove",this.checkAndDelete.bind(this)),this.render()},t.prototype.render=function(){this.renderBlockMarker()},t.prototype.renderBlockMarker=function(){this.element===undefined&&(this.element=this.app.Canvas.path(),this.element.attr({"stroke-width":2,stroke:"#0000FF"}),this.element.hover(this.onMouseOver.bind(this),this.onMouseOut.bind(this)),this.element.drag(this.dragMove.bind(this),this.dragStart.bind(this),this.dragEnd.bind(this)),this.app.BlockMarkersSet.push(this.element),this.app.MarkersSet.toFront()),this.blockMarker.get("marker")&&this.listenTo(this.blockMarker.get("marker"),"change:y",this.updateBlockMakereY.bind(this));var e=this.blockMarker.get("style"),t=[];e==="dashed"?t=["-"]:e==="dotted"&&(t=["."]),this.element.attr({path:this.getPath(),"stroke-dasharray":t}),this.resizeCanvas(),this.updateStatusBox(),this.renderTooltip()},t.prototype.renderTooltip=function(){var e=this;$(this.element.node).qtip({content:{text:this.blockMarker.get("name")+"("+this.blockMarker.get("age")+" myr )"},position:{my:"bottom left",target:"mouse"}})},t.prototype.resizeCanvas=function(){var e=Math.max(this.app.Canvas.height,this.blockMarker.get("y")+100);this.blockMarker.get("blockColumn").set({height:e}),this.app.Canvas.setSize(this.app.Canvas.width,e)},t.prototype.updateBlockMakereY=function(){this.blockMarker.get("marker")&&this.blockMarker.set({y:this.blockMarker.get("marker").get("y")})},t.prototype.updateStatusBox=function(){this.app.StatusBox&&this.app.StatusBox.html(this.statusBoxTemplate.render(this.blockMarker.toJSON()))},t.prototype.getPath=function(){var e=this.blockMarker.get("blockColumn").get("x")+this.blockMarker.get("blockColumn").get("width");return"M"+this.blockMarker.get("blockColumn").get("x")+","+this.blockMarker.get("y")+"H"+e},t.prototype.dragStart=function(e,t,n){var r=this.blockMarker.get("blockColumn").get("blockMarkers"),i=r.indexOf(this.blockMarker);this.prevMarker=r.at(i-1),this.nextMarker=r.at(i+1)},t.prototype.dragMove=function(e,t,n,r,i){if(this.prevMarker&&this.nextMarker&&(this.prevMarker.get("y")+2>i.offsetY||i.offsetY>this.nextMarker.get("y")-2))return;if(!this.prevMarker&&this.nextMarker&&i.offsetY>this.nextMarker.get("y")-2)return;if(this.prevMarker&&!this.nextMarker&&this.prevMarker.get("y")+2>i.offsetY)return;this.blockMarker.set({y:i.offsetY})},t.prototype.onMouseOver=function(){this.$el.addClass("hover"),this.blockMarker.set({hover:!0})},t.prototype.onMouseOut=function(){this.$el.removeClass("hover"),this.blockMarker.set({hover:!1})},t.prototype.setHoverStatus=function(){this.blockMarker.get("hover")?(this.element.attr({"stroke-width":5}),this.$el.addClass("hover")):(this.element.attr({"stroke-width":2}),this.$el.removeClass("hover"))},t.prototype.dragEnd=function(e){},t.prototype.delete=function(){this.element!==undefined&&this.element.remove(),this.$el.remove(),this.remove()},t.prototype.checkAndDelete=function(){this.blockMarker.get("blocks").length==0&&this.destroy()},t.prototype.destroy=function(){this.blockMarker.destroy()},t}),define("referenceBlockColumnView",["baseView","referenceBlockView","referenceBlockMarkerView","referenceBlock","referenceBlockMarker"],function(e,t,n,r,i){var s=e.extend({tagName:"li",classname:"ReferenceBlockColumnView",events:{"click .toggle":"ReferencetoggleBlockColumnForm","click .block-column-data":"ReferencetoggleBlockColumnForm","click .destroy":"destroy","click label.block-column-blocks-data":"showBlocksList","keypress :input":"ReferenceupdateBlockColumn","keyup :input":"ReferenceupdateBlockColumn",'change input[name="block-column-bg-color"]':"ReferenceupdateBlockColumn",mouseover:"onMouseOver",mouseout:"onMouseOut"}});return s.prototype.template=new EJS({url:"/reference_column_maker/ejs/block_column.ejs"}),s.prototype.initialize=function(e,t){this.app=e,this.blockColumn=t,this.render(),this.listenTo(this.blockColumn,"change:edit",this.editBlockColumn.bind(this)),this.listenTo(this.blockColumn,"change",this.renderBlockColumn.bind(this)),this.listenTo(this.blockColumn.get("settings"),"change",this.renderBlockColumn.bind(this)),this.listenTo(this.blockColumn.get("blockMarkers"),"add",this.addBlockMarker.bind(this)),this.listenTo(this.blockColumn.get("blocks"),"remove",this.removeBlock.bind(this)),this.listenTo(this.blockColumn.get("blocks"),"add",this.addBlock.bind(this)),this.listenTo(this.blockColumn,"destroy",this.delete.bind(this))},s.prototype.render=function(){this.$el.html(this.template.render(this.blockColumn.toJSON())),this.$toggle=this.$(".toggle"),this.$blockColumnForm=this.$(".block-column-form"),this.$blockColumnData=this.$(".block-column-data"),this.$blockColumnName=this.$('input[name="block-column-name"]')[0],this.$blockColumnWidth=this.$('input[name="block-column-width"]')[0],this.$blockColumnBgColor=this.$('input[name="block-column-bg-color"]')[0],this.$blockColumnDescription=this.$('textarea[name="block-column-description"]')[0],this.$blocksList=this.$(".blocks-list"),this.renderBlockColumn()},s.prototype.renderBlockColumn=function(){this.element===undefined&&(this.element=this.app.Canvas.rect(this.blockColumn.get("x"),0,this.blockColumn.get("width"),this.app.Canvas.height),this.element.dblclick(this.createBlockMarker.bind(this)),this.app.MarkersSet.toFront()),this.element.attr({x:this.blockColumn.get("x"),width:this.blockColumn.get("width"),height:this.blockColumn.get("height"),fill:this.blockColumn.get("settings").get("backgroundColor")}),this.resizeCanvas(),this.updateBlockColumns()},s.prototype.resizeCanvas=function(){var e=Math.max(this.app.Canvas.width,this.blockColumn.get("x")+this.blockColumn.get("width"));this.app.Canvas.setSize(e,this.app.Canvas.height)},s.prototype.resetBlocks=function(){this.$blocksList.html(""),this.blockColumn.get("blocks").each(this.addBlock.bind(this))},s.prototype.ReferencerenderBlocks=function(){this.blockColumn.get("blocks").each(this.addBlockMarker.bind(this))},s.prototype.ReferencetoggleBlockColumnForm=function(){this.renderBlockColumn(),this.blockColumn.set({edit:!this.blockColumn.get("edit")})},s.prototype.editBlockColumn=function(){this.blockColumn.get("edit")?(this.$blockColumnForm.removeClass("hide"),this.$blockColumnData.addClass("hide"),this.$toggle.removeClass("hide-data"),this.$toggle.addClass("show-data")):(this.$blockColumnForm.addClass("hide"),this.$blockColumnData.removeClass("hide"),this.$toggle.removeClass("show-data"),this.$toggle.addClass("hide-data"))},s.prototype.delete=function(){this.element!==undefined&&this.element.remove(),this.$el.remove(),this.remove()},s.prototype.ReferenceupdateBlockColumn=function(e){e.keyCode==13&&this.ReferencetoggleBlockColumnForm();var t=this.$blockColumnName.value,n=this.$blockColumnDescription.value,r=this.$blockColumnWidth.value,i=this.$blockColumnBgColor.value;this.blockColumn.set({name:t,description:n,width:parseInt(r)||0}),this.blockColumn.get("settings").set({backgroundColor:i})},s.prototype.createBlockMarker=function(e){if(!this.app.enBlocks)return;var t=new i({y:e.offsetY,blockColumn:this.blockColumn},this.app);this.blockColumn.get("blockMarkers").add(t)},s.prototype.addBlockMarker=function(e){var t=new n(this.app,e),i=this,s=this.blockColumn.get("blocks"),o=this.blockColumn.get("blockMarkers");o.sort();var u=o.indexOf(e),a,f;if(o.length>1){u==0?(a=o.at(u),f=o.at(u+1)):(a=o.at(u-1),f=o.at(u));var l=s.findWhere({top:a,base:f})||new r({top:a,base:f,blockColumn:i.blockColumn});a.get("blocks").add(l),f.get("blocks").add(l),f.set({name:l.get("name")+" Base"}),s.add(l)}},s.prototype.removeBlock=function(e){var t=e.get("top"),n=e.get("top")},s.prototype.addBlock=function(e){var n=new t(this.app,e);this.$blocksList.append(n.el)},s.prototype.updateBlockColumns=function(){var e=this;if(!this.app.ReferenceBlockColumnsCollection)return;var t=this.app.ReferenceBlockColumnsCollection.indexOf(this.blockColumn);this.app.ReferenceBlockColumnsCollection.each(function(n,r){if(r>t){var i=e.app.ReferenceBlockColumnsCollection.at(r-1),s=i.get("x")+i.get("width");n.set({x:s})}})},s.prototype.showBlocksList=function(){this.$blocksList.hasClass("hide")?this.$blocksList.removeClass("hide"):this.$blocksList.addClass("hide")},s.prototype.delete=function(){_.invoke(this.blockColumn.get("blocks").toArray(),"destroy"),this.element&&this.element.remove(),this.$el.remove(),this.remove()},s.prototype.destroy=function(){this.blockColumn.destroy()},s}),define("referenceColumnSideView",["baseView","referenceColumn","referenceBlockColumn","referenceBlockColumnView","referenceColumnSideView","referenceBlockMarker","referenceBlock","marker"],function(e,t,n,r,i,s,o,u){var i=e.extend({el:"#ref-col-set-list",classname:"ReferenceColumnSideView",events:{"keypress :input":"updateReferenceColumnSettings","keyup :input":"updateReferenceColumnSettings","click input[type=radio]":"updateReferenceColumnSettings","dragover #reference-column-box":"dataDragover","drop #reference-column-box":"dataDrop"}});return i.prototype.template=new EJS({url:"/reference_column_maker/ejs/reference_column.ejs"}),i.prototype.settingsTemplate=new EJS({url:"/reference_column_maker/ejs/reference_column_settings.ejs"}),i.prototype.initialize=function(e){this.app=e,this.app.refCol={},this.zones=this.app.ZonesCollection,this.markers=this.app.MarkersCollection,this.referenceColumn=new t({top:0,base:15}),this.app.referenceColumn=this.referenceColumn,this.listenTo(this.referenceColumn,"change:columnsData",this.render.bind(this)),this.listenTo(this.referenceColumn,"change:columnId",this.render.bind(this)),this.listenTo(this.referenceColumn,"change:top",this.render.bind(this)),this.listenTo(this.referenceColumn,"change:base",this.render.bind(this)),this.renderReferenceColumnCanvas(),this.loadReferenceColumnData()},i.prototype.listenToActionEvents=function(){var e=this;this.$enRefPanel=$("a[href='#show-ref-panel']"),this.$enRefPanel.click(function(){e.$refPanel.toggleClass("hidden")})},i.prototype.renderReferenceColumnCanvas=function(){this.$refPanel=$("#ref-panel"),this.$refPanel.html(this.template.render({})),this.app.refCol.$canvas=$("#ref-canvas"),this.$canvas=this.app.refCol.$canvas,this.app.refCol.Canvas=new Raphael(this.$canvas[0],0,0),this.app.refCol.MarkersSet=this.app.refCol.Canvas.set(),this.app.refCol.BlockMarkersSet=this.app.refCol.Canvas.set(),this.app.refCol.BlocksSet=this.app.refCol.Canvas.set(),this.listenToActionEvents()},i.prototype.loadReferenceColumnData=function(){var e=this;$.get("/commons/json/default-reference-column-data.json",function(t){e.referenceColumn.set({columnsData:t.referenceBlockColumns})})},i.prototype.render=function(){var e=this;e.$el.html(e.settingsTemplate.render(e.referenceColumn.toJSON())),this.$topAge=this.$('input[name="top-age"]'),this.$baseAge=this.$('input[name="base-age"]'),this.updateReferenceColumn()},i.prototype.updateReferenceColumnSettings=function(e){var t=this;this.$columnId=this.$('input[name="ref-column"]:checked'),t.referenceColumn.set({columnId:t.$columnId.val()}),(e.keyCode==TimescaleApp.ENTER||e.keyCode==TimescaleApp.ESC)&&t.referenceColumn.set({top:parseFloat(t.$topAge.val()),base:parseFloat(t.$baseAge.val())})},i.prototype.getColumnData=function(e){var t=null;return this.referenceColumn.get("columnsData").forEach(function(n){n.id===e&&(t=n)}),t},i.prototype.updateReferenceColumn=function(e,t,n){_.invoke(this.markers.toArray(),"destroy"),_.invoke(this.zones.toArray(),"destroy"),this.referenceColumn.get("column")&&this.referenceColumn.get("column").destroy();if(this.referenceColumn.get("top")>this.referenceColumn.get("base")||this.referenceColumn.get("columnId")==="none")return;var r=this.getColumnData(this.referenceColumn.get("columnId"));r?(this.referenceColumn.set({column:this.loadBlockColumn(r)}),this.resizeReferenceColumnCanvas()):this.referenceColumn.set({columnId:"none"})},i.prototype.loadBlockColumn=function(e){var t=this;e.x=0;var i=new n(e),s=new r(this.app.refCol,i);return t.addBlockMarkers(e,i),i},i.prototype.resizeReferenceColumnCanvas=function(){var e=this.referenceColumn.get("column").get("width"),t=this.referenceColumn.get("column").get("blockMarkes")?this.referenceColumn.get("column").get("blockMarkes").last().get("y")+100:0;t=Math.max(this.app.Canvas.height,t),this.app.refCol.Canvas.setSize(e,t),this.app.Canvas.setSize(this.app.Canvas.width,t)},i.prototype.addBlockMarkers=function(e,t){var n=this,r=n.referenceColumn.get("top"),i=n.referenceColumn.get("base");e.blockMarkers.forEach(function(s,o){if(s.age<r||s.age>i)return;n.addBlockMarkerToColumn(s,t,o,e)})},i.prototype.addBlockMarkerToColumn=function(e,t,n,r){var i=this;e.y=t.get("blockMarkers").length>0?(t.get("blockMarkers").length+1)*50:50;var o=t.get("blockMarkers").findWhere({age:e.age})||new s({y:e.y,blockColumn:t,age:e.age},this.app);t.get("blockMarkers").add(o);var a=i.markers.findWhere({age:e.age})||new u(e);i.markers.add(a),o.set({name:e.name,marker:a}),a.set({name:e.name});if(n>0){var f=i.zones.last(),l=t.get("blocks").last(),c=r.blocks[n-1];f&&f.set({name:c.name,description:c.description}),l&&(l.set({name:c.name,description:c.description}),l.get("settings").set({backgroundColor:c.settings.backgroundColor}))}},i.prototype.updateBlockNames=function(e,t){var n=this;e.blocks.forEach(function(e,r,i){var s=t.get("blockMarkers").findWhere({age:e.top.age}),o=t.get("blockMarkers").findWhere({age:e.base.age}),u=n.markers.findWhere({age:e.top.age}),a=n.markers.findWhere({age:e.base.age});if(u!==null&&a!==null){var f=n.zones.findWhere({topMarker:u,baseMarker:a});f&&f.set({name:e.name,description:e.description})}if(s!==null&&o!==null){var l=t.get("blocks").findWhere({top:s,base:o});l&&(l.set({name:e.name,description:e.description}),l.get("settings").set({backgroundColor:e.settings.backgroundColor}))}})},i.prototype.dataDragover=function(e){var e=e.originalEvent;e.stopPropagation(),e.preventDefault()},i.prototype.dataDrop=function(e){$("#loading").removeClass("hide");var t=this,e=e.originalEvent;e.stopPropagation(),e.preventDefault();var n=e.dataTransfer.files[0],r=n.name.split(".").pop(),i=new FileReader;i.onloadend=function(e){r==="json"&&t.referenceColumn.set({columnsData:JSON.parse(this.result).referenceBlockColumns}),$("#loading").addClass("hide")},i.readAsText(n)},i}),define("blockAppView",["baseView","cursorView","fileSystemView","markers","markersView","zones","zonesView","blockColumns","blockColumnsView","dataExportView","loader","exporter","referenceColumnSideView"],function(e,t,n,r,i,s,o,u,a,f,l,c,h){var p=e.extend({el:".container",classname:"BlockAppView",events:{"click a.block-settings":"showSettings","click a.maker-tools":"enableTool","click a.continue":"showCanvas","dragover #data-box":"dataDragover","drop #data-box":"dataDrop"}});return p.prototype.initialize=function(){this.blockApp={type:"block"},this.blockApp.BlockColumnsCollection=new u,this.blockApp.ZonesCollection=new s,this.blockApp.MarkersCollection=new r,this.blockApp.StatusBox=$(".status-box"),this.$introScreen=this.$("#intro-screen"),this.blockApp.$canvas=this.$("#canvas"),this.$canvas=this.blockApp.$canvas,this.$displayPanels=this.$(".display-panel"),this.blockApp.loader=new l(this.blockApp),this.blockApp.exporter=new c(this.blockApp),this.blockApp.Canvas=new Raphael(this.$canvas[0],2e3,2e3),this.blockApp.MarkersSet=this.blockApp.Canvas.set(),this.blockApp.BlockMarkersSet=this.blockApp.Canvas.set(),this.blockApp.BlocksSet=this.blockApp.Canvas.set(),this.render(),this.listenToActionEvents()},p.prototype.listenToActionEvents=function(){var e=this;$(".close-reveal-modal").click(function(e){$(e.target).parent().foundation("reveal","close")}),$("a[href=#continue-load-from-local-storage]").click(function(t){$(t.target).parent().foundation("reveal","close"),e.loadFromLocalStorage()}),$("a[href=#continue-save-to-local-storage]").click(function(t){$(t.target).parent().foundation("reveal","close"),e.saveToLocalStorage()})},p.prototype.showCanvas=function(){this.$canvas.removeClass("hide"),this.$introScreen.addClass("hide")},p.prototype.render=function(){this.dataExportView=new f(this.blockApp),this.cursorView=new t(this.blockApp),this.fileSystemView=new n(this.blockApp),this.zonesView=new o(this.blockApp),this.markersView=new i(this.blockApp),this.blockColumnsView=new a(this.blockApp),this.referenceColumnSideView=new h(this.blockApp,"#reference-column-settings"),$(".linked").scroll(function(){$(".linked").scrollTop($(this).scrollTop())})},p.prototype.showSettings=function(e){var t=e.target.getAttribute("href")+"-list";$(t).hasClass("active")?($(t).removeClass("active"),$(e.target).removeClass("active"),$(e.target).parent().removeClass("active"),this.$("#sections-panel").removeClass("active")):(this.$(".settings-content").removeClass("active"),this.$(".settings-links").removeClass("active"),this.$(".block-settings").removeClass("active"),$(t).addClass("active"),$(e.target).addClass("active"),$(e.target).parent().addClass("active"),this.$("#sections-panel").addClass("active"))},p.prototype.showExportDataPanel=function(e){this.$exportPanel.hasClass("active")||this.dataExportView.render()},p.prototype.exportCanvasAsImage=function(){},p.prototype.saveToLocalStorage=function(){this.blockApp.exporter.export(),localStorage.blockApp=this.blockApp.exporter.getJSON()},p.prototype.loadFromLocalStorage=function(){this.showCanvas(),this.blockApp.loader.loadFromLocalStorage()},p.prototype.dataDragover=function(e){var e=e.originalEvent;e.stopPropagation(),e.preventDefault()},p.prototype.dataDrop=function(e){var t=this,e=e.originalEvent;e.stopPropagation(),e.preventDefault();var n=e.dataTransfer.files[0];if(n.type==="application/json"){var r=new FileReader;r.onloadend=function(e){t.showCanvas(),t.blockApp.loader.loadData(this.result)},r.readAsText(n)}},p.prototype.toggleBlocks=function(e){$("a[href='#add-block']").parent().hasClass("active")?($("a[href='#add-block']").parent().removeClass("active"),this.blockApp.enBlocks=!1):($("a[href='#add-block']").parent().addClass("active"),this.blockApp.enBlocks=!0)},p.prototype.dataDragover=function(e){var e=e.originalEvent;e.stopPropagation(),e.preventDefault()},p.prototype.dataDrop=function(e){$("#loading").removeClass("hide");var t=this,e=e.originalEvent;e.stopPropagation(),e.preventDefault();var n=e.dataTransfer.files[0],r=n.name.split(".").pop(),i=new FileReader;i.onloadend=function(e){t.showCanvas(),r==="json"&&t.blockApp.loader.loadData(this.result),r==="txt"&&t.blockApp.loader.loadTextData(this.result),$("#loading").addClass("hide")},i.readAsText(n)},p.prototype.enableTool=function(e){var t=e.target.getAttribute("href");this.markersView.enMarkers&&this.markersView.toggleMarkers(),this.blockApp.enBlocks&&this.toggleBlocks();switch(t){case"#add-marker":this.markersView.toggleMarkers();break;case"#export-data":this.dataExportView.toggleExportView();break;case"#file-system":this.fileSystemView.toggleView();break;case"#save-to-local-storage":$("#quick-save-data").foundation("reveal","open");break;case"#reload-data":$("#load-saved-data").foundation("reveal","open");break;case"#new-column":break;case"#add-block":this.toggleBlocks();break;default:}},p}),requirejs.config({paths:{baseView:"/commons/js/views/base_view",baseModel:"/commons/js/models/base_model",baseCollection:"/commons/js/collections/base_collection",app:"/commons/js/models/app",settings:"/commons/js/models/settings",cursorView:"/commons/js/views/cursor_view",cursor:"/commons/js/models/cursor",markersView:"/commons/js/views/markers_view",markerView:"/commons/js/views/marker_view",marker:"/commons/js/models/marker",markers:"/commons/js/collections/markers",zoneView:"/commons/js/views/zone_view",zonesView:"/commons/js/views/zones_view",zone:"/commons/js/models/zone",zones:"/commons/js/collections/zones",loader:"/block_column_maker/js/utils/loader",exporter:"/block_column_maker/js/utils/exporter",dataExportView:"/block_column_maker/js/views/data_export_view",block:"/block_column_maker/js/models/block",blocks:"/block_column_maker/js/collections/blocks",blockMarker:"/block_column_maker/js/models/block_marker",blockMarkers:"/block_column_maker/js/collections/block_markers",blockColumn:"/block_column_maker/js/models/block_column",blockColumns:"/block_column_maker/js/collections/block_columns",blockView:"/block_column_maker/js/views/block_view",blockMarkerView:"/block_column_maker/js/views/block_marker_view",blockColumnView:"/block_column_maker/js/views/block_column_view",blockColumnsView:"/block_column_maker/js/views/block_columns_view",polyK:"/commons/js/lib/polyK",file:"/file_system/js/models/file",files:"/file_system/js/collections/files",fileView:"/file_system/js/views/file_view",filesView:"/file_system/js/views/files_view",fileSystem:"/file_system/js/models/file_system",fileSystemView:"/file_system/js/views/file_system_view",blockAppView:"/block_column_maker/js/views/block_app_view",referenceColumnLoader:"/reference_column_maker/js/utils/loader",referenceColumn:"/reference_column_maker/js/models/reference_column",referenceBlock:"/reference_column_maker/js/models/reference_block",referenceBlocks:"/reference_column_maker/js/collections/reference_blocks",referenceBlockMarker:"/reference_column_maker/js/models/reference_block_marker",referenceBlockMarkers:"/reference_column_maker/js/collections/reference_block_markers",referenceBlockColumn:"/reference_column_maker/js/models/reference_block_column",referenceBlockColumns:"/reference_column_maker/js/collections/reference_block_columns",referenceBlockView:"/reference_column_maker/js/views/reference_block_view",referenceBlockMarkerView:"/reference_column_maker/js/views/reference_block_marker_view",referenceBlockColumnView:"/reference_column_maker/js/views/reference_block_column_view",referenceBlockColumnsView:"/reference_column_maker/js/views/reference_block_columns_view",referenceColumnSideView:"/reference_column_maker/js/views/reference_column_side_view"}}),requirejs(["blockAppView"],function(e){var t=new e}),define("block_column_maker/js/block_app",function(){});